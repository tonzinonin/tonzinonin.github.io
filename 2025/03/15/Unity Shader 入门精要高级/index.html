<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Unity Shader 入门精要高级 | final fantasy</title><meta name="author" content="某不知名的作者"><meta name="copyright" content="某不知名的作者"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Unity Shader 入门精要高级 屏幕后处理屏幕后处理，顾名思义，通常指的是在渲染完整个场景得到屏幕图像之后再对这个图形进行一系列操作，实现各种屏幕特效 Unity为我们提供了一个接口用于抓取屏幕OnRenderImage。它的函数声明如下：  当在脚本声明这个函数之后Unity会把当前渲染得到的图像存储在第一个参数对应的源渲染纹理中，通过函数中的一系列操作之后，再把目标渲染纹理，即第二个参">
<meta property="og:type" content="article">
<meta property="og:title" content="Unity Shader 入门精要高级">
<meta property="og:url" content="https://tonzinonin.github.io/2025/03/15/Unity%20Shader%20%E5%85%A5%E9%97%A8%E7%B2%BE%E8%A6%81%E9%AB%98%E7%BA%A7/index.html">
<meta property="og:site_name" content="final fantasy">
<meta property="og:description" content="Unity Shader 入门精要高级 屏幕后处理屏幕后处理，顾名思义，通常指的是在渲染完整个场景得到屏幕图像之后再对这个图形进行一系列操作，实现各种屏幕特效 Unity为我们提供了一个接口用于抓取屏幕OnRenderImage。它的函数声明如下：  当在脚本声明这个函数之后Unity会把当前渲染得到的图像存储在第一个参数对应的源渲染纹理中，通过函数中的一系列操作之后，再把目标渲染纹理，即第二个参">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://s3.bmp.ovh/imgs/2023/01/12/1e052378ba7e2bfd.jpg">
<meta property="article:published_time" content="2025-03-15T13:25:13.000Z">
<meta property="article:modified_time" content="2025-03-30T04:16:57.041Z">
<meta property="article:author" content="某不知名的作者">
<meta property="article:tag" content="Unity">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s3.bmp.ovh/imgs/2023/01/12/1e052378ba7e2bfd.jpg"><link rel="shortcut icon" href="/img/icon.png"><link rel="canonical" href="https://tonzinonin.github.io/2025/03/15/Unity%20Shader%20%E5%85%A5%E9%97%A8%E7%B2%BE%E8%A6%81%E9%AB%98%E7%BA%A7/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Unity Shader 入门精要高级',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-03-30 12:16:57'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/OIP.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">88</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">27</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">14</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://s3.bmp.ovh/imgs/2023/01/12/1e052378ba7e2bfd.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">final fantasy</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Unity Shader 入门精要高级</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-03-15T13:25:13.000Z" title="发表于 2025-03-15 21:25:13">2025-03-15</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-03-30T04:16:57.041Z" title="更新于 2025-03-30 12:16:57">2025-03-30</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Unity/">Unity</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Unity Shader 入门精要高级"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>Unity Shader 入门精要高级</p>
<h1 id="屏幕后处理"><a href="#屏幕后处理" class="headerlink" title="屏幕后处理"></a>屏幕后处理</h1><p>屏幕后处理，顾名思义，通常指的是在渲染完整个场景得到屏幕图像之后再对这个图形进行一系列操作，实现各种屏幕特效</p>
<p>Unity为我们提供了一个接口用于抓取屏幕OnRenderImage。它的函数声明如下：</p>
<p><img src="/./../../../BlogImg/image-20250317220443815.png" alt="image-20250317220443815"></p>
<p>当在脚本声明这个函数之后Unity会把当前渲染得到的图像存储在第一个参数对应的源渲染纹理中，通过函数中的一系列操作之后，再把目标渲染纹理，即第二个参数对应的渲染纹理显示到屏幕上。在OnRenderImage函数当中，我们通常是利用Graphics.Blit函数来完成对渲染纹理的处理</p>
<p><img src="/./../../../BlogImg/image-20250317220547932.png" alt="image-20250317220547932"></p>
<p>参数src对应源纹理，这个参数通常就是当前屏幕的渲染纹理或者是上一步处理之后得到的渲染纹理，参数dest是目标渲染纹理，如果它的值为null就会直接将结果显示在屏幕上，参数mat是我们使用的材质，这个材质使用的Unity Shader将会进行各种屏幕后处理操作，而src纹理将会被传递给Shader中名为_MainTex的纹理属性。参数pass的默认值为-1，表示将会依次调用Shader内的所有Pass。否则，只会调用给定索引的Pass</p>
<p>在默认情况下，OnRenderImage函数会在所有的不透明和透明的Pass执行完毕之后被调用，以便对场景中所有游戏对象都产生影响。</p>
<p>我们可以在函数前添加ImageEffectOpaque属性来在不透明的Pass（渲染队列小于等于2500的Pass，内置的Background，Geometry和AlphaTest都在这个范围之内）执行完毕之后立即调用OnRenderImage函数，从而不对透明物体产生任何影响。</p>
<p>在摄像机当中添加脚本，使用OnRenderImage获取渲染纹理，再调用Graphics.Bilt函数使用特定的Unity Shader来对当前图像进行处理。再把返回的渲染纹理显示到屏幕上，对于一些复杂的屏幕特效，我们可能需要多次调用Graphics.Blit函数来对上一步的输出结果进行下一步处理。</p>
<p>进行屏幕后处理之前，要检查当前平台是否支持渲染纹理和屏幕特效当前使用的UnityShader等。</p>
<p><img src="/./../../../BlogImg/image-20250318000427860.png" alt="image-20250318000427860"></p>
<p>为此我们创建了一个用于屏幕后处理效果的基类，实现各种特效需要继承这个基类，再实现派生类当中的不同操作即可。</p>
<pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl"><span class="token keyword">using</span> System<span class="token punctuation">;</span>
<span class="token keyword">using</span> System<span class="token punctuation">.</span>Collections<span class="token punctuation">;</span>
<span class="token keyword">using</span> System<span class="token punctuation">.</span>Collections<span class="token punctuation">.</span>Generic<span class="token punctuation">;</span>
<span class="token keyword">using</span> UnityEngine<span class="token punctuation">;</span>

<span class="token punctuation">[</span>ExecuteInEditMode<span class="token punctuation">]</span><span class="token comment">//保证在编辑请模式可以执行这个脚本</span>
<span class="token punctuation">[</span><span class="token function">RequireComponent</span><span class="token punctuation">(</span><span class="token function">typeof</span><span class="token punctuation">(</span>Camera<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> PostEffectsBase <span class="token operator">:</span> MonoBehaviour
<span class="token punctuation">&#123;</span>
    protected <span class="token keyword">void</span> <span class="token function">CheckResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">bool</span> isSupported <span class="token operator">=</span> <span class="token function">CheckSupport</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span>isSupported <span class="token operator">==</span> <span class="token keyword">false</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token function">NotSupported</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    private <span class="token keyword">bool</span> <span class="token function">CheckSupport</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>SystemInfo<span class="token punctuation">.</span>supportsImageEffects <span class="token operator">==</span> <span class="token keyword">false</span> <span class="token operator">||</span>
         SystemInfo<span class="token punctuation">.</span>supportsRenderTextures <span class="token operator">==</span> <span class="token keyword">false</span><span class="token punctuation">)</span><span class="token comment">//疑似已经过时</span>
         <span class="token punctuation">&#123;</span>
             Debug<span class="token punctuation">.</span><span class="token function">LogWarning</span><span class="token punctuation">(</span><span class="token string">"This platform does not support image effects or render textures."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token keyword">return</span> <span class="token keyword">false</span><span class="token punctuation">;</span>
         <span class="token punctuation">&#125;</span>
         <span class="token keyword">return</span> <span class="token keyword">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    protected <span class="token keyword">void</span> <span class="token function">NotSupported</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        enabled <span class="token operator">=</span> <span class="token keyword">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    protected  <span class="token keyword">void</span> <span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token function">CheckResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//提前检查资源和条件是否满足</span>
    <span class="token punctuation">&#125;</span>
    
    protected Material <span class="token function">CheckShaderAndCreateMaterial</span><span class="token punctuation">(</span>Shader shader <span class="token punctuation">,</span> Material material<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>shader <span class="token operator">==</span> null<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>shader<span class="token punctuation">.</span>isSupported <span class="token operator">&amp;&amp;</span> material <span class="token operator">&amp;&amp;</span> material<span class="token punctuation">.</span>shader <span class="token operator">==</span> shader<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token comment">//`shader.isSupported` 是一个布尔值属性，表示当前平台是否支持指定的 `Shader`。</span>
            <span class="token comment">// 如果这个属性为 `false`，则表示当前平台不支持该 `Shader`</span>
            <span class="token keyword">return</span> material<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>shader<span class="token punctuation">.</span>isSupported<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">&#123;</span>
            material <span class="token operator">=</span> new <span class="token function">Material</span><span class="token punctuation">(</span>shader<span class="token punctuation">)</span><span class="token punctuation">;</span>
            material<span class="token punctuation">.</span>hideFlags <span class="token operator">=</span> HideFlags<span class="token punctuation">.</span>DontSave<span class="token punctuation">;</span>
            <span class="token comment">//创建的新材质对象的 `hideFlags` 属性被设置为 `HideFlags.DontSave`。`hideFlags` </span>
            <span class="token comment">// 是一个用于控制对象在 Unity 编辑器中行为的枚举值。通过设置为 `HideFlags.DontSave`，</span>
            <span class="token comment">// 可以确保这个材质对象不会被保存到场景文件中。</span>
            <span class="token comment">// 这意味着当场景被保存时，这个材质不会被持久化存储，但在运行时仍然可以被正确使用。</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>material<span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                <span class="token keyword">return</span> material<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">&#123;</span>
                <span class="token keyword">return</span> null<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="调整屏幕的亮度饱和度和对比度"><a href="#调整屏幕的亮度饱和度和对比度" class="headerlink" title="调整屏幕的亮度饱和度和对比度"></a>调整屏幕的亮度饱和度和对比度</h2><p>代码</p>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Collections</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Collections<span class="token punctuation">.</span>Generic</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">UnityEngine</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BrightnessSaturationAndContrast</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">PostEffectsBase</span></span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token class-name">Shader</span> briSatConShader<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Material</span> briSatConMaterial<span class="token punctuation">;</span>
    <span class="token comment">//对应我们创建的shader和材质</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">Material</span> material
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">get</span>
        <span class="token punctuation">&#123;</span>
            briSatConMaterial <span class="token operator">=</span> <span class="token function">CheckShaderAndCreateMaterial</span><span class="token punctuation">(</span>briSatConShader<span class="token punctuation">,</span> briSatConMaterial<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> briSatConMaterial<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        
    <span class="token punctuation">&#125;</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Range</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token number">0.0f</span> <span class="token punctuation">,</span> <span class="token number">3.0f</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token class-name"><span class="token keyword">float</span></span> brightness <span class="token operator">=</span> <span class="token number">1.0f</span><span class="token punctuation">;</span><span class="token comment">//亮度</span>

    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Range</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token number">0.0f</span> <span class="token punctuation">,</span> <span class="token number">3.0f</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token class-name"><span class="token keyword">float</span></span> saturation <span class="token operator">=</span> <span class="token number">1.0f</span><span class="token punctuation">;</span><span class="token comment">//饱和度</span>

    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Range</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token number">0.0f</span> <span class="token punctuation">,</span> <span class="token number">3.0f</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token class-name"><span class="token keyword">float</span></span> contrast <span class="token operator">=</span> <span class="token number">1.0f</span><span class="token punctuation">;</span><span class="token comment">//对比度</span>

    <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnRenderImage</span><span class="token punctuation">(</span><span class="token class-name">RenderTexture</span> src <span class="token punctuation">,</span> <span class="token class-name">RenderTexture</span> dest<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>material <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            material<span class="token punctuation">.</span><span class="token function">SetFloat</span><span class="token punctuation">(</span><span class="token string">"_Brightness"</span> <span class="token punctuation">,</span> brightness<span class="token punctuation">)</span><span class="token punctuation">;</span>
            material<span class="token punctuation">.</span><span class="token function">SetFloat</span><span class="token punctuation">(</span><span class="token string">"_Saturation"</span> <span class="token punctuation">,</span> saturation<span class="token punctuation">)</span><span class="token punctuation">;</span>
            material<span class="token punctuation">.</span><span class="token function">SetFloat</span><span class="token punctuation">(</span><span class="token string">"_Contrast"</span> <span class="token punctuation">,</span> contrast<span class="token punctuation">)</span><span class="token punctuation">;</span>

            Graphics<span class="token punctuation">.</span><span class="token function">Blit</span><span class="token punctuation">(</span>src <span class="token punctuation">,</span> dest <span class="token punctuation">,</span> material<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">else</span>
        <span class="token punctuation">&#123;</span>
            Graphics<span class="token punctuation">.</span><span class="token function">Blit</span><span class="token punctuation">(</span>src <span class="token punctuation">,</span> dest<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token comment">//每当OnRenderImage函数被调用的时候，它会检测材质是否可用，如果可用，就把参数传递给材质</span>
        <span class="token comment">//再调用Graphics.Blit函数进行处理：否则，直接吧原图像显示到屏幕上，不做任何处理。</span>

    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl">Shader <span class="token string">"Custom/Chapter12_1_BrightnessSaturationAndContrast"</span>
<span class="token punctuation">&#123;</span>
    Properties
    <span class="token punctuation">&#123;</span>
        <span class="token function">_MainTex</span><span class="token punctuation">(</span><span class="token string">"Base (RGB)"</span> <span class="token punctuation">,</span> <span class="token number">2</span>D<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">"white"</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
        <span class="token function">_Brightness</span><span class="token punctuation">(</span><span class="token string">"Brightness"</span> <span class="token punctuation">,</span> Float<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span>
        <span class="token function">_Saturation</span><span class="token punctuation">(</span><span class="token string">"Saturation"</span> <span class="token punctuation">,</span> Float<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span>
        <span class="token function">_Contrast</span><span class="token punctuation">(</span><span class="token string">"Contrast"</span> <span class="token punctuation">,</span> Float<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span>
    <span class="token punctuation">&#125;</span>
    
    SubShader
    <span class="token punctuation">&#123;</span><span class="token comment">//屏幕后处理实际上是在场景中绘制了一个与屏幕同宽同高的四边形面片，为了防止它对其他物体的影响，</span>
        <span class="token comment">//我们需要关闭深度测试和深度写入。这是屏幕后处理设置的标配</span>
        Pass
        <span class="token punctuation">&#123;</span>
            ZTest Always Cull Off ZWrite Off

            CGPROGRAM
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">vertex vert</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">fragment frag</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"UnityCG.cginc"</span></span>

            <span class="token keyword">sampler2D</span> _MainTex<span class="token punctuation">;</span>
            <span class="token keyword">float</span> _Brightness<span class="token punctuation">;</span>
            <span class="token keyword">float</span> _Saturation<span class="token punctuation">;</span>
            <span class="token keyword">float</span> _Contrast<span class="token punctuation">;</span>

            <span class="token keyword">struct</span> <span class="token class-name">a2v</span>
            <span class="token punctuation">&#123;</span>
                float4 vertex <span class="token operator">:</span> POSITION<span class="token punctuation">;</span>
                float2 texcoord <span class="token operator">:</span> TEXCOORD0<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

            v2f <span class="token function">vert</span><span class="token punctuation">(</span>appdata_img v<span class="token punctuation">)</span><span class="token comment">//使用了UNITY内置的顶点结构体作为顶点着色器的输入，它只包含了图像处理时必需的顶点坐标和纹理坐标</span>
            <span class="token comment">//等变量</span>
            <span class="token punctuation">&#123;</span>
                v2f o<span class="token punctuation">;</span>
                o<span class="token punctuation">.</span>pos <span class="token operator">=</span> <span class="token function">mul</span><span class="token punctuation">(</span>UNITY_MATRIX_MVP <span class="token punctuation">,</span> v<span class="token punctuation">.</span>vertex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                o<span class="token punctuation">.</span>uv <span class="token operator">=</span> v<span class="token punctuation">.</span>texcoord<span class="token punctuation">;</span>
                <span class="token keyword">return</span> o<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            fixed4 <span class="token function">frag</span><span class="token punctuation">(</span>v2f i<span class="token punctuation">)</span> <span class="token operator">:</span> SV_Target
            <span class="token punctuation">&#123;</span>
                fixed4 renderTex <span class="token operator">=</span> <span class="token function">tex2D</span><span class="token punctuation">(</span>_MainTex <span class="token punctuation">,</span> i<span class="token punctuation">.</span>uv<span class="token punctuation">)</span><span class="token punctuation">;</span>

                fixed3 finalColor <span class="token operator">=</span> renderTex<span class="token punctuation">.</span>rgb <span class="token operator">*</span> _Brightness<span class="token punctuation">;</span><span class="token comment">//亮度</span>

                <span class="token keyword">fixed</span> luminance <span class="token operator">=</span> <span class="token number">0.2125</span> <span class="token operator">*</span> renderTex<span class="token punctuation">.</span>r <span class="token operator">+</span> <span class="token number">0.7154</span> <span class="token operator">*</span> renderTex<span class="token punctuation">.</span>g <span class="token operator">+</span> <span class="token number">0.0721</span> <span class="token operator">*</span> renderTex<span class="token punctuation">.</span>b<span class="token punctuation">;</span>
                fixed3 luminanceColor <span class="token operator">=</span> <span class="token function">fixed3</span><span class="token punctuation">(</span>luminance <span class="token punctuation">,</span> luminance <span class="token punctuation">,</span> luminance<span class="token punctuation">)</span><span class="token punctuation">;</span>
                finalColor <span class="token operator">=</span> <span class="token function">lerp</span><span class="token punctuation">(</span>luminanceColor <span class="token punctuation">,</span> finalColor <span class="token punctuation">,</span> _Saturation<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//饱和度</span>

                fixed3 avgColor <span class="token operator">=</span> <span class="token function">fixed3</span> <span class="token punctuation">(</span><span class="token number">0.5</span> <span class="token punctuation">,</span> <span class="token number">0.5</span> <span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                finalColor <span class="token operator">=</span> <span class="token function">lerp</span><span class="token punctuation">(</span>avgColor <span class="token punctuation">,</span> finalColor <span class="token punctuation">,</span> _Contrast<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//对比度</span>

                <span class="token keyword">return</span> <span class="token function">fixed4</span><span class="token punctuation">(</span>finalColor <span class="token punctuation">,</span> renderTex<span class="token punctuation">.</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    FallBack Off
<span class="token punctuation">&#125;</span>

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p><img src="/./../../../BlogImg/image-20250317231616640.png" alt="image-20250317231616640"></p>
<p><img src="/./../../../BlogImg/image-20250317232015786.png" alt="image-20250317232015786"></p>
<h2 id="边缘检测"><a href="#边缘检测" class="headerlink" title="边缘检测"></a>边缘检测</h2><p><img src="/./../../../BlogImg/image-20250317235302539.png" alt="image-20250317235302539"></p>
<p>代码</p>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Collections</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Collections<span class="token punctuation">.</span>Generic</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">UnityEngine</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EdgeDetection</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">PostEffectsBase</span></span><span class="token comment">//继承基类</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token class-name">Shader</span> edgeDetectShader<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Material</span> edgeDetectMaterial<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token return-type class-name">Material</span> material
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">get</span>
        <span class="token punctuation">&#123;</span>
            edgeDetectMaterial <span class="token operator">=</span> <span class="token function">CheckShaderAndCreateMaterial</span><span class="token punctuation">(</span>edgeDetectShader <span class="token punctuation">,</span> edgeDetectMaterial<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> edgeDetectMaterial<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Range</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token number">0.0f</span> <span class="token punctuation">,</span> <span class="token number">1.0f</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token class-name"><span class="token keyword">float</span></span> edgesOnly <span class="token operator">=</span> <span class="token number">0.0f</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">Color</span> edgeColor <span class="token operator">=</span> Color<span class="token punctuation">.</span>black<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">Color</span> backgroundColor <span class="token operator">=</span> Color<span class="token punctuation">.</span>white<span class="token punctuation">;</span>

    <span class="token comment">//当edgesOnly为0的时候边缘将会叠加在原渲染图像上，当edgesOnly值为1的时候</span>
    <span class="token comment">//则会值显示边缘，不显示原渲染图像，其中，背景颜色由backgroundColor指定</span>
    <span class="token comment">//边缘颜色由edgeColor指定</span>

    <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnRenderImage</span><span class="token punctuation">(</span><span class="token class-name">RenderTexture</span> source<span class="token punctuation">,</span> <span class="token class-name">RenderTexture</span> destination<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>material <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            material<span class="token punctuation">.</span><span class="token function">SetFloat</span><span class="token punctuation">(</span><span class="token string">"_EdgesOnly"</span> <span class="token punctuation">,</span> edgesOnly<span class="token punctuation">)</span><span class="token punctuation">;</span>
            material<span class="token punctuation">.</span><span class="token function">SetColor</span><span class="token punctuation">(</span><span class="token string">"_EdgeColor"</span> <span class="token punctuation">,</span> edgeColor<span class="token punctuation">)</span><span class="token punctuation">;</span>
            material<span class="token punctuation">.</span><span class="token function">SetColor</span><span class="token punctuation">(</span><span class="token string">"_BackgroundColor"</span> <span class="token punctuation">,</span> backgroundColor<span class="token punctuation">)</span><span class="token punctuation">;</span>

            Graphics<span class="token punctuation">.</span><span class="token function">Blit</span><span class="token punctuation">(</span>source <span class="token punctuation">,</span> destination <span class="token punctuation">,</span> material<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">&#123;</span>
            Graphics<span class="token punctuation">.</span><span class="token function">Blit</span><span class="token punctuation">(</span>source <span class="token punctuation">,</span> destination<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>shader</p>
<pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl"><span class="token comment">// Upgrade NOTE: replaced 'mul(UNITY_MATRIX_MVP,*)' with 'UnityObjectToClipPos(*)'</span>

Shader <span class="token string">"Custom/Chapter12_2_EdgeDetection"</span>
<span class="token punctuation">&#123;</span>
    Properties
    <span class="token punctuation">&#123;</span>
        <span class="token function">_MainTex</span> <span class="token punctuation">(</span><span class="token string">"Base (RGB)"</span> <span class="token punctuation">,</span> <span class="token number">2</span>D<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">"white"</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
        <span class="token function">_EdgesOnly</span> <span class="token punctuation">(</span><span class="token string">"Edge Only"</span> <span class="token punctuation">,</span> Float<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1.0</span>
        <span class="token function">_EdgeColor</span> <span class="token punctuation">(</span><span class="token string">"Edge COlor"</span> <span class="token punctuation">,</span> Color<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token function">_BackgroundColor</span><span class="token punctuation">(</span><span class="token string">"Background Color"</span> <span class="token punctuation">,</span> Color<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token punctuation">,</span> <span class="token number">1</span> <span class="token punctuation">,</span> <span class="token number">1</span> <span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>

    SubShader
    <span class="token punctuation">&#123;</span>
        Pass
        <span class="token punctuation">&#123;</span>
            CGPROGRAM

            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">vertex vert</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">fragment frag</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"UnityCG.cginc"</span></span>

            <span class="token keyword">sampler2D</span> _MainTex<span class="token punctuation">;</span>
            float4 _MainTex_TexelSize<span class="token punctuation">;</span><span class="token comment">//Unity提供的访问xxx纹理的每个纹素的大小</span>
            <span class="token comment">//比如一张512x512的纹理，_MainTex_TexelSize.xy = 1/512</span>
            <span class="token comment">//由于卷积需要对相邻区域内的纹理进行采样，所以我们需要利用_MainTex_TexelSize.xy</span>
            <span class="token comment">//来计算各个相邻区域的纹理坐标</span>
            <span class="token keyword">float</span> _EdgesOnly<span class="token punctuation">;</span>
            float4 _EdgeColor<span class="token punctuation">;</span>
            float4 _BackgroundColor<span class="token punctuation">;</span>

            <span class="token keyword">struct</span> <span class="token class-name">v2f</span>
            <span class="token punctuation">&#123;</span>
                float4 pos <span class="token operator">:</span> SV_POSITION<span class="token punctuation">;</span>
                half2 uv<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span> <span class="token operator">:</span> TEXCOORD0<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

            <span class="token keyword">half</span> <span class="token function">Sobel</span><span class="token punctuation">(</span>v2f i<span class="token punctuation">)</span><span class="token punctuation">;</span>

            
			<span class="token keyword">fixed</span> <span class="token function">luminance</span><span class="token punctuation">(</span>fixed4 color<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				<span class="token keyword">return</span>  <span class="token number">0.2125</span> <span class="token operator">*</span> color<span class="token punctuation">.</span>r <span class="token operator">+</span> <span class="token number">0.7154</span> <span class="token operator">*</span> color<span class="token punctuation">.</span>g <span class="token operator">+</span> <span class="token number">0.0721</span> <span class="token operator">*</span> color<span class="token punctuation">.</span>b<span class="token punctuation">;</span> 
			<span class="token punctuation">&#125;</span>

            v2f <span class="token function">vert</span><span class="token punctuation">(</span>appdata_img v<span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                v2f o<span class="token punctuation">;</span>
                o<span class="token punctuation">.</span>pos <span class="token operator">=</span> <span class="token function">UnityObjectToClipPos</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>vertex<span class="token punctuation">)</span><span class="token punctuation">;</span>

                half2 uv <span class="token operator">=</span> v<span class="token punctuation">.</span>texcoord<span class="token punctuation">;</span>
                <span class="token comment">// 6 7 8</span>
                <span class="token comment">// 3 4 5</span>
                <span class="token comment">// 0 1 2</span>
                o<span class="token punctuation">.</span>uv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> uv <span class="token operator">+</span> _MainTex_TexelSize<span class="token punctuation">.</span>xy <span class="token operator">*</span> <span class="token function">half2</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                o<span class="token punctuation">.</span>uv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> uv <span class="token operator">+</span> _MainTex_TexelSize<span class="token punctuation">.</span>xy <span class="token operator">*</span> <span class="token function">half2</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                o<span class="token punctuation">.</span>uv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> uv <span class="token operator">+</span> _MainTex_TexelSize<span class="token punctuation">.</span>xy <span class="token operator">*</span> <span class="token function">half2</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                o<span class="token punctuation">.</span>uv<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> uv <span class="token operator">+</span> _MainTex_TexelSize<span class="token punctuation">.</span>xy <span class="token operator">*</span> <span class="token function">half2</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                o<span class="token punctuation">.</span>uv<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> uv <span class="token operator">+</span> _MainTex_TexelSize<span class="token punctuation">.</span>xy <span class="token operator">*</span> <span class="token function">half2</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                o<span class="token punctuation">.</span>uv<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> uv <span class="token operator">+</span> _MainTex_TexelSize<span class="token punctuation">.</span>xy <span class="token operator">*</span> <span class="token function">half2</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                o<span class="token punctuation">.</span>uv<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">=</span> uv <span class="token operator">+</span> _MainTex_TexelSize<span class="token punctuation">.</span>xy <span class="token operator">*</span> <span class="token function">half2</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                o<span class="token punctuation">.</span>uv<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">=</span> uv <span class="token operator">+</span> _MainTex_TexelSize<span class="token punctuation">.</span>xy <span class="token operator">*</span> <span class="token function">half2</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                o<span class="token punctuation">.</span>uv<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span> <span class="token operator">=</span> uv <span class="token operator">+</span> _MainTex_TexelSize<span class="token punctuation">.</span>xy <span class="token operator">*</span> <span class="token function">half2</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">return</span> o<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            half4 <span class="token function">frag</span><span class="token punctuation">(</span>v2f i<span class="token punctuation">)</span> <span class="token operator">:</span> SV_Target
            <span class="token punctuation">&#123;</span>
                <span class="token keyword">half</span> edge <span class="token operator">=</span> <span class="token function">Sobel</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">//`withEdgeColor`：在边缘处显示 `_EdgeColor`，其它地方显示原图颜色。</span>
                <span class="token comment">//`onlyEdgeColor`：在边缘处显示 `_EdgeColor`，其它地方显示 `_BackgroundColor`。</span>
                fixed4 withEdgeColor <span class="token operator">=</span> <span class="token function">lerp</span><span class="token punctuation">(</span>_EdgeColor <span class="token punctuation">,</span> <span class="token function">tex2D</span><span class="token punctuation">(</span>_MainTex <span class="token punctuation">,</span> i<span class="token punctuation">.</span>uv<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">,</span> edge<span class="token punctuation">)</span><span class="token punctuation">;</span>
                fixed4 onlyEdgeColor <span class="token operator">=</span> <span class="token function">lerp</span><span class="token punctuation">(</span>_EdgeColor <span class="token punctuation">,</span> _BackgroundColor <span class="token punctuation">,</span> edge<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token function">lerp</span><span class="token punctuation">(</span>withEdgeColor <span class="token punctuation">,</span> onlyEdgeColor <span class="token punctuation">,</span> _EdgesOnly<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//_EdgeOnly为1时只显示边缘，为0时显示背景色</span>
                <span class="token comment">//当参数c为0的时候，lerp(a b c)返回a ,即a * (1 - c)，b * c。 </span>
            <span class="token punctuation">&#125;</span>

            <span class="token keyword">half</span> <span class="token function">Sobel</span><span class="token punctuation">(</span>v2f i<span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                <span class="token keyword">const</span> <span class="token keyword">half</span> Gx<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2</span> <span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">,</span> 
                                    <span class="token number">0</span> <span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">,</span> 
                                    <span class="token number">1</span> <span class="token punctuation">,</span> <span class="token number">2</span> <span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
                <span class="token keyword">const</span> <span class="token keyword">half</span> Gy<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">,</span> <span class="token number">1</span> <span class="token punctuation">,</span> 
                                     <span class="token operator">-</span><span class="token number">2</span> <span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">,</span> <span class="token number">2</span> <span class="token punctuation">,</span> 
                                     <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
                <span class="token keyword">half</span> texColor<span class="token punctuation">;</span>
                <span class="token keyword">half</span> edgeX <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token keyword">half</span> edgeY <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">9</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span>
                <span class="token punctuation">&#123;</span>
                    texColor <span class="token operator">=</span> <span class="token function">luminance</span><span class="token punctuation">(</span><span class="token function">tex2D</span><span class="token punctuation">(</span>_MainTex<span class="token punctuation">,</span> i<span class="token punctuation">.</span>uv<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//Luminance是一个函数，用于计算颜色的亮度值。它将彩色纹理的 RGB 值转换为一个灰度值，</span>
                    <span class="token comment">//这个灰度值代表了该位置的颜色强度，</span>
                    <span class="token comment">//忽略了颜色的具体色调信息。通常，亮度值是通过加权的 RGB 值计算得到的，</span>
                    <span class="token comment">//权重通常是基于人眼对不同颜色的敏感度，例如常见的公式是 </span>
                    <span class="token comment">//`Luminance = 0.299 * R + 0.587 * G + 0.114 * B`。</span>
                    edgeX <span class="token operator">+=</span> Gx<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">*</span> texColor<span class="token punctuation">;</span>
                    edgeY <span class="token operator">+=</span> Gy<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">*</span> texColor<span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>

                <span class="token keyword">half</span> edge <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">-</span> <span class="token function">abs</span><span class="token punctuation">(</span>edgeX<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">abs</span><span class="token punctuation">(</span>edgeY<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">return</span> edge<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            ENDCG
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    FallBack Off
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p><img src="/./../../../BlogImg/image-20250318004538478.png" alt="image-20250318004538478"></p>
<h2 id="高斯模糊"><a href="#高斯模糊" class="headerlink" title="高斯模糊"></a>高斯模糊</h2><p><img src="/./../../../BlogImg/image-20250318112904592.png" alt="image-20250318112904592"><br><img src="/./../../../BlogImg/image-20250318120025907.png" alt="image-20250318120025907"></p>
<p>创建一个继承了后处理基类的脚本<br>我们写了三种OnRenderImage函数<br>第一种</p>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnRenderImage</span><span class="token punctuation">(</span><span class="token class-name">RenderTexture</span> src <span class="token punctuation">,</span> <span class="token class-name">RenderTexture</span> dest<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>material <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token class-name"><span class="token keyword">int</span></span> rtW <span class="token operator">=</span> src<span class="token punctuation">.</span>width<span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">int</span></span> rtH <span class="token operator">=</span> src<span class="token punctuation">.</span>height<span class="token punctuation">;</span>

            <span class="token class-name">RenderTexture</span> buffer <span class="token operator">=</span> RenderTexture<span class="token punctuation">.</span><span class="token function">GetTemporary</span><span class="token punctuation">(</span>rtW <span class="token punctuation">,</span> rtH <span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            Graphics<span class="token punctuation">.</span><span class="token function">Blit</span><span class="token punctuation">(</span>src <span class="token punctuation">,</span> buffer <span class="token punctuation">,</span> material <span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Graphics<span class="token punctuation">.</span><span class="token function">Blit</span><span class="token punctuation">(</span>buffer <span class="token punctuation">,</span> dest <span class="token punctuation">,</span> material <span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            RenderTexture<span class="token punctuation">.</span><span class="token function">ReleaseTemporary</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">&#123;</span>
            Graphics<span class="token punctuation">.</span><span class="token function">Blit</span><span class="token punctuation">(</span>src <span class="token punctuation">,</span> dest<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这里我们使用了RenderTexture.GetTemporary函数来分配了一块和屏幕图像大小相同的缓冲区。<br>这是因为高斯模糊需要调用两个Pass。</p>
<p>我们需要使用一块中间缓存来存储第一个Pass执行完毕之后得到的模糊效果，我们先调用Graphics.Blit(src , buffer , material , 0);，使用Shader当中的第一个Pass（竖直方向上的第一个Pass）对src进行处理，并且降结果存储到了buffer当中。</p>
<p>然后，再调用Graphics.Blit(buffer , dest , material , 1);，使用shader中的第二个Pass，即使用水平方向的一位高斯核进行滤波对buffer进行处理，返回最终的0屏幕图像，最后我们还需要调用RenderTexture.ReleaseTemporary来释放之前分配的缓存。</p>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnRenderImage</span><span class="token punctuation">(</span><span class="token class-name">RenderTexture</span> src <span class="token punctuation">,</span> <span class="token class-name">RenderTexture</span> dest<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>material <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token class-name"><span class="token keyword">int</span></span> rtW <span class="token operator">=</span> src<span class="token punctuation">.</span>width <span class="token operator">/</span> downSample<span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">int</span></span> rtH <span class="token operator">=</span> src<span class="token punctuation">.</span>height <span class="token operator">/</span>downSample<span class="token punctuation">;</span> 

            <span class="token class-name">RenderTexture</span> buffer <span class="token operator">=</span> RenderTexture<span class="token punctuation">.</span><span class="token function">GetTemporary</span><span class="token punctuation">(</span>rtW <span class="token punctuation">,</span> rtH <span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            buffer<span class="token punctuation">.</span>filterMode <span class="token operator">=</span> FilterMode<span class="token punctuation">.</span>Bilinear<span class="token punctuation">;</span> <span class="token comment">//第二个版本添加的代码</span>

            Graphics<span class="token punctuation">.</span><span class="token function">Blit</span><span class="token punctuation">(</span>src <span class="token punctuation">,</span> buffer <span class="token punctuation">,</span> material <span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Graphics<span class="token punctuation">.</span><span class="token function">Blit</span><span class="token punctuation">(</span>buffer <span class="token punctuation">,</span> dest <span class="token punctuation">,</span> material <span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            RenderTexture<span class="token punctuation">.</span><span class="token function">ReleaseTemporary</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">&#123;</span>
            Graphics<span class="token punctuation">.</span><span class="token function">Blit</span><span class="token punctuation">(</span>src <span class="token punctuation">,</span> dest<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token comment">//我们在声明缓冲区的大小的时候，使用了小于原屏幕分辨率的尺寸，并且将该临时渲染纹理的滤波模式设置成了双线性，</span>
         <span class="token comment">//这样在调用第一个Pass的时候我们需要处理的像素个数就是原来的几分之一。</span>
         <span class="token comment">//对图像进行降采样不仅可以减少需要处理像素个数，提高性能，而且适当的降采样往往还可以得到更好的模糊效果。</span>
         <span class="token comment">//但是downSample值越大可能会造成图像像素化。</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnRenderImage</span><span class="token punctuation">(</span><span class="token class-name">RenderTexture</span> src <span class="token punctuation">,</span> <span class="token class-name">RenderTexture</span> dest<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>material <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>

            <span class="token class-name"><span class="token keyword">int</span></span> rtW <span class="token operator">=</span> src<span class="token punctuation">.</span>width <span class="token operator">/</span> downSample<span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">int</span></span> rtH <span class="token operator">=</span> src<span class="token punctuation">.</span>height <span class="token operator">/</span>downSample<span class="token punctuation">;</span> 

            <span class="token class-name">RenderTexture</span> buffer0 <span class="token operator">=</span> RenderTexture<span class="token punctuation">.</span><span class="token function">GetTemporary</span><span class="token punctuation">(</span>rtW <span class="token punctuation">,</span> rtH <span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            buffer0<span class="token punctuation">.</span>filterMode <span class="token operator">=</span> FilterMode<span class="token punctuation">.</span>Bilinear<span class="token punctuation">;</span> <span class="token comment">//第二个版本添加的代码</span>

            Graphics<span class="token punctuation">.</span><span class="token function">Blit</span><span class="token punctuation">(</span>src <span class="token punctuation">,</span> buffer0<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//第三个版本添加的代码</span>

            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> i <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span> i <span class="token operator">&lt;</span> iterations <span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token comment">//第三个版本添加的代码,处理迭代</span>
            <span class="token punctuation">&#123;</span>
                material<span class="token punctuation">.</span><span class="token function">SetFloat</span><span class="token punctuation">(</span><span class="token string">"_BlurSize"</span> <span class="token punctuation">,</span> <span class="token number">1.0f</span> <span class="token operator">+</span> i <span class="token operator">*</span> blurSpread<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token class-name">RenderTexture</span> buffer1 <span class="token operator">=</span> RenderTexture<span class="token punctuation">.</span><span class="token function">GetTemporary</span><span class="token punctuation">(</span>rtW <span class="token punctuation">,</span> rtH <span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">//render vertical pass</span>
                Graphics<span class="token punctuation">.</span><span class="token function">Blit</span><span class="token punctuation">(</span>buffer0 <span class="token punctuation">,</span> buffer1 <span class="token punctuation">,</span> material <span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                RenderTexture<span class="token punctuation">.</span><span class="token function">ReleaseTemporary</span><span class="token punctuation">(</span>buffer0<span class="token punctuation">)</span><span class="token punctuation">;</span>

                buffer0 <span class="token operator">=</span> buffer1<span class="token punctuation">;</span>
                buffer1 <span class="token operator">=</span> RenderTexture<span class="token punctuation">.</span><span class="token function">GetTemporary</span><span class="token punctuation">(</span>rtW <span class="token punctuation">,</span> rtH <span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">//render horizontal pass</span>
                Graphics<span class="token punctuation">.</span><span class="token function">Blit</span><span class="token punctuation">(</span>buffer0 <span class="token punctuation">,</span> buffer1 <span class="token punctuation">,</span> material <span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                RenderTexture<span class="token punctuation">.</span><span class="token function">ReleaseTemporary</span><span class="token punctuation">(</span>buffer0<span class="token punctuation">)</span><span class="token punctuation">;</span>

                buffer0 <span class="token operator">=</span> buffer1<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            

            <span class="token comment">//Graphics.Blit(src , buffer0 , material , 0);</span>
            Graphics<span class="token punctuation">.</span><span class="token function">Blit</span><span class="token punctuation">(</span>buffer0 <span class="token punctuation">,</span> dest<span class="token punctuation">)</span><span class="token punctuation">;</span>

            RenderTexture<span class="token punctuation">.</span><span class="token function">ReleaseTemporary</span><span class="token punctuation">(</span>buffer0<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">&#123;</span>
            Graphics<span class="token punctuation">.</span><span class="token function">Blit</span><span class="token punctuation">(</span>src <span class="token punctuation">,</span> dest<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>上面的代码显示了如何利用两个临时混存在迭代之间进行交替的过程。在迭代开始之前，我们首先定义了第一个缓存buffer0，并且把src中的图像缩放后存储到buffer0当中。在迭代过程中，我们又定义了第二个缓存buffer1，在执行第一个Pass时候，输入是buffer0，输出是buffer1，完毕之后把buffer0释放，再把结果值buffer1存储到buffer0当中，重新分配buffer1，然后再调用第二个Pass，重复上述过程，迭代完成之后，buffer0将会存储最终的图像。</p>
<p><img src="/./../../../BlogImg/image-20250318124113968.png" alt="image-20250318124113968"></p>
<pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl"><span class="token comment">// Upgrade NOTE: replaced 'mul(UNITY_MATRIX_MVP,*)' with 'UnityObjectToClipPos(*)'</span>

Shader <span class="token string">"Custom/Chapter12_3_Gaussius"</span>
<span class="token punctuation">&#123;</span>
    Properties
    <span class="token punctuation">&#123;</span>
        <span class="token function">_MainTex</span> <span class="token punctuation">(</span><span class="token string">"Texture"</span><span class="token punctuation">,</span> <span class="token number">2</span>D<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">"white"</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
        <span class="token function">_BlurSize</span> <span class="token punctuation">(</span><span class="token string">"Blur Size"</span><span class="token punctuation">,</span> Float<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span>
    <span class="token punctuation">&#125;</span>
    SubShader
    <span class="token punctuation">&#123;</span>   
        CGINCLUDE
        <span class="token comment">//`CGINCLUDE`是Unity Shader Lab中的一个指令，</span>
        <span class="token comment">//它允许你定义一段可以在多个Pass之间共享的代码。</span>
        <span class="token comment">//这段代码在这里主要用于定义一些通用的变量、结构体和函数，</span>
        <span class="token comment">//这些变量、结构体和函数在垂直模糊（GAUSSIAN_BLUR_VERTICAL)</span>
        <span class="token comment">//和水平模糊（GAUSSIAN_BLUR_HORIZONTAL）Pass中都会用到。</span>

        <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"UnityCG.cginc"</span></span>

        <span class="token keyword">sampler2D</span> _MainTex<span class="token punctuation">;</span>
        float4 _MainTex_TexelSize<span class="token punctuation">;</span>
        <span class="token keyword">float</span> _BlurSize<span class="token punctuation">;</span>
        
        <span class="token keyword">struct</span> <span class="token class-name">v2f</span>
        <span class="token punctuation">&#123;</span>
            float4 pos <span class="token operator">:</span> SV_POSITION<span class="token punctuation">;</span>
            float2 uv<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">:</span> TEXCOORD0<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        
        v2f <span class="token function">vertBlurVertical</span><span class="token punctuation">(</span>appdata_img v<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            v2f o<span class="token punctuation">;</span>
            o<span class="token punctuation">.</span>pos <span class="token operator">=</span> <span class="token function">UnityObjectToClipPos</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>vertex<span class="token punctuation">)</span><span class="token punctuation">;</span>

            half2 uv <span class="token operator">=</span> v<span class="token punctuation">.</span>texcoord<span class="token punctuation">;</span>

            o<span class="token punctuation">.</span>uv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> uv<span class="token punctuation">;</span>
            o<span class="token punctuation">.</span>uv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> uv <span class="token operator">+</span> <span class="token function">float2</span><span class="token punctuation">(</span><span class="token number">0.0</span> <span class="token punctuation">,</span> _MainTex_TexelSize<span class="token punctuation">.</span>y <span class="token operator">*</span> <span class="token number">1.0</span><span class="token punctuation">)</span> <span class="token operator">*</span> _BlurSize<span class="token punctuation">;</span>
            o<span class="token punctuation">.</span>uv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> uv <span class="token operator">-</span> <span class="token function">float2</span><span class="token punctuation">(</span><span class="token number">0.0</span> <span class="token punctuation">,</span> _MainTex_TexelSize<span class="token punctuation">.</span>y <span class="token operator">*</span> <span class="token number">1.0</span><span class="token punctuation">)</span> <span class="token operator">*</span> _BlurSize<span class="token punctuation">;</span>                
            o<span class="token punctuation">.</span>uv<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> uv <span class="token operator">+</span> <span class="token function">float2</span><span class="token punctuation">(</span><span class="token number">0.0</span> <span class="token punctuation">,</span> _MainTex_TexelSize<span class="token punctuation">.</span>y <span class="token operator">*</span> <span class="token number">2.0</span><span class="token punctuation">)</span> <span class="token operator">*</span> _BlurSize<span class="token punctuation">;</span>
            o<span class="token punctuation">.</span>uv<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> uv <span class="token operator">-</span> <span class="token function">float2</span><span class="token punctuation">(</span><span class="token number">0.0</span> <span class="token punctuation">,</span> _MainTex_TexelSize<span class="token punctuation">.</span>y <span class="token operator">*</span> <span class="token number">2.0</span><span class="token punctuation">)</span> <span class="token operator">*</span> _BlurSize<span class="token punctuation">;</span>

            <span class="token keyword">return</span> o<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        v2f <span class="token function">vertBlurHorizontal</span><span class="token punctuation">(</span>appdata_img v<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            v2f o<span class="token punctuation">;</span>
            o<span class="token punctuation">.</span>pos <span class="token operator">=</span> <span class="token function">UnityObjectToClipPos</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>vertex<span class="token punctuation">)</span><span class="token punctuation">;</span>

            half2 uv <span class="token operator">=</span> v<span class="token punctuation">.</span>texcoord<span class="token punctuation">;</span>

            o<span class="token punctuation">.</span>uv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> uv<span class="token punctuation">;</span>
            o<span class="token punctuation">.</span>uv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> uv <span class="token operator">+</span> <span class="token function">float2</span><span class="token punctuation">(</span>_MainTex_TexelSize<span class="token punctuation">.</span>x <span class="token operator">*</span> <span class="token number">1.0</span> <span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">*</span> _BlurSize<span class="token punctuation">;</span>
            o<span class="token punctuation">.</span>uv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> uv <span class="token operator">-</span> <span class="token function">float2</span><span class="token punctuation">(</span>_MainTex_TexelSize<span class="token punctuation">.</span>x <span class="token operator">*</span> <span class="token number">1.0</span> <span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">*</span> _BlurSize<span class="token punctuation">;</span>                
            o<span class="token punctuation">.</span>uv<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> uv <span class="token operator">+</span> <span class="token function">float2</span><span class="token punctuation">(</span>_MainTex_TexelSize<span class="token punctuation">.</span>x <span class="token operator">*</span> <span class="token number">2.0</span> <span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">*</span> _BlurSize<span class="token punctuation">;</span>
            o<span class="token punctuation">.</span>uv<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> uv <span class="token operator">-</span> <span class="token function">float2</span><span class="token punctuation">(</span>_MainTex_TexelSize<span class="token punctuation">.</span>x <span class="token operator">*</span> <span class="token number">2.0</span> <span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">*</span> _BlurSize<span class="token punctuation">;</span>

            <span class="token keyword">return</span> o<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>


        fixed4 <span class="token function">fragBlur</span><span class="token punctuation">(</span>v2f i<span class="token punctuation">)</span> <span class="token operator">:</span> SV_Target
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">float</span> weight<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0.4026</span> <span class="token punctuation">,</span> <span class="token number">0.2442</span> <span class="token punctuation">,</span> <span class="token number">0.0545</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

            fixed3 sum <span class="token operator">=</span> <span class="token function">tex2D</span><span class="token punctuation">(</span>_MainTex <span class="token punctuation">,</span> i<span class="token punctuation">.</span>uv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>rgb <span class="token operator">*</span> weight<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> it <span class="token operator">=</span> <span class="token number">1</span> <span class="token punctuation">;</span> it <span class="token operator">&lt;</span> <span class="token number">3</span> <span class="token punctuation">;</span> it<span class="token operator">++</span><span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                sum <span class="token operator">+=</span> <span class="token function">tex2D</span><span class="token punctuation">(</span>_MainTex <span class="token punctuation">,</span> i<span class="token punctuation">.</span>uv<span class="token punctuation">[</span>it<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>rgb <span class="token operator">*</span> weight<span class="token punctuation">[</span>it<span class="token punctuation">]</span><span class="token punctuation">;</span>
                sum <span class="token operator">+=</span> <span class="token function">tex2D</span><span class="token punctuation">(</span>_MainTex <span class="token punctuation">,</span> i<span class="token punctuation">.</span>uv<span class="token punctuation">[</span>it<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>rgb <span class="token operator">*</span> weight<span class="token punctuation">[</span>it<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            <span class="token keyword">return</span> <span class="token function">fixed4</span><span class="token punctuation">(</span>sum <span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        ENDCG

        ZTest Always Cull Off ZWrite Off

        Pass
        <span class="token punctuation">&#123;</span>
            NAME <span class="token string">"GAUSSIAN_BLUR_VERTICAL"</span>

            CGPROGRAM
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">vertex vertBlurVertical</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">fragment fragBlur</span></span>
            ENDCG
        <span class="token punctuation">&#125;</span>
        Pass
        <span class="token punctuation">&#123;</span>
            NAME <span class="token string">"GAUSSIAN_BLUR_HORIZONTAL"</span>

            CGPROGRAM
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">vertex vertBlurHorizontal</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">fragment fragBlur</span></span>
            ENDCG
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    FallBack <span class="token string">"Diffuse"</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="/./../../../BlogImg/image-20250318130525711.png" alt="image-20250318130525711"></p>
<h2 id="Bloom效果"><a href="#Bloom效果" class="headerlink" title="Bloom效果"></a>Bloom效果</h2><p>代码</p>
<pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl"><span class="token keyword">using</span> System<span class="token punctuation">.</span>Collections<span class="token punctuation">;</span>
<span class="token keyword">using</span> System<span class="token punctuation">.</span>Collections<span class="token punctuation">.</span>Generic<span class="token punctuation">;</span>
<span class="token keyword">using</span> UnityEngine<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> Bloom <span class="token operator">:</span> PostEffectsBase
<span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> Shader bloomShader<span class="token punctuation">;</span>
    private Material bloomMaterial <span class="token operator">=</span> null<span class="token punctuation">;</span>

    <span class="token keyword">public</span> Material material
    <span class="token punctuation">&#123;</span>
        get
        <span class="token punctuation">&#123;</span>
            bloomMaterial <span class="token operator">=</span> <span class="token function">CheckShaderAndCreateMaterial</span><span class="token punctuation">(</span>bloomShader <span class="token punctuation">,</span> bloomMaterial<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> bloomMaterial<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token punctuation">[</span><span class="token function">Range</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> interation <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>

    <span class="token punctuation">[</span><span class="token function">Range</span><span class="token punctuation">(</span><span class="token number">0.2f</span> <span class="token punctuation">,</span> <span class="token number">3.0f</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token keyword">float</span> blurSpread <span class="token operator">=</span> <span class="token number">0.6f</span><span class="token punctuation">;</span>

    <span class="token punctuation">[</span><span class="token function">Range</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> downSample <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>

    <span class="token punctuation">[</span><span class="token function">Range</span><span class="token punctuation">(</span><span class="token number">0.0f</span> <span class="token punctuation">,</span> <span class="token number">4.0f</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token keyword">float</span> luminanceThreshold <span class="token operator">=</span> <span class="token number">0.6f</span><span class="token punctuation">;</span>

    <span class="token keyword">void</span> <span class="token function">OnRenderImage</span><span class="token punctuation">(</span>RenderTexture src <span class="token punctuation">,</span> RenderTexture dest<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>material <span class="token operator">!=</span> null<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            material<span class="token punctuation">.</span><span class="token function">SetFloat</span><span class="token punctuation">(</span><span class="token string">"_LuminanceThreshold"</span> <span class="token punctuation">,</span> luminanceThreshold<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">int</span> rtW <span class="token operator">=</span> src<span class="token punctuation">.</span>width <span class="token operator">/</span> downSample<span class="token punctuation">;</span>
            <span class="token keyword">int</span> rtH <span class="token operator">=</span> src<span class="token punctuation">.</span>height <span class="token operator">/</span>downSample<span class="token punctuation">;</span> 

            RenderTexture buffer0 <span class="token operator">=</span> RenderTexture<span class="token punctuation">.</span><span class="token function">GetTemporary</span><span class="token punctuation">(</span>rtW <span class="token punctuation">,</span> rtH <span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            buffer0<span class="token punctuation">.</span>filterMode <span class="token operator">=</span> FilterMode<span class="token punctuation">.</span>Bilinear<span class="token punctuation">;</span>

            Graphics<span class="token punctuation">.</span><span class="token function">Blit</span><span class="token punctuation">(</span>src <span class="token punctuation">,</span> buffer0 <span class="token punctuation">,</span> material <span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//提取亮度区域到buffer0当中</span>

            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span> i <span class="token operator">&lt;</span> interation <span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span><span class="token comment">//</span>
                material<span class="token punctuation">.</span><span class="token function">SetFloat</span><span class="token punctuation">(</span><span class="token string">"_BlurSize"</span> <span class="token punctuation">,</span> <span class="token number">1.0f</span> <span class="token operator">+</span> i <span class="token operator">*</span> blurSpread<span class="token punctuation">)</span><span class="token punctuation">;</span>

                RenderTexture buffer1 <span class="token operator">=</span> RenderTexture<span class="token punctuation">.</span><span class="token function">GetTemporary</span><span class="token punctuation">(</span>rtW <span class="token punctuation">,</span> rtH <span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">//render vertical pass</span>
                Graphics<span class="token punctuation">.</span><span class="token function">Blit</span><span class="token punctuation">(</span>buffer0 <span class="token punctuation">,</span> buffer1 <span class="token punctuation">,</span> material <span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                RenderTexture<span class="token punctuation">.</span><span class="token function">ReleaseTemporary</span><span class="token punctuation">(</span>buffer0<span class="token punctuation">)</span><span class="token punctuation">;</span>
                buffer0 <span class="token operator">=</span> buffer1<span class="token punctuation">;</span>
                buffer1 <span class="token operator">=</span> RenderTexture<span class="token punctuation">.</span><span class="token function">GetTemporary</span><span class="token punctuation">(</span>rtW <span class="token punctuation">,</span> rtH <span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">//render horizontal pass</span>
                Graphics<span class="token punctuation">.</span><span class="token function">Blit</span><span class="token punctuation">(</span>buffer0 <span class="token punctuation">,</span> buffer1 <span class="token punctuation">,</span> material <span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                RenderTexture<span class="token punctuation">.</span><span class="token function">ReleaseTemporary</span><span class="token punctuation">(</span>buffer0<span class="token punctuation">)</span><span class="token punctuation">;</span>
                buffer0 <span class="token operator">=</span> buffer1<span class="token punctuation">;</span><span class="token comment">// 模糊之后的较亮区域存储在buffer0之中。</span>
            <span class="token punctuation">&#125;</span>
            material<span class="token punctuation">.</span><span class="token function">SetTexture</span><span class="token punctuation">(</span><span class="token string">"_Bloom"</span> <span class="token punctuation">,</span> buffer0<span class="token punctuation">)</span><span class="token punctuation">;</span>
            Graphics<span class="token punctuation">.</span><span class="token function">Blit</span><span class="token punctuation">(</span>src <span class="token punctuation">,</span> dest <span class="token punctuation">,</span> material <span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//进行最后的混合</span>
            RenderTexture<span class="token punctuation">.</span><span class="token function">ReleaseTemporary</span><span class="token punctuation">(</span>buffer0<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">&#123;</span>
            Graphics<span class="token punctuation">.</span><span class="token function">Blit</span><span class="token punctuation">(</span>src <span class="token punctuation">,</span> dest<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">//基本和高斯模糊时使用的代码相同，但是进行了一些修改</span>
<span class="token comment">//Bloom效果需要三步骤：</span>
<span class="token comment">//1.提取亮度高区域，所以我们没有直接对src进行降采样</span>
<span class="token comment">//2.对提取到的亮度区域进行高斯模糊迭代处</span>
<span class="token comment">//3.进行混合处理并且输出</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>shader</p>
<pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl"><span class="token comment">// Upgrade NOTE: replaced 'mul(UNITY_MATRIX_MVP,*)' with 'UnityObjectToClipPos(*)'</span>

Shader <span class="token string">"Custom/Chapter12_4_Bloom"</span>
<span class="token punctuation">&#123;</span>
    Properties
    <span class="token punctuation">&#123;</span>
        <span class="token function">_MainTex</span> <span class="token punctuation">(</span><span class="token string">"Base (RGB)"</span> <span class="token punctuation">,</span> <span class="token number">2</span>D<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">"white"</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
        <span class="token function">_Bloom</span> <span class="token punctuation">(</span><span class="token string">"Bloom (RGB)"</span> <span class="token punctuation">,</span> <span class="token number">2</span>D<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">"black"</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
        <span class="token function">_LuminanceThreshold</span> <span class="token punctuation">(</span><span class="token string">"Luminance Threshold"</span><span class="token punctuation">,</span> Float<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0.5</span>
        <span class="token function">_BlurSize</span> <span class="token punctuation">(</span><span class="token string">"Blur Size"</span> <span class="token punctuation">,</span> Float<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1.0</span>
    <span class="token punctuation">&#125;</span>
    SubShader
    <span class="token punctuation">&#123;</span>
        CGINCLUDE
        
		<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"UnityCG.cginc"</span></span>

        <span class="token keyword">sampler2D</span> _MainTex<span class="token punctuation">;</span>
        half4 _MainTex_TexelSize<span class="token punctuation">;</span>
        <span class="token keyword">sampler2D</span> _Bloom<span class="token punctuation">;</span>
        <span class="token keyword">float</span> _LuminanceThreshold<span class="token punctuation">;</span>
        <span class="token keyword">float</span> _BlurSize<span class="token punctuation">;</span>

        <span class="token keyword">struct</span> <span class="token class-name">v2f</span>
        <span class="token punctuation">&#123;</span>
            float4 pos <span class="token operator">:</span> SV_POSITION<span class="token punctuation">;</span>
            float2 uv <span class="token operator">:</span> TEXCOORD0<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

        v2f <span class="token function">vertExtractBright</span><span class="token punctuation">(</span>appdata_img v<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            v2f o<span class="token punctuation">;</span>
            o<span class="token punctuation">.</span>pos <span class="token operator">=</span> <span class="token function">UnityObjectToClipPos</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>vertex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            o<span class="token punctuation">.</span>uv <span class="token operator">=</span> v<span class="token punctuation">.</span>texcoord<span class="token punctuation">;</span>
            <span class="token keyword">return</span> o<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">fixed</span> <span class="token function">luminance</span><span class="token punctuation">(</span>fixed4 color<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token number">0.2125</span> <span class="token operator">*</span> color<span class="token punctuation">.</span>r <span class="token operator">+</span> <span class="token number">0.7154</span> <span class="token operator">*</span> color<span class="token punctuation">.</span>g <span class="token operator">+</span> <span class="token number">0.0721</span> <span class="token operator">*</span> color<span class="token punctuation">.</span>b<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        fixed4 <span class="token function">fragExtractBright</span><span class="token punctuation">(</span>v2f i<span class="token punctuation">)</span> <span class="token operator">:</span> SV_Target
        <span class="token punctuation">&#123;</span>
            fixed4 c <span class="token operator">=</span> <span class="token function">tex2D</span><span class="token punctuation">(</span>_MainTex <span class="token punctuation">,</span> i<span class="token punctuation">.</span>uv<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">fixed</span> val <span class="token operator">=</span> <span class="token function">clamp</span><span class="token punctuation">(</span><span class="token function">luminance</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">-</span> _LuminanceThreshold <span class="token punctuation">,</span> <span class="token number">0.0</span> <span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">return</span> c <span class="token operator">*</span> val<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">struct</span> <span class="token class-name">v2fBloom</span>
        <span class="token punctuation">&#123;</span>
            float4 pos<span class="token operator">:</span> SV_POSITION<span class="token punctuation">;</span>
            half4 uv <span class="token operator">:</span> TEXCOORD0<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

        v2fBloom <span class="token function">vertBloom</span><span class="token punctuation">(</span>appdata_img v<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            v2fBloom o<span class="token punctuation">;</span>
            o<span class="token punctuation">.</span>pos <span class="token operator">=</span> <span class="token function">UnityObjectToClipPos</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>vertex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            o<span class="token punctuation">.</span>uv<span class="token punctuation">.</span>xy <span class="token operator">=</span> v<span class="token punctuation">.</span>texcoord<span class="token punctuation">;</span>
            o<span class="token punctuation">.</span>uv<span class="token punctuation">.</span>zw <span class="token operator">=</span> v<span class="token punctuation">.</span>texcoord<span class="token punctuation">;</span>
            <span class="token comment">//xy为_MainTex的uv，zw为_Bloom的uv</span>

            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">UNITY_UV_STARTS_AT_TOP</span></span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>_MainTex_TexelSize<span class="token punctuation">.</span>y <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                o<span class="token punctuation">.</span>uv<span class="token punctuation">.</span>w <span class="token operator">=</span> <span class="token number">1.0</span> <span class="token operator">-</span> o<span class="token punctuation">.</span>uv<span class="token punctuation">.</span>w<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

            <span class="token keyword">return</span> o<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        fixed4 <span class="token function">fragBloom</span><span class="token punctuation">(</span>v2fBloom i<span class="token punctuation">)</span> <span class="token operator">:</span> SV_Target
        <span class="token punctuation">&#123;</span>   
            <span class="token keyword">return</span> <span class="token function">tex2D</span><span class="token punctuation">(</span>_MainTex <span class="token punctuation">,</span> i<span class="token punctuation">.</span>uv<span class="token punctuation">.</span>xy<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">tex2D</span><span class="token punctuation">(</span>_Bloom <span class="token punctuation">,</span> i<span class="token punctuation">.</span>uv<span class="token punctuation">.</span>zw<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        ENDCG

        ZTest Always Cull Off ZWrite Off
        Pass
        <span class="token punctuation">&#123;</span>
            CGPROGRAM
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">vertex vertExtractBright</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">fragment fragExtractBright</span></span>
            ENDCG
        <span class="token punctuation">&#125;</span>
        
		UsePass <span class="token string">"Custom/Chapter12_3_Gaussius/GAUSSIAN_BLUR_VERTICAL"</span>
		
		UsePass <span class="token string">"Custom/Chapter12_3_Gaussius/GAUSSIAN_BLUR_HORIZONTAL"</span>

        Pass
        <span class="token punctuation">&#123;</span>
            CGPROGRAM
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">vertex vertBloom</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">fragment fragBloom</span></span>
            ENDCG
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    FallBack Off
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p><img src="/./../../../BlogImg/image-20250318164617110.png" alt="image-20250318164617110"></p>
<h2 id="运动模糊"><a href="#运动模糊" class="headerlink" title="运动模糊"></a>运动模糊</h2><p>赛车游戏效果常用</p>
<p>累计缓存技术内存开销过大</p>
<p>速度缓存技术性能更好</p>
<p><img src="/./../../../BlogImg/image-20250318172909989.png" alt="image-20250318172909989"></p>
<p><img src="/./../../../BlogImg/image-20250318175425952.png" alt="image-20250318175425952"></p>
<p>代码</p>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Collections</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Collections<span class="token punctuation">.</span>Generic</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">UnityEngine</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MotionBlur</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">PostEffectsBase</span></span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token class-name">Shader</span> motionBlurShader<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Material</span> motionBlurMaterial <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token return-type class-name">Material</span> material
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">get</span>
        <span class="token punctuation">&#123;</span>
            motionBlurMaterial <span class="token operator">=</span> <span class="token function">CheckShaderAndCreateMaterial</span><span class="token punctuation">(</span>motionBlurShader <span class="token punctuation">,</span> motionBlurMaterial<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> motionBlurMaterial<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Range</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token number">0.0f</span> <span class="token punctuation">,</span> <span class="token number">0.9f</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token class-name"><span class="token keyword">float</span></span> blurAmount <span class="token operator">=</span> <span class="token number">0.5f</span><span class="token punctuation">;</span>
    <span class="token comment">//blurAmount的值越大，运动拖尾的效果就越明显，为了防止拖尾效果完全替代当前帧的渲染结果，我们把它的值截取在0.0到0.9之间</span>

    <span class="token keyword">private</span> <span class="token class-name">RenderTexture</span> accumulationTexture<span class="token punctuation">;</span><span class="token comment">//保存之前图像叠加的结果</span>

    <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnDisable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//在脚本不运行的时候，调用这个函数，让下一次开始应用运动模糊的时候重新开始叠加图像。</span>
    <span class="token punctuation">&#123;</span>
        <span class="token function">DestroyImmediate</span><span class="token punctuation">(</span>accumulationTexture<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnRenderImage</span><span class="token punctuation">(</span><span class="token class-name">RenderTexture</span> src<span class="token punctuation">,</span> <span class="token class-name">RenderTexture</span> dest<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>material <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>   
            <span class="token comment">//创建叠加图像的RenderTexture</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>accumulationTexture <span class="token operator">==</span> <span class="token keyword">null</span>
                <span class="token operator">||</span> accumulationTexture<span class="token punctuation">.</span>width <span class="token operator">!=</span> src<span class="token punctuation">.</span>width
                <span class="token operator">||</span> accumulationTexture<span class="token punctuation">.</span>height <span class="token operator">!=</span> src<span class="token punctuation">.</span>height<span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                <span class="token function">DestroyImmediate</span><span class="token punctuation">(</span>accumulationTexture<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//如果之前的RenderTexture已经存在，销毁它</span>
                accumulationTexture <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">RenderTexture</span><span class="token punctuation">(</span>src<span class="token punctuation">.</span>width <span class="token punctuation">,</span> src<span class="token punctuation">.</span>height <span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//创建一个和屏幕分辨率相匹配的RenderTexture，第三个参数的0表示RenderTexture的深度</span>
                accumulationTexture<span class="token punctuation">.</span>hideFlags <span class="token operator">=</span> HideFlags<span class="token punctuation">.</span>HideAndDontSave<span class="token punctuation">;</span>
                <span class="token comment">//这个变量不会显示在Hierarchy窗口当中，也不会保存到场景当中。</span>
                Graphics<span class="token punctuation">.</span><span class="token function">Blit</span><span class="token punctuation">(</span>src <span class="token punctuation">,</span> accumulationTexture<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//使用当前帧的图像作为第一个输入，将它叠加到accumulationTexture中</span>
            <span class="token punctuation">&#125;</span>

            accumulationTexture<span class="token punctuation">.</span><span class="token function">MarkRestoreExpected</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//标记要恢复的RenderTexture</span>
            <span class="token comment">//已经被弃用</span>

            material<span class="token punctuation">.</span><span class="token function">SetFloat</span><span class="token punctuation">(</span><span class="token string">"_BlurAmount"</span> <span class="token punctuation">,</span> <span class="token number">1.0f</span> <span class="token operator">-</span> blurAmount<span class="token punctuation">)</span><span class="token punctuation">;</span>
            Graphics<span class="token punctuation">.</span><span class="token function">Blit</span><span class="token punctuation">(</span>src <span class="token punctuation">,</span> accumulationTexture <span class="token punctuation">,</span> material<span class="token punctuation">)</span><span class="token punctuation">;</span>
            Graphics<span class="token punctuation">.</span><span class="token function">Blit</span><span class="token punctuation">(</span>accumulationTexture <span class="token punctuation">,</span> dest<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">&#123;</span>
            Graphics<span class="token punctuation">.</span><span class="token function">Blit</span><span class="token punctuation">(</span>src <span class="token punctuation">,</span> dest<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>shader</p>
<pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl">Shader <span class="token string">"Custom/Chapter12_5_MotionBlur"</span>
<span class="token punctuation">&#123;</span>
    Properties
    <span class="token punctuation">&#123;</span>
        <span class="token function">_MainTex</span> <span class="token punctuation">(</span><span class="token string">"Texture"</span><span class="token punctuation">,</span> <span class="token number">2</span>D<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">"white"</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
        <span class="token function">_BlurAmount</span> <span class="token punctuation">(</span><span class="token string">"Blur Amount"</span><span class="token punctuation">,</span> Float<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1.0</span>
    <span class="token punctuation">&#125;</span>
    SubShader
    <span class="token punctuation">&#123;</span>
        CGINCLUDE
        
        <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"UnityCG.cginc"</span></span>

        <span class="token keyword">sampler2D</span> _MainTex<span class="token punctuation">;</span>
        float4 _MainTex_TexelSize<span class="token punctuation">;</span>
        <span class="token keyword">float</span> _BlurAmount<span class="token punctuation">;</span>

        <span class="token keyword">struct</span> <span class="token class-name">v2f</span>
        <span class="token punctuation">&#123;</span>
            float4 pos <span class="token operator">:</span> SV_POSITION<span class="token punctuation">;</span>
            float2 uv <span class="token operator">:</span> TEXCOORD0<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

        v2f <span class="token function">vert</span><span class="token punctuation">(</span>appdata_img v<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            v2f o<span class="token punctuation">;</span>
            o<span class="token punctuation">.</span>pos <span class="token operator">=</span> <span class="token function">UnityObjectToClipPos</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>vertex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            o<span class="token punctuation">.</span>uv <span class="token operator">=</span> v<span class="token punctuation">.</span>texcoord<span class="token punctuation">;</span>
            <span class="token keyword">return</span> o<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        
        fixed4 <span class="token function">fragRGB</span> <span class="token punctuation">(</span>v2f i<span class="token punctuation">)</span> <span class="token operator">:</span> SV_Target<span class="token comment">//用于更新纹理的RGB通道部分</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token function">fixed4</span><span class="token punctuation">(</span><span class="token function">tex2D</span><span class="token punctuation">(</span>_MainTex <span class="token punctuation">,</span> i<span class="token punctuation">.</span>uv<span class="token punctuation">)</span><span class="token punctuation">.</span>rgb<span class="token punctuation">,</span> _BlurAmount<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        half4 <span class="token function">fragA</span> <span class="token punctuation">(</span>v2f i<span class="token punctuation">)</span> <span class="token operator">:</span> SV_Target<span class="token comment">//用于更新渲染纹理的A通道部分</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token function">tex2D</span><span class="token punctuation">(</span>_MainTex<span class="token punctuation">,</span> i<span class="token punctuation">.</span>uv<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">//RGB通道版本的Shader对当前图形进行采样，并且将其A通道的值设置成了_BlurAmount，</span>
        <span class="token comment">//以便在后面混合的时候可用使用它的透明通道进行混合。</span>
        <span class="token comment">//A通道版本的代码直接返回采样结果，实际上这个版本只是为了维护渲染纹理的透明通道值</span>
        <span class="token comment">//不让其受到混合时使用的透明度值的影响</span>


        ENDCG

        ZTest Always Cull Off ZWrite Off
        Pass
        <span class="token punctuation">&#123;</span><span class="token comment">//用于更新渲染纹理的RGB通道部分</span>
            Blend SrcAlpha OneMinusSrcAlpha
            ColorMask RGB

            CGPROGRAM
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">vertex vert</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">fragment fragRGB</span></span>
            ENDCG
        <span class="token punctuation">&#125;</span>
        Pass<span class="token comment">//用于更新渲染纹理的A通道部分</span>
        <span class="token punctuation">&#123;</span>
            Blend One Zero<span class="token comment">//相当于关闭混合</span>
            ColorMask A

            CGPROGRAM
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">vertex vert</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">fragment fragA</span></span>
            ENDCG
        <span class="token punctuation">&#125;</span>
        
        <span class="token comment">//我们不希望在更新RGB通道时候，将A通道的值也更新，所以我们只需要在混合的时候使用A通道的透明度值即可。</span>
    <span class="token punctuation">&#125;</span>
    FallBack Off
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p><img src="/./../../../BlogImg/image-20250318175854416.png" alt="image-20250318175854416"></p>
<h1 id="使用深度和法线纹理"><a href="#使用深度和法线纹理" class="headerlink" title="使用深度和法线纹理"></a>使用深度和法线纹理</h1><p>如果想让物体能够出现在深度和法线纹理当中，就必须在Shader当中设置正确的RenderType标签</p>
<p>深度纹理实际上就是一张渲染纹理，只不过它里面存储的像素值不是颜色值，而是一个高精度的深度值。由于被存储在一张纹理中，深度纹理里的深度值范围是[0 , 1] ，而且通常是非线性分布的。</p>
<p>这些深度值来自顶点变换后得到的归一化的设备坐标（Normalized Device Coordinates，NDC）一个模型要想最终被绘制在屏幕上需要把它的顶点从模型空间变换到齐次裁剪坐标系下，这是通过在定点着色器中乘上MVP变换矩阵得到的。</p>
<p>在变换的最后一步我使用一个投影矩阵来变换顶点。当我们使用的是透视类型的摄像机时，这个投影举证就是非线性的。</p>
<p>DirectX使用的NDC变换后的z分量通常在 0,1之间</p>
<p><img src="/./../../../BlogImg/image-20250318200132127.png" alt="image-20250318200132127"></p>
<p><img src="/./../../../BlogImg/image-20250318200151104.png" alt="image-20250318200151104"></p>
<p>得到NDC之后，深度纹理中的像素值就可以很方便的计算得到，这些深度值就对应了NDC当中顶点坐标分量的值，由于NDC中z分量在-1到1，为了让这些值能够被存储在一张图像当中，我们需要使用公式进行映射</p>
<p><img src="/./../../../BlogImg/image-20250318200349081.png" alt="image-20250318200349081"></p>
<p>其中d对应了深度纹理中的像素值，zndc对应了NDC坐标中z分量的值</p>
<p>Unity当中深度纹理可以直接来自真正的深度缓存，也可以由一个单独的Pass渲染而成，这取决于使用的渲染路径和硬件，一般来说，当使用延迟渲染路径（包括遗留的延迟渲染路径）时，深度纹理理所当然可以访问到，因为延迟渲染会把这些信息渲染到G-Buffer当中。而当无法直接获取到深度缓存的时候，深度和法线纹理时通过一个单独的Pass得到的。</p>
<p>具体实现是Unity的着色器替换技术，选择那些渲染类型为Opaque的物体，判断它们使用的渲染队列是否小于等于2500（大于的一般属于透明物体），如果满足条件就把它加入到渲染队列当中。因此，要想让物体能够出现在深度和法线纹理当中，就必须在Shader中设置正确的RenderType标签</p>
<p>在Unity当中，我们可以选择让一个摄像机生成一张深度纹理或者是一张深度+法线纹理。</p>
<p>当选择是前者时候，即只需要一张单独的深度纹理的时候，Unity就会直接获取深度缓存或者是按之前讲到的着色器替换技术，选取需要的不透明物体，并且使用它投射投影时使用的Pass（即LightMode被设置成ShadowCaster的Pass），来得到深度纹理。</p>
<p>如果Shader中不包含这样一个Pass，那么这个物体就不会出现在深度纹理当中（当然，它也不能向其它物体投射投影）。深度纹理的精度通常是24位或者16位，这取决于使用的深度缓存的精度，如果选择生成一张深度+法线纹理，Unity就会创建一张和屏幕分辨率相同，精度为32位（每个通道为8位）的纹理</p>
<p>其中观察空间下的法线信息会被编码到纹理的R、G通道，而深度信息在B、A通道。法线信息的获取在延迟渲染当中是非常容易就能得到的，Unity只需要合并深度和法线缓存即可，而在前向渲染当中，默认情况下是不会创建法线缓存的，因此Unity底层使用了一个单独的Pass把整个场景再次渲染一次再来完成。</p>
<p><img src="/./../../../BlogImg/image-20250318201751843.png" alt="image-20250318201751843"></p>
<p>Unity如果想要获取深度纹理：</p>
<p>通过一下的代码来从摄像机当中获取深度纹理</p>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp">camera<span class="token punctuation">.</span>depthTextureMode <span class="token operator">=</span> DepthTextureMode<span class="token punctuation">.</span>Depth<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>设置了之后，我们就可以在Shader当中通过声明_CameraDepthTexture变量来访问它。</p>
<p>如果我们需要获得深度+法线纹理，需要在代码当中这样设置</p>
<pre class="line-numbers language-none"><code class="language-none">camera.depthTextureMode |&#x3D; DepthTextureMode.Depth;
camera.depthTextureMode |&#x3D; DepthTextureMode.DepthNormals;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>在Unity5当中，我们还可以再摄像机的Camera组件上看到当前摄像机是否需要渲染深度或者深度+法线纹理。</p>
<p>当shader中访问到了深度纹理_CameraDepthTexture之后，我们就可以使用当前像素的坐标纹理对它进行采样。绝大多数情况下，我们直接使用tex2D函数采样即可，但是在某些平台上我们需要一些特殊处理。</p>
<p>Unity为我们提供了一个统一个宏SAMPLE_DEPTH_TEXTURE，用来处理这些由于平台差异造成的问题。而我们只需要在Shader当中使用SAMPLE_DEPTH_TEXTURE宏对深度纹理进行采样。</p>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token class-name"><span class="token keyword">float</span></span> d <span class="token operator">=</span> <span class="token function">SAMPLE_DEPTH_TEXTURE</span><span class="token punctuation">(</span>_CameraDepthTexture <span class="token punctuation">,</span> i<span class="token punctuation">.</span>uv<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>其中i.uv是一个float2类型的变量，对应了当前像素的纹理坐标。类似的宏还有<br>SAMPLE_DEPTH_TEXUTRE_PROJ、SAMPLE_DEPTH_TEXTURE_LOD。</p>
<p>SAMPLE_DEPTH_TEXTURE_PROJ宏同样接受两个参数——深度纹理和一个float3或者float4类型的纹理坐标，它的内部使用了tex2Dproj这样的函数进行投影纹理采样，纹理坐标的前两个分量首先会除以最后一个分量，在进行纹理采样。如果提供了第四个分量，还会进行一次比较，通常用于阴影的实现当中。</p>
<p>SAMPLE_DEPTH_TEXTURE_PROJ的第二个参数通常是由顶点着色器输出插值而得的屏幕坐标</p>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token class-name"><span class="token keyword">float</span></span> d <span class="token operator">=</span> <span class="token function">SAMPLE_DEPTH_TEXTURE_PROJ</span><span class="token punctuation">(</span>_CameraDepthTexture <span class="token punctuation">,</span> <span class="token function">UNITY_PROJ_COORD</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>scrPos<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>其中i.scrPos是在顶点着色器中通过调用ComputeScreenPos得到的屏幕坐标。上诉这些宏的定义，读者可以在Unity内置的HLSLSupport.cginc文件当中找到。</p>
<p>当通过纹理采样得到深度值后，这些深度值往往是非线性的，这种非线性来自于透视投影使用的裁剪矩阵。然而，在我们的计算过程当中通常是需要线性的深度值，也就是说，我们需要把投影后的深度值变换到线性空间下，例如视角空间下的深度值。</p>
<p><img src="/./../../../BlogImg/image-20250318211224070.png" alt="image-20250318211224070"></p>
<p>Unity提供了两个辅助函数来为我们进行上述的计算过程——LinearEyeDepth和Linear01Depth，LinearEyeDepth负责把深度纹理的采样结果转换到视角空间下的深度值，也就是上面的结果值z01，Linear01Depth会返回一个范围在[0 , 1]的线性深度值。两个函数都使用了内置的_ZBufferParams变量来得到远近裁剪平面的距离。</p>
<p>如果我们需要获取深度+法线纹理，可以直接使用tex2D函数来对_CameraDepthNormalsTexture进行采样，得到里面存储的深度和法线信息。Unity提供了辅助函数来为我们对这个采样结果进行解码，从而得到深度值和法线方向。这个函数是DecodeDepthNormal，它在UnityCG.cginc里面被定义：</p>
<p><img src="/./../../../BlogImg/image-20250318211848525.png" alt="image-20250318211848525"></p>
<p>DecodeDepthNormal的第一个参数是对深度+法线纹理的采样结果，这个采样结果是Unity对深度和法线信息编码之后的结果，它的xy分量存储的是视角空间下的法线信息，而深度信息被编码进来zw分量。通过调用DecodeDepthNormal函数对采样结果解码之后，我们就可以得到解码后的深度值和法线。这个深度值是范围在[0 , 1]的线性深度值（这与单独的深度纹理中存储的深度值不同），而得到的法线则是视角空间下的法线方向。</p>
<p><strong>使用帧调试器查看深度和法线纹理</strong><br><img src="/./../../../BlogImg/image-20250318212501604.png" alt="image-20250318212501604"></p>
<p>在片元着色器当中输出转换或者解码后的深度和法线值</p>
<pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl"><span class="token keyword">float</span> depth <span class="token operator">=</span> <span class="token function">SAMPLE_DEPTH_TEXTURE</span><span class="token punctuation">(</span>_CameraDepthTexture <span class="token punctuation">,</span> i<span class="token punctuation">.</span>uv<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">float</span> linearDepth <span class="token operator">=</span> <span class="token function">Linear01Depth</span><span class="token punctuation">(</span>depth<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> <span class="token function">fixed4</span><span class="token punctuation">(</span>linearDepth <span class="token punctuation">,</span> linearDepth <span class="token punctuation">,</span> linearDepth <span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>或者是输出法线方向</p>
<pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl">fixed3 normal <span class="token operator">=</span> <span class="token function">DecodeViewNormalStereo</span><span class="token punctuation">(</span><span class="token function">tex2D</span><span class="token punctuation">(</span>_CameraDepthNormalsTexture <span class="token punctuation">,</span> i<span class="token punctuation">.</span>uv<span class="token punctuation">)</span><span class="token punctuation">.</span>xy<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> <span class="token function">fixed4</span><span class="token punctuation">(</span>normal <span class="token operator">*</span> <span class="token number">0.5</span> <span class="token operator">+</span> <span class="token number">0.5</span> <span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>如果输出的深度纹理时全黑（封闭区域）或者全白（开放区域），注意把摄像机远裁剪面的距离（Unity默认为1000）调小。</p>
<p>使得视椎体的范围刚刚好覆盖场景所在的区域</p>
<p><img src="/./../../../BlogImg/image-20250318213106169.png" alt="image-20250318213106169"></p>
<h2 id="运动模糊2"><a href="#运动模糊2" class="headerlink" title="运动模糊2"></a>运动模糊2</h2><p>速度缓冲：<br>1 把场景中所有物体的速度都渲染到一个纹理当中，缺点在于要给场景中所有物体的Shader添加计算速度的代码并且输出到一个渲染纹理当中。</p>
<p>2通过深度纹理在片元着色器中为每个像素计算器在世界空间下的位置，通过对当前帧和上一帧进行矩阵变换，缺点是两次乘法对性能有所影响</p>
<pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl"><span class="token keyword">using</span> System<span class="token punctuation">.</span>Collections<span class="token punctuation">;</span>
<span class="token keyword">using</span> System<span class="token punctuation">.</span>Collections<span class="token punctuation">.</span>Generic<span class="token punctuation">;</span>
<span class="token keyword">using</span> UnityEngine<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> MotionBlurWithDepthTexture <span class="token operator">:</span> PostEffectsBase
<span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> Shader motionBlurShader<span class="token punctuation">;</span>
    private Material motionBlurMaterial<span class="token punctuation">;</span>

    <span class="token keyword">public</span> Material material
    <span class="token punctuation">&#123;</span>
        get
        <span class="token punctuation">&#123;</span>
            motionBlurMaterial <span class="token operator">=</span> <span class="token function">CheckShaderAndCreateMaterial</span><span class="token punctuation">(</span>motionBlurShader <span class="token punctuation">,</span> motionBlurMaterial<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> motionBlurMaterial<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token punctuation">[</span><span class="token function">Range</span><span class="token punctuation">(</span><span class="token number">0.0f</span> <span class="token punctuation">,</span> <span class="token number">1.0f</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token keyword">float</span> blurSize <span class="token operator">=</span> <span class="token number">0.5f</span><span class="token punctuation">;</span><span class="token comment">//运动模糊的时候图像使用的大小</span>

    private Camera myCamera<span class="token punctuation">;</span>
    <span class="token keyword">public</span> Camera MyCamera
    <span class="token punctuation">&#123;</span>
        get
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>myCamera <span class="token operator">==</span> null<span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                myCamera <span class="token operator">=</span> GetComponent<span class="token operator">&lt;</span>Camera<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">return</span> myCamera<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    private Matrix4x4 previousViewProjectionMatrix<span class="token punctuation">;</span><span class="token comment">//定义一个变量来保存上一帧摄像机的视角投影矩阵</span>

    <span class="token keyword">void</span> <span class="token function">OnEnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
         MyCamera<span class="token punctuation">.</span>depthTextureMode <span class="token operator">|=</span> DepthTextureMode<span class="token punctuation">.</span>Depth<span class="token punctuation">;</span> <span class="token comment">//添加新的深度纹理模式而不影响其他已经启用的模式</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">void</span> <span class="token function">OnRenderImage</span><span class="token punctuation">(</span>RenderTexture src <span class="token punctuation">,</span> RenderTexture dest<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>material <span class="token operator">!=</span> null<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            material<span class="token punctuation">.</span><span class="token function">SetFloat</span><span class="token punctuation">(</span><span class="token string">"_BlurSize"</span> <span class="token punctuation">,</span> blurSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
            material<span class="token punctuation">.</span><span class="token function">SetMatrix</span><span class="token punctuation">(</span><span class="token string">"_PreviousViewProjectionMatrix"</span> <span class="token punctuation">,</span> previousViewProjectionMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//前一帧视角的投影矩阵</span>
            Matrix4x4 currentViewProjectionMatrix <span class="token operator">=</span>  MyCamera<span class="token punctuation">.</span>projectionMatrix <span class="token operator">*</span>  MyCamera<span class="token punctuation">.</span>worldToCameraMatrix<span class="token punctuation">;</span>
            Matrix4x4 currentViewProjectionInverseMatrix <span class="token operator">=</span> currentViewProjectionMatrix<span class="token punctuation">.</span>inverse<span class="token punctuation">;</span><span class="token comment">//当前帧视角的投影矩阵的逆矩阵</span>
            
            material<span class="token punctuation">.</span><span class="token function">SetMatrix</span><span class="token punctuation">(</span><span class="token string">"_CurrentViewProjectionInverseMatrix"</span> <span class="token punctuation">,</span> currentViewProjectionInverseMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>

            previousViewProjectionMatrix <span class="token operator">=</span> currentViewProjectionMatrix<span class="token punctuation">;</span>
            <span class="token comment">//将当前帧从世界坐标系转换到裁剪坐标系的视角投影矩阵保存为上一帧的视角投影矩阵</span>

            Graphics<span class="token punctuation">.</span><span class="token function">Blit</span><span class="token punctuation">(</span>src <span class="token punctuation">,</span> dest <span class="token punctuation">,</span> material<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">&#123;</span>
            Graphics<span class="token punctuation">.</span><span class="token function">Blit</span><span class="token punctuation">(</span>src <span class="token punctuation">,</span> dest<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl"><span class="token comment">// Upgrade NOTE: replaced 'mul(UNITY_MATRIX_MVP,*)' with 'UnityObjectToClipPos(*)'</span>

Shader <span class="token string">"Custom/Chapter13_1_MotionBlurWithDepthTexture"</span>
<span class="token punctuation">&#123;</span>
    Properties
    <span class="token punctuation">&#123;</span>
        <span class="token function">_MainTex</span><span class="token punctuation">(</span><span class="token string">"Base (RGB)"</span> <span class="token punctuation">,</span> <span class="token number">2</span>D<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">"white"</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
        <span class="token function">_BlurSize</span><span class="token punctuation">(</span><span class="token string">"Blur Size"</span> <span class="token punctuation">,</span> Float<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1.0</span>
    <span class="token punctuation">&#125;</span>
    SubShader
    <span class="token punctuation">&#123;</span>
        CGINCLUDE

        <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"UnityCG.cginc"</span></span>
        <span class="token keyword">sampler2D</span> _MainTex<span class="token punctuation">;</span><span class="token comment">//这个纹理即为屏幕，在脚本上的OnRenderImage由src传入</span>
        float4 _MainTex_TexelSize<span class="token punctuation">;</span>

        <span class="token comment">//Unity传递给我们的深度纹理</span>
        <span class="token keyword">sampler2D</span> _CameraDepthTexture<span class="token punctuation">;</span>

        <span class="token comment">//脚本传递来的矩阵</span>
        float4x4 _CurrentViewProjectionInverseMatrix<span class="token punctuation">;</span>
        float4x4 _PreviousViewProjectionMatrix<span class="token punctuation">;</span>

        <span class="token keyword">half</span> _BlurSize<span class="token punctuation">;</span>

        <span class="token keyword">struct</span> <span class="token class-name">v2f</span>
        <span class="token punctuation">&#123;</span>
            float4 pos <span class="token operator">:</span> SV_POSITION<span class="token punctuation">;</span>
            half2 uv <span class="token operator">:</span> TEXCOORD0<span class="token punctuation">;</span>
            half2 uv_depth <span class="token operator">:</span> TEXCOORD1<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

        v2f <span class="token function">vert</span><span class="token punctuation">(</span>appdata_img v<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            v2f o<span class="token punctuation">;</span>
            o<span class="token punctuation">.</span>pos <span class="token operator">=</span> <span class="token function">UnityObjectToClipPos</span><span class="token punctuation">(</span> v<span class="token punctuation">.</span>vertex<span class="token punctuation">)</span><span class="token punctuation">;</span>

            o<span class="token punctuation">.</span>uv <span class="token operator">=</span> v<span class="token punctuation">.</span>texcoord<span class="token punctuation">;</span>
            o<span class="token punctuation">.</span>uv_depth <span class="token operator">=</span> v<span class="token punctuation">.</span>texcoord<span class="token punctuation">;</span>

            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">UNITY_UV_START_AT_TOP</span></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>_MainTex_TexelSize<span class="token punctuation">.</span>y <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                o<span class="token punctuation">.</span>uv_depth<span class="token punctuation">.</span>y <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">-</span> o<span class="token punctuation">.</span>uv_depth<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

            <span class="token keyword">return</span> o<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">//由于在本例中，我们需要处理多张渲染纹理，因此在DirectX这样的平台</span>
        <span class="token comment">//我们需要处理平台差异导致的图像翻转问题，在上面的代码当中</span>
        <span class="token comment">//我们对深度纹理的采样坐标进行了差异化处理</span>
        <span class="token comment">//以便在DirectX平台上，在开启了抗锯齿的情况下仍然可以得到正确的结果</span>

        fixed4 <span class="token function">frag</span><span class="token punctuation">(</span>v2f i<span class="token punctuation">)</span> <span class="token operator">:</span> SV_Target
        <span class="token punctuation">&#123;</span>
            <span class="token comment">//从摄像机的深度纹理中采样深度值</span>
            <span class="token keyword">float</span> d <span class="token operator">=</span> <span class="token function">SAMPLE_DEPTH_TEXTURE</span><span class="token punctuation">(</span>_CameraDepthTexture <span class="token punctuation">,</span> i<span class="token punctuation">.</span>uv_depth<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//（0,1）的uv坐标和深度值转换成（-1,1）的uv坐标和深度值对应NDC</span>
            float4 H <span class="token operator">=</span> <span class="token function">float4</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>uv<span class="token punctuation">.</span>x <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">-</span> <span class="token number">1</span> <span class="token punctuation">,</span> i<span class="token punctuation">.</span>uv<span class="token punctuation">.</span>y <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">-</span> <span class="token number">1</span> <span class="token punctuation">,</span> d <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">-</span> <span class="token number">1</span> <span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//把屏幕空间上取样的坐标转换为世界空间的坐标</span>
            float4 D <span class="token operator">=</span> <span class="token function">mul</span><span class="token punctuation">(</span>_CurrentViewProjectionInverseMatrix <span class="token punctuation">,</span> H<span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token comment">//NDC坐标由于透视除法，w值为1，但是后面变成裁剪空间会乘上w，尤其是在之后的逆变换中，w值会发生偏移，因此需要除以w</span>
            float4 worldPos <span class="token operator">=</span> D <span class="token operator">/</span> D<span class="token punctuation">.</span>w<span class="token punctuation">;</span>

            <span class="token comment">//将NDC赋值给当前帧</span>
            float4 currentPos <span class="token operator">=</span> H<span class="token punctuation">;</span>

            <span class="token comment">//上一帧，把它从世界坐标弄到屏幕里面去</span>
            float4 previousPos <span class="token operator">=</span> <span class="token function">mul</span><span class="token punctuation">(</span>_PreviousViewProjectionMatrix <span class="token punctuation">,</span> worldPos<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//要除w分量，进行透视除法，变到NDC空间</span>
            previousPos <span class="token operator">/=</span> previousPos<span class="token punctuation">.</span>w<span class="token punctuation">;</span>

            float2 velocity <span class="token operator">=</span> <span class="token punctuation">(</span>currentPos<span class="token punctuation">.</span>xy <span class="token operator">-</span> previousPos<span class="token punctuation">.</span>xy<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2.0f</span><span class="token punctuation">;</span><span class="token comment">//计算两者在屏幕上的偏移量，作为速度</span>

            float2 uv <span class="token operator">=</span> i<span class="token punctuation">.</span>uv<span class="token punctuation">;</span><span class="token comment">//得到屏幕上的坐标</span>
            float4 c <span class="token operator">=</span> <span class="token function">tex2D</span><span class="token punctuation">(</span>_MainTex <span class="token punctuation">,</span> uv<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//采样屏幕</span>

            uv <span class="token operator">+=</span> velocity <span class="token operator">*</span> _BlurSize<span class="token punctuation">;</span><span class="token comment">//将uv坐标偏移一段距离，模拟运动模糊</span>
            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> it <span class="token operator">=</span> <span class="token number">1</span> <span class="token punctuation">;</span> it <span class="token operator">&lt;</span> <span class="token number">3</span> <span class="token punctuation">;</span> it<span class="token operator">++</span> <span class="token punctuation">,</span> uv <span class="token operator">+=</span> velocity <span class="token operator">*</span> _BlurSize<span class="token punctuation">)</span><span class="token comment">//迭代1+2次，模拟运动模糊</span>
            <span class="token punctuation">&#123;</span>
                float4 currentColor <span class="token operator">=</span> <span class="token function">tex2D</span><span class="token punctuation">(</span>_MainTex <span class="token punctuation">,</span> uv<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获得偏移后uv上的颜色</span>
                c <span class="token operator">+=</span> currentColor<span class="token punctuation">;</span><span class="token comment">//将这一帧颜色加上原屏幕上</span>
            <span class="token punctuation">&#125;</span>
            c <span class="token operator">/=</span> <span class="token number">3.0f</span><span class="token punctuation">;</span><span class="token comment">//平均一下，防止过重</span>

            <span class="token keyword">return</span> <span class="token function">fixed4</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>rgb <span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        
        ENDCG

        Pass
        <span class="token punctuation">&#123;</span>
            ZTest Always Cull Off ZWrite Off
            CGPROGRAM
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">vertex vert</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">fragment frag</span></span>
            ENDCG
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    FallBack Off
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>效果</p>
<p><img src="/./../../../BlogImg/image-20250318232225655.png" alt="image-20250318232225655"></p>
<h2 id="全局雾效"><a href="#全局雾效" class="headerlink" title="全局雾效"></a>全局雾效</h2><p>Unity内置的雾效可以产生基于距离的线性或者指数雾效。</p>
<p>要在自己编写的顶点片元着色器中实现雾效，要添加#pragma multi_compile_fog<br>以及相关的内置宏UNITY_FOG_COORDS，UNITY_TRANSFER_FOG、UNITY_APPLY_FOG等</p>
<p>需要为场景中所有物体添加这个代码，而且实现的效果非常有限。</p>
<p>基于屏幕后处理的全局雾效</p>
<p><strong>关键</strong></p>
<p>根据深度纹理来重建每个像素在世界空间下的位置<br>相比使用构建NDC的方法性能更好</p>
<p>首先对图像空间下的视椎体射线进行插值，这条射线存储了该像素在世界空间下到摄像机的方向信息。</p>
<p>然后我们把这个射线和线性化后的视角空间下的深度值相乘，再加上摄像机的位置，就可以得到像素在世界空间下的位置，这个时候可以使用各种公式模拟全局雾效</p>
<p>重建世界坐标</p>
<p><img src="/./../../../BlogImg/image-20250319121025175.png" alt="image-20250319121025175"></p>
<p>代码</p>
<pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl"><span class="token keyword">using</span> System<span class="token punctuation">.</span>Collections<span class="token punctuation">;</span>
<span class="token keyword">using</span> System<span class="token punctuation">.</span>Collections<span class="token punctuation">.</span>Generic<span class="token punctuation">;</span>
<span class="token keyword">using</span> UnityEngine<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> FogWithDepthTexture <span class="token operator">:</span> PostEffectsBase
<span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> Shader fogShader<span class="token punctuation">;</span>
    private Material fogMaterial<span class="token punctuation">;</span>

    <span class="token keyword">public</span> Material material
    <span class="token punctuation">&#123;</span>
        get
        <span class="token punctuation">&#123;</span>
            fogMaterial <span class="token operator">=</span> <span class="token function">CheckShaderAndCreateMaterial</span><span class="token punctuation">(</span>fogShader <span class="token punctuation">,</span> fogMaterial<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> fogMaterial<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    private Camera myCamera<span class="token punctuation">;</span>
    <span class="token keyword">public</span> Camera MyCamera
    <span class="token punctuation">&#123;</span>
        get
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>myCamera <span class="token operator">==</span> null<span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                myCamera <span class="token operator">=</span> GetComponent<span class="token operator">&lt;</span>Camera<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">return</span> myCamera<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    private Transform myCameraTransform<span class="token punctuation">;</span>
    <span class="token keyword">public</span> Transform MyCameraTransform
    <span class="token punctuation">&#123;</span>
        get
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>myCameraTransform <span class="token operator">==</span> null<span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                myCameraTransform <span class="token operator">=</span> MyCamera<span class="token punctuation">.</span>transform<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">return</span> myCameraTransform<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token punctuation">[</span><span class="token function">Range</span><span class="token punctuation">(</span><span class="token number">0.0f</span> <span class="token punctuation">,</span> <span class="token number">3.0f</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token keyword">float</span> fogDensity <span class="token operator">=</span> <span class="token number">1.0f</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> Color fogColor <span class="token operator">=</span> Color<span class="token punctuation">.</span>white<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">float</span> fogStart <span class="token operator">=</span> <span class="token number">0.0f</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">float</span> fogEnd <span class="token operator">=</span> <span class="token number">2.0f</span><span class="token punctuation">;</span>

    <span class="token keyword">void</span> <span class="token function">OnEnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        MyCamera<span class="token punctuation">.</span>depthTextureMode <span class="token operator">|=</span> DepthTextureMode<span class="token punctuation">.</span>Depth<span class="token punctuation">;</span> <span class="token comment">//添加新的深度纹理模式而不影响其他已经启用的模式</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">void</span> <span class="token function">OnRenderImage</span><span class="token punctuation">(</span>RenderTexture src <span class="token punctuation">,</span> RenderTexture dest<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>material <span class="token operator">!=</span> null<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            Matrix4x4 frustumCorners <span class="token operator">=</span> Matrix4x4<span class="token punctuation">.</span>identity<span class="token punctuation">;</span>

            <span class="token keyword">float</span> fov <span class="token operator">=</span> MyCamera<span class="token punctuation">.</span>fieldOfView<span class="token punctuation">;</span>
            <span class="token keyword">float</span> near <span class="token operator">=</span> MyCamera<span class="token punctuation">.</span>nearClipPlane<span class="token punctuation">;</span>
            <span class="token keyword">float</span> aspect <span class="token operator">=</span> MyCamera<span class="token punctuation">.</span>aspect<span class="token punctuation">;</span>

            <span class="token keyword">float</span> halfHeight <span class="token operator">=</span> near <span class="token operator">*</span> Mathf<span class="token punctuation">.</span><span class="token function">Tan</span><span class="token punctuation">(</span>fov <span class="token operator">*</span> <span class="token number">0.5f</span> <span class="token operator">*</span> Mathf<span class="token punctuation">.</span>Deg2Rad<span class="token punctuation">)</span><span class="token punctuation">;</span>
            Vector3 toRight <span class="token operator">=</span> MyCameraTransform<span class="token punctuation">.</span>right <span class="token operator">*</span> halfHeight <span class="token operator">*</span> aspect<span class="token punctuation">;</span>
            Vector3 toTop <span class="token operator">=</span> MyCameraTransform<span class="token punctuation">.</span>up <span class="token operator">*</span> halfHeight<span class="token punctuation">;</span>

            Vector3 bottomLeft <span class="token operator">=</span> MyCameraTransform<span class="token punctuation">.</span>forward <span class="token operator">*</span> near <span class="token operator">-</span> toTop <span class="token operator">-</span> toRight<span class="token punctuation">;</span>
            Vector3 bottomRight <span class="token operator">=</span> MyCameraTransform<span class="token punctuation">.</span>forward <span class="token operator">*</span> near <span class="token operator">-</span> toTop <span class="token operator">+</span> toRight<span class="token punctuation">;</span>
            Vector3 topRight <span class="token operator">=</span> MyCameraTransform<span class="token punctuation">.</span>forward <span class="token operator">*</span> near <span class="token operator">+</span> toTop <span class="token operator">+</span> toRight<span class="token punctuation">;</span>
            Vector3 topLeft <span class="token operator">=</span> MyCameraTransform<span class="token punctuation">.</span>forward <span class="token operator">*</span> near <span class="token operator">+</span> toTop <span class="token operator">-</span> toRight<span class="token punctuation">;</span>


            <span class="token keyword">float</span> scale <span class="token operator">=</span> topLeft<span class="token punctuation">.</span>magnitude <span class="token operator">/</span> near<span class="token punctuation">;</span>

            topLeft<span class="token punctuation">.</span><span class="token function">Normalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            topLeft <span class="token operator">*=</span> scale<span class="token punctuation">;</span>
            topRight<span class="token punctuation">.</span><span class="token function">Normalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            topRight <span class="token operator">*=</span> scale<span class="token punctuation">;</span>
            bottomRight<span class="token punctuation">.</span><span class="token function">Normalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            bottomRight <span class="token operator">*=</span> scale<span class="token punctuation">;</span>
            bottomLeft<span class="token punctuation">.</span><span class="token function">Normalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            bottomLeft <span class="token operator">*=</span> scale<span class="token punctuation">;</span>

            frustumCorners<span class="token punctuation">.</span><span class="token function">SetRow</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> bottomLeft<span class="token punctuation">)</span><span class="token punctuation">;</span>
            frustumCorners<span class="token punctuation">.</span><span class="token function">SetRow</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> bottomRight<span class="token punctuation">)</span><span class="token punctuation">;</span>
            frustumCorners<span class="token punctuation">.</span><span class="token function">SetRow</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> topRight<span class="token punctuation">)</span><span class="token punctuation">;</span>
            frustumCorners<span class="token punctuation">.</span><span class="token function">SetRow</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> topLeft<span class="token punctuation">)</span><span class="token punctuation">;</span>

            material<span class="token punctuation">.</span><span class="token function">SetMatrix</span><span class="token punctuation">(</span><span class="token string">"_FrustumCornersRay"</span> <span class="token punctuation">,</span> frustumCorners<span class="token punctuation">)</span><span class="token punctuation">;</span>
            material<span class="token punctuation">.</span><span class="token function">SetMatrix</span><span class="token punctuation">(</span><span class="token string">"_ViewProjectionInverseMatrix"</span> <span class="token punctuation">,</span> <span class="token punctuation">(</span>MyCamera<span class="token punctuation">.</span>projectionMatrix
             <span class="token operator">*</span> MyCamera<span class="token punctuation">.</span>worldToCameraMatrix<span class="token punctuation">)</span><span class="token punctuation">.</span>inverse<span class="token punctuation">)</span><span class="token punctuation">;</span>

            material<span class="token punctuation">.</span><span class="token function">SetFloat</span><span class="token punctuation">(</span><span class="token string">"_FogDensity"</span> <span class="token punctuation">,</span> fogDensity<span class="token punctuation">)</span><span class="token punctuation">;</span>
            material<span class="token punctuation">.</span><span class="token function">SetColor</span><span class="token punctuation">(</span><span class="token string">"_FogColor"</span> <span class="token punctuation">,</span> fogColor<span class="token punctuation">)</span><span class="token punctuation">;</span>
            material<span class="token punctuation">.</span><span class="token function">SetFloat</span><span class="token punctuation">(</span><span class="token string">"_FogStart"</span> <span class="token punctuation">,</span> fogStart<span class="token punctuation">)</span><span class="token punctuation">;</span>
            material<span class="token punctuation">.</span><span class="token function">SetFloat</span><span class="token punctuation">(</span><span class="token string">"_FogEnd"</span> <span class="token punctuation">,</span> fogEnd<span class="token punctuation">)</span><span class="token punctuation">;</span>

            Graphics<span class="token punctuation">.</span><span class="token function">Blit</span><span class="token punctuation">(</span>src <span class="token punctuation">,</span> dest <span class="token punctuation">,</span> material<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">&#123;</span>
            Graphics<span class="token punctuation">.</span><span class="token function">Blit</span><span class="token punctuation">(</span>src <span class="token punctuation">,</span> dest<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl"><span class="token comment">// Upgrade NOTE: replaced 'mul(UNITY_MATRIX_MVP,*)' with 'UnityObjectToClipPos(*)'</span>

Shader <span class="token string">"Custom/Chapter13_2_FogWithDepthTexture"</span>
<span class="token punctuation">&#123;</span>
    Properties
    <span class="token punctuation">&#123;</span>
        <span class="token function">_MainTex</span> <span class="token punctuation">(</span><span class="token string">"Texture"</span><span class="token punctuation">,</span> <span class="token number">2</span>D<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">"white"</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
        <span class="token function">_FogDensity</span> <span class="token punctuation">(</span><span class="token string">"Fog Density"</span><span class="token punctuation">,</span> Float<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1.0</span>
        <span class="token function">_FogColor</span> <span class="token punctuation">(</span><span class="token string">"Fog Color"</span><span class="token punctuation">,</span> Color<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token punctuation">,</span> <span class="token number">1</span> <span class="token punctuation">,</span> <span class="token number">1</span> <span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token function">_FogStart</span> <span class="token punctuation">(</span><span class="token string">"Fog Start"</span><span class="token punctuation">,</span> Float<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0.0</span>
        <span class="token function">_FogEnd</span> <span class="token punctuation">(</span><span class="token string">"Fog End"</span><span class="token punctuation">,</span> Float<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1.0</span>
    <span class="token punctuation">&#125;</span>

    SubShader
    <span class="token punctuation">&#123;</span>
        CGINCLUDE
        <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"UnityCG.cginc"</span></span>

        float4x4 _FrustumCornersRay<span class="token punctuation">;</span>

        <span class="token keyword">sampler2D</span> _MainTex<span class="token punctuation">;</span>
        float4 _MainTex_TexelSize<span class="token punctuation">;</span>

        <span class="token keyword">sampler2D</span> _CameraDepthTexture<span class="token punctuation">;</span> <span class="token comment">//声明了深度纹理</span>

        <span class="token keyword">float</span> _FogDensity<span class="token punctuation">;</span>
        float4 _FogColor<span class="token punctuation">;</span>
        <span class="token keyword">float</span> _FogStart<span class="token punctuation">;</span>
        <span class="token keyword">float</span> _FogEnd<span class="token punctuation">;</span>

        <span class="token keyword">struct</span> <span class="token class-name">v2f</span>
        <span class="token punctuation">&#123;</span>
            float4 pos <span class="token operator">:</span> SV_POSITION<span class="token punctuation">;</span>
            half2 uv <span class="token operator">:</span> TEXCOORD0<span class="token punctuation">;</span>
            half2 uv_depth <span class="token operator">:</span> TEXCOORD1<span class="token punctuation">;</span>
            float4 interpolatedRay <span class="token operator">:</span> TEXCOORD2<span class="token punctuation">;</span><span class="token comment">//插值射线，在四条射线当中选取</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

        v2f <span class="token function">vert</span><span class="token punctuation">(</span>appdata_img v<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            v2f o<span class="token punctuation">;</span>
            o<span class="token punctuation">.</span>pos <span class="token operator">=</span> <span class="token function">UnityObjectToClipPos</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>vertex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            o<span class="token punctuation">.</span>uv <span class="token operator">=</span> v<span class="token punctuation">.</span>texcoord<span class="token punctuation">;</span>
            o<span class="token punctuation">.</span>uv_depth <span class="token operator">=</span> v<span class="token punctuation">.</span>texcoord<span class="token punctuation">;</span>

            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">UNITY_UV_STARTS_AT_TOP</span></span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>_MainTex_TexelSize<span class="token punctuation">.</span>y <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                    o<span class="token punctuation">.</span>uv_depth<span class="token punctuation">.</span>y <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">-</span> o<span class="token punctuation">.</span>uv_depth<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

            <span class="token comment">//计算插值射线</span>
            <span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>v<span class="token punctuation">.</span>texcoord<span class="token punctuation">.</span>x <span class="token operator">&lt;</span> <span class="token number">0.5</span> <span class="token operator">&amp;&amp;</span> v<span class="token punctuation">.</span>texcoord<span class="token punctuation">.</span>y <span class="token operator">&lt;</span> <span class="token number">0.5</span><span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>v<span class="token punctuation">.</span>texcoord<span class="token punctuation">.</span>x <span class="token operator">></span> <span class="token number">0.5</span> <span class="token operator">&amp;&amp;</span> v<span class="token punctuation">.</span>texcoord<span class="token punctuation">.</span>y <span class="token operator">&lt;</span> <span class="token number">0.5</span><span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                index <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>v<span class="token punctuation">.</span>texcoord<span class="token punctuation">.</span>x <span class="token operator">></span> <span class="token number">0.5</span> <span class="token operator">&amp;&amp;</span> v<span class="token punctuation">.</span>texcoord<span class="token punctuation">.</span>y <span class="token operator">></span> <span class="token number">0.5</span><span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                index <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">&#123;</span>
                index <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">UNITY_UV_STARTS_AT_TOP</span></span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>_MainTex_TexelSize<span class="token punctuation">.</span>y <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                    index <span class="token operator">=</span> <span class="token number">3</span> <span class="token operator">-</span> index<span class="token punctuation">;</span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

            o<span class="token punctuation">.</span>interpolatedRay <span class="token operator">=</span> _FrustumCornersRay<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>

            <span class="token keyword">return</span> o<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        half4 <span class="token function">frag</span> <span class="token punctuation">(</span>v2f i<span class="token punctuation">)</span> <span class="token operator">:</span> SV_Target
        <span class="token punctuation">&#123;</span>
            <span class="token comment">//计算深度</span>
            <span class="token keyword">float</span> linearDepth <span class="token operator">=</span> <span class="token function">LinearEyeDepth</span><span class="token punctuation">(</span><span class="token function">SAMPLE_DEPTH_TEXTURE</span><span class="token punctuation">(</span>_CameraDepthTexture<span class="token punctuation">,</span> i<span class="token punctuation">.</span>uv_depth<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            float3 worldPos <span class="token operator">=</span> _WorldSpaceCameraPos <span class="token operator">+</span> linearDepth <span class="token operator">*</span> i<span class="token punctuation">.</span>interpolatedRay<span class="token punctuation">.</span>xyz<span class="token punctuation">;</span>

            <span class="token keyword">float</span> fogDensity <span class="token operator">=</span> <span class="token punctuation">(</span>_FogEnd <span class="token operator">-</span> worldPos<span class="token punctuation">.</span>y<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>_FogEnd <span class="token operator">-</span> _FogStart<span class="token punctuation">)</span><span class="token punctuation">;</span>
            fogDensity <span class="token operator">=</span> <span class="token function">saturate</span><span class="token punctuation">(</span>fogDensity <span class="token operator">*</span> _FogDensity<span class="token punctuation">)</span><span class="token punctuation">;</span>

            fixed4 finalColor <span class="token operator">=</span> <span class="token function">tex2D</span><span class="token punctuation">(</span>_MainTex <span class="token punctuation">,</span> i<span class="token punctuation">.</span>uv<span class="token punctuation">)</span><span class="token punctuation">;</span>
            finalColor<span class="token punctuation">.</span>rgb <span class="token operator">=</span> <span class="token function">lerp</span><span class="token punctuation">(</span>finalColor<span class="token punctuation">.</span>rgb<span class="token punctuation">,</span> _FogColor<span class="token punctuation">.</span>rgb<span class="token punctuation">,</span> fogDensity<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">return</span> finalColor<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        ENDCG

        Pass
        <span class="token punctuation">&#123;</span>
            ZTest Always Cull Off ZWrite Off

            CGPROGRAM
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">vertex vert</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">fragment frag</span></span>
            ENDCG
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    FallBack Off
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="/./../../../BlogImg/image-20250319123950051.png" alt="image-20250319123950051"></p>
<p><img src="/./../../../BlogImg/image-20250319120802505.png" alt="image-20250319120802505"></p>
<p><img src="/./../../../BlogImg/image-20250319131246994.png" alt="image-20250319131246994"></p>
<h2 id="再谈边缘检测"><a href="#再谈边缘检测" class="headerlink" title="再谈边缘检测"></a>再谈边缘检测</h2><p>使用Roberts算子来进行边缘检测</p>
<p>计算左上角和右下角的差值，乘以右上角和右下角的差值，作为评估边缘的依据<br><img src="/./../../../BlogImg/image-20250319131609631.png" alt="image-20250319131609631"></p>
<p>codes</p>
<pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl"><span class="token keyword">using</span> System<span class="token punctuation">.</span>Collections<span class="token punctuation">;</span>
<span class="token keyword">using</span> System<span class="token punctuation">.</span>Collections<span class="token punctuation">.</span>Generic<span class="token punctuation">;</span>
<span class="token keyword">using</span> UnityEngine<span class="token punctuation">;</span>

<span class="token punctuation">[</span>ExecuteInEditMode<span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> EdgeDetectNormalAndDepth <span class="token operator">:</span> PostEffectsBase
<span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> Shader edgeDetectShader<span class="token punctuation">;</span>
    private Material edgeDetectMaterial<span class="token punctuation">;</span>

    <span class="token keyword">public</span> Material material
    <span class="token punctuation">&#123;</span>
        get
        <span class="token punctuation">&#123;</span>
            edgeDetectMaterial <span class="token operator">=</span> <span class="token function">CheckShaderAndCreateMaterial</span>
            <span class="token punctuation">(</span>edgeDetectShader <span class="token punctuation">,</span> edgeDetectMaterial<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> edgeDetectMaterial<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token punctuation">[</span><span class="token function">Range</span><span class="token punctuation">(</span><span class="token number">0.0f</span> <span class="token punctuation">,</span> <span class="token number">1.0f</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

    <span class="token keyword">public</span> <span class="token keyword">float</span> edgesOnly <span class="token operator">=</span> <span class="token number">0.0f</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> Color edgeColor <span class="token operator">=</span> Color<span class="token punctuation">.</span>black<span class="token punctuation">;</span>

    <span class="token keyword">public</span> Color backgroundColor <span class="token operator">=</span> Color<span class="token punctuation">.</span>white<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">float</span> sampleDistance <span class="token operator">=</span> <span class="token number">1.0f</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">float</span> sensitivityDepth <span class="token operator">=</span> <span class="token number">1.0f</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">float</span> sensitivityNormals <span class="token operator">=</span> <span class="token number">1.0f</span><span class="token punctuation">;</span>

    <span class="token comment">//sampleDistance用于控制对深度+法线采样的时候使用的采样距离</span>
    <span class="token comment">//从视觉上看，sampleDistance值越大，描边越宽，</span>
    <span class="token comment">//sensitivityDepth和sensitivityNormals将会影响</span>
    <span class="token comment">//当邻域的深度值或法线值相差多少时,才会被认为是边缘</span>
    <span class="token comment">//如果不拿灵敏度调的很大，那么可能即使是深度或者法线上非常小的变化也会形成一条边</span>
    <span class="token punctuation">[</span>ImageEffectOpaque<span class="token punctuation">]</span>
    <span class="token comment">//[ImageEffectOpaque] 是 Unity 中的一种特性标签，</span>
    <span class="token comment">// 用于标识一个后处理效果（post-processing effect）应该在渲染的过程中应用在不透明物体的渲染之后。</span>
    <span class="token keyword">void</span> <span class="token function">OnEnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        GetComponent<span class="token operator">&lt;</span>Camera<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>depthTextureMode <span class="token operator">|=</span> DepthTextureMode<span class="token punctuation">.</span>DepthNormals<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">void</span> <span class="token function">OnRenderImage</span> <span class="token punctuation">(</span>RenderTexture src <span class="token punctuation">,</span> RenderTexture dest<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>material <span class="token operator">!=</span> null<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            material<span class="token punctuation">.</span><span class="token function">SetFloat</span><span class="token punctuation">(</span><span class="token string">"_EdgeOnly"</span> <span class="token punctuation">,</span> edgesOnly<span class="token punctuation">)</span><span class="token punctuation">;</span>
            material<span class="token punctuation">.</span><span class="token function">SetColor</span><span class="token punctuation">(</span><span class="token string">"_EdgeColor"</span> <span class="token punctuation">,</span> edgeColor<span class="token punctuation">)</span><span class="token punctuation">;</span>
            material<span class="token punctuation">.</span><span class="token function">SetColor</span><span class="token punctuation">(</span><span class="token string">"_BackgroundColor"</span> <span class="token punctuation">,</span> backgroundColor<span class="token punctuation">)</span><span class="token punctuation">;</span>
            material<span class="token punctuation">.</span><span class="token function">SetFloat</span><span class="token punctuation">(</span><span class="token string">"_SampleDistance"</span> <span class="token punctuation">,</span> sampleDistance<span class="token punctuation">)</span><span class="token punctuation">;</span>
            material<span class="token punctuation">.</span><span class="token function">SetVector</span><span class="token punctuation">(</span><span class="token string">"_Sensitivity"</span> <span class="token punctuation">,</span> new <span class="token function">Vector4</span>
            <span class="token punctuation">(</span>sensitivityNormals <span class="token punctuation">,</span> sensitivityDepth <span class="token punctuation">,</span> <span class="token number">0.0f</span> <span class="token punctuation">,</span> <span class="token number">0.0f</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            Graphics<span class="token punctuation">.</span><span class="token function">Blit</span><span class="token punctuation">(</span>src <span class="token punctuation">,</span> dest <span class="token punctuation">,</span> material<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">&#123;</span>
            Graphics<span class="token punctuation">.</span><span class="token function">Blit</span><span class="token punctuation">(</span>src <span class="token punctuation">,</span> dest<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>shader</p>
<pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl"><span class="token comment">// Upgrade NOTE: replaced 'mul(UNITY_MATRIX_MVP,*)' with 'UnityObjectToClipPos(*)'</span>

Shader <span class="token string">"Unity Shaders Book/Chapter 13/Edge Detection Normals And Depth"</span> <span class="token punctuation">&#123;</span>
	Properties <span class="token punctuation">&#123;</span>
		<span class="token function">_MainTex</span> <span class="token punctuation">(</span><span class="token string">"Base (RGB)"</span><span class="token punctuation">,</span> <span class="token number">2</span>D<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">"white"</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
		<span class="token function">_EdgeOnly</span> <span class="token punctuation">(</span><span class="token string">"Edge Only"</span><span class="token punctuation">,</span> Float<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1.0</span>
		<span class="token function">_EdgeColor</span> <span class="token punctuation">(</span><span class="token string">"Edge Color"</span><span class="token punctuation">,</span> Color<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token function">_BackgroundColor</span> <span class="token punctuation">(</span><span class="token string">"Background Color"</span><span class="token punctuation">,</span> Color<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token function">_SampleDistance</span> <span class="token punctuation">(</span><span class="token string">"Sample Distance"</span><span class="token punctuation">,</span> Float<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1.0</span>
		<span class="token function">_Sensitivity</span> <span class="token punctuation">(</span><span class="token string">"Sensitivity"</span><span class="token punctuation">,</span> Vector<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	SubShader <span class="token punctuation">&#123;</span>
		CGINCLUDE
		
		<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"UnityCG.cginc"</span></span>
		
		<span class="token keyword">sampler2D</span> _MainTex<span class="token punctuation">;</span>
		half4 _MainTex_TexelSize<span class="token punctuation">;</span>
		<span class="token keyword">fixed</span> _EdgeOnly<span class="token punctuation">;</span>
		fixed4 _EdgeColor<span class="token punctuation">;</span>
		fixed4 _BackgroundColor<span class="token punctuation">;</span>
		<span class="token keyword">float</span> _SampleDistance<span class="token punctuation">;</span>
		half4 _Sensitivity<span class="token punctuation">;</span>
		
		<span class="token keyword">sampler2D</span> _CameraDepthNormalsTexture<span class="token punctuation">;</span>
		
		<span class="token keyword">struct</span> <span class="token class-name">v2f</span> <span class="token punctuation">&#123;</span>
			float4 pos <span class="token operator">:</span> SV_POSITION<span class="token punctuation">;</span>
			half2 uv<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token operator">:</span> TEXCOORD0<span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
		  
		v2f <span class="token function">vert</span><span class="token punctuation">(</span>appdata_img v<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			v2f o<span class="token punctuation">;</span>
			o<span class="token punctuation">.</span>pos <span class="token operator">=</span> <span class="token function">UnityObjectToClipPos</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>vertex<span class="token punctuation">)</span><span class="token punctuation">;</span>
			
			half2 uv <span class="token operator">=</span> v<span class="token punctuation">.</span>texcoord<span class="token punctuation">;</span>
			o<span class="token punctuation">.</span>uv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> uv<span class="token punctuation">;</span>
			
			<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">UNITY_UV_STARTS_AT_TOP</span></span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>_MainTex_TexelSize<span class="token punctuation">.</span>y <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
				uv<span class="token punctuation">.</span>y <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">-</span> uv<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
			<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
			
			o<span class="token punctuation">.</span>uv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> uv <span class="token operator">+</span> _MainTex_TexelSize<span class="token punctuation">.</span>xy <span class="token operator">*</span> <span class="token function">half2</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> _SampleDistance<span class="token punctuation">;</span>
			o<span class="token punctuation">.</span>uv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> uv <span class="token operator">+</span> _MainTex_TexelSize<span class="token punctuation">.</span>xy <span class="token operator">*</span> <span class="token function">half2</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> _SampleDistance<span class="token punctuation">;</span>
			o<span class="token punctuation">.</span>uv<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> uv <span class="token operator">+</span> _MainTex_TexelSize<span class="token punctuation">.</span>xy <span class="token operator">*</span> <span class="token function">half2</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> _SampleDistance<span class="token punctuation">;</span>
			o<span class="token punctuation">.</span>uv<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> uv <span class="token operator">+</span> _MainTex_TexelSize<span class="token punctuation">.</span>xy <span class="token operator">*</span> <span class="token function">half2</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> _SampleDistance<span class="token punctuation">;</span>
					 
			<span class="token keyword">return</span> o<span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>
		
		<span class="token keyword">half</span> <span class="token function">CheckSame</span><span class="token punctuation">(</span>half4 center<span class="token punctuation">,</span> half4 <span class="token keyword">sample</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			half2 centerNormal <span class="token operator">=</span> center<span class="token punctuation">.</span>xy<span class="token punctuation">;</span>
			<span class="token keyword">float</span> centerDepth <span class="token operator">=</span> <span class="token function">DecodeFloatRG</span><span class="token punctuation">(</span>center<span class="token punctuation">.</span>zw<span class="token punctuation">)</span><span class="token punctuation">;</span>
			half2 sampleNormal <span class="token operator">=</span> <span class="token keyword">sample</span><span class="token punctuation">.</span>xy<span class="token punctuation">;</span>
			<span class="token keyword">float</span> sampleDepth <span class="token operator">=</span> <span class="token function">DecodeFloatRG</span><span class="token punctuation">(</span><span class="token keyword">sample</span><span class="token punctuation">.</span>zw<span class="token punctuation">)</span><span class="token punctuation">;</span>
			
			<span class="token comment">// difference in normals</span>
			<span class="token comment">// do not bother decoding normals - there's no need here</span>
			half2 diffNormal <span class="token operator">=</span> <span class="token function">abs</span><span class="token punctuation">(</span>centerNormal <span class="token operator">-</span> sampleNormal<span class="token punctuation">)</span> <span class="token operator">*</span> _Sensitivity<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
			<span class="token keyword">int</span> isSameNormal <span class="token operator">=</span> <span class="token punctuation">(</span>diffNormal<span class="token punctuation">.</span>x <span class="token operator">+</span> diffNormal<span class="token punctuation">.</span>y<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0.1</span><span class="token punctuation">;</span>
			<span class="token comment">// difference in depth</span>
			<span class="token keyword">float</span> diffDepth <span class="token operator">=</span> <span class="token function">abs</span><span class="token punctuation">(</span>centerDepth <span class="token operator">-</span> sampleDepth<span class="token punctuation">)</span> <span class="token operator">*</span> _Sensitivity<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
			<span class="token comment">// scale the required threshold by the distance</span>
			<span class="token keyword">int</span> isSameDepth <span class="token operator">=</span> diffDepth <span class="token operator">&lt;</span> <span class="token number">0.1</span> <span class="token operator">*</span> centerDepth<span class="token punctuation">;</span>
			
			<span class="token comment">// return:</span>
			<span class="token comment">// 1 - if normals and depth are similar enough</span>
			<span class="token comment">// 0 - otherwise</span>
			<span class="token keyword">return</span> isSameNormal <span class="token operator">*</span> isSameDepth <span class="token operator">?</span> <span class="token number">1.0</span> <span class="token operator">:</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>
		
		fixed4 <span class="token function">fragRobertsCrossDepthAndNormal</span><span class="token punctuation">(</span>v2f i<span class="token punctuation">)</span> <span class="token operator">:</span> SV_Target <span class="token punctuation">&#123;</span>
			half4 sample1 <span class="token operator">=</span> <span class="token function">tex2D</span><span class="token punctuation">(</span>_CameraDepthNormalsTexture<span class="token punctuation">,</span> i<span class="token punctuation">.</span>uv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			half4 sample2 <span class="token operator">=</span> <span class="token function">tex2D</span><span class="token punctuation">(</span>_CameraDepthNormalsTexture<span class="token punctuation">,</span> i<span class="token punctuation">.</span>uv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			half4 sample3 <span class="token operator">=</span> <span class="token function">tex2D</span><span class="token punctuation">(</span>_CameraDepthNormalsTexture<span class="token punctuation">,</span> i<span class="token punctuation">.</span>uv<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			half4 sample4 <span class="token operator">=</span> <span class="token function">tex2D</span><span class="token punctuation">(</span>_CameraDepthNormalsTexture<span class="token punctuation">,</span> i<span class="token punctuation">.</span>uv<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			
			<span class="token keyword">half</span> edge <span class="token operator">=</span> <span class="token number">1.0</span><span class="token punctuation">;</span>
			
			edge <span class="token operator">*=</span> <span class="token function">CheckSame</span><span class="token punctuation">(</span>sample1<span class="token punctuation">,</span> sample2<span class="token punctuation">)</span><span class="token punctuation">;</span>
			edge <span class="token operator">*=</span> <span class="token function">CheckSame</span><span class="token punctuation">(</span>sample3<span class="token punctuation">,</span> sample4<span class="token punctuation">)</span><span class="token punctuation">;</span>
			
			fixed4 withEdgeColor <span class="token operator">=</span> <span class="token function">lerp</span><span class="token punctuation">(</span>_EdgeColor<span class="token punctuation">,</span> <span class="token function">tex2D</span><span class="token punctuation">(</span>_MainTex<span class="token punctuation">,</span> i<span class="token punctuation">.</span>uv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> edge<span class="token punctuation">)</span><span class="token punctuation">;</span>
			fixed4 onlyEdgeColor <span class="token operator">=</span> <span class="token function">lerp</span><span class="token punctuation">(</span>_EdgeColor<span class="token punctuation">,</span> _BackgroundColor<span class="token punctuation">,</span> edge<span class="token punctuation">)</span><span class="token punctuation">;</span>
			
			<span class="token keyword">return</span> <span class="token function">lerp</span><span class="token punctuation">(</span>withEdgeColor<span class="token punctuation">,</span> onlyEdgeColor<span class="token punctuation">,</span> _EdgeOnly<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>
		
		ENDCG
		
		Pass <span class="token punctuation">&#123;</span> 
			ZTest Always Cull Off ZWrite Off
			
			CGPROGRAM      
			
			<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">vertex vert  </span></span>
			<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">fragment fragRobertsCrossDepthAndNormal</span></span>
			
			ENDCG  
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span> 
	FallBack Off
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>结果<br><img src="/./../../../BlogImg/image-20250319144239051.png" alt="image-20250319144239051"></p>
<h1 id="NPR"><a href="#NPR" class="headerlink" title="NPR"></a>NPR</h1><h2 id="卡通风格"><a href="#卡通风格" class="headerlink" title="卡通风格"></a>卡通风格</h2><pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl"><span class="token comment">// Upgrade NOTE: replaced '_Object2World' with 'unity_ObjectToWorld'</span>
<span class="token comment">// Upgrade NOTE: replaced '_World2Object' with 'unity_WorldToObject'</span>
<span class="token comment">// Upgrade NOTE: replaced 'mul(UNITY_MATRIX_MVP,*)' with 'UnityObjectToClipPos(*)'</span>

Shader <span class="token string">"Custom/Chapter14_1_NPRcartoon"</span>
<span class="token punctuation">&#123;</span>
    Properties
    <span class="token punctuation">&#123;</span>
        <span class="token function">_Color</span> <span class="token punctuation">(</span><span class="token string">"Color Tint"</span><span class="token punctuation">,</span> Color<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token function">_MainTex</span> <span class="token punctuation">(</span><span class="token string">"Main Tex"</span><span class="token punctuation">,</span> <span class="token number">2</span>D<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">"white"</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
        <span class="token function">_Ramp</span> <span class="token punctuation">(</span><span class="token string">"Ramp Texture"</span><span class="token punctuation">,</span> <span class="token number">2</span>D<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">"white"</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
        <span class="token function">_Outline</span> <span class="token punctuation">(</span><span class="token string">"Outline"</span> <span class="token punctuation">,</span> <span class="token function">Range</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0.1</span>
        <span class="token function">_OutlineColor</span> <span class="token punctuation">(</span><span class="token string">"Outline Color"</span><span class="token punctuation">,</span> Color<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token function">_Specular</span><span class="token punctuation">(</span><span class="token string">"Specular"</span><span class="token punctuation">,</span> Color<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token punctuation">,</span> <span class="token number">1</span> <span class="token punctuation">,</span> <span class="token number">1</span> <span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token function">_SpecularScale</span><span class="token punctuation">(</span><span class="token string">"Specular Scale"</span><span class="token punctuation">,</span> <span class="token function">Range</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token punctuation">,</span> <span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0.01</span>
    <span class="token punctuation">&#125;</span>

    SubShader
    <span class="token punctuation">&#123;</span>
        Tags <span class="token punctuation">&#123;</span> <span class="token string">"RenderType"</span><span class="token operator">=</span><span class="token string">"Opaque"</span> <span class="token punctuation">&#125;</span>

        Pass
        <span class="token punctuation">&#123;</span>
            NAME <span class="token string">"OUTLINE"</span>

            Cull Front <span class="token comment">//使用cull指令把表面的三角面片移除，只渲染背面，使用name命名名称</span>

            CGPROGRAM
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">vertex vert</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">fragment frag</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"UnityCG.cginc"</span></span>

            
            <span class="token keyword">float</span> _Outline<span class="token punctuation">;</span>
            fixed4 _OutlineColor<span class="token punctuation">;</span>

            <span class="token keyword">struct</span> <span class="token class-name">a2v</span>
            <span class="token punctuation">&#123;</span>
                float4 vertex <span class="token operator">:</span> POSITION<span class="token punctuation">;</span>
                float3 normal <span class="token operator">:</span> NORMAL<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

            <span class="token keyword">struct</span> <span class="token class-name">v2f</span>
            <span class="token punctuation">&#123;</span>
                float4 pos <span class="token operator">:</span> SV_POSITION<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

            v2f <span class="token function">vert</span><span class="token punctuation">(</span>a2v v<span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                v2f o<span class="token punctuation">;</span>
                
                float4 pos <span class="token operator">=</span> <span class="token function">mul</span><span class="token punctuation">(</span>UNITY_MATRIX_MV<span class="token punctuation">,</span> v<span class="token punctuation">.</span>vertex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//这和float4 pos = UnityObjectToClipPos(v.vertex);有什么区别吗？</span>
                <span class="token comment">//区别是前者将模型空间转换到视图空间，后者将视图空间转换到裁剪空间。</span>

                float3 normal <span class="token operator">=</span> <span class="token function">mul</span><span class="token punctuation">(</span><span class="token punctuation">(</span>float3x3<span class="token punctuation">)</span>UNITY_MATRIX_IT_MV <span class="token punctuation">,</span> v<span class="token punctuation">.</span>normal<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//表示模型矩阵视图矩阵的逆矩阵和转置矩阵。将模型空间中的顶点和法线转换到视图空间中</span>

                <span class="token comment">//确保法线在变换过程当中保持正确的方向和长度</span>
                normal<span class="token punctuation">.</span>z <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">;</span>

                pos <span class="token operator">=</span> pos <span class="token operator">+</span> <span class="token function">float4</span> <span class="token punctuation">(</span><span class="token function">normalize</span><span class="token punctuation">(</span>normal<span class="token punctuation">)</span> <span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">*</span> _Outline<span class="token punctuation">;</span>
                o<span class="token punctuation">.</span>pos <span class="token operator">=</span> <span class="token function">mul</span><span class="token punctuation">(</span>UNITY_MATRIX_P <span class="token punctuation">,</span> pos<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//对设置法线的z分量，对其归一化之后再将顶点沿其方向进行扩张，得到扩张之后的顶点坐标，</span>
                <span class="token comment">//对法线的处理是为了尽可能避免背面扩张后的顶点挡住正面的面片。</span>

                <span class="token comment">//向着摄像机的方向扩张吗</span>

                <span class="token keyword">return</span> o<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            
            float4 <span class="token function">frag</span><span class="token punctuation">(</span>v2f i<span class="token punctuation">)</span> <span class="token operator">:</span> SV_Target
            <span class="token punctuation">&#123;</span>
                <span class="token keyword">return</span> <span class="token function">float4</span><span class="token punctuation">(</span>_OutlineColor<span class="token punctuation">.</span>rgb <span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            ENDCG
        <span class="token punctuation">&#125;</span>

        Pass
        <span class="token punctuation">&#123;</span>
            Tags <span class="token punctuation">&#123;</span> <span class="token string">"LightMode"</span><span class="token operator">=</span><span class="token string">"ForwardBase"</span> <span class="token punctuation">&#125;</span>

            Cull Back <span class="token comment">//使用cull指令把背面的三角面片移除，只渲染正面，使用name命名名称</span>

            CGPROGRAM
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">vertex vert</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">fragment frag</span></span>

            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">multi_compile_fwdbase</span></span>

            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"UnityCG.cginc"</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"AutoLight.cginc"</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Lighting.cginc"</span></span>

            fixed4 _Color<span class="token punctuation">;</span>
            <span class="token keyword">sampler2D</span> _MainTex<span class="token punctuation">;</span>
            float4 _MainTex_ST<span class="token punctuation">;</span>

            <span class="token keyword">sampler2D</span> _Ramp<span class="token punctuation">;</span>
            fixed4 _Specular<span class="token punctuation">;</span>
            <span class="token keyword">float</span> _SpecularScale<span class="token punctuation">;</span>

            <span class="token keyword">struct</span> <span class="token class-name">a2v</span>
            <span class="token punctuation">&#123;</span>
                float4 vertex <span class="token operator">:</span> POSITION<span class="token punctuation">;</span>
                float3 normal <span class="token operator">:</span> NORMAL<span class="token punctuation">;</span>
                float2 texcoord <span class="token operator">:</span> TEXCOORD0<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
            
            <span class="token keyword">struct</span> <span class="token class-name">v2f</span>
            <span class="token punctuation">&#123;</span>
                float4 pos <span class="token operator">:</span> POSITION<span class="token punctuation">;</span><span class="token comment">//和SV_POSITION没什么区别，都是裁剪空间的位置</span>
                float2 uv <span class="token operator">:</span> TEXCOORD0<span class="token punctuation">;</span>
                float3 worldNormal <span class="token operator">:</span> TEXCOORD1<span class="token punctuation">;</span>
                float3 worldPos <span class="token operator">:</span> TEXCOORD2<span class="token punctuation">;</span>
                <span class="token function">SHADOW_COORDS</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

            v2f <span class="token function">vert</span><span class="token punctuation">(</span>a2v v<span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                v2f o<span class="token punctuation">;</span>

                o<span class="token punctuation">.</span>pos <span class="token operator">=</span> <span class="token function">UnityObjectToClipPos</span><span class="token punctuation">(</span> v<span class="token punctuation">.</span>vertex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                o<span class="token punctuation">.</span>uv <span class="token operator">=</span> <span class="token function">TRANSFORM_TEX</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>texcoord <span class="token punctuation">,</span> _MainTex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                o<span class="token punctuation">.</span>worldNormal <span class="token operator">=</span> <span class="token function">mul</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>normal <span class="token punctuation">,</span> <span class="token punctuation">(</span>float3x3<span class="token punctuation">)</span>unity_WorldToObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
                o<span class="token punctuation">.</span>worldPos <span class="token operator">=</span> <span class="token function">mul</span><span class="token punctuation">(</span>unity_ObjectToWorld <span class="token punctuation">,</span> v<span class="token punctuation">.</span>vertex<span class="token punctuation">)</span><span class="token punctuation">.</span>xyz<span class="token punctuation">;</span>

                <span class="token function">TRANSFER_SHADOW</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">return</span> o<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            fixed4 <span class="token function">frag</span><span class="token punctuation">(</span>v2f i<span class="token punctuation">)</span> <span class="token operator">:</span> SV_TARGET
            <span class="token punctuation">&#123;</span>
                fixed3 worldNormal <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>worldNormal<span class="token punctuation">)</span><span class="token punctuation">;</span>
                fixed3 worldLightDir <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span><span class="token function">UnityWorldSpaceLightDir</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>worldPos<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                fixed3 worldViewDir <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span><span class="token function">UnityWorldSpaceViewDir</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>worldPos<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                fixed3 worldHalfDir <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>worldLightDir <span class="token operator">+</span> worldViewDir<span class="token punctuation">)</span><span class="token punctuation">;</span>

                fixed3 c <span class="token operator">=</span> <span class="token function">tex2D</span><span class="token punctuation">(</span>_MainTex <span class="token punctuation">,</span> i<span class="token punctuation">.</span>uv<span class="token punctuation">)</span><span class="token punctuation">;</span>
                fixed3 albedo <span class="token operator">=</span> c<span class="token punctuation">.</span>rgb <span class="token operator">*</span> _Color<span class="token punctuation">.</span>rgb<span class="token punctuation">;</span>

                fixed3 ambient <span class="token operator">=</span> UNITY_LIGHTMODEL_AMBIENT<span class="token punctuation">.</span>xyz <span class="token operator">*</span> albedo<span class="token punctuation">;</span>

                <span class="token function">UNITY_LIGHT_ATTENUATION</span><span class="token punctuation">(</span>atten <span class="token punctuation">,</span> i <span class="token punctuation">,</span> i<span class="token punctuation">.</span>worldPos<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">fixed</span> diff <span class="token operator">=</span> <span class="token function">dot</span><span class="token punctuation">(</span>worldNormal <span class="token punctuation">,</span> worldLightDir<span class="token punctuation">)</span><span class="token punctuation">;</span>
                diff <span class="token operator">=</span> <span class="token punctuation">(</span>diff <span class="token operator">*</span> <span class="token number">0.5</span> <span class="token operator">+</span> <span class="token number">0.5</span><span class="token punctuation">)</span> <span class="token operator">*</span> atten<span class="token punctuation">;</span><span class="token comment">//半兰伯特</span>

                fixed3 diffuse <span class="token operator">=</span> _LightColor0<span class="token punctuation">.</span>rgb <span class="token operator">*</span> albedo <span class="token operator">*</span> <span class="token function">tex2D</span><span class="token punctuation">(</span>_Ramp <span class="token punctuation">,</span> <span class="token function">float2</span><span class="token punctuation">(</span>diff <span class="token punctuation">,</span> diff<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>rgb <span class="token operator">*</span> diff<span class="token punctuation">;</span>

                <span class="token keyword">fixed</span> spec <span class="token operator">=</span> <span class="token function">dot</span><span class="token punctuation">(</span>worldNormal <span class="token punctuation">,</span> worldHalfDir<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">//fwidth函数用于计算输入参数在屏幕空间当中的梯度（即变化率）。</span>
                <span class="token comment">//具体来说fwidth参数会计算输入参数在当前像素周围的两个相邻像素之间的差异</span>
                <span class="token keyword">fixed</span> w <span class="token operator">=</span> <span class="token function">fwidth</span><span class="token punctuation">(</span>spec<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2.0f</span><span class="token punctuation">;</span>
                fixed3 specular <span class="token operator">=</span> _Specular<span class="token punctuation">.</span>rgb <span class="token operator">*</span> <span class="token function">lerp</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token punctuation">,</span> <span class="token number">1</span> <span class="token punctuation">,</span> <span class="token function">smoothstep</span><span class="token punctuation">(</span><span class="token operator">-</span>w <span class="token punctuation">,</span> w <span class="token punctuation">,</span> spec <span class="token operator">+</span> _SpecularScale <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                 <span class="token operator">*</span> <span class="token function">step</span><span class="token punctuation">(</span><span class="token number">0.0001</span> <span class="token punctuation">,</span> _SpecularScale<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">return</span> <span class="token function">fixed4</span><span class="token punctuation">(</span>ambient <span class="token operator">+</span> diffuse <span class="token operator">+</span> specular <span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            ENDCG
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    FallBack <span class="token string">"Diffuse"</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>效果<br><img src="/./../../../BlogImg/image-20250319201444021.png" alt="image-20250319201444021"></p>
<h2 id="素描效果"><a href="#素描效果" class="headerlink" title="素描效果"></a>素描效果</h2><pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl"><span class="token comment">// Upgrade NOTE: replaced 'mul(UNITY_MATRIX_MVP,*)' with 'UnityObjectToClipPos(*)'</span>

Shader <span class="token string">"Custom/Chapter14_2_Hatching"</span>
<span class="token punctuation">&#123;</span>
    Properties
    <span class="token punctuation">&#123;</span>
        <span class="token function">_Color</span> <span class="token punctuation">(</span><span class="token string">"Color"</span><span class="token punctuation">,</span> Color<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token function">_TileFactor</span><span class="token punctuation">(</span><span class="token string">"Tile Factor"</span> <span class="token punctuation">,</span> Float<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span>
        <span class="token function">_Outline</span> <span class="token punctuation">(</span><span class="token string">"Outline"</span> <span class="token punctuation">,</span> <span class="token function">Range</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0.1</span>
        <span class="token function">_Hatch0</span> <span class="token punctuation">(</span><span class="token string">"Hatch 0"</span> <span class="token punctuation">,</span> <span class="token number">2</span>D<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">"white"</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
        <span class="token function">_Hatch1</span> <span class="token punctuation">(</span><span class="token string">"Hatch 1"</span> <span class="token punctuation">,</span> <span class="token number">2</span>D<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">"white"</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
        <span class="token function">_Hatch2</span> <span class="token punctuation">(</span><span class="token string">"Hatch 2"</span> <span class="token punctuation">,</span> <span class="token number">2</span>D<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">"white"</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
        <span class="token function">_Hatch3</span> <span class="token punctuation">(</span><span class="token string">"Hatch 3"</span> <span class="token punctuation">,</span> <span class="token number">2</span>D<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">"white"</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
        <span class="token function">_Hatch4</span> <span class="token punctuation">(</span><span class="token string">"Hatch 4"</span> <span class="token punctuation">,</span> <span class="token number">2</span>D<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">"white"</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
        <span class="token function">_Hatch5</span> <span class="token punctuation">(</span><span class="token string">"Hatch 5"</span> <span class="token punctuation">,</span> <span class="token number">2</span>D<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">"white"</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    SubShader
    <span class="token punctuation">&#123;</span>
        Tags <span class="token punctuation">&#123;</span> <span class="token string">"RenderType"</span><span class="token operator">=</span><span class="token string">"Opaque"</span> <span class="token string">"Queue"</span><span class="token operator">=</span><span class="token string">"Geometry"</span><span class="token punctuation">&#125;</span>
        
        UsePass <span class="token string">"Custom/Chapter14_1_NPRcartoon/OUTLINE"</span>

        Pass
        <span class="token punctuation">&#123;</span>
            Tags <span class="token punctuation">&#123;</span> <span class="token string">"LightMode"</span><span class="token operator">=</span><span class="token string">"ForwardBase"</span> <span class="token punctuation">&#125;</span>
            CGPROGRAM
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">vertex vert</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">fragment frag</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">multi_compile_fwdbase</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"UnityCG.cginc"</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"AutoLight.cginc"</span></span>

            fixed4 _Color<span class="token punctuation">;</span>
            <span class="token keyword">float</span> _TileFactor<span class="token punctuation">;</span>
            <span class="token keyword">float</span> _Outline<span class="token punctuation">;</span>
            <span class="token keyword">sampler2D</span> _Hatch0<span class="token punctuation">;</span>
            <span class="token keyword">sampler2D</span> _Hatch1<span class="token punctuation">;</span>
            <span class="token keyword">sampler2D</span> _Hatch2<span class="token punctuation">;</span>
            <span class="token keyword">sampler2D</span> _Hatch3<span class="token punctuation">;</span>
            <span class="token keyword">sampler2D</span> _Hatch4<span class="token punctuation">;</span>
            <span class="token keyword">sampler2D</span> _Hatch5<span class="token punctuation">;</span>

            <span class="token keyword">struct</span> <span class="token class-name">a2v</span>
            <span class="token punctuation">&#123;</span>
                float4 vertex <span class="token operator">:</span> POSITION<span class="token punctuation">;</span>
                float3 texcoord <span class="token operator">:</span> TEXCOORD0<span class="token punctuation">;</span>
                float3 normal <span class="token operator">:</span> NORMAL<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

            <span class="token keyword">struct</span> <span class="token class-name">v2f</span>
            <span class="token punctuation">&#123;</span>
                float4 pos <span class="token operator">:</span> SV_POSITION<span class="token punctuation">;</span>
                float2 uv <span class="token operator">:</span> TEXCOORD0<span class="token punctuation">;</span>
                fixed3 hatchWeights0 <span class="token operator">:</span> TEXCOORD1<span class="token punctuation">;</span>
                fixed3 hatchWeights1 <span class="token operator">:</span> TEXCOORD2<span class="token punctuation">;</span>
                float3 worldPos <span class="token operator">:</span> TEXCOORD3<span class="token punctuation">;</span>
                <span class="token function">SHADOW_COORDS</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token comment">// put shadows data into TEXCOORD4</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
            v2f <span class="token function">vert</span> <span class="token punctuation">(</span>a2v v<span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                v2f o<span class="token punctuation">;</span>
                o<span class="token punctuation">.</span>pos <span class="token operator">=</span> <span class="token function">UnityObjectToClipPos</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>vertex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                o<span class="token punctuation">.</span>uv <span class="token operator">=</span> v<span class="token punctuation">.</span>texcoord<span class="token punctuation">.</span>xy <span class="token operator">*</span> _TileFactor<span class="token punctuation">;</span>

                fixed3 worldLightDir <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span><span class="token function">WorldSpaceLightDir</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>vertex<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                fixed3 worldNormal <span class="token operator">=</span> <span class="token function">UnityObjectToWorldNormal</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>normal<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">fixed</span> diff <span class="token operator">=</span> <span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token punctuation">,</span> <span class="token function">dot</span><span class="token punctuation">(</span>worldLightDir <span class="token punctuation">,</span> worldNormal<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                o<span class="token punctuation">.</span>hatchWeights0 <span class="token operator">=</span> <span class="token function">fixed3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                o<span class="token punctuation">.</span>hatchWeights1 <span class="token operator">=</span> <span class="token function">fixed3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">float</span> hatchFactor <span class="token operator">=</span> diff <span class="token operator">*</span> <span class="token number">7.0</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span><span class="token punctuation">(</span>hatchFactor <span class="token operator">></span> <span class="token number">6.0</span><span class="token punctuation">)</span>
                <span class="token punctuation">&#123;</span>
                    <span class="token comment">//do nothing</span>
                <span class="token punctuation">&#125;</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>hatchFactor <span class="token operator">></span> <span class="token number">5.0</span><span class="token punctuation">)</span>
                <span class="token punctuation">&#123;</span>
                    o<span class="token punctuation">.</span>hatchWeights0<span class="token punctuation">.</span>x <span class="token operator">=</span> hatchFactor <span class="token operator">-</span> <span class="token number">5.0</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>hatchFactor <span class="token operator">></span> <span class="token number">4.0</span><span class="token punctuation">)</span>
                <span class="token punctuation">&#123;</span>
                    o<span class="token punctuation">.</span>hatchWeights0<span class="token punctuation">.</span>x <span class="token operator">=</span> hatchFactor <span class="token operator">-</span> <span class="token number">4.0</span><span class="token punctuation">;</span>
                    o<span class="token punctuation">.</span>hatchWeights0<span class="token punctuation">.</span>y <span class="token operator">=</span> <span class="token number">1.0</span> <span class="token operator">-</span> o<span class="token punctuation">.</span>hatchWeights0<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>hatchFactor <span class="token operator">></span> <span class="token number">3.0</span><span class="token punctuation">)</span>
                <span class="token punctuation">&#123;</span>
                    o<span class="token punctuation">.</span>hatchWeights0<span class="token punctuation">.</span>y <span class="token operator">=</span> hatchFactor <span class="token operator">-</span> <span class="token number">3.0</span><span class="token punctuation">;</span>
                    o<span class="token punctuation">.</span>hatchWeights0<span class="token punctuation">.</span>z <span class="token operator">=</span> <span class="token number">1.0</span> <span class="token operator">-</span> o<span class="token punctuation">.</span>hatchWeights0<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>hatchFactor <span class="token operator">></span> <span class="token number">2.0</span><span class="token punctuation">)</span>
                <span class="token punctuation">&#123;</span>
                    o<span class="token punctuation">.</span>hatchWeights0<span class="token punctuation">.</span>z <span class="token operator">=</span> hatchFactor <span class="token operator">-</span> <span class="token number">2.0</span><span class="token punctuation">;</span>
                    o<span class="token punctuation">.</span>hatchWeights1<span class="token punctuation">.</span>x <span class="token operator">=</span> <span class="token number">1.0</span> <span class="token operator">-</span> o<span class="token punctuation">.</span>hatchWeights0<span class="token punctuation">.</span>z<span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>hatchFactor <span class="token operator">></span> <span class="token number">1.0</span><span class="token punctuation">)</span>
                <span class="token punctuation">&#123;</span>
                    o<span class="token punctuation">.</span>hatchWeights1<span class="token punctuation">.</span>x <span class="token operator">=</span> hatchFactor <span class="token operator">-</span> <span class="token number">1.0</span><span class="token punctuation">;</span>
                    o<span class="token punctuation">.</span>hatchWeights1<span class="token punctuation">.</span>y <span class="token operator">=</span> <span class="token number">1.0</span> <span class="token operator">-</span> o<span class="token punctuation">.</span>hatchWeights1<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span><span class="token keyword">else</span> 
                <span class="token punctuation">&#123;</span>
                    o<span class="token punctuation">.</span>hatchWeights1<span class="token punctuation">.</span>y <span class="token operator">=</span> hatchFactor<span class="token punctuation">;</span>
                    o<span class="token punctuation">.</span>hatchWeights1<span class="token punctuation">.</span>z <span class="token operator">=</span> <span class="token number">1.0</span> <span class="token operator">-</span> o<span class="token punctuation">.</span>hatchWeights1<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token comment">//这是根据光照强度来计算每个格子的权重，权重越高，格子越亮。</span>
                o<span class="token punctuation">.</span>worldPos <span class="token operator">=</span> <span class="token function">mul</span><span class="token punctuation">(</span>unity_ObjectToWorld<span class="token punctuation">,</span> v<span class="token punctuation">.</span>vertex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">TRANSFER_SHADOW</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span> <span class="token comment">// transfer shadow data to o.pos</span>
                <span class="token keyword">return</span> o<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            fixed4 <span class="token function">frag</span> <span class="token punctuation">(</span>v2f i<span class="token punctuation">)</span> <span class="token operator">:</span> SV_Target
            <span class="token punctuation">&#123;</span>
                fixed4 hatchTex0 <span class="token operator">=</span> <span class="token function">tex2D</span><span class="token punctuation">(</span>_Hatch0<span class="token punctuation">,</span> i<span class="token punctuation">.</span>uv<span class="token punctuation">)</span> <span class="token operator">*</span> i<span class="token punctuation">.</span>hatchWeights0<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
                fixed4 hatchTex1 <span class="token operator">=</span> <span class="token function">tex2D</span><span class="token punctuation">(</span>_Hatch1<span class="token punctuation">,</span> i<span class="token punctuation">.</span>uv<span class="token punctuation">)</span> <span class="token operator">*</span> i<span class="token punctuation">.</span>hatchWeights0<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
                fixed4 hatchTex2 <span class="token operator">=</span> <span class="token function">tex2D</span><span class="token punctuation">(</span>_Hatch2<span class="token punctuation">,</span> i<span class="token punctuation">.</span>uv<span class="token punctuation">)</span> <span class="token operator">*</span> i<span class="token punctuation">.</span>hatchWeights0<span class="token punctuation">.</span>z<span class="token punctuation">;</span>
                fixed4 hatchTex3 <span class="token operator">=</span> <span class="token function">tex2D</span><span class="token punctuation">(</span>_Hatch3<span class="token punctuation">,</span> i<span class="token punctuation">.</span>uv<span class="token punctuation">)</span> <span class="token operator">*</span> i<span class="token punctuation">.</span>hatchWeights1<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
                fixed4 hatchTex4 <span class="token operator">=</span> <span class="token function">tex2D</span><span class="token punctuation">(</span>_Hatch4<span class="token punctuation">,</span> i<span class="token punctuation">.</span>uv<span class="token punctuation">)</span> <span class="token operator">*</span> i<span class="token punctuation">.</span>hatchWeights1<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
                fixed4 hatchTex5 <span class="token operator">=</span> <span class="token function">tex2D</span><span class="token punctuation">(</span>_Hatch5<span class="token punctuation">,</span> i<span class="token punctuation">.</span>uv<span class="token punctuation">)</span> <span class="token operator">*</span> i<span class="token punctuation">.</span>hatchWeights1<span class="token punctuation">.</span>z<span class="token punctuation">;</span>
                fixed4 whiteColor <span class="token operator">=</span> <span class="token function">fixed4</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> i<span class="token punctuation">.</span>hatchWeights0<span class="token punctuation">.</span>x <span class="token operator">-</span> i<span class="token punctuation">.</span>hatchWeights0<span class="token punctuation">.</span>y
                    <span class="token operator">-</span> i<span class="token punctuation">.</span>hatchWeights0<span class="token punctuation">.</span>z <span class="token operator">-</span> i<span class="token punctuation">.</span>hatchWeights1<span class="token punctuation">.</span>x <span class="token operator">-</span> i<span class="token punctuation">.</span>hatchWeights1<span class="token punctuation">.</span>y <span class="token operator">-</span> i<span class="token punctuation">.</span>hatchWeights1<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">;</span>
                fixed4 hatchColor <span class="token operator">=</span> hatchTex0 <span class="token operator">+</span> hatchTex1 <span class="token operator">+</span> hatchTex2 <span class="token operator">+</span> hatchTex3
                    <span class="token operator">+</span> hatchTex4 <span class="token operator">+</span> hatchTex5 <span class="token operator">+</span> whiteColor<span class="token punctuation">;</span>
                <span class="token function">UNITY_LIGHT_ATTENUATION</span><span class="token punctuation">(</span>atten <span class="token punctuation">,</span> i <span class="token punctuation">,</span> i<span class="token punctuation">.</span>worldPos<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token function">fixed4</span><span class="token punctuation">(</span>hatchColor<span class="token punctuation">.</span>rgb <span class="token operator">*</span> _Color<span class="token punctuation">.</span>rgb <span class="token operator">*</span> atten<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            ENDCG
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    FallBack <span class="token string">"Diffuse"</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p><img src="/./../../../BlogImg/image-20250319204507614.png" alt="image-20250319204507614"></p>
<h1 id="噪声"><a href="#噪声" class="headerlink" title="噪声"></a>噪声</h1><h2 id="消融"><a href="#消融" class="headerlink" title="消融"></a>消融</h2><pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl"><span class="token comment">// Upgrade NOTE: replaced '_Object2World' with 'unity_ObjectToWorld'</span>
<span class="token comment">// Upgrade NOTE: replaced 'mul(UNITY_MATRIX_MVP,*)' with 'UnityObjectToClipPos(*)'</span>

Shader <span class="token string">"Custom/Chapter15_1_Dissolve"</span>
<span class="token punctuation">&#123;</span>
    Properties
    <span class="token punctuation">&#123;</span>
        <span class="token comment">//控制消融程度</span>
        <span class="token function">_BurnAmount</span> <span class="token punctuation">(</span><span class="token string">"Burn Amount"</span> <span class="token punctuation">,</span> <span class="token function">Range</span><span class="token punctuation">(</span><span class="token number">0.0</span> <span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0.0</span>
        
        <span class="token comment">//控制模拟烧焦时候的线宽，值越大越广</span>
        <span class="token function">_LineWidth</span><span class="token punctuation">(</span><span class="token string">"Burn Line Width"</span> <span class="token punctuation">,</span> <span class="token function">Range</span><span class="token punctuation">(</span><span class="token number">0.0</span> <span class="token punctuation">,</span> <span class="token number">2.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0.1</span>
        <span class="token function">_MainTex</span> <span class="token punctuation">(</span><span class="token string">"Base (RGB)"</span><span class="token punctuation">,</span> <span class="token number">2</span>D<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">"white"</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
        <span class="token function">_BumpMap</span> <span class="token punctuation">(</span><span class="token string">"Normal Map"</span><span class="token punctuation">,</span> <span class="token number">2</span>D<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">"bump"</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
        <span class="token function">_BurnFirstColor</span><span class="token punctuation">(</span><span class="token string">"Burn First Color"</span><span class="token punctuation">,</span> Color<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token function">_BurnSecondColor</span><span class="token punctuation">(</span><span class="token string">"Burn Second Color"</span><span class="token punctuation">,</span> Color<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>
        
        <span class="token comment">//关键的噪声纹理</span>
        <span class="token function">_BurnMap</span><span class="token punctuation">(</span><span class="token string">"Burn Map"</span><span class="token punctuation">,</span> <span class="token number">2</span>D<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">"white"</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    SubShader
    <span class="token punctuation">&#123;</span>
		Tags <span class="token punctuation">&#123;</span> <span class="token string">"RenderType"</span><span class="token operator">=</span><span class="token string">"Opaque"</span> <span class="token string">"Queue"</span><span class="token operator">=</span><span class="token string">"Geometry"</span><span class="token punctuation">&#125;</span>
        Pass
        <span class="token punctuation">&#123;</span>
            Tags <span class="token punctuation">&#123;</span> <span class="token string">"LightMode"</span><span class="token operator">=</span><span class="token string">"ForwardBase"</span> <span class="token punctuation">&#125;</span>
            
            Cull Off
            <span class="token comment">//消融时候物体背面也会渲染</span>

            CGPROGRAM

            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Lighting.cginc"</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"AutoLight.cginc"</span></span>

            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">multi_compile_fwdbase</span></span>

            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">vertex vert</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">fragment frag</span></span>

            <span class="token keyword">float</span> _BurnAmount<span class="token punctuation">;</span>
            <span class="token keyword">float</span> _LineWidth<span class="token punctuation">;</span>
            <span class="token keyword">sampler2D</span> _MainTex<span class="token punctuation">;</span> 
            <span class="token keyword">sampler2D</span> _BumpMap<span class="token punctuation">;</span>
            float4 _BurnFirstColor<span class="token punctuation">;</span>
            float4 _BurnSecondColor<span class="token punctuation">;</span>
            <span class="token keyword">sampler2D</span> _BurnMap<span class="token punctuation">;</span>

            float4 _MainTex_ST<span class="token punctuation">;</span>
            float4 _BumpMap_ST<span class="token punctuation">;</span>
            float4 _BurnMap_ST<span class="token punctuation">;</span>

            <span class="token keyword">struct</span> <span class="token class-name">a2v</span>
            <span class="token punctuation">&#123;</span>
                float4 vertex <span class="token operator">:</span> POSITION<span class="token punctuation">;</span>
                float3 normal <span class="token operator">:</span> NORMAL<span class="token punctuation">;</span>
                float4 texcoord <span class="token operator">:</span> TEXCOORD0<span class="token punctuation">;</span>
                float4 tangent <span class="token operator">:</span> TANGENT<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

            <span class="token keyword">struct</span> <span class="token class-name">v2f</span>
            <span class="token punctuation">&#123;</span>
                float4 pos <span class="token operator">:</span> SV_POSITION<span class="token punctuation">;</span>
                float2 uvMainTex <span class="token operator">:</span> TEXCOORD0<span class="token punctuation">;</span>
                float2 uvBumpMap <span class="token operator">:</span> TEXCOORD1<span class="token punctuation">;</span>
                float2 uvBurnMap <span class="token operator">:</span> TEXCOORD2<span class="token punctuation">;</span>
                float3 lightDir <span class="token operator">:</span> TEXCOORD3<span class="token punctuation">;</span>
                float3 worldPos <span class="token operator">:</span> TEXCOORD4<span class="token punctuation">;</span>
                <span class="token function">SHADOW_COORDS</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

            v2f <span class="token function">vert</span><span class="token punctuation">(</span>a2v v<span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                v2f o<span class="token punctuation">;</span>
                o<span class="token punctuation">.</span>pos <span class="token operator">=</span> <span class="token function">UnityObjectToClipPos</span><span class="token punctuation">(</span> v<span class="token punctuation">.</span>vertex<span class="token punctuation">)</span><span class="token punctuation">;</span>

                o<span class="token punctuation">.</span>uvMainTex <span class="token operator">=</span> <span class="token function">TRANSFORM_TEX</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>texcoord <span class="token punctuation">,</span> _MainTex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                o<span class="token punctuation">.</span>uvBumpMap <span class="token operator">=</span> <span class="token function">TRANSFORM_TEX</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>texcoord <span class="token punctuation">,</span> _BumpMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
				o<span class="token punctuation">.</span>uvBurnMap <span class="token operator">=</span> <span class="token function">TRANSFORM_TEX</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>texcoord<span class="token punctuation">,</span> _BurnMap<span class="token punctuation">)</span><span class="token punctuation">;</span>

                TANGENT_SPACE_ROTATION<span class="token punctuation">;</span> <span class="token comment">//切线空间置换</span>

                o<span class="token punctuation">.</span>lightDir <span class="token operator">=</span> <span class="token function">mul</span><span class="token punctuation">(</span>rotation <span class="token punctuation">,</span> <span class="token function">ObjSpaceLightDir</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>vertex<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>xyz<span class="token punctuation">;</span>
                <span class="token comment">//计算顶点到光源的光照方向。这个rotation是由模型矩阵和切线矩阵计算得到的。</span>

                o<span class="token punctuation">.</span>worldPos <span class="token operator">=</span> <span class="token function">mul</span><span class="token punctuation">(</span>unity_ObjectToWorld <span class="token punctuation">,</span> v<span class="token punctuation">.</span>vertex<span class="token punctuation">)</span><span class="token punctuation">.</span>xyz<span class="token punctuation">;</span>

                <span class="token function">TRANSFER_SHADOW</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> o<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            fixed4 <span class="token function">frag</span><span class="token punctuation">(</span>v2f i<span class="token punctuation">)</span> <span class="token operator">:</span> SV_Target
            <span class="token punctuation">&#123;</span>
                <span class="token comment">//获取纹理颜色</span>
                fixed3 burn <span class="token operator">=</span> <span class="token function">tex2D</span><span class="token punctuation">(</span>_BurnMap<span class="token punctuation">,</span> i<span class="token punctuation">.</span>uvBurnMap<span class="token punctuation">)</span><span class="token punctuation">.</span>rgb<span class="token punctuation">;</span>

                <span class="token comment">//当结果小于0的时候，像素将会被剔除</span>
                <span class="token function">clip</span><span class="token punctuation">(</span>burn<span class="token punctuation">.</span>r <span class="token operator">-</span> _BurnAmount<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//拖拽BurnAmount的值来控制消融程度,</span>
                <span class="token comment">//由于噪声图是灰白色，所以r通道的值和其他通道一样，通过看r就可以判断是否需要渲染。</span>

                float3 tangentLightDir <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>lightDir<span class="token punctuation">)</span><span class="token punctuation">;</span>
                fixed3 tangentNormal <span class="token operator">=</span> <span class="token function">UnpackNormal</span><span class="token punctuation">(</span><span class="token function">tex2D</span><span class="token punctuation">(</span>_BumpMap<span class="token punctuation">,</span> i<span class="token punctuation">.</span>uvBumpMap<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                fixed3 albedo <span class="token operator">=</span> <span class="token function">tex2D</span><span class="token punctuation">(</span>_MainTex <span class="token punctuation">,</span> i<span class="token punctuation">.</span>uvMainTex<span class="token punctuation">)</span><span class="token punctuation">.</span>rgb<span class="token punctuation">;</span>

                fixed3 ambient <span class="token operator">=</span> UNITY_LIGHTMODEL_AMBIENT<span class="token punctuation">.</span>xyz <span class="token operator">*</span> albedo<span class="token punctuation">;</span>
                fixed3 diffuse <span class="token operator">=</span> _LightColor0<span class="token punctuation">.</span>rgb <span class="token operator">*</span> albedo <span class="token operator">*</span> <span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token punctuation">,</span> <span class="token function">dot</span><span class="token punctuation">(</span>tangentNormal 
                    <span class="token punctuation">,</span> tangentLightDir<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                
                fixed3 t <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">-</span> <span class="token function">smoothstep</span><span class="token punctuation">(</span><span class="token number">0.0</span> <span class="token punctuation">,</span> _LineWidth <span class="token punctuation">,</span> burn<span class="token punctuation">.</span>r <span class="token operator">-</span> _BurnAmount<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获得燃烧的线宽，由燃烧程度度决定</span>
                <span class="token comment">//burn.r - _BurnAmount（燃烧程度）的值越小，t越趋近于1</span>
                fixed3 burnColor <span class="token operator">=</span> <span class="token function">lerp</span><span class="token punctuation">(</span>_BurnFirstColor<span class="token punctuation">.</span>rgb <span class="token punctuation">,</span> _BurnSecondColor<span class="token punctuation">.</span>rgb <span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//在燃烧的两种颜色之间进行插值</span>
                <span class="token comment">//如果燃烧程度接近于1，则颜色趋近于第二种颜色，否则趋近于第一种颜色</span>
                burnColor <span class="token operator">=</span> <span class="token function">pow</span><span class="token punctuation">(</span>burnColor <span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//让颜色更加鲜艳</span>

                <span class="token function">UNITY_LIGHT_ATTENUATION</span><span class="token punctuation">(</span>atten <span class="token punctuation">,</span> i <span class="token punctuation">,</span> i<span class="token punctuation">.</span>worldPos<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//处理光照衰减</span>
                fixed3 finalColor <span class="token operator">=</span> <span class="token function">lerp</span> <span class="token punctuation">(</span>ambient <span class="token operator">+</span> diffuse <span class="token operator">*</span> atten <span class="token punctuation">,</span> burnColor <span class="token punctuation">,</span>
                    t <span class="token operator">*</span> <span class="token function">step</span><span class="token punctuation">(</span><span class="token number">0.001</span> <span class="token punctuation">,</span> burn<span class="token punctuation">.</span>r <span class="token operator">-</span> _BurnAmount<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//当burn.r - _BurnAmount小于0.001时，step函数会返回0，否则返回1</span>
                    <span class="token comment">//这使得在燃烧边缘附近的像素能够平滑过渡到燃烧颜色，而不是突然变化。</span>

                <span class="token keyword">return</span> <span class="token function">fixed4</span><span class="token punctuation">(</span>finalColor <span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            ENDCG
        <span class="token punctuation">&#125;</span>

        Pass
        <span class="token punctuation">&#123;</span>
            Tags <span class="token punctuation">&#123;</span> <span class="token string">"LightMode"</span> <span class="token operator">=</span> <span class="token string">"ShadowCaster"</span><span class="token punctuation">&#125;</span>

            CGPROGRAM
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">vertex vert</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">fragment frag</span></span>

            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">multi_compile_shadowcaster</span></span>

			<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"UnityCG.cginc"</span></span>
            
			<span class="token keyword">fixed</span> _BurnAmount<span class="token punctuation">;</span>
			<span class="token keyword">sampler2D</span> _BurnMap<span class="token punctuation">;</span>
			float4 _BurnMap_ST<span class="token punctuation">;</span>

            <span class="token keyword">struct</span> <span class="token class-name">v2f</span>
            <span class="token punctuation">&#123;</span>
                V2F_SHADOW_CASTER<span class="token punctuation">;</span>
                float2 uvBurnMap <span class="token operator">:</span> TEXCOORD1<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

            v2f <span class="token function">vert</span><span class="token punctuation">(</span>appdata_base v<span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                v2f o<span class="token punctuation">;</span>
                <span class="token function">TRANSFER_SHADOW_CASTER_NORMALOFFSET</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span>

                o<span class="token punctuation">.</span>uvBurnMap <span class="token operator">=</span> <span class="token function">TRANSFORM_TEX</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>texcoord <span class="token punctuation">,</span> _BurnMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> o<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            fixed4 <span class="token function">frag</span><span class="token punctuation">(</span>v2f i<span class="token punctuation">)</span> <span class="token operator">:</span> SV_Target
            <span class="token punctuation">&#123;</span>
                fixed3 burn <span class="token operator">=</span> <span class="token function">tex2D</span><span class="token punctuation">(</span>_BurnMap <span class="token punctuation">,</span> i<span class="token punctuation">.</span>uvBurnMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">clip</span><span class="token punctuation">(</span>burn<span class="token punctuation">.</span>r <span class="token operator">-</span> _BurnAmount<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">SHADOW_CASTER_FRAGMENT</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            ENDCG
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    FallBack Off
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="/./../../../BlogImg/20250319225314288.png" alt="image-20250319225041910"></p>
<h2 id="水波"><a href="#水波" class="headerlink" title="水波"></a>水波</h2><pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl"><span class="token comment">// Upgrade NOTE: replaced '_Object2World' with 'unity_ObjectToWorld'</span>
<span class="token comment">// Upgrade NOTE: replaced 'mul(UNITY_MATRIX_MVP,*)' with 'UnityObjectToClipPos(*)'</span>

Shader <span class="token string">"Custom/Chapter15_2_WaterWave"</span>
<span class="token punctuation">&#123;</span>
    Properties
    <span class="token punctuation">&#123;</span>
        <span class="token function">_Color</span> <span class="token punctuation">(</span><span class="token string">"Main Color"</span> <span class="token punctuation">,</span> Color<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token punctuation">,</span> <span class="token number">0.15</span> <span class="token punctuation">,</span> <span class="token number">0.115</span> <span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token function">_MainTex</span> <span class="token punctuation">(</span><span class="token string">"Base(RGB)"</span> <span class="token punctuation">,</span> <span class="token number">2</span>D<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">"white"</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
        <span class="token function">_WaveMap</span> <span class="token punctuation">(</span><span class="token string">"Wave Map"</span> <span class="token punctuation">,</span> <span class="token number">2</span>D<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">"bump"</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
        <span class="token function">_Cubemap</span> <span class="token punctuation">(</span><span class="token string">"Environment Cubemap"</span> <span class="token punctuation">,</span> Cube<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">"_Skybox"</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>

        <span class="token comment">//控制发现纹理在X轴和Y轴的速度</span>
        <span class="token function">_WaveXSpeed</span> <span class="token punctuation">(</span><span class="token string">"Wace Horizontal Speed"</span> <span class="token punctuation">,</span> <span class="token function">Range</span><span class="token punctuation">(</span> <span class="token operator">-</span><span class="token number">0.1</span> <span class="token punctuation">,</span> <span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0.01</span>
        <span class="token function">_WaveYSpeed</span> <span class="token punctuation">(</span><span class="token string">"Wave Vertical Speed"</span> <span class="token punctuation">,</span> <span class="token function">Range</span><span class="token punctuation">(</span> <span class="token operator">-</span><span class="token number">0.1</span> <span class="token punctuation">,</span> <span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0.01</span>

        <span class="token comment">//控制折射时候图像的扭曲程度</span>
        <span class="token function">_Distortion</span> <span class="token punctuation">(</span><span class="token string">"Distortion"</span> <span class="token punctuation">,</span> <span class="token function">Range</span><span class="token punctuation">(</span> <span class="token number">0</span> <span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">10</span>
    <span class="token punctuation">&#125;</span>
    SubShader
    <span class="token punctuation">&#123;</span>
        Tags <span class="token punctuation">&#123;</span> <span class="token string">"Queue"</span> <span class="token operator">=</span> <span class="token string">"Transparent"</span> <span class="token string">"RenderType"</span> <span class="token operator">=</span> <span class="token string">"Opaque"</span><span class="token punctuation">&#125;</span>
        GrabPass <span class="token punctuation">&#123;</span><span class="token string">"_RefractionTex"</span><span class="token punctuation">&#125;</span><span class="token comment">//通过GrabPass定义了一个抓取屏幕的纹理，并将其命名为_RefractionTex</span>
        
        Pass<span class="token punctuation">&#123;</span>
            CGPROGRAM
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">vertex vert</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">fragment frag</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"UnityCG.cginc"</span></span>

            fixed4 _Color<span class="token punctuation">;</span>
            <span class="token keyword">sampler2D</span> _MainTex<span class="token punctuation">;</span>
            float4 _MainTex_ST<span class="token punctuation">;</span>
            <span class="token keyword">sampler2D</span> _WaveMap<span class="token punctuation">;</span>
            float4 _WaveMap_ST<span class="token punctuation">;</span>
            samplerCUBE _Cubemap<span class="token punctuation">;</span>
            <span class="token keyword">fixed</span> _WaveXSpeed<span class="token punctuation">;</span>
            <span class="token keyword">fixed</span> _WaveYSpeed<span class="token punctuation">;</span>
            <span class="token keyword">float</span> _Distortion<span class="token punctuation">;</span>

            <span class="token comment">//定义这两个变量，对应了GrabPass</span>
            <span class="token keyword">sampler2D</span> _RefractionTex<span class="token punctuation">;</span>
            float4 _RefractionTex_TexelSize<span class="token punctuation">;</span>

            <span class="token keyword">struct</span> <span class="token class-name">a2v</span>
            <span class="token punctuation">&#123;</span>
                float4 vertex <span class="token operator">:</span> POSITION<span class="token punctuation">;</span>
                float3 normal <span class="token operator">:</span> NORMAL<span class="token punctuation">;</span>
                float4 tangent <span class="token operator">:</span> TANGENT<span class="token punctuation">;</span>
                float2 texcoord <span class="token operator">:</span> TEXCOORD0<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
            <span class="token keyword">struct</span> <span class="token class-name">v2f</span>
            <span class="token punctuation">&#123;</span>
                float4 pos <span class="token operator">:</span> SV_POSITION<span class="token punctuation">;</span>
                float4 scrPos <span class="token operator">:</span> TEXCOORD0<span class="token punctuation">;</span><span class="token comment">//scrPos存储的是屏幕上的坐标</span>
                float4 uv <span class="token operator">:</span> TEXCOORD1<span class="token punctuation">;</span><span class="token comment">//存储两个uv，分别对应了主纹理和波纹纹理</span>
                float4 TtoW0 <span class="token operator">:</span> TEXCOORD2<span class="token punctuation">;</span>
                float4 TtoW1 <span class="token operator">:</span> TEXCOORD3<span class="token punctuation">;</span>
                float4 TtoW2 <span class="token operator">:</span> TEXCOORD4<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

            v2f <span class="token function">vert</span><span class="token punctuation">(</span>a2v v<span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                v2f o<span class="token punctuation">;</span>
                o<span class="token punctuation">.</span>pos <span class="token operator">=</span> <span class="token function">UnityObjectToClipPos</span><span class="token punctuation">(</span> v<span class="token punctuation">.</span>vertex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                o<span class="token punctuation">.</span>scrPos <span class="token operator">=</span> <span class="token function">ComputeGrabScreenPos</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span>pos<span class="token punctuation">)</span><span class="token punctuation">;</span>

                o<span class="token punctuation">.</span>uv<span class="token punctuation">.</span>xy <span class="token operator">=</span> <span class="token function">TRANSFORM_TEX</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>texcoord <span class="token punctuation">,</span> _MainTex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                o<span class="token punctuation">.</span>uv<span class="token punctuation">.</span>zw <span class="token operator">=</span> <span class="token function">TRANSFORM_TEX</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>texcoord <span class="token punctuation">,</span> _WaveMap<span class="token punctuation">)</span><span class="token punctuation">;</span>

                float3 worldPos <span class="token operator">=</span> <span class="token function">mul</span><span class="token punctuation">(</span>unity_ObjectToWorld <span class="token punctuation">,</span> v<span class="token punctuation">.</span>vertex<span class="token punctuation">)</span><span class="token punctuation">.</span>xyz<span class="token punctuation">;</span>
                fixed3 worldNormal <span class="token operator">=</span> <span class="token function">UnityObjectToWorldNormal</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>normal<span class="token punctuation">)</span><span class="token punctuation">;</span>
                fixed3 worldTangent <span class="token operator">=</span> <span class="token function">UnityObjectToWorldDir</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>tangent<span class="token punctuation">.</span>xyz<span class="token punctuation">)</span><span class="token punctuation">;</span>
                fixed3 worldBinormal <span class="token operator">=</span> <span class="token function">cross</span><span class="token punctuation">(</span>worldNormal <span class="token punctuation">,</span> worldTangent<span class="token punctuation">)</span><span class="token punctuation">;</span>

                o<span class="token punctuation">.</span>TtoW0 <span class="token operator">=</span> <span class="token function">float4</span><span class="token punctuation">(</span>worldTangent<span class="token punctuation">.</span>x <span class="token punctuation">,</span> worldBinormal<span class="token punctuation">.</span>x <span class="token punctuation">,</span> worldNormal<span class="token punctuation">.</span>x <span class="token punctuation">,</span> worldPos<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
                o<span class="token punctuation">.</span>TtoW1 <span class="token operator">=</span> <span class="token function">float4</span><span class="token punctuation">(</span>worldTangent<span class="token punctuation">.</span>y <span class="token punctuation">,</span> worldBinormal<span class="token punctuation">.</span>y <span class="token punctuation">,</span> worldNormal<span class="token punctuation">.</span>y <span class="token punctuation">,</span> worldPos<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
                o<span class="token punctuation">.</span>TtoW2 <span class="token operator">=</span> <span class="token function">float4</span><span class="token punctuation">(</span>worldTangent<span class="token punctuation">.</span>z <span class="token punctuation">,</span> worldBinormal<span class="token punctuation">.</span>z <span class="token punctuation">,</span> worldNormal<span class="token punctuation">.</span>z <span class="token punctuation">,</span> worldPos<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">return</span> o<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            <span class="token comment">//通过必要的顶点坐标变换之后，我们通过调用ComputeGrabScreenPos来得到被抓取屏幕图像的</span>
            <span class="token comment">//采样坐标。我们可以在UnityCG.cginc找到ComputeGrabScreenPos的定义。</span>
            <span class="token comment">//它的主要代码和ComputeScreenPos类似，最大的不同是针对平台差异造成的采样坐标问题进行了处理</span>
            <span class="token comment">//接着我们计算了_MainTex和_BumpMap的采样坐标，并且把它们分别存储在一个float4类型的变量uv中</span>
            <span class="token comment">//由于我们需要在片段着色器中把法线方向从切线空间变换到世界空间下，以便对CubeMap进行采样</span>
            <span class="token comment">//因此我们需要在这里计算该顶点对应的从切线空间到世界空间的变换矩阵。</span>

            fixed4 <span class="token function">frag</span><span class="token punctuation">(</span>v2f i<span class="token punctuation">)</span> <span class="token operator">:</span> SV_Target
            <span class="token punctuation">&#123;</span>
                float3 worldPos <span class="token operator">=</span> <span class="token function">float3</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>TtoW0<span class="token punctuation">.</span>w <span class="token punctuation">,</span> i<span class="token punctuation">.</span>TtoW1<span class="token punctuation">.</span>w <span class="token punctuation">,</span> i<span class="token punctuation">.</span>TtoW2<span class="token punctuation">.</span>w<span class="token punctuation">)</span><span class="token punctuation">;</span>
                fixed3 viewDir <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span><span class="token function">UnityWorldSpaceViewDir</span><span class="token punctuation">(</span>worldPos<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                float2 speed <span class="token operator">=</span> _Time<span class="token punctuation">.</span>y <span class="token operator">*</span> <span class="token function">float2</span><span class="token punctuation">(</span>_WaveXSpeed <span class="token punctuation">,</span> _WaveYSpeed<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">//获得在切线空间下的法向量，由于是REPEAT模式，所以不用担心会超出纹理范围</span>
                <span class="token comment">//UnpackNormal函数可以将一个贴图的RGB值转换为一个法向量</span>
                <span class="token comment">//这是为了模拟两层交叉的水面波动的情况</span>
                fixed3 bump1 <span class="token operator">=</span> <span class="token function">UnpackNormal</span><span class="token punctuation">(</span><span class="token function">tex2D</span><span class="token punctuation">(</span>_WaveMap <span class="token punctuation">,</span> i<span class="token punctuation">.</span>uv<span class="token punctuation">.</span>zw <span class="token operator">+</span> speed<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>rgb<span class="token punctuation">;</span>
                fixed3 bump2 <span class="token operator">=</span> <span class="token function">UnpackNormal</span><span class="token punctuation">(</span><span class="token function">tex2D</span><span class="token punctuation">(</span>_WaveMap <span class="token punctuation">,</span> i<span class="token punctuation">.</span>uv<span class="token punctuation">.</span>zw <span class="token operator">-</span> speed<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>rgb<span class="token punctuation">;</span>
                fixed3 bump <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>bump1 <span class="token operator">+</span> bump2<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取两个法向量的平均值，并归一化</span>
                <span class="token comment">//得到切线下的法向量（其实就是不加上speed的法向量）</span>

                <span class="token comment">//在切线空间下处理折射</span>
                <span class="token comment">//因为切线方向下的法线可以反映顶点局部空间下的法线方向。</span>
                <span class="token comment">//scrPos.x = x_ndc * w 并不是直接计算屏幕坐标，而是 把 NDC 反推回裁剪空间（Clip Space） 的计算方法。</span>
                float2 offset <span class="token operator">=</span> bump<span class="token punctuation">.</span>xy <span class="token operator">*</span> _Distortion <span class="token operator">*</span> _RefractionTex_TexelSize<span class="token punctuation">.</span>xy<span class="token punctuation">;</span>
                i<span class="token punctuation">.</span>scrPos<span class="token punctuation">.</span>xy <span class="token operator">=</span> offset <span class="token operator">*</span> i<span class="token punctuation">.</span>scrPos<span class="token punctuation">.</span>z <span class="token operator">+</span> i<span class="token punctuation">.</span>scrPos<span class="token punctuation">.</span>xy<span class="token punctuation">;</span><span class="token comment">//根据其深度进行偏移，模拟折射</span>
                
                fixed3 refrCol <span class="token operator">=</span> <span class="token function">tex2D</span><span class="token punctuation">(</span>_RefractionTex <span class="token punctuation">,</span> i<span class="token punctuation">.</span>scrPos<span class="token punctuation">.</span>xy <span class="token operator">/</span> i<span class="token punctuation">.</span>scrPos<span class="token punctuation">.</span>w<span class="token punctuation">)</span><span class="token punctuation">.</span>rgb<span class="token punctuation">;</span>
                <span class="token comment">//i.scrPos.xy为什么要除i.scrPos.w</span>

                bump <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span><span class="token function">half3</span> <span class="token punctuation">(</span><span class="token function">dot</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>TtoW0<span class="token punctuation">.</span>xyz <span class="token punctuation">,</span> bump<span class="token punctuation">)</span> <span class="token punctuation">,</span>
                <span class="token function">dot</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>TtoW1<span class="token punctuation">.</span>xyz <span class="token punctuation">,</span> bump<span class="token punctuation">)</span> <span class="token punctuation">,</span>
                <span class="token function">dot</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>TtoW2<span class="token punctuation">.</span>xyz <span class="token punctuation">,</span> bump<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//将切线空间下的法向量变换到世界空间下</span>

                <span class="token comment">//计算反射颜色</span>
                fixed4 texColor <span class="token operator">=</span> <span class="token function">tex2D</span><span class="token punctuation">(</span>_MainTex <span class="token punctuation">,</span> i<span class="token punctuation">.</span>uv<span class="token punctuation">.</span>xy<span class="token punctuation">)</span><span class="token punctuation">;</span>
                fixed3 reflDir <span class="token operator">=</span> <span class="token function">reflect</span><span class="token punctuation">(</span><span class="token operator">-</span>viewDir <span class="token punctuation">,</span> bump<span class="token punctuation">)</span><span class="token punctuation">;</span>
                fixed3 reflCol <span class="token operator">=</span> <span class="token function">texCUBE</span><span class="token punctuation">(</span>_Cubemap <span class="token punctuation">,</span> reflDir<span class="token punctuation">)</span><span class="token punctuation">.</span>rgb <span class="token operator">*</span> texColor<span class="token punctuation">.</span>rgb <span class="token operator">*</span> _Color<span class="token punctuation">.</span>rgb<span class="token punctuation">;</span>

                <span class="token comment">//fresnel 处理</span>
                <span class="token keyword">fixed</span> fresnel<span class="token operator">=</span> <span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> <span class="token function">saturate</span><span class="token punctuation">(</span><span class="token function">dot</span><span class="token punctuation">(</span>viewDir <span class="token punctuation">,</span> bump<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token comment">//套公式</span>
                fixed3 finalColor <span class="token operator">=</span> reflCol <span class="token operator">*</span> fresnel <span class="token operator">+</span> refrCol <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> fresnel<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">return</span> <span class="token function">fixed4</span><span class="token punctuation">(</span>finalColor <span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">//TODO</span>
            <span class="token punctuation">&#125;</span>
            ENDCG
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    FallBack <span class="token string">"Diffuse"</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="/./../../../BlogImg/image-20250320003746039.png" alt="image-20250320003746039"></p>
<p>注意我们可以直接从噪声纹理生成normalmap（原理为高度图），但是注意要勾选这几个选项<br><img src="/./../../../BlogImg/image-20250320003901859.png" alt="image-20250320003901859"></p>
<h2 id="动态雾"><a href="#动态雾" class="headerlink" title="动态雾"></a>动态雾</h2><pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl"><span class="token keyword">using</span> System<span class="token punctuation">;</span>
<span class="token keyword">using</span> System<span class="token punctuation">.</span>Collections<span class="token punctuation">;</span>
<span class="token keyword">using</span> System<span class="token punctuation">.</span>Collections<span class="token punctuation">.</span>Generic<span class="token punctuation">;</span>
<span class="token keyword">using</span> System<span class="token punctuation">.</span>Linq<span class="token punctuation">.</span>Expressions<span class="token punctuation">;</span>
<span class="token keyword">using</span> UnityEngine<span class="token punctuation">;</span>
<span class="token keyword">using</span> UnityEngine<span class="token punctuation">.</span>Rendering<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> NoiseFog <span class="token operator">:</span> PostEffectsBase
<span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> Shader fogShader<span class="token punctuation">;</span>
    private Material fogMaterial <span class="token operator">=</span> null<span class="token punctuation">;</span>

    <span class="token keyword">public</span> Material material
    <span class="token punctuation">&#123;</span>
        get
        <span class="token punctuation">&#123;</span>
            fogMaterial <span class="token operator">=</span> <span class="token function">CheckShaderAndCreateMaterial</span><span class="token punctuation">(</span>fogShader<span class="token punctuation">,</span> fogMaterial<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> fogMaterial<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    private Camera myCamera<span class="token punctuation">;</span>
    <span class="token keyword">public</span> Camera MyCamera
    <span class="token punctuation">&#123;</span>
        get
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>myCamera <span class="token operator">==</span> null<span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                myCamera <span class="token operator">=</span> GetComponent<span class="token operator">&lt;</span>Camera<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">return</span> myCamera<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    private Transform myCameraTransform<span class="token punctuation">;</span>
    <span class="token keyword">public</span> Transform cameraTransform
    <span class="token punctuation">&#123;</span>
        get
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>myCameraTransform <span class="token operator">==</span> null<span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                myCameraTransform <span class="token operator">=</span> MyCamera<span class="token punctuation">.</span>transform<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">return</span> myCameraTransform<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token punctuation">[</span><span class="token function">Range</span><span class="token punctuation">(</span><span class="token number">0.1f</span><span class="token punctuation">,</span> <span class="token number">3.0f</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token keyword">float</span> fogDensity <span class="token operator">=</span> <span class="token number">1.0f</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> Color fogColor <span class="token operator">=</span> Color<span class="token punctuation">.</span>white<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">float</span> fogStart <span class="token operator">=</span> <span class="token number">0.0f</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">float</span> fogEnd <span class="token operator">=</span> <span class="token number">2.0f</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> Texture noiseTexture<span class="token punctuation">;</span>

    <span class="token punctuation">[</span><span class="token function">Range</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.5f</span><span class="token punctuation">,</span> <span class="token number">0.5f</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token keyword">float</span> fogXSpeed <span class="token operator">=</span> <span class="token number">0.1f</span><span class="token punctuation">;</span>
    <span class="token punctuation">[</span><span class="token function">Range</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.5f</span><span class="token punctuation">,</span> <span class="token number">0.5f</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token keyword">float</span> fogYSpeed <span class="token operator">=</span> <span class="token number">0.1f</span><span class="token punctuation">;</span>
    <span class="token punctuation">[</span><span class="token function">Range</span><span class="token punctuation">(</span><span class="token number">0.0f</span><span class="token punctuation">,</span> <span class="token number">3.0f</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token keyword">float</span> noiseAmount <span class="token operator">=</span> <span class="token number">1.0f</span><span class="token punctuation">;</span>

    <span class="token keyword">void</span> <span class="token function">OnEnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    <span class="token punctuation">&#123;</span>
        GetComponent<span class="token operator">&lt;</span>Camera<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>depthTextureMode <span class="token operator">|=</span> DepthTextureMode<span class="token punctuation">.</span>Depth<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">void</span> <span class="token function">OnRenderImage</span><span class="token punctuation">(</span>RenderTexture src <span class="token punctuation">,</span> RenderTexture dest<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>material <span class="token operator">!=</span> null<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            Matrix4x4 frustumCorners <span class="token operator">=</span> Matrix4x4<span class="token punctuation">.</span>identity<span class="token punctuation">;</span>

            <span class="token comment">//Compute frustum corners</span>
            <span class="token comment">//回顾：获得摄像机上四个对角上的向量</span>
            <span class="token keyword">float</span> fov <span class="token operator">=</span> MyCamera<span class="token punctuation">.</span>fieldOfView<span class="token punctuation">;</span><span class="token comment">//获得垂直方向上的视角</span>
            <span class="token keyword">float</span> aspect <span class="token operator">=</span> MyCamera<span class="token punctuation">.</span>aspect<span class="token punctuation">;</span>
            <span class="token keyword">float</span> near <span class="token operator">=</span> MyCamera<span class="token punctuation">.</span>nearClipPlane<span class="token punctuation">;</span>
            <span class="token comment">//float camFar = MyCamera.farClipPlane;</span>

            <span class="token keyword">float</span> halfHeight <span class="token operator">=</span> near <span class="token operator">*</span> Mathf<span class="token punctuation">.</span><span class="token function">Tan</span><span class="token punctuation">(</span>fov <span class="token operator">*</span> <span class="token number">0.5f</span> <span class="token operator">*</span> Mathf<span class="token punctuation">.</span>Deg2Rad<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获得在近平面上一半的高度</span>
            Vector3 toRight <span class="token operator">=</span> halfHeight <span class="token operator">*</span> aspect <span class="token operator">*</span> myCamera<span class="token punctuation">.</span>transform<span class="token punctuation">.</span>right<span class="token punctuation">;</span>
            Vector3 toTop <span class="token operator">=</span> halfHeight <span class="token operator">*</span> myCamera<span class="token punctuation">.</span>transform<span class="token punctuation">.</span>up<span class="token punctuation">;</span>

            Vector3 topLeft <span class="token operator">=</span> cameraTransform<span class="token punctuation">.</span>forward <span class="token operator">*</span> near <span class="token operator">+</span> toTop <span class="token operator">-</span> toRight<span class="token punctuation">;</span>
            <span class="token comment">//</span>
            <span class="token keyword">float</span> scale <span class="token operator">=</span> topLeft<span class="token punctuation">.</span>magnitude <span class="token operator">/</span> near<span class="token punctuation">;</span><span class="token comment">//使用相似三角形</span>
            topLeft<span class="token punctuation">.</span><span class="token function">Normalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            topLeft <span class="token operator">*=</span> scale<span class="token punctuation">;</span><span class="token comment">//让四个角上的向量变成和near距离的缩放尺度，避免了投影计算的不一致性</span>

            Vector3 bottomLeft <span class="token operator">=</span> cameraTransform<span class="token punctuation">.</span>forward <span class="token operator">*</span> near <span class="token operator">-</span> toTop <span class="token operator">-</span> toRight<span class="token punctuation">;</span>
            bottomLeft<span class="token punctuation">.</span><span class="token function">Normalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            bottomLeft <span class="token operator">*=</span> scale<span class="token punctuation">;</span>

            Vector3 topRight <span class="token operator">=</span> cameraTransform<span class="token punctuation">.</span>forward <span class="token operator">*</span> near <span class="token operator">+</span> toTop <span class="token operator">+</span> toRight<span class="token punctuation">;</span>
            topRight<span class="token punctuation">.</span><span class="token function">Normalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            topRight <span class="token operator">*=</span> scale<span class="token punctuation">;</span>

            Vector3 bottomRight <span class="token operator">=</span> cameraTransform<span class="token punctuation">.</span>forward <span class="token operator">*</span> near <span class="token operator">-</span> toTop <span class="token operator">+</span> toRight<span class="token punctuation">;</span>
            bottomRight<span class="token punctuation">.</span><span class="token function">Normalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            bottomRight <span class="token operator">*=</span> scale<span class="token punctuation">;</span>

            frustumCorners<span class="token punctuation">.</span><span class="token function">SetRow</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token punctuation">,</span> bottomLeft<span class="token punctuation">)</span><span class="token punctuation">;</span>
            frustumCorners<span class="token punctuation">.</span><span class="token function">SetRow</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token punctuation">,</span> bottomRight<span class="token punctuation">)</span><span class="token punctuation">;</span>
            frustumCorners<span class="token punctuation">.</span><span class="token function">SetRow</span><span class="token punctuation">(</span><span class="token number">2</span> <span class="token punctuation">,</span> topRight<span class="token punctuation">)</span><span class="token punctuation">;</span>
            frustumCorners<span class="token punctuation">.</span><span class="token function">SetRow</span><span class="token punctuation">(</span><span class="token number">3</span> <span class="token punctuation">,</span> topLeft<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//TODO</span>
            material<span class="token punctuation">.</span><span class="token function">SetMatrix</span><span class="token punctuation">(</span><span class="token string">"_FrustumCornersRay"</span><span class="token punctuation">,</span> frustumCorners<span class="token punctuation">)</span><span class="token punctuation">;</span>

            material<span class="token punctuation">.</span><span class="token function">SetFloat</span><span class="token punctuation">(</span><span class="token string">"_FogStart"</span><span class="token punctuation">,</span> fogStart<span class="token punctuation">)</span><span class="token punctuation">;</span>
            material<span class="token punctuation">.</span><span class="token function">SetFloat</span><span class="token punctuation">(</span><span class="token string">"_FogEnd"</span><span class="token punctuation">,</span> fogEnd<span class="token punctuation">)</span><span class="token punctuation">;</span>

            material<span class="token punctuation">.</span><span class="token function">SetColor</span><span class="token punctuation">(</span><span class="token string">"_FogColor"</span> <span class="token punctuation">,</span> fogColor<span class="token punctuation">)</span><span class="token punctuation">;</span>
            material<span class="token punctuation">.</span><span class="token function">SetFloat</span><span class="token punctuation">(</span><span class="token string">"_FogDensity"</span> <span class="token punctuation">,</span> fogDensity<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//添加的代码</span>
            material<span class="token punctuation">.</span><span class="token function">SetTexture</span><span class="token punctuation">(</span><span class="token string">"_NoiseTex"</span><span class="token punctuation">,</span> noiseTexture<span class="token punctuation">)</span><span class="token punctuation">;</span>
            material<span class="token punctuation">.</span><span class="token function">SetFloat</span><span class="token punctuation">(</span><span class="token string">"_FogXSpeed"</span><span class="token punctuation">,</span>fogXSpeed<span class="token punctuation">)</span><span class="token punctuation">;</span>
            material<span class="token punctuation">.</span><span class="token function">SetFloat</span><span class="token punctuation">(</span><span class="token string">"_FogYSpeed"</span><span class="token punctuation">,</span> fogYSpeed<span class="token punctuation">)</span><span class="token punctuation">;</span>
            material<span class="token punctuation">.</span><span class="token function">SetFloat</span><span class="token punctuation">(</span><span class="token string">"_NoiseAmount"</span><span class="token punctuation">,</span> noiseAmount<span class="token punctuation">)</span><span class="token punctuation">;</span>

            Graphics<span class="token punctuation">.</span><span class="token function">Blit</span><span class="token punctuation">(</span>src <span class="token punctuation">,</span> dest <span class="token punctuation">,</span> material<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">&#123;</span>
            Graphics<span class="token punctuation">.</span><span class="token function">Blit</span><span class="token punctuation">(</span>src <span class="token punctuation">,</span> dest<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl">Shader <span class="token string">"Custom/Chapter15_3_FogWithNoise"</span>
<span class="token punctuation">&#123;</span>
    Properties
    <span class="token punctuation">&#123;</span>
		<span class="token function">_MainTex</span> <span class="token punctuation">(</span><span class="token string">"Base (RGB)"</span><span class="token punctuation">,</span> <span class="token number">2</span>D<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">"white"</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
        <span class="token function">_FogDensity</span> <span class="token punctuation">(</span><span class="token string">"Fog Density"</span> <span class="token punctuation">,</span> Float<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1.0</span>
        <span class="token function">_FogColor</span> <span class="token punctuation">(</span><span class="token string">"Fog Color"</span> <span class="token punctuation">,</span> Color<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token punctuation">,</span> <span class="token number">1</span> <span class="token punctuation">,</span><span class="token number">1</span> <span class="token punctuation">)</span>
        <span class="token function">_FogStart</span> <span class="token punctuation">(</span><span class="token string">"Fog Start"</span> <span class="token punctuation">,</span> Float<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0.0</span>
        <span class="token function">_FogEnd</span> <span class="token punctuation">(</span><span class="token string">"Fog End"</span> <span class="token punctuation">,</span> Float<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1.0</span>
        <span class="token function">_NoiseTex</span> <span class="token punctuation">(</span><span class="token string">"Noise Texture"</span> <span class="token punctuation">,</span> <span class="token number">2</span>D<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">"white"</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
        <span class="token function">_FogXSpeed</span> <span class="token punctuation">(</span><span class="token string">"Fog X Speed"</span> <span class="token punctuation">,</span> Float<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0.1</span>
        <span class="token function">_FogYSpeed</span> <span class="token punctuation">(</span><span class="token string">"Fog Y Speed"</span> <span class="token punctuation">,</span> Float<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0.1</span>
        <span class="token function">_NoiseAmount</span> <span class="token punctuation">(</span><span class="token string">"Noise Amount"</span> <span class="token punctuation">,</span> Float<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span>
    <span class="token punctuation">&#125;</span>

    SubShader
    <span class="token punctuation">&#123;</span>
        CGINCLUDE

        <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"UnityCG.cginc"</span></span>
        <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"AutoLight.cginc"</span></span>
        <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Lighting.cginc"</span></span>

        float4x4 _FrustumCornersRay<span class="token punctuation">;</span>

        <span class="token keyword">sampler2D</span> _MainTex<span class="token punctuation">;</span>
        half4 _MainTex_TexelSize<span class="token punctuation">;</span>
        <span class="token keyword">sampler2D</span> _CameraDepthTexture<span class="token punctuation">;</span>
        <span class="token keyword">half</span> _FogDensity<span class="token punctuation">;</span>
        fixed4 _FogColor<span class="token punctuation">;</span>
        <span class="token keyword">float</span> _FogStart<span class="token punctuation">;</span>
        <span class="token keyword">float</span> _FogEnd<span class="token punctuation">;</span>
        <span class="token keyword">sampler2D</span> _NoiseTex<span class="token punctuation">;</span>
        <span class="token keyword">half</span> _FogXSpeed<span class="token punctuation">;</span>
        <span class="token keyword">half</span> _FogYSpeed<span class="token punctuation">;</span>
        <span class="token keyword">half</span> _NoiseAmount<span class="token punctuation">;</span>

        <span class="token keyword">struct</span> <span class="token class-name">v2f</span>
        <span class="token punctuation">&#123;</span>
            float4 pos <span class="token operator">:</span> SV_POSITION<span class="token punctuation">;</span>
            float2 uv <span class="token operator">:</span> TEXCOORD0<span class="token punctuation">;</span>
            float2 uv_depth <span class="token operator">:</span> TEXCOORD1<span class="token punctuation">;</span>
            float4 interpolatedRay <span class="token operator">:</span> TEXCOORD2<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

        v2f <span class="token function">vert</span><span class="token punctuation">(</span>appdata_img v<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            v2f o<span class="token punctuation">;</span>
            o<span class="token punctuation">.</span>pos <span class="token operator">=</span> <span class="token function">UnityObjectToClipPos</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>vertex<span class="token punctuation">)</span><span class="token punctuation">;</span>

            o<span class="token punctuation">.</span>uv <span class="token operator">=</span> v<span class="token punctuation">.</span>texcoord<span class="token punctuation">;</span>
            o<span class="token punctuation">.</span>uv_depth <span class="token operator">=</span> v<span class="token punctuation">.</span>texcoord<span class="token punctuation">;</span>

            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">UNITY_UV_STARTS_AT_TOP</span></span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>_MainTex_TexelSize<span class="token punctuation">.</span>y <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token punctuation">&#123;</span>
                    o<span class="token punctuation">.</span>uv_depth<span class="token punctuation">.</span>y <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">-</span> o<span class="token punctuation">.</span>uv_depth<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

            <span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>v<span class="token punctuation">.</span>texcoord<span class="token punctuation">.</span>x <span class="token operator">&lt;</span> <span class="token number">0.5</span> <span class="token operator">&amp;&amp;</span> v<span class="token punctuation">.</span>texcoord<span class="token punctuation">.</span>y <span class="token operator">&lt;</span> <span class="token number">0.5</span><span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>texcoord<span class="token punctuation">.</span>x <span class="token operator">></span> <span class="token number">0.5</span> <span class="token operator">&amp;&amp;</span> v<span class="token punctuation">.</span>texcoord<span class="token punctuation">.</span>y <span class="token operator">&lt;</span> <span class="token number">0.5</span><span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                index <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>texcoord<span class="token punctuation">.</span>x <span class="token operator">></span> <span class="token number">0.5</span> <span class="token operator">&amp;&amp;</span> v<span class="token punctuation">.</span>texcoord<span class="token punctuation">.</span>y <span class="token operator">></span> <span class="token number">0.5</span><span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                index <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">&#123;</span>
                index <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">UNITY_UV_STARTS_AT_TOP</span></span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>_MainTex_TexelSize<span class="token punctuation">.</span>y <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                    index <span class="token operator">=</span> <span class="token number">3</span> <span class="token operator">-</span> index<span class="token punctuation">;</span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

            o<span class="token punctuation">.</span>interpolatedRay <span class="token operator">=</span> _FrustumCornersRay<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>
         
            <span class="token keyword">return</span> o<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        
        fixed4 <span class="token function">frag</span><span class="token punctuation">(</span>v2f i<span class="token punctuation">)</span> <span class="token operator">:</span> SV_Target
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">float</span> linearDepth <span class="token operator">=</span> <span class="token function">LinearEyeDepth</span><span class="token punctuation">(</span><span class="token function">SAMPLE_DEPTH_TEXTURE</span><span class="token punctuation">(</span>_CameraDepthTexture<span class="token punctuation">,</span> i<span class="token punctuation">.</span>uv_depth<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            float3 worldPos <span class="token operator">=</span> _WorldSpaceCameraPos <span class="token operator">+</span> linearDepth <span class="token operator">*</span> i<span class="token punctuation">.</span>interpolatedRay<span class="token punctuation">.</span>xyz<span class="token punctuation">;</span>

            float2 speed <span class="token operator">=</span> _Time<span class="token punctuation">.</span>y <span class="token operator">*</span> <span class="token function">float2</span><span class="token punctuation">(</span>_FogXSpeed <span class="token punctuation">,</span> _FogYSpeed<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">float</span> noise <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">tex2D</span><span class="token punctuation">(</span>_NoiseTex<span class="token punctuation">,</span> i<span class="token punctuation">.</span>uv <span class="token operator">+</span> speed<span class="token punctuation">)</span><span class="token punctuation">.</span>r <span class="token operator">-</span> <span class="token number">0.5</span><span class="token punctuation">)</span> <span class="token operator">*</span> _NoiseAmount<span class="token punctuation">;</span>

            <span class="token keyword">float</span> fogDensity <span class="token operator">=</span> <span class="token punctuation">(</span>_FogEnd <span class="token operator">-</span> worldPos<span class="token punctuation">.</span>y<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>_FogEnd <span class="token operator">-</span> _FogStart<span class="token punctuation">)</span><span class="token punctuation">;</span>
            fogDensity <span class="token operator">=</span> <span class="token function">saturate</span><span class="token punctuation">(</span>fogDensity <span class="token operator">*</span> _FogDensity <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> noise<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            fixed4 finalColor <span class="token operator">=</span> <span class="token function">tex2D</span><span class="token punctuation">(</span>_MainTex <span class="token punctuation">,</span> i<span class="token punctuation">.</span>uv<span class="token punctuation">)</span><span class="token punctuation">;</span>
            finalColor<span class="token punctuation">.</span>rgb <span class="token operator">=</span> <span class="token function">lerp</span><span class="token punctuation">(</span>finalColor<span class="token punctuation">.</span>rgb <span class="token punctuation">,</span> _FogColor<span class="token punctuation">.</span>rgb <span class="token punctuation">,</span> fogDensity<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">return</span> finalColor<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        ENDCG    

        Pass
        <span class="token punctuation">&#123;</span>
            <span class="token comment">//ZTest Always Cull Off ZWrite Off</span>

            CGPROGRAM
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">vertex vert</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">fragment frag</span></span>
            ENDCG
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    FallBack Off
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p><img src="/./../../../BlogImg/image-20250320123905447.png" alt="image-20250320123905447"></p>
<h1 id="Unity渲染优化"><a href="#Unity渲染优化" class="headerlink" title="Unity渲染优化"></a>Unity渲染优化</h1><p>影响性能的因素：<br>CPU：<br>过多的draw Call<br>复杂的脚本或者物理模拟<br>GPU：<br>顶点处理<br>    过多的顶点<br>    过多的逐顶点计算<br>片元处理<br>    过多的片元<br>    过多的逐片元计算<br>带宽：<br>    使用了尺寸很大并且未压缩的纹理</p>
<h2 id="渲染调试工具"><a href="#渲染调试工具" class="headerlink" title="渲染调试工具"></a>渲染调试工具</h2><p>移动平台的特点，移动平台的Gpu架构有很大的不同，由于处理资源等条件的限制，移动设备的gpu架构专注于尽可能使用更小的带宽和功能，也由此带来了许多和pc平台完全不同的现象</p>
<p>例如为了尽可能移除隐藏的表面，减少了overdraw（即为一个像素被描绘了多次），power vr芯片（通常用于ios设备和某些安卓设备）使用了<strong>基于瓦片的延迟渲染架构</strong>，把所有的渲染图像装入一个个瓦片当中，再由硬件找到相应的片元，而只有这些可见片元才会执行片元着色器。</p>
<h3 id="渲染统计窗口"><a href="#渲染统计窗口" class="headerlink" title="渲染统计窗口"></a><strong>渲染统计窗口</strong></h3><p><img src="/./../../../BlogImg/image-20250320133605532.png" alt="image-20250320133605532"></p>
<p><img src="/./../../../BlogImg/image-20250320133549250.png" alt="image-20250320133549250"></p>
<h3 id="性能分析器的渲染区域"><a href="#性能分析器的渲染区域" class="headerlink" title="性能分析器的渲染区域"></a>性能分析器的渲染区域</h3><p><img src="/./../../../BlogImg/image-20250320133509692.png" alt="image-20250320133509692"></p>
<p>性能分析器显示了绝大部分在渲染统计窗口当中提供的信息，例如绿色的线表示了批处理数目，蓝色的线显示了Pass的数目等，同时还给出了许多其他非常有用的信息，例如draw call数目、动态批处理&#x2F;静态批处理的数目、渲染纹理的数目和内存占用等等。</p>
<p>结合渲染统计窗口和性能分析器，我们可以查看与渲染相关的绝大多数重要的数据。一个值得注意的现象是，性能分析器给出的drawcall数目 与 批处理数目、pass数目并不一致，并且看起来总是大于我们估算的数值，这是因为unity在背后进行了很多的工作，例如初始化各个缓存、为阴影更新深度纹理和阴影映射纹理等，因此需要花费比预期更多的drawcall</p>
<p>我们可以使用帧调试器来查看每一个draw call的工作</p>
<h3 id="帧调试器"><a href="#帧调试器" class="headerlink" title="帧调试器"></a>帧调试器</h3><p>帧调试器上面显示了渲染这一帧需要的所有渲染事件，单击上面的每个事件，我们可以在game视图看到绘制成果、</p>
<p>其他的性能分析工具</p>
<h2 id="针对CPU的优化"><a href="#针对CPU的优化" class="headerlink" title="针对CPU的优化"></a>针对CPU的优化</h2><h3 id="减少draw-call数目——批处理技术"><a href="#减少draw-call数目——批处理技术" class="headerlink" title="减少draw call数目——批处理技术"></a>减少draw call数目——批处理技术</h3><p><strong>打开关闭批处理</strong></p>
<p><img src="/./../../../BlogImg/image-20250320181025232.png" alt="image-20250320181025232"></p>
<p><strong>批处理的原因</strong>：cpu检查哪些光源影响了这个物体，绑定shader并且设置它的参数，再把渲染命令发送给GPU，当场景包含大量对象就会非常耗时</p>
<p><strong>批处理实现原理</strong>：在每次调用drawcall的时候尽可能的处理多个物体</p>
<p><strong>可以进行批处理的物体</strong>：使用同一个材质的物体，它们的不同仅仅是顶点数据的差别，可以吧这些顶点数据合并到一起发给gpu，就算完成了一次批处理</p>
<p><strong>Unity支持的两种批处理方式：</strong>动态批处理和静态批处理</p>
<p><strong>两种批处理方式的优缺点</strong>：动态批处理一切处理都是unity自动完成的，不需要我们自己做任何 操作，物体可以进行移动。缺点在于限制很多，可能一不小心打破了这种机制（比如顶点数量过多）<br>静态批处理自由度高，限制很少，不在乎顶点数量，缺点在于可能会占用更多的内存，而且经过静态批处理之后的所有物体都不可以再移动。</p>
<h4 id="动态批处理"><a href="#动态批处理" class="headerlink" title="动态批处理"></a>动态批处理</h4><p><strong>条件</strong>：</p>
<p>1 模型共享了同一个材质<br>2 顶点属性数满足Unity限制（一般来说不能超过900个，如果一个顶点使用了例如法线位置纹理坐标三个顶点属性，那么顶点数目就不能超过300）<br>（Unity5中对模型缩放的限制不存在）所有对象都要使用同一个缩放尺度<br>3 在使用光照纹理（lightmap）的物体需要额外的渲染参数，比如在光照纹理上的索引、偏移量、缩放信息等<br>为了让这些物体可以被动态批处理，需要保证它们指向的是光照纹理的同一个位置<br>4 多Pass的shader会中断批处理，在前向渲染中可能需要额外的pass，这样会中断批处理</p>
<p><strong>基本原理</strong>：每一帧把可以进行批处理的模型网格进行合并，再把合并之后的模型数据传递给GPU，然后使用同一个材质对其进行渲染。</p>
<p><strong>好处</strong>：实现方便，经过批处理的物体仍然可以进行移动。</p>
<p><strong>批处理仍然可以进行移动的原因</strong>：Unity处理每一帧都会重新合并一次网格</p>
<p><strong>从渲染统计数据中查看动态批处理</strong><br><img src="/./../../../BlogImg/image-20250320172841011.png" alt="image-20250320172841011"></p>
<p>举例：没有打开dynamic batch的情况下，现在显示的batches是38，saved by batches为0，说明批处理数为0，<br>通过saved batches来片段是否发生了batch</p>
<p><img src="/./../../../BlogImg/image-20250320185429357.png" alt="image-20250320185429357"></p>
<p>注意：天空盒渲染以及background color会调用2个drawcall</p>
<p><img src="/./../../../BlogImg/image-20250320185245105.png" alt="image-20250320185245105"></p>
<p>我们添加四个立方体，此时我们使用的材质里面的shader pass没有选择前向渲染标签，物体不会发生光照计算，可以看到场景中并没有多出来batches但是却多出来了3个saved by batches。这是因为在deepPassJob中仍然发生了批处理</p>
<p><em><strong>DeepPassJob</strong> 是一个渲染过程，用于填充深度缓冲区，通常是为了进行 <strong>深度预处理</strong>，尤其是在延迟渲染管线中。</em></p>
<p><em><strong>批处理的可能性</strong>：</em></p>
<ul>
<li><em>如果物体满足 <strong>静态批处理（Static Batching）</strong> 和 <strong>动态批处理（Dynamic Batching）</strong> 的条件，<code>DeepPassJob</code> 渲染的深度数据可能会被合并到一个 Draw Call。</em></li>
<li><em>但是，<strong>动态物体</strong>、<strong>骨骼动画物体</strong>、*<em>不同的材质或 Shader</em></em> 等会导致批处理失败。*</li>
</ul>
<p><img src="/./../../../BlogImg/image-20250320185613977.png" alt="image-20250320185613977"></p>
<p>此时场景当中没有光照，这里有四个使用相同<strong>同向渲染</strong>材质的立方体，可以注意到它们只调用了一次batch，saved 3 batches，说明发生了动态批处理<br><img src="/./../../../BlogImg/image-20250320182142339.png" alt="image-20250320182142339"></p>
<p>打开场景中的平行光，发生了光照，可以发现batch数目加了1,多进行了一次批处理</p>
<p><img src="/./../../../BlogImg/image-20250320182251049.png" alt="image-20250320182251049"></p>
<p>这里场景中多出了一种材质，batches数目加了2。</p>
<p><img src="/./../../../BlogImg/image-20250320183306345.png" alt="image-20250320183306345"></p>
<p>当我们在里面添加了一个球体的时候，batch数又增加了，这是因为Unity创建的球体的顶点数是515个,而我们这里的shader中一个顶点至少包含了位置和法线纹理坐标属性，于是总的顶点属性远大于900个，这个时候就无法在相同材质下进行动态批处理</p>
<p>注意渲染信息面板上的顶点数是偏多的，因为unity做了一些底部工作，需要在帧调试器里找到球体渲染的部分查看其顶点数</p>
<p>切换一个可以接收点光源的材质<br><img src="/./../../../BlogImg/image-20250320184423692.png" alt="image-20250320184423692"><br>之后添加点光源<br><img src="/./../../../BlogImg/image-20250320184455537.png" alt="image-20250320184455537"><br>可以发现saved by batching数量减少了。原来的4变成了2，这是因为在使用了<strong>多个pass</strong>的shader在需要应用多个光照的情况下，破坏了动态批处理的机制，导致unity不能对这些物体进行动态批处理。</p>
<p><img src="/./../../../BlogImg/image-20250320185823972.png" alt="image-20250320185823972"><br>仍然遗留两个是因为depthPassJob仍然可以发生批处理，但是在drawing部分无法进行批处理</p>
<h4 id="静态批处理"><a href="#静态批处理" class="headerlink" title="静态批处理"></a>静态批处理</h4><p><strong>实现原理</strong>：在运行开始阶段把需要进行静态批处理的模型网格合并到一个新的网格结构当中（这意味着这些模型不可以在运行的时候进行移动）</p>
<p><strong>优点</strong>：只需要进行一次合并操作，不需要每帧进行，所以比动态批处理更加高效。</p>
<p><strong>缺点：</strong>模型不可以在运行的时候进行移动，某些情况会占用大量内存</p>
<p><strong>占用大量内存的情况：</strong>在静态批处理之前如果一些物体共享了相同的网格，在批处理之后内存中的每一个物体都会对应一个这个网格的复制品，即一个网格会变成多个网格发送个igpu。</p>
<p><strong>静态批处理的实现</strong>：在projectSetting-player里面吧static batching勾选上，之后在需要静态批处理的物体上勾选static</p>
<p><strong>从渲染统计数据中查看静态批处理</strong></p>
<p><img src="/./../../../BlogImg/image-20250320191627694.png" alt="image-20250320191627694"></p>
<p>可以发现除去背景和天空盒发生的2次drawcall，整个渲染只调用了两次batches，静态批处理无视了球体的顶点属性数量将其和其他立方体强行打包成了一个网格，进行深度预处理和调用drawcall。</p>
<p>这个时候每个模型的网格变成了结合网格<br><img src="/./../../../BlogImg/image-20250320192232916.png" alt="image-20250320192232916"><br>与此同时scene面板不能移动物体了，会显示一行字static<br><img src="/./../../../BlogImg/image-20250320192321865.png" alt="image-20250320192321865"></p>
<p>添加一个不同材质的物体将其设置成static<br><img src="/./../../../BlogImg/image-20250320192545748.png" alt="image-20250320192545748"><br>它也变成了结合网格<br><img src="/./../../../BlogImg/image-20250320192646061.png" alt="image-20250320192646061"><br>于此同时下面显示了一个sub meshes，这事实上代表合并后网格拥有5个子网格，即场景当中的五个对象，对于合并后的网格，unity会片段其中使用同一个材质的子网格，然后对他们进行批处理。</p>
<p><strong>内部实现</strong>：Unity首先把这些静态物体变换到世界空间下，为他们建立一个更大的顶点和索引缓存。对于使用了同一材质的物体，unity只需要调用一个drawcall就可以绘制。而对于使用了不同材质的物体，静态批处理仍然可以提升渲染性能。尽管这些物体仍然需要调用多个drawcall，<strong>静态批处理可以减少不同材质drawcall之间的切换</strong>，而这些切换往往是费时间的操作</p>
<p>尽管四个立方体使用同一个网格，但是合并之后变成了4个独立的网格。<br>事实上，查看VBO知道，静态批处理需要处理的顶点数更多，占用的内存也更多</p>
<p><img src="/./../../../BlogImg/image-20250320194715930.png" alt="image-20250320194715930"><br><img src="/./../../../BlogImg/image-20250320194603568.png" alt="image-20250320194603568"></p>
<p><img src="/./../../../BlogImg/image-20250320194803460.png" alt="image-20250320194803460"></p>
<p>注意添加了新光源之后，它在shader当中定义了额外的pass来处理它们，这些额外的pass部分是不会被批处理的。<br>但是处理平行光的部分仍然可以被静态批处理</p>
<h4 id="共享材质"><a href="#共享材质" class="headerlink" title="共享材质"></a>共享材质</h4><p><strong>背景：</strong>动态批处理和静态批处理都要求模型共享同一个材质</p>
<p><strong>材质只有纹理不同：</strong>可以把这些纹理合并到一张更大的纹理当中，这张更大的纹理被称为图集atlas，一档使用了同一张纹理，我们就可以使用同一个材质，再使用不同的采样坐标对纹理进行采样。</p>
<p><strong>材质上有其他参数不同：</strong>使用网格的顶点数据来存储这些参数。由于批处理之后的物体会被处理成更大的vbo发送给gpu，vbo中的数据可以作为输入传递给顶点着色器。因此我们可以巧妙地对vbo中的数据进行控制，从而达到不同效果的目的。</p>
<p>**注意:**如果我们在脚本当中访问共享材质，应该使用Renderer.sharedMaterial来保证修改的是和其他物体共享的材质，但是这意味着修改会运用到所有使用这个材质的物体上，另一个类似的api是renderer.material，调用它修改材质会创建一个这个材质的复制品，从而破坏批处理在这个物体的应用</p>
<h4 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h4><p><strong>尽可能选择静态批处理</strong>，但是小心内存的消耗，注意静态批处理物体不能移动<br>如果无法进行静态批处理，而要使用动态批处理，尽量让物体包含少的顶点属性<br><strong>对于游戏中的小道具可以使用动态批处理</strong><br>对于包含动画的物体，无法全部使用静态批处理，但是如果其中有不动的部分，仍然可以把它标识成static</p>
<p>由于批处理需要把多个模型变换到世界空间下然后合并，如果shader中存在一些基于模型空间的坐标运算往往会得到错误的结果。<br>解决方法是在shader中使用<strong>DisableBatching</strong>强制使用该shader的材质不会被批处理。</p>
<p>使用半透明材质的物体要严格的从后往前绘制顺序来保证透明混合的正确性，这些物体unity会先保证绘制顺序然后尝试批处理，绘制顺序无法满足则批处理无法运用</p>
<h2 id="针对GPU的优化"><a href="#针对GPU的优化" class="headerlink" title="针对GPU的优化"></a>针对GPU的优化</h2><h3 id="减少需要处理的顶点数目"><a href="#减少需要处理的顶点数目" class="headerlink" title="减少需要处理的顶点数目"></a>减少需要处理的顶点数目</h3><p><strong>优化几何体</strong></p>
<p>​	建模软件和unity当中的顶点数目往往不同，因为unity中是站在gpu上计算定点数，unity需要分离顶点坐标和产生平滑的边界。</p>
<p>​	对于一个立方体来说它的六个面上使用了许多相同的顶点，也就是一个顶点上有多个顶点坐标对gpu来说这是不可理解的，他必须把这个顶点拆分成多个具有不同纹理坐标的顶点。</p>
<p>​	平滑边界也是类似，此时一个顶点会对于多个法线信息或者切线信息，这是因为我们要决定一条边是<strong>硬边</strong>还是<strong>平滑边</strong>。</p>
<p>​	尽量移除不必要的硬边以及纹理衔接，避免边界平滑和纹理分离</p>
<p><strong>LOD技术</strong></p>
<pre><code>当对象远离摄像机的时候减少面片
</code></pre>
<p><strong>遮挡剔除</strong></p>
<p>​	和<strong>视椎体剔除</strong>是不一样的，遮挡剔除可以判断事业中是否有物体被其他物体挡住<br>​	使用一个虚拟的摄像机遍历场景，构建一个潜在的可见的对象集合的层级结构。在运行时候，每个摄像机将会使用这个数据来识别哪些物体是可见的，而哪些物体挡住不可见。</p>
<p>​	可以减少overdraw，减少处理顶点的数目</p>
<p>​	lod和遮挡剔除可以同时减少CPU和GPU的负荷</p>
<h3 id="减少需要处理的面片数目"><a href="#减少需要处理的面片数目" class="headerlink" title="减少需要处理的面片数目"></a><strong>减少需要处理的面片数目</strong></h3><p>**overdraw的概念:**一个像素被绘制了多次</p>
<p><strong>Unity的overdraw视图：</strong><br><img src="/./../../../BlogImg/image-20250320201506491.png" alt="image-20250320201506491"></p>
<p>实际上这里的视图只是提供了查看物体互相遮挡的层数，并不是真正最终屏幕绘制的overdraw。</p>
<p>通过把所有对象渲染成一个透明的轮廓，通过查看透明颜色的累计程度来判断物体之间的遮挡</p>
<p><strong>控制绘制顺序</strong></p>
<p><strong>原因：</strong>由于速度测试的存在，我们需要保证物体是从前往后进行绘制的，可以很大程度上减少overdraw。这是因为在后面绘制的物体由于无法通过深度测试，因此就不会再进行后面的渲染处理。</p>
<p>unity中渲染队列数目小于2500的都是不透明物体，从前往后进行绘制。</p>
<p>尽可能把物体的队列设置成不透明队列。避免使用半透明队列。</p>
<p>充分利用unity的渲染队列来控制绘制顺序。<br>比如fps游戏中人物主角一般先进行绘制，可以使用更小的渲染队列<br>天空盒一般在所有物体的后面，它的队列可以设置成geometry+1，保证不对他进行overdraw</p>
<p><strong>时刻警惕透明物体</strong></p>
<p><strong>原因：</strong>半透明物体没有深度写入需要从后往前进行渲染。半透明物体几乎一定会造成overdraw，这意味这如果不注意就可能在某些机器上造成严重的性能下降。</p>
<p><strong>举例：</strong>GUI对象，大面积的半透明对象，很多层互相覆盖的半透明对象，透明的例子效果都会在移动设备上造成大量overdraw？</p>
<p><strong>解决：</strong></p>
<p>尽量减少窗口中GUI所占的面积。</p>
<p>把gui的绘制和三维场景的绘制交给不同摄像机，两者视角范围尽量不要相互重叠。</p>
<p><strong>注意：</strong></p>
<p>移动平台上透明度测试也会影响游戏性能。它的实现使用了discard或者clip操作，这些操作会导致一些硬件的优化策略事小。</p>
<p><img src="/./../../../BlogImg/image-20250320202839950.png" alt="image-20250320202839950"></p>
<h3 id="减少实时光照和投影"><a href="#减少实时光照和投影" class="headerlink" title="减少实时光照和投影"></a>减少实时光照和投影</h3><p><strong>原因：</strong>实时光照对于移动平台是一种非常昂贵的操作，如果场景中包含过多的点光源，而且使用了多个pass的shader，那么很有可能造成性能下降。</p>
<p>**用光照纹理来实现欺骗性的光照:**将光照提前烘焙到一张光照纹理当中，然后在运行的时候根据纹理采样得到光照结果。</p>
<p><strong>GodRay：</strong></p>
<p><strong>在移动平台上</strong>，一个物体使用的逐像素光源数目应该小于1（不包括平行光）。如果要使用更多的平行光，可以选择使用顶点光照代替</p>
<p><strong>LUT：</strong>把复杂的光照存储到一张查找纹理（lookup textuire 、LUT）当中，然后在运行的时候使用光源方向、视角方向、法线防线，对LUT进行采样。</p>
<p><strong>LUT的优点：</strong></p>
<p>可以让我们实现如BRDF等更加高级的光照模型。</p>
<p>可以利用查找纹理的大小来进一步优化性能，比如主角使用大分辨率LUT，次要NPC使用小分辨率LUT</p>
<h2 id="节省带宽"><a href="#节省带宽" class="headerlink" title="节省带宽"></a>节省带宽</h2><h3 id="减少纹理大小"><a href="#减少纹理大小" class="headerlink" title="减少纹理大小"></a>减少纹理大小</h3><p>​	Generate Mip Maps多级渐远纹理，三分之一内存的代价实现纹理的缩放。</p>
<p>​	美术制作纹理的时候尽量选择2的次幂的长宽，unity会进行压缩</p>
<p>​	压缩纹理，对于Android平台有很多不同架构的gpu，纹理压缩更加复杂，不同的gpu架构有自己的纹理压缩形式，Unity可以根据不同的设备选择不同的压缩形式，我们只需要把纹理压缩相识设置成自动压缩。GUI纹理除外</p>
<h3 id="利用分辨率缩放"><a href="#利用分辨率缩放" class="headerlink" title="利用分辨率缩放"></a>利用分辨率缩放</h3><p>​	unity设置屏幕分辨率可以直接调用Screen.SetResolution，尽管实际运用的时候会遇到一些情况</p>
<h2 id="减少计算复杂度"><a href="#减少计算复杂度" class="headerlink" title="减少计算复杂度"></a>减少计算复杂度</h2><h3 id="LOD"><a href="#LOD" class="headerlink" title="LOD"></a>LOD</h3><p>​	<img src="/./../../../BlogImg/image-20250320204234806.png" alt="image-20250320204234806"></p>
<p>默认情况下LOD等级无限大，意味着任何被当前显卡支持的shader都可以被使用。但是在某些情况下我们需要去掉一些使用了复杂计算的shader渲染。这时候我们可以使用Shader.maximumLOD或者Shader.globalMaximumLOD来设置允许的最大LOD值。</p>
<p><img src="/./../../../BlogImg/image-20250320204441118.png" alt="image-20250320204441118"></p>
<h3 id="代码方面的优化："><a href="#代码方面的优化：" class="headerlink" title="代码方面的优化："></a>代码方面的优化：</h3><p>​	<strong>尽可能使用低精度浮点数进行计算</strong></p>
<p>​	float&#x2F;highp使用存储顶点坐标，速度最慢</p>
<p>​	half&#x2F;mediump使用标量和纹理坐标，速度是float的两倍</p>
<p>​	fixed&#x2F;lowp使用于绝大多数颜色变量和归一化的方向矢量，速度大约是float的四倍</p>
<p>​	避免对低精度变量进行排放的<em>swizzle</em>（如color.xwxw？）操作</p>
<p>​	避免不同精度之间进行切换</p>
<p>​	<strong>对大多数GPU来说，使用插值寄存器把数据从顶点着色器传递给下一个阶段的时候，我们应该尽量少使用插值变量</strong></p>
<p>​	如果要对两个纹理坐标进行插值，我们通常把它打包在同一个float4类型的变量当中。</p>
<p>​	对于某些平台（如power vr）存储在不同插值变量有时表现得更好。</p>
<p>​	<strong>尽可能不要使用全屏的屏幕后处理效果</strong></p>
<p>​	如果要使用，尽量使用fixed&#x2F;lowp进行低精度运算，高精度运算可以使用查找表或者转移到顶点着色器当中处理</p>
<p>​	尽量多个屏幕后处理特效合并到一个shader当中。</p>
<p>​	<strong>其他</strong></p>
<p>​	尽可能少使用分支和循环语句</p>
<p>​	尽可能少使用如sin、pow等数学运算</p>
<p>​	尽可能不要使用discard，这会影响某些硬件的优化</p>
<h3 id="根据硬件条件进行优化："><a href="#根据硬件条件进行优化：" class="headerlink" title="根据硬件条件进行优化："></a>根据硬件条件进行优化：</h3><p>​	放缩思想</p>
</article><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Unity/">Unity</a></div><div class="post_share"><div class="social-share" data-image="https://s3.bmp.ovh/imgs/2023/01/12/1e052378ba7e2bfd.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2025/03/16/%E5%9C%A8UnityShader%E5%BD%93%E4%B8%AD%E9%81%87%E5%88%B0%E8%BF%87%E7%9A%84%E9%97%AE%E9%A2%98/"><img class="prev-cover" src="https://s3.bmp.ovh/imgs/2023/01/12/b290daacd1b79e32.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info"></div></div></a></div><div class="next-post pull-right"><a href="/2025/03/14/Blender%20%E7%A1%AC%E8%A1%A8%E9%9D%A2%E6%95%99%E7%A8%8B/"><img class="next-cover" src="https://s3.bmp.ovh/imgs/2023/01/12/b290daacd1b79e32.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info"></div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2025/03/10/Unity%202D_RPG%E6%B8%B8%E6%88%8F%E5%88%B6%E4%BD%9C%E7%AC%94%E8%AE%B0/" title="Unity Shader 入门精要高级"><img class="cover" src="https://s3.bmp.ovh/imgs/2023/01/12/1e052378ba7e2bfd.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-03-10</div><div class="title">Unity Shader 入门精要高级</div></div></a></div><div><a href="/2022/10/28/Unity%20%E4%BB%8EBuilt%20in%E5%8D%87%E7%BA%A7%E5%88%B0Universal%20Render%20PipeLine/" title="Unity 从Built in升级到Universal Render PipeLine"><img class="cover" src="https://s3.bmp.ovh/imgs/2023/01/12/f8943481ff2f250b.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-10-28</div><div class="title">Unity 从Built in升级到Universal Render PipeLine</div></div></a></div><div><a href="/2025/03/17/Unity%20Shader%20%E5%85%A5%E9%97%A8%E7%B2%BE%E8%A6%81%E6%89%A9%E5%B1%95/" title="Unity Shader 入门精要扩展"><img class="cover" src="https://s3.bmp.ovh/imgs/2023/01/12/1e052378ba7e2bfd.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-03-17</div><div class="title">Unity Shader 入门精要扩展</div></div></a></div><div><a href="/2022/10/28/Unity%20%E5%B0%84%E5%87%BB%E7%94%9F%E5%AD%98%E6%B8%B8%E6%88%8F%E5%88%B6%E4%BD%9C%E7%AC%94%E8%AE%B0/" title="Unity 设计生存游戏制作笔记"><img class="cover" src="https://s3.bmp.ovh/imgs/2023/01/12/1e052378ba7e2bfd.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-10-28</div><div class="title">Unity 设计生存游戏制作笔记</div></div></a></div><div><a href="/2025/03/13/Unity%20Shader%E5%85%A5%E9%97%A8%E7%B2%BE%E8%A6%81%E4%B8%AD%E7%BA%A7/" title="Unity Shader 入门精要中级"><img class="cover" src="https://s3.bmp.ovh/imgs/2023/01/12/4380663e3f60c5ab.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-03-13</div><div class="title">Unity Shader 入门精要中级</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/OIP.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">某不知名的作者</div><div class="author-info__description">衬衫的价格是九磅十五便士</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">88</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">27</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">14</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/tonzinonin" target="_blank" title="Github"><i class="fab fa-github"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%B1%8F%E5%B9%95%E5%90%8E%E5%A4%84%E7%90%86"><span class="toc-number">1.</span> <span class="toc-text">屏幕后处理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B0%83%E6%95%B4%E5%B1%8F%E5%B9%95%E7%9A%84%E4%BA%AE%E5%BA%A6%E9%A5%B1%E5%92%8C%E5%BA%A6%E5%92%8C%E5%AF%B9%E6%AF%94%E5%BA%A6"><span class="toc-number">1.1.</span> <span class="toc-text">调整屏幕的亮度饱和度和对比度</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BE%B9%E7%BC%98%E6%A3%80%E6%B5%8B"><span class="toc-number">1.2.</span> <span class="toc-text">边缘检测</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%AB%98%E6%96%AF%E6%A8%A1%E7%B3%8A"><span class="toc-number">1.3.</span> <span class="toc-text">高斯模糊</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Bloom%E6%95%88%E6%9E%9C"><span class="toc-number">1.4.</span> <span class="toc-text">Bloom效果</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%90%E5%8A%A8%E6%A8%A1%E7%B3%8A"><span class="toc-number">1.5.</span> <span class="toc-text">运动模糊</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%B7%B1%E5%BA%A6%E5%92%8C%E6%B3%95%E7%BA%BF%E7%BA%B9%E7%90%86"><span class="toc-number">2.</span> <span class="toc-text">使用深度和法线纹理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%90%E5%8A%A8%E6%A8%A1%E7%B3%8A2"><span class="toc-number">2.1.</span> <span class="toc-text">运动模糊2</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%A8%E5%B1%80%E9%9B%BE%E6%95%88"><span class="toc-number">2.2.</span> <span class="toc-text">全局雾效</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%8D%E8%B0%88%E8%BE%B9%E7%BC%98%E6%A3%80%E6%B5%8B"><span class="toc-number">2.3.</span> <span class="toc-text">再谈边缘检测</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#NPR"><span class="toc-number">3.</span> <span class="toc-text">NPR</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%A1%E9%80%9A%E9%A3%8E%E6%A0%BC"><span class="toc-number">3.1.</span> <span class="toc-text">卡通风格</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B4%A0%E6%8F%8F%E6%95%88%E6%9E%9C"><span class="toc-number">3.2.</span> <span class="toc-text">素描效果</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%99%AA%E5%A3%B0"><span class="toc-number">4.</span> <span class="toc-text">噪声</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B6%88%E8%9E%8D"><span class="toc-number">4.1.</span> <span class="toc-text">消融</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B0%B4%E6%B3%A2"><span class="toc-number">4.2.</span> <span class="toc-text">水波</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E9%9B%BE"><span class="toc-number">4.3.</span> <span class="toc-text">动态雾</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Unity%E6%B8%B2%E6%9F%93%E4%BC%98%E5%8C%96"><span class="toc-number">5.</span> <span class="toc-text">Unity渲染优化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B8%B2%E6%9F%93%E8%B0%83%E8%AF%95%E5%B7%A5%E5%85%B7"><span class="toc-number">5.1.</span> <span class="toc-text">渲染调试工具</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B8%B2%E6%9F%93%E7%BB%9F%E8%AE%A1%E7%AA%97%E5%8F%A3"><span class="toc-number">5.1.1.</span> <span class="toc-text">渲染统计窗口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E5%99%A8%E7%9A%84%E6%B8%B2%E6%9F%93%E5%8C%BA%E5%9F%9F"><span class="toc-number">5.1.2.</span> <span class="toc-text">性能分析器的渲染区域</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%A7%E8%B0%83%E8%AF%95%E5%99%A8"><span class="toc-number">5.1.3.</span> <span class="toc-text">帧调试器</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%92%88%E5%AF%B9CPU%E7%9A%84%E4%BC%98%E5%8C%96"><span class="toc-number">5.2.</span> <span class="toc-text">针对CPU的优化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%8F%E5%B0%91draw-call%E6%95%B0%E7%9B%AE%E2%80%94%E2%80%94%E6%89%B9%E5%A4%84%E7%90%86%E6%8A%80%E6%9C%AF"><span class="toc-number">5.2.1.</span> <span class="toc-text">减少draw call数目——批处理技术</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E6%89%B9%E5%A4%84%E7%90%86"><span class="toc-number">5.2.1.1.</span> <span class="toc-text">动态批处理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E6%89%B9%E5%A4%84%E7%90%86"><span class="toc-number">5.2.1.2.</span> <span class="toc-text">静态批处理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B1%E4%BA%AB%E6%9D%90%E8%B4%A8"><span class="toc-number">5.2.1.3.</span> <span class="toc-text">共享材质</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="toc-number">5.2.1.4.</span> <span class="toc-text">注意事项</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%92%88%E5%AF%B9GPU%E7%9A%84%E4%BC%98%E5%8C%96"><span class="toc-number">5.3.</span> <span class="toc-text">针对GPU的优化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%8F%E5%B0%91%E9%9C%80%E8%A6%81%E5%A4%84%E7%90%86%E7%9A%84%E9%A1%B6%E7%82%B9%E6%95%B0%E7%9B%AE"><span class="toc-number">5.3.1.</span> <span class="toc-text">减少需要处理的顶点数目</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%8F%E5%B0%91%E9%9C%80%E8%A6%81%E5%A4%84%E7%90%86%E7%9A%84%E9%9D%A2%E7%89%87%E6%95%B0%E7%9B%AE"><span class="toc-number">5.3.2.</span> <span class="toc-text">减少需要处理的面片数目</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%8F%E5%B0%91%E5%AE%9E%E6%97%B6%E5%85%89%E7%85%A7%E5%92%8C%E6%8A%95%E5%BD%B1"><span class="toc-number">5.3.3.</span> <span class="toc-text">减少实时光照和投影</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%8A%82%E7%9C%81%E5%B8%A6%E5%AE%BD"><span class="toc-number">5.4.</span> <span class="toc-text">节省带宽</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%8F%E5%B0%91%E7%BA%B9%E7%90%86%E5%A4%A7%E5%B0%8F"><span class="toc-number">5.4.1.</span> <span class="toc-text">减少纹理大小</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E5%88%86%E8%BE%A8%E7%8E%87%E7%BC%A9%E6%94%BE"><span class="toc-number">5.4.2.</span> <span class="toc-text">利用分辨率缩放</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%87%8F%E5%B0%91%E8%AE%A1%E7%AE%97%E5%A4%8D%E6%9D%82%E5%BA%A6"><span class="toc-number">5.5.</span> <span class="toc-text">减少计算复杂度</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#LOD"><span class="toc-number">5.5.1.</span> <span class="toc-text">LOD</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E6%96%B9%E9%9D%A2%E7%9A%84%E4%BC%98%E5%8C%96%EF%BC%9A"><span class="toc-number">5.5.2.</span> <span class="toc-text">代码方面的优化：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%B9%E6%8D%AE%E7%A1%AC%E4%BB%B6%E6%9D%A1%E4%BB%B6%E8%BF%9B%E8%A1%8C%E4%BC%98%E5%8C%96%EF%BC%9A"><span class="toc-number">5.5.3.</span> <span class="toc-text">根据硬件条件进行优化：</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2025/03/29/Substance%20Painter%20Blender%E5%B7%A5%E4%BD%9C%E6%B5%81/" title="无题"><img src="https://s3.bmp.ovh/imgs/2023/01/12/e92609f7d9e775f5.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="无题"/></a><div class="content"><a class="title" href="/2025/03/29/Substance%20Painter%20Blender%E5%B7%A5%E4%BD%9C%E6%B5%81/" title="无题">无题</a><time datetime="2025-03-29T12:39:26.888Z" title="发表于 2025-03-29 20:39:26">2025-03-29</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/03/26/UnityShaderGraph/" title="无题"><img src="https://s3.bmp.ovh/imgs/2023/01/12/b290daacd1b79e32.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="无题"/></a><div class="content"><a class="title" href="/2025/03/26/UnityShaderGraph/" title="无题">无题</a><time datetime="2025-03-26T08:33:02.619Z" title="发表于 2025-03-26 16:33:02">2025-03-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/03/26/%E6%8A%80%E6%9C%AF%E7%BE%8E%E6%9C%AF%E5%85%A5%E9%97%A8/" title="无题"><img src="https://s3.bmp.ovh/imgs/2023/01/12/1e052378ba7e2bfd.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="无题"/></a><div class="content"><a class="title" href="/2025/03/26/%E6%8A%80%E6%9C%AF%E7%BE%8E%E6%9C%AF%E5%85%A5%E9%97%A8/" title="无题">无题</a><time datetime="2025-03-26T04:48:22.514Z" title="发表于 2025-03-26 12:48:22">2025-03-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/03/26/Gpu%E9%98%B3%E6%98%A5%E7%99%BD%E9%9B%AA%E4%B8%8E%E4%B8%8B%E9%87%8C%E5%B7%B4%E4%BA%BA%E7%AC%94%E8%AE%B0/" title="无题"><img src="https://s3.bmp.ovh/imgs/2023/01/12/4bcf264a84775fc0.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="无题"/></a><div class="content"><a class="title" href="/2025/03/26/Gpu%E9%98%B3%E6%98%A5%E7%99%BD%E9%9B%AA%E4%B8%8E%E4%B8%8B%E9%87%8C%E5%B7%B4%E4%BA%BA%E7%AC%94%E8%AE%B0/" title="无题">无题</a><time datetime="2025-03-26T02:43:50.830Z" title="发表于 2025-03-26 10:43:50">2025-03-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/03/25/Unity%E8%83%8C%E5%8C%85%E7%B3%BB%E7%BB%9F/" title="无题"><img src="https://s3.bmp.ovh/imgs/2023/01/12/4380663e3f60c5ab.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="无题"/></a><div class="content"><a class="title" href="/2025/03/25/Unity%E8%83%8C%E5%8C%85%E7%B3%BB%E7%BB%9F/" title="无题">无题</a><time datetime="2025-03-25T11:28:52.056Z" title="发表于 2025-03-25 19:28:52">2025-03-25</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: '',
      appKey: '',
      avatar: 'monsterid',
      serverURLs: '',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !true) {
  if (true) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>