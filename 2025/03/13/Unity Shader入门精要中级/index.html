<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Unity Shader 入门精要中级 | final fantasy</title><meta name="author" content="某不知名的作者"><meta name="copyright" content="某不知名的作者"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Unity Shader入门精要中级 中级光照可以在摄像机组件下设置渲染路径  在之前我们场景之中只有一个平行光，在实际游戏中我们会需要处理数量更多，类型更加复杂的光源，更加重要的是我们需要得到阴影。 Unity如何处理这些光源的：Unity里，渲染路径决定了光照是如何被应用到Unity Shader当中的，因此，如果我们需要和光源打交道，我们需要为每一个Pass指定它使用的渲染路径。Unity这">
<meta property="og:type" content="article">
<meta property="og:title" content="Unity Shader 入门精要中级">
<meta property="og:url" content="https://tonzinonin.github.io/2025/03/13/Unity%20Shader%E5%85%A5%E9%97%A8%E7%B2%BE%E8%A6%81%E4%B8%AD%E7%BA%A7/index.html">
<meta property="og:site_name" content="final fantasy">
<meta property="og:description" content="Unity Shader入门精要中级 中级光照可以在摄像机组件下设置渲染路径  在之前我们场景之中只有一个平行光，在实际游戏中我们会需要处理数量更多，类型更加复杂的光源，更加重要的是我们需要得到阴影。 Unity如何处理这些光源的：Unity里，渲染路径决定了光照是如何被应用到Unity Shader当中的，因此，如果我们需要和光源打交道，我们需要为每一个Pass指定它使用的渲染路径。Unity这">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://s3.bmp.ovh/imgs/2023/01/12/e92609f7d9e775f5.jpg">
<meta property="article:published_time" content="2025-03-13T13:25:13.000Z">
<meta property="article:modified_time" content="2025-03-30T04:29:27.954Z">
<meta property="article:author" content="某不知名的作者">
<meta property="article:tag" content="Unity">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s3.bmp.ovh/imgs/2023/01/12/e92609f7d9e775f5.jpg"><link rel="shortcut icon" href="/img/icon.png"><link rel="canonical" href="https://tonzinonin.github.io/2025/03/13/Unity%20Shader%E5%85%A5%E9%97%A8%E7%B2%BE%E8%A6%81%E4%B8%AD%E7%BA%A7/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Unity Shader 入门精要中级',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-03-30 12:29:27'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/OIP.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">88</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">27</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">14</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://s3.bmp.ovh/imgs/2023/01/12/e92609f7d9e775f5.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">final fantasy</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Unity Shader 入门精要中级</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-03-13T13:25:13.000Z" title="发表于 2025-03-13 21:25:13">2025-03-13</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-03-30T04:29:27.954Z" title="更新于 2025-03-30 12:29:27">2025-03-30</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Unity/">Unity</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Unity Shader 入门精要中级"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>Unity Shader入门精要中级</p>
<h1 id="中级光照"><a href="#中级光照" class="headerlink" title="中级光照"></a>中级光照</h1><p>可以在摄像机组件下设置渲染路径</p>
<p><img src="http://gitee.com/tonzin/picgo_image_inventory/raw/master/blog/20250317211008627.png" alt="image-20250316094010967"></p>
<p>在之前我们场景之中只有一个平行光，在实际游戏中我们会需要处理数量更多，类型更加复杂的光源，更加重要的是我们需要得到阴影。</p>
<p>Unity如何处理这些光源的：<br>Unity里，<strong>渲染路径</strong>决定了光照是如何被应用到Unity Shader当中的，因此，如果我们需要和光源打交道，我们需要为每一个Pass指定它使用的渲染路径。<br>Unity这里有3种渲染路径：<br>前向渲染路径<br>延迟渲染路径<br>顶点照明渲染路径</p>
<p>大多数情况一个项目只会使用一个渲染路径。</p>
<p>可以在设置种选择项目渲染路径（但是我找不到书上的位置有这个选项）<br><img src="https://gitee.com/tonzin/picgo_image_inventory/raw/master/blog/20250317211008628.png" alt="image-20250316094952359"></p>
<p>如果当前的显卡并不支持所选择的渲染路径，Unity就会自动使用更低一级的渲染路径，比如如果一个GPU不支持延迟渲染，那么Unity就会使用前向渲染。</p>
<pre class="line-numbers language-none"><code class="language-none">Pass
&#123;
	Tags &#123;&quot;LightMode&quot; &#x3D; &quot;ForwardBase&quot;&#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>钱箱渲染路径还有一种路径叫做ForwardAdd<br><img src="https://gitee.com/tonzin/picgo_image_inventory/raw/master/blog/20250317211008629.png" alt="image-20250316095251313"></p>
<p>如果我们没有指定任何渲染路径（在Unity5x版本如果使用了前向渲染但又没有为Pass指定任何前向渲染适合的标签，就会被当成一个和顶点照明渲染路径等同的Pass) 那么一些光照变量很可能就不会被正确的赋值，我们计算出的效果也很有可能是错误的。</p>
<h2 id="前向渲染路径"><a href="#前向渲染路径" class="headerlink" title="前向渲染路径"></a>前向渲染路径</h2><p>原理：<br>每进行一次完整的前向渲染，我们就需要渲染这个对象的渲染图元，并且计算两个缓冲区的信息：一个是颜色缓冲区，一个是深度缓冲区。我们利用深度缓冲区来决定一个片元是否可见，如果可见就更新颜色缓冲区中的颜色值</p>
<p><img src="https://gitee.com/tonzin/picgo_image_inventory/raw/master/blog/20250317211008630.png" alt="image-20250316100159027"></p>
<p>对于每一个逐像素光源，我们都会需要进行上面一次完整的渲染流程。如果一个物体在多个逐像素光源的影响区域之内，那么这个物体就需要执行多个Pass，每个Pass计算一个逐像素光源的光照结果。然后把这些光照结果混合起来得到最终颜色。</p>
<p>渲染引擎通常会限制每一个物体的逐像素光照的数目。</p>
<h3 id="Unity中的前向渲染"><a href="#Unity中的前向渲染" class="headerlink" title="Unity中的前向渲染"></a>Unity中的前向渲染</h3><p><img src="https://gitee.com/tonzin/picgo_image_inventory/raw/master/blog/20250317211008631.png" alt="image-20250316104619743"></p>
<p>Pass不止可以用来计算逐像素光照，他也可以用来计算逐顶点等其他光照。这取决于光照计算所处流水线阶段以及计算时候使用的数学模型。当我们渲染一个物体的时候，Unity会计算哪一些光源照亮了它。以及这些光源照亮这个物体的方式。</p>
<p>Unity中前向渲染有三种照亮物体的方式：<strong>逐顶点处理，逐像素处理，球谐函数处理</strong>。而决定一个光源使用哪一种处理模式取决于它的类型和渲染模式。</p>
<p><strong>光源类型</strong>：这个光是平行光还是其他类型的光源。<br><strong>光源的渲染模式</strong>：这个光源是否是重要的。</p>
<p>如果我们把一个光照的模式设置成Important，意味着我们告诉Unity要将这个光源当成一个逐像素光源来进行处理。</p>
<p>前向渲染中，当我们渲染一个物体Unity会根据场景中各个光源的设置以及这些光源对物体的影响程度对这些光源进行一个重要度排序。<br>其中一定数目的光源会按照逐像素的方式进行处理。</p>
<p>然后最多有4个光源按照逐顶点的方式进行处理。<br>剩下的光源可以按照SH（Spherical Harmonics，球谐光照）方式进行处理。</p>
<p>判断规则如下：<br><strong>1 场景中最亮的平行光总是是按照逐像素进行处理的。</strong><br><strong>2 渲染模式被设置成Not Important的光源会按照逐顶点或者SH处理。</strong><br><strong>3 渲染模式被设置成Important的光源，会按照逐像素的方式进行处理。</strong><br><strong>4 如果根据以上规则得到的逐像素光源数量小于Quality Setting当中的逐像素光源数量（Pixel Light Count），就会有更多的光源以逐像素的方式进行渲染。</strong></p>
<p><img src="https://gitee.com/tonzin/picgo_image_inventory/raw/master/blog/20250317211008632.png" alt="image-20250316102419234"></p>
<p>光照计算将会在Pass当中进行，但是Pass被分成Base Path 和 Additional Path。</p>
<p>这两种Pass进行的标签和渲染设置以及常规光照计算如图<br><img src="https://gitee.com/tonzin/picgo_image_inventory/raw/master/blog/20250317211008633.png" alt="image-20250316102552489"></p>
<p>在渲染设置中，我们需要使用<br>#pragma multi_compile_fwdbase 这样的编译指令。<br>这些编译指令保证Unity可以为相应类型的Pass生成所有需要的Shader变种。这些变种会处理不同条件下的渲染逻辑，例如是否使用lightmap，当前使用哪种光源类型等等。</p>
<p>在AddPass中使用命令替换#pragma multi_compile_fwdadd 编译指令开启阴影效果，但是这需要Unity在内部使用更多的Shader变种。</p>
<p>环境光和自发光一般都是在BasePass当中进行计算的，因为这种光一般只需要计算一次。而我们在Additional Pass来计算这两种光照，就会造成叠加多次环境光和自发光<br><img src="https://gitee.com/tonzin/picgo_image_inventory/raw/master/blog/20250317211008634.png" alt="image-20250316104553452"></p>
<p>在AddPass中开启了混合，因为我们需要进行光照的叠加</p>
<p>这只是在通常情况下，渲染路径告诉Unity这个Pass在前向渲染当中的位置，然后底层的渲染引擎就会进行相关计算并且填充一些内部变量（比如_LightColor0）如何使用这些内置变量进行计算完全取决于开发者的选择。</p>
<p><strong>前向渲染可以使用的内置光照变量</strong><br><img src="https://gitee.com/tonzin/picgo_image_inventory/raw/master/blog/20250317211008635.png" alt="image-20250316103909893"></p>
<p><img src="https://gitee.com/tonzin/picgo_image_inventory/raw/master/blog/20250317211008636.png" alt="image-20250316105030208"></p>
<h3 id="顶点照明渲染路径"><a href="#顶点照明渲染路径" class="headerlink" title="顶点照明渲染路径"></a>顶点照明渲染路径</h3><p>顶点照明渲染路径通常在一个Pass当中就可以完成对于物体的渲染，在这个Pass当中我们会计算我们关心的所有光源对于这个物体的照明。并且这个计算是按照逐顶点的方式进行处理的。</p>
<p>对硬件的配置要求最少，运算性能最高，但是同时也是得到效果最差的一种类</p>
<p><img src="https://gitee.com/tonzin/picgo_image_inventory/raw/master/blog/20250317211008637.png" alt="image-20250316105807890"></p>
<p>见书上P185</p>
<h3 id="延迟渲染路径"><a href="#延迟渲染路径" class="headerlink" title="延迟渲染路径"></a>延迟渲染路径</h3><p>当场景包含有大量实时光源前向渲染的性能就会急速下降，例如如果我们在场景当中的某一块区域放置了多个光源，这些光源影响的区域互相重叠，那么为了得到最终的光照效果，我们就需要我这个区域的每一个物体执行多个Pass来计算不同光源对这个物体的光照结果。然而每执行一个Pass我们都会需要重新渲染一遍物体。但是很多计算实际上是重复的。</p>
<p>延迟渲染主要包括了两个Pass，第一个Pass不进行任何的光照计算，仅仅计算哪一些片元可见，这主要是通过深度缓冲技术来进行实现。当发现自己一个片元是可见的，那么我们就可以把它的相关信息存储到G缓冲区当中，然后在第二个Pass当中，我们利用G缓冲区的各个片元信息，例如表面法线，视角方向，漫反射系统，来进行真正的光照计算。</p>
<p><img src="https://gitee.com/tonzin/picgo_image_inventory/raw/master/blog/20250317211008638.png" alt="image-20250316110120397"></p>
<p>延迟渲染的效率不依赖于场景的复杂度，而是和我们的屏幕空间的大小有关。</p>
<p>两种：<br>Unity5之前遗留的延迟渲染路径<br>Unity5.x当中使用的延迟渲染路径</p>
<p>如果游戏当中使用了大量的实时光照，那么我们可能希望选择延迟渲染路径，但是这种路径需要一定的硬件支持。</p>
<p><img src="https://gitee.com/tonzin/picgo_image_inventory/raw/master/blog/20250317211008639.png" alt="image-20250316111000469"></p>
<p>对于延迟渲染路径来说它适合在场景当中光源数量很多的时候。<br>缺点在于：<br>不能支持真正的抗锯齿anti-aliasing功能<br>不能处理半透明物体<br>对显卡有一定的要求，如果要使用延迟渲染的话，显卡必须支持MRT，Shader Mode3.0以及以上，深度渲染纹理以及双面的模版缓冲。</p>
<p>当使用延迟渲染的时候Unity要求我们提供两个Pass<br>第一个Pass用于渲染G缓冲，在这个Pass当中我们要把物体的漫反射颜色，高光反射颜色、平滑度、法线、自发光和深度等信息渲染到屏幕空间的G缓冲区当中，对于每一个物体来说这个Pass只会执行一次。</p>
<p>第二个Pass用于计算真正的光照模型，这个Pass会使用上一个Pass当中渲染的数据来计算最终的光照颜色，再存储到帧缓冲当中。<br><img src="https://gitee.com/tonzin/picgo_image_inventory/raw/master/blog/20250317211008641.png" alt="image-20250316111705264"></p>
<p><strong>延迟渲染路径可访问的内置变量和函数</strong><br>这些变量都可以在UnityDeferredLibrary.cginc文件当中找到它们的声明。<br><img src="https://gitee.com/tonzin/picgo_image_inventory/raw/master/blog/20250317211008642.png" alt="image-20250316111936553"></p>
<h3 id="Unity官方文档中对渲染路径的比较"><a href="#Unity官方文档中对渲染路径的比较" class="headerlink" title="Unity官方文档中对渲染路径的比较"></a>Unity官方文档中对渲染路径的比较</h3><p><img src="https://gitee.com/tonzin/picgo_image_inventory/raw/master/blog/20250317211008643.png" alt="image-20250316112026495"></p>
<h2 id="光源"><a href="#光源" class="headerlink" title="光源"></a>光源</h2><p>光源的属性有 位置、方向、颜色、强度、以及衰减等</p>
<p>平行光<br>最简单的光，没有一个唯一的位置，通过调整rotation来改变它的光源方向。<br>而且平行光导场景中所有点的方向都是一样的，这也是平行光名字的由来。</p>
<p>点光源<br>照亮空间有限，一个球体定义，向所有方向延伸<br><img src="https://gitee.com/tonzin/picgo_image_inventory/raw/master/blog/20250317211008644.png" alt="image-20250316112426547"></p>
<p>聚光灯<br>照亮空间通用是有限的，但是是由空间中的一个椎体来决定<br><img src="https://gitee.com/tonzin/picgo_image_inventory/raw/master/blog/20250317211008645.png" alt="image-20250316112557633"></p>
<h3 id="在前向渲染当中处理不同的光源类型"><a href="#在前向渲染当中处理不同的光源类型" class="headerlink" title="在前向渲染当中处理不同的光源类型"></a>在前向渲染当中处理不同的光源类型</h3><pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl"><span class="token comment">// Upgrade NOTE: replaced '_LightMatrix0' with 'unity_WorldToLight'</span>

<span class="token comment">// Upgrade NOTE: replaced '_Object2World' with 'unity_ObjectToWorld'</span>
<span class="token comment">// Upgrade NOTE: replaced 'mul(UNITY_MATRIX_MVP,*)' with 'UnityObjectToClipPos(*)'</span>

Shader <span class="token string">"Custom/Chapter91_ForwardRendering"</span>
<span class="token punctuation">&#123;</span>
    Properties
    <span class="token punctuation">&#123;</span>
        <span class="token function">_Color</span> <span class="token punctuation">(</span><span class="token string">"Color Tint"</span><span class="token punctuation">,</span> Color<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token function">_Specularity</span> <span class="token punctuation">(</span><span class="token string">"Specular"</span><span class="token punctuation">,</span> Color<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token function">_Shininess</span> <span class="token punctuation">(</span><span class="token string">"Shininess"</span><span class="token punctuation">,</span> <span class="token function">Range</span><span class="token punctuation">(</span><span class="token number">8.</span><span class="token punctuation">,</span> <span class="token number">256.</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">120</span>
    <span class="token punctuation">&#125;</span>
    SubShader
    <span class="token punctuation">&#123;</span>
        Tags <span class="token punctuation">&#123;</span><span class="token string">"Queue"</span> <span class="token operator">=</span> <span class="token string">"Geometry"</span><span class="token punctuation">&#125;</span><span class="token comment">//设置渲染队列为Geometry，这样可以保证物体的前后顺序正确</span>
        Pass
        <span class="token punctuation">&#123;</span><span class="token comment">// Pass for ambient light &amp; first pixel light (directional light)</span>
            Tags <span class="token punctuation">&#123;</span><span class="token string">"LightMode"</span> <span class="token operator">=</span> <span class="token string">"ForwardBase"</span><span class="token punctuation">&#125;</span>

            CGPROGRAM
            
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">multi_compile_fwdbase</span></span>

            <span class="token comment">//这个定义可以保证我们在Shader当中使用的光照衰减等光照变量可以被正确的赋值</span>

            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">vertex vert</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">fragment frag</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Lighting.cginc"</span></span>

            fixed4 _Color<span class="token punctuation">;</span>
            fixed4 _Specularity<span class="token punctuation">;</span>
            <span class="token keyword">float</span> _Shininess<span class="token punctuation">;</span>

            <span class="token keyword">struct</span> <span class="token class-name">a2v</span>
            <span class="token punctuation">&#123;</span>
                float4 vertex <span class="token operator">:</span> POSITION<span class="token punctuation">;</span>
                float3 normal <span class="token operator">:</span> NORMAL<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

            <span class="token keyword">struct</span> <span class="token class-name">v2f</span>
            <span class="token punctuation">&#123;</span>
                float4 pos <span class="token operator">:</span> SV_POSITION<span class="token punctuation">;</span>
                float3 worldNormal <span class="token operator">:</span> TEXCOORD0<span class="token punctuation">;</span>
                float3 worldPos <span class="token operator">:</span> TEXCOORD1<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
            
            v2f <span class="token function">vert</span><span class="token punctuation">(</span>a2v v<span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                v2f o<span class="token punctuation">;</span>
                o<span class="token punctuation">.</span>pos <span class="token operator">=</span> <span class="token function">UnityObjectToClipPos</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>vertex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                o<span class="token punctuation">.</span>worldNormal <span class="token operator">=</span> <span class="token function">UnityObjectToWorldNormal</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>normal<span class="token punctuation">)</span><span class="token punctuation">;</span>
                o<span class="token punctuation">.</span>worldPos <span class="token operator">=</span> <span class="token function">mul</span><span class="token punctuation">(</span>unity_ObjectToWorld<span class="token punctuation">,</span> v<span class="token punctuation">.</span>vertex<span class="token punctuation">)</span><span class="token punctuation">.</span>xyz<span class="token punctuation">;</span>
                <span class="token comment">//o.uv = TRANSFORM_TEX(v.uv, _MainTex);</span>
                <span class="token keyword">return</span> o<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            fixed4 <span class="token function">frag</span><span class="token punctuation">(</span>v2f i<span class="token punctuation">)</span> <span class="token operator">:</span> SV_Target
            <span class="token punctuation">&#123;</span><span class="token comment">//每一个光源有五个属性：颜色，方向，位置，强度，衰减。</span>
                fixed3 worldNormal <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>worldNormal<span class="token punctuation">)</span><span class="token punctuation">;</span>
                fixed3 lightDir <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>_WorldSpaceLightPos0<span class="token punctuation">.</span>xyz<span class="token punctuation">)</span><span class="token punctuation">;</span>
                fixed3 viewDir <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span><span class="token function">UnityWorldToViewPos</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>worldPos<span class="token punctuation">)</span><span class="token punctuation">.</span>xyz<span class="token punctuation">)</span><span class="token punctuation">;</span>
                fixed3 halfDir <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>lightDir <span class="token operator">+</span> viewDir<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">//fixed4 albedo = tex2D(_MainTex , i.uv);</span>

                <span class="token comment">// 首先计算了环境的环境光</span>
                fixed3 ambient <span class="token operator">=</span> UNITY_LIGHTMODEL_AMBIENT<span class="token punctuation">.</span>xyz<span class="token punctuation">;</span> 
                <span class="token comment">// 计算了平行光的漫反射光</span>
                fixed3 dffuse <span class="token operator">=</span> _LightColor0<span class="token punctuation">.</span>rgb <span class="token operator">*</span> _Color<span class="token punctuation">.</span>rgb <span class="token operator">*</span> <span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token punctuation">,</span> <span class="token function">dot</span><span class="token punctuation">(</span>worldNormal<span class="token punctuation">,</span> lightDir<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 计算了平行光的镜面光</span>
                fixed3 specular <span class="token operator">=</span> _LightColor0<span class="token punctuation">.</span>rgb <span class="token operator">*</span> _Specularity<span class="token punctuation">.</span>rgb <span class="token operator">*</span> <span class="token function">pow</span><span class="token punctuation">(</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token punctuation">,</span> <span class="token function">dot</span><span class="token punctuation">(</span>worldNormal<span class="token punctuation">,</span> halfDir<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">,</span> _Shininess<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 衰减</span>
                <span class="token keyword">fixed</span> atten <span class="token operator">=</span> <span class="token number">1.0</span><span class="token punctuation">;</span><span class="token comment">//平行光可以认为没有衰减</span>
                
                fixed3 finalColor <span class="token operator">=</span> ambient <span class="token operator">+</span> <span class="token punctuation">(</span>dffuse <span class="token operator">+</span> specular<span class="token punctuation">)</span> <span class="token operator">*</span> atten<span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token function">fixed4</span><span class="token punctuation">(</span>ambient <span class="token operator">+</span> <span class="token punctuation">(</span>dffuse <span class="token operator">+</span> specular<span class="token punctuation">)</span> <span class="token operator">*</span> atten<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            
            ENDCG
        <span class="token punctuation">&#125;</span>

        Pass
        <span class="token punctuation">&#123;</span>
            Tags <span class="token punctuation">&#123;</span><span class="token string">"LightMode"</span> <span class="token operator">=</span> <span class="token string">"ForwardAdd"</span><span class="token punctuation">&#125;</span><span class="token comment">//注意要更改tag为ForwardAdd，否则不会进行第二次光照计算</span>

            Blend One One <span class="token comment">//选择混合系数为1，即完全不透明</span>
            <span class="token comment">//将计算得到的光照结果与原本的颜色进行相加</span>
            <span class="token comment">//如果没有blend命令，additional pass会覆盖掉原本的颜色</span>
            <span class="token comment">//常见的还有Blend SrcAlpha One</span>

            <span class="token comment">//一般来说Add Pass的光照处理和Base Pass的处理方式和Base Pass的处理方式是一样的</span>
            <span class="token comment">//只需要稍微做一些修改</span>
            CGPROGRAM
            
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">multi_compile_fwdadd</span></span>

            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">vertex vert</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">fragment frag</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Lighting.cginc"</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"AutoLight.cginc"</span><span class="token comment">//添加这个文件才可以进行光照衰减</span></span>

            fixed4 _Color<span class="token punctuation">;</span>
            fixed4 _Specularity<span class="token punctuation">;</span>
            <span class="token keyword">fixed</span> _Shininess<span class="token punctuation">;</span>

            <span class="token keyword">struct</span> <span class="token class-name">a2v</span>
            <span class="token punctuation">&#123;</span>
                float4 vertex <span class="token operator">:</span> POSITION<span class="token punctuation">;</span>
                float3 normal <span class="token operator">:</span> NORMAL<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

            <span class="token keyword">struct</span> <span class="token class-name">v2f</span>
            <span class="token punctuation">&#123;</span>
                float4 pos <span class="token operator">:</span> SV_POSITION<span class="token punctuation">;</span>
                float3 worldNormal <span class="token operator">:</span> TEXCOORD0<span class="token punctuation">;</span>
                float3 worldPos <span class="token operator">:</span> TEXCOORD1<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
            
            v2f <span class="token function">vert</span><span class="token punctuation">(</span>a2v v<span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                v2f o<span class="token punctuation">;</span>
                o<span class="token punctuation">.</span>pos <span class="token operator">=</span> <span class="token function">UnityObjectToClipPos</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>vertex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                o<span class="token punctuation">.</span>worldNormal <span class="token operator">=</span> <span class="token function">UnityObjectToWorldNormal</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>normal<span class="token punctuation">)</span><span class="token punctuation">;</span>
                o<span class="token punctuation">.</span>worldPos <span class="token operator">=</span> <span class="token function">mul</span><span class="token punctuation">(</span>unity_ObjectToWorld<span class="token punctuation">,</span> v<span class="token punctuation">.</span>vertex<span class="token punctuation">)</span><span class="token punctuation">.</span>xyz<span class="token punctuation">;</span>
                <span class="token comment">//o.uv = TRANSFORM_TEX(v.uv, _MainTex);</span>
                <span class="token keyword">return</span> o<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            fixed4 <span class="token function">frag</span><span class="token punctuation">(</span>v2f i<span class="token punctuation">)</span> <span class="token operator">:</span> SV_Target
            <span class="token punctuation">&#123;</span><span class="token comment">//每一个光源有五个属性：颜色，方向，位置，强度，衰减。</span>
                fixed3 worldNormal <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>worldNormal<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">//fixed4 albedo = tex2D(_MainTex , i.uv);</span>

                <span class="token comment">//————不用再计算环境光了，因为已经在Base Pass中计算过了</span>
                <span class="token comment">//fixed3 ambient = UNITY_LIGHTMODEL_AMBIENT.xyz; </span>

                <span class="token comment">//首先判断了当前处理的逐像素光源类型，这事通过使用#ifdef指令判断是否定义了</span>
                <span class="token comment">//USING_DIRECTIONAL_LIGHT 这个宏来得到的</span>
                <span class="token comment">//如果是平行光，那么unity的底层渲染引擎就会定义usingDirectionalLight这个宏</span>
                <span class="token comment">//如果是点光源，那么就不会定义这个宏</span>
                <span class="token comment">//得知是平行光之后，光源方向可以直接由_WorldSpaceLightPos0.xyz得到。</span>
                <span class="token comment">//如果是点光源或者聚光灯，那么_WorldSpaceLightPos0.xyz表示的是世界坐标下的光源位置</span>
                <span class="token comment">//而想要得到光源的方向的话，那么我们就需要用这个位置减去世界空间下的顶点位置。</span>
                <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">USING_DIRECTIONAL_LIGHT</span></span>
                    fixed3 worldLightDir <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>_WorldSpaceLightPos0<span class="token punctuation">.</span>xyz<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
                    fixed3 worldLightDir <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>_WorldSpaceLightPos0<span class="token punctuation">.</span>xyz <span class="token operator">-</span> i<span class="token punctuation">.</span>worldPos<span class="token punctuation">.</span>xyz<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
                fixed3 viewDir <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span><span class="token function">UnityWorldToViewPos</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>worldPos<span class="token punctuation">)</span><span class="token punctuation">.</span>xyz<span class="token punctuation">)</span><span class="token punctuation">;</span>
                fixed3 halfDir <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>worldLightDir <span class="token operator">+</span> viewDir<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// 计算了漫反射光</span>
                fixed3 dffuse <span class="token operator">=</span> _LightColor0<span class="token punctuation">.</span>rgb <span class="token operator">*</span> _Color<span class="token punctuation">.</span>rgb <span class="token operator">*</span> <span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token punctuation">,</span> <span class="token function">dot</span><span class="token punctuation">(</span>worldNormal<span class="token punctuation">,</span> worldLightDir<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 计算了镜面光</span>
                fixed3 specular <span class="token operator">=</span> _LightColor0<span class="token punctuation">.</span>rgb <span class="token operator">*</span> _Specularity<span class="token punctuation">.</span>rgb <span class="token operator">*</span> <span class="token function">pow</span><span class="token punctuation">(</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token punctuation">,</span> <span class="token function">dot</span><span class="token punctuation">(</span>worldNormal<span class="token punctuation">,</span> halfDir<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">,</span> _Shininess<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 衰减</span>


                <span class="token comment">//尽管我们可以使用数学表达式来计算点光源和聚光灯的衰减，但是这些计算往往涉及到开根号、除法等计算量较大的操作</span>
                <span class="token comment">//Unity选择使用一张纹理作为查找表（Lookup Table，LUT）来存储衰减值</span>
                <span class="token comment">//我们首先得到光源空间下的坐标，然后用这个坐标对衰减纹理进行采样得到衰减值。</span>
                <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">USING_DIRECTIONAL_LIGHT</span></span>
                    <span class="token keyword">fixed</span> atten <span class="token operator">=</span> <span class="token number">1.0</span><span class="token punctuation">;</span>
                <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span> </span>
                    <span class="token comment">//获取物体在光源坐标下的位置</span>
                    float3 lightCoord <span class="token operator">=</span> <span class="token function">mul</span><span class="token punctuation">(</span>unity_WorldToLight <span class="token punctuation">,</span> <span class="token function">float4</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>worldPos <span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>xyz<span class="token punctuation">;</span>
                    <span class="token comment">//光源可能是一个贴图，所以需要使用tex2D来获取衰减值，不过一般都是一个颜色</span>
                    <span class="token keyword">fixed</span> atten <span class="token operator">=</span> <span class="token function">tex2D</span><span class="token punctuation">(</span>_LightTexture0 <span class="token punctuation">,</span> <span class="token function">dot</span><span class="token punctuation">(</span>lightCoord <span class="token punctuation">,</span> lightCoord<span class="token punctuation">)</span><span class="token punctuation">.</span>rr<span class="token punctuation">)</span><span class="token punctuation">.</span>UNITY_ATTEN_CHANNEL<span class="token punctuation">;</span>
                <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
                
                fixed3 finalColor <span class="token operator">=</span> <span class="token punctuation">(</span>dffuse <span class="token operator">+</span> specular<span class="token punctuation">)</span> <span class="token operator">*</span> atten<span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token function">fixed4</span><span class="token punctuation">(</span><span class="token punctuation">(</span>dffuse <span class="token operator">+</span> specular<span class="token punctuation">)</span> <span class="token operator">*</span> atten<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            
            ENDCG
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">//FallBack "Specular"</span>
<span class="token punctuation">&#125;</span>

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这段代码暂时还无法正常表现，我们在场景当中新建一个场景，放置一个球体，附着这个材质，然后给场景中添加3个不同的点光源，得到这样的效果</p>
<p><img src="https://gitee.com/tonzin/picgo_image_inventory/raw/master/blog/20250317211008646.png" alt="image-20250316143440764"></p>
<p>这种效果怎么来的？<br>当我们创建一个光源的时候，默认情况下它的rendermode是auto。这意味着，unity会在后面为我们判断哪些光源会按照逐像素处理，而哪些按逐顶点或者SH的方式进行处理。由于我们没有更改Edit -&gt; Project Settings -&gt; Quality -&gt; Pixel Light Count 当中的数值，因此默认情况下一个物体可以接受除最亮的平行光之外的4个逐像素光照。<br>在这个例子当中场景中包含了4个光源，其中一个是平行光，它会在Base Pass当中按照逐像素的方式被处理，其余3个都是点光源，由于它们的Render Mode为Auto而且数目正好又等于3 &lt; 4，因此都会在Add Pass当中按照逐像素的方式被处理，每一个光源都会调用一次Add Pass。</p>
<p>我们还可以使用帧调试器（Frame Debugger）工具来查看场景的绘制过程。<br><img src="https://gitee.com/tonzin/picgo_image_inventory/raw/master/blog/20250317211008647.png" alt="image-20250316132308373"></p>
<p><img src="https://gitee.com/tonzin/picgo_image_inventory/raw/master/blog/20250317211008648.png" alt="在这里插入图片描述"></p>
<p><img src="https://gitee.com/tonzin/picgo_image_inventory/raw/master/blog/20250317211008649.png" alt="image-20250316143705161"></p>
<p> Frame Debugger进行逐帧调试。渲染顺序是根据光源的重要程度排序的。</p>
<p>如果逐像素光源的数目很多的话，这个物体的additional pass就会被调用很多次，影响性能。</p>
<p>我们可以把光源的render mode设置成NotImportant来告诉Unity，我们不希望将这个光源当成逐像素处理。比如我们把3个点光源的render mode都设置成not important 那么我们就可以得到下面的结果</p>
<p><img src="https://gitee.com/tonzin/picgo_image_inventory/raw/master/blog/20250317211008650.png" alt="image-20250316144258292"></p>
<p>由于我们在shader当中没有在base Pass当中计算逐顶点和SH光源，因此场景当中的四个点光源实际上不会对物体造成影响，如果把平行光的render mode也设置成not important，那么物体就仅仅会显示环境光的光照效果。</p>
<h3 id="Unity当中的光照衰减"><a href="#Unity当中的光照衰减" class="headerlink" title="Unity当中的光照衰减"></a>Unity当中的光照衰减</h3><p>用于光照衰减的纹理<br>Unity在内部使用一张名为_LightTexture0的纹理来计算光源衰减</p>
<p>如果我们对光源使用了cookie，那么衰减查找纹理是_LightTextureB0</p>
<p>我们通常只关心_LightTexture0对角线上的纹理颜色值，这些值表明了在光源不同位置的衰减值。其中0 0代表了与光源位置重合的时候的衰减值，而1,1点表面了在光源空间当中所关心的距离最远的点的衰减。</p>
<p>我们要先得到该点在<strong>光源空间</strong>中的位置，这是通过_LightMatrix0变换得到的，我们需要将 _LightMatrix0和世界空间当中的顶点坐标相乘即可得到光源空间当中的相应位置。</p>
<p>之后我们可以使用这个坐标的模的平方来对衰减纹理进行采样，得到衰减值。<br>（之所以没有使用距离值采样是因为这样避免了开方操作）</p>
<p>然后我们使用UNITY_ATTEN_CHANNEL来得到衰减纹理中衰减值所在的分量。得到了最终的衰减值<br><img src="https://gitee.com/tonzin/picgo_image_inventory/raw/master/blog/20250317211008651.png" alt="image-20250316145258378"></p>
<p><strong>使用数学公式进行衰减</strong></p>
<p>纹理采样的方法可以减少衰减时的复杂度<br>但是仍然可以使用数学来进行衰减计算<br>比如<br><img src="https://gitee.com/tonzin/picgo_image_inventory/raw/master/blog/20250317211008652.png" alt="image-20250316145417995"></p>
<p>我们无法再shader当中通过内置变量得到光源的方位聚光灯的朝鲜张开角度等信息，得到的效果常常不尽人意。</p>
<h3 id="Unity当中的阴影"><a href="#Unity当中的阴影" class="headerlink" title="Unity当中的阴影"></a>Unity当中的阴影</h3><p>阴影是如何实现的。</p>
<p>在实时渲染的时候我们最常使用的是一种叫做<strong>shadowMap</strong>的技术，这种技术首先会把摄像机的位置放在与光源位置重合的位置上，那么场景当中这个光源的阴影区域就是哪些摄像机看不到的地方，unity使用这种技术。</p>
<p>在前向渲染路径当中，如果场景当中最重要的平行光开启了阴影，Unity就会为这个光源计算它的阴影映射纹理(shadowMap) ，这张阴影映射纹理本质上是一张<strong>深度图</strong>，它记录了这个光源的位置出发，看到的场景当中距离它最近的表面位置（深度信息）。</p>
<p>在计算阴影映射纹理的时候如何判断距离它最近的表面距离？</p>
<p>1，把摄像机放到光源的位置上，然后按照正常的渲染流程，即调用base pass 和additional pass来更新深度信息，得到阴影映射纹理，但是这种方法会对性能造成一定的浪费，因为我们只需要知道深度信息</p>
<p>Unity选择使用一个额外的pass来专门更新光源的阴影映射纹理，这个pass就是lightmode标签被设置为<strong>shadowcaster</strong>的pass</p>
<p>这个pass的渲染目标不是帧缓存，而是阴影映射纹理（或者深度纹理）。</p>
<p>Unity先把摄像机放到光源的位置上，然后调用这个Pass，通过对顶点变换后得到光源空间下的位置，<strong>并且据此来输出深度信息到<u>阴影映射纹理</u>当中</strong></p>
<p>因此当开启了光源的阴影效果之后底层渲染引擎会先在当前渲染物体的UnityShader当中找到LightMode为ShadowCaster的Pass，如果没有他就会在Fallback指定的UnityShader当中寻找，如果仍然没有找到，该物体就无法向其它的物体投射投影。（但是它仍然可以接受来自其他物体的阴影）</p>
<p>当找到了一个LightMode为ShadowCaster的Pass之后，Unity就会使用这个Pass更新光源的阴影映射纹理</p>
<p>在传统的阴影映射纹理的实现中，我们会在正常渲染的Pass当中把顶点位置变换到光源空间下，得到他在光源空间中的三维位置信息。</p>
<p>然后我们使用xy分量对阴影映射纹理进行采样，得到阴影映射纹理的深度信息，如果该深度值小于该点的深度值（通常由z分量得到）那么说明该点位于阴影当中。</p>
<p><img src="https://gitee.com/tonzin/picgo_image_inventory/raw/master/blog/20250317211008653.png" alt="image-20250316154827600"></p>
<p>2，在Unity当中Unity使用了不同于这种传统的阴影采样技术，即<strong>屏幕空间的阴影映射技术</strong>。</p>
<p>屏幕空间的阴影映射原本是延迟渲染中产生阴影的方法，但是需要注意的是，不是所有平台Unity都会采用这种技术，因为屏幕空间的阴影映射需要显卡支持MRT，一些移动平台往往不支持</p>
<p>Unity会通过调用LightMode为ShadowCaster的Pass来得到可投射阴影的光源的阴影映射纹理以及摄像机的深度纹理。然后根据光源的阴影映射纹理和摄像机的深度纹理来得到<strong>屏幕空间的阴影图</strong>，<strong>如果摄像机的深度图当中记录的表面深度大于转换到阴影映射纹理当中的深度值，就说明该表面虽然是可见的，但是却处于光源的阴影当中。</strong></p>
<p>通过这种方式，阴影图就包含了屏幕空间中所有有阴影的区域，如果我们想要一个物体接收来自其他物体的阴影，只需要在shader中对阴影图进行采样。由于阴影图是在屏幕空间下的，因此我们首先要把表面坐标从模型空间转换到屏幕空间当中。</p>
<p>然后使用这个坐标对阴影图进行采样即可。</p>
<p>一个物体接收来自其他物体的阴影，以及它乡其他物体投射阴影是两个过程：</p>
<p>如果我们想要一个物体接收来自其他物体的阴影，就必须在Shader当中对阴影映射纹理（包括屏幕空间当中的阴影图）进行采样，把采样结果和最后的光照结果相乘来产生阴影效果。</p>
<p>如果我们想要一个物体向其它物体投射阴影，就必须把物体加入到光源的阴影映射纹理的计算中，从而让其他物体在对阴影映射纹理采样的时候可以得到这个物体的相关信息。在unity当中，这个过程是通过为这个物体执行LightMode为ShadowCaster的Pass来实现的，如果使用了屏幕空间的投影映射技术，Unity还会使用这个Pass产生一张摄像机的深度纹理。</p>
<h4 id="不透明物体的阴影"><a href="#不透明物体的阴影" class="headerlink" title="不透明物体的阴影"></a>不透明物体的阴影</h4><p><img src="https://gitee.com/tonzin/picgo_image_inventory/raw/master/blog/20250317211008654.png" alt="image-20250316161229118"></p>
<p>Cast Shadows可以被设置成On或者Off关闭，如果开启了CastShadows属性<br>那么Unity就会把物体加入到光源的阴影映射纹理的计算当中。让其他物体在对阴影映射纹理进行采样的时候得到该物体的相关信息。</p>
<p>Receive Shadows则可以选择是否让物体接收来自其他物体的阴影，如果没有开启receive shadows，那么当我们调用unity的内置宏和变量计算阴影的时候这些宏通过判断物体有没有开启接收阴影接收的功能，就不会在内部为我们计算阴影。</p>
<p>我直接创建的正方体是没有阴影的<br><img src="https://gitee.com/tonzin/picgo_image_inventory/raw/master/blog/20250317211008655.png" alt="image-20250316162013993"><br>这是因为我把Fallback’注释掉了<br><img src="https://gitee.com/tonzin/picgo_image_inventory/raw/master/blog/20250317211008656.png" alt="image-20250316162032367"><br>如果取消注释<br><img src="https://gitee.com/tonzin/picgo_image_inventory/raw/master/blog/20250317211008657.png" alt="image-20250316162050746"></p>
<p><img src="https://gitee.com/tonzin/picgo_image_inventory/raw/master/blog/20250317211008658.png" alt="image-20250316162112475"></p>
<p>在specular通过不断回调中寻找到了lightmode为shadow caster的pass</p>
<p><img src="https://gitee.com/tonzin/picgo_image_inventory/raw/master/blog/20250317211008659.png" alt="image-20250316162252101"></p>
<p>由于面剔除，平面背面没有渲染阴影<br><img src="https://gitee.com/tonzin/picgo_image_inventory/raw/master/blog/20250317211008660.png" alt="image-20250316162546279"><br>我们需要把它Cast Shadows 设置成two sides<br><img src="https://gitee.com/tonzin/picgo_image_inventory/raw/master/blog/20250317211008661.png" alt="image-20250316162714783"></p>
<p><img src="https://gitee.com/tonzin/picgo_image_inventory/raw/master/blog/20250317211008662.png" alt="image-20250316162705515"></p>
<p>但是我们看到正方体并没有接收到来自平面的阴影</p>
<p>SHADOW_COORDS、TRANSFER_SHADOW、SHADOW_ATTENUATION是计算阴影时的“三剑客”，这些内置宏帮助我们在必要的时候计算光源的阴影。</p>
<p><img src="https://gitee.com/tonzin/picgo_image_inventory/raw/master/blog/20250317211008663.png" alt="image-20250316163902004"></p>
<p><img src="https://gitee.com/tonzin/picgo_image_inventory/raw/master/blog/20250317211008664.png" alt="image-20250316163912791"></p>
<p>上面代码实际上是unity为了处理不同的光源类型，不同平台而定义了多个版本的宏，在前向渲染当中<br>SHADOW_COORDS实际上就是声明了一个名为_ShadowCoord的阴影纹理坐标变量</p>
<p>而TRANSFER_SHADOW的实现会根据不同平台而有所差异。如果当前平台可以使用屏幕空间的阴影映射技术（通过片段是否定义了UNITY_NO_SCREENSPACE_SHADOWS）来得到。TRANSFER_SHADOW会调用内置的ComputeScreenPos函数来计算 _ShadowCoord。如果这个平台不支持屏幕空间的阴影映射技术，就会使用传统的阴影映射技术。这个宏会把顶点坐标从模型空间变换到光源空间后存储到 _ShadowCoord中</p>
<p>然后SHADOW_ATTENUATION负责使用_ShadowCoord对相关的纹理进行采样，得到阴影信息</p>
<p>注意到上面的内代码在最后定义了在关闭阴影时的处理代码。当关闭阴影之火SHADOW_COORDS、TRANSFER_SHADOW实际没有发生作用，SHADOW_ATTENUATION会等于1</p>
<p><img src="https://gitee.com/tonzin/picgo_image_inventory/raw/master/blog/20250317211008665.png" alt="image-20250316164808839"></p>
<p>完成操作之后我们只要把阴影值shadow鹅漫反射以及高光反射颜色相乘就行。</p>
<pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl">Shader <span class="token string">"Custom/Chapter92_ShadowRendering"</span>
<span class="token punctuation">&#123;</span>
    Properties
    <span class="token punctuation">&#123;</span>
        <span class="token function">_Color</span> <span class="token punctuation">(</span><span class="token string">"Color Tint"</span><span class="token punctuation">,</span> Color<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token function">_Specularity</span> <span class="token punctuation">(</span><span class="token string">"Specular"</span><span class="token punctuation">,</span> Color<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token function">_Shininess</span> <span class="token punctuation">(</span><span class="token string">"Shininess"</span><span class="token punctuation">,</span> <span class="token function">Range</span><span class="token punctuation">(</span><span class="token number">8.</span><span class="token punctuation">,</span> <span class="token number">256.</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">120</span>
    <span class="token punctuation">&#125;</span>
    SubShader
    <span class="token punctuation">&#123;</span>
        Tags <span class="token punctuation">&#123;</span><span class="token string">"Queue"</span> <span class="token operator">=</span> <span class="token string">"Geometry"</span><span class="token punctuation">&#125;</span>
        Pass
        <span class="token punctuation">&#123;</span>
            Tags <span class="token punctuation">&#123;</span><span class="token string">"LightMode"</span> <span class="token operator">=</span> <span class="token string">"ForwardBase"</span><span class="token punctuation">&#125;</span>

            CGPROGRAM
            
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">multi_compile_fwdbase</span></span>

            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">vertex vert</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">fragment frag</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Lighting.cginc"</span></span>
            <span class="token comment">//#include "AutoLight.cginc"</span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"AutoLight.cginc"</span><span class="token comment">//添加一个新的内置文件计算阴影</span></span>

            fixed4 _Color<span class="token punctuation">;</span>
            fixed4 _Specularity<span class="token punctuation">;</span>
            <span class="token keyword">float</span> _Shininess<span class="token punctuation">;</span>

            <span class="token keyword">struct</span> <span class="token class-name">a2v</span>
            <span class="token punctuation">&#123;</span>
                float4 vertex <span class="token operator">:</span> POSITION<span class="token punctuation">;</span>
                float3 normal <span class="token operator">:</span> NORMAL<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

            <span class="token keyword">struct</span> <span class="token class-name">v2f</span>
            <span class="token punctuation">&#123;</span>
                float4 pos <span class="token operator">:</span> SV_POSITION<span class="token punctuation">;</span>
                float3 worldNormal <span class="token operator">:</span> TEXCOORD0<span class="token punctuation">;</span>
                float3 worldPos <span class="token operator">:</span> TEXCOORD1<span class="token punctuation">;</span>

                <span class="token function">SHADOW_COORDS</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment">//添加一个新的宏，用于声明阴影贴图的UV坐标</span>
                <span class="token comment">//它的参数需要下一个可用的插值寄存器的索引值。</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
            
            v2f <span class="token function">vert</span><span class="token punctuation">(</span>a2v v<span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                v2f o<span class="token punctuation">;</span>
                <span class="token comment">//计算阴影贴图的UV坐标</span>
                o<span class="token punctuation">.</span>pos <span class="token operator">=</span> <span class="token function">UnityObjectToClipPos</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>vertex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                o<span class="token punctuation">.</span>worldNormal <span class="token operator">=</span> <span class="token function">UnityObjectToWorldNormal</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>normal<span class="token punctuation">)</span><span class="token punctuation">;</span>
                o<span class="token punctuation">.</span>worldPos <span class="token operator">=</span> <span class="token function">mul</span><span class="token punctuation">(</span>unity_ObjectToWorld<span class="token punctuation">,</span> v<span class="token punctuation">.</span>vertex<span class="token punctuation">)</span><span class="token punctuation">.</span>xyz<span class="token punctuation">;</span>

                <span class="token function">TRANSFER_SHADOW</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//调用宏，将阴影贴图的UV坐标传给寄存器2</span>

                <span class="token keyword">return</span> o<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            fixed4 <span class="token function">frag</span><span class="token punctuation">(</span>v2f i<span class="token punctuation">)</span> <span class="token operator">:</span> SV_Target
            <span class="token punctuation">&#123;</span>

                fixed3 worldNormal <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>worldNormal<span class="token punctuation">)</span><span class="token punctuation">;</span>
                fixed3 lightDir <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>_WorldSpaceLightPos0<span class="token punctuation">.</span>xyz<span class="token punctuation">)</span><span class="token punctuation">;</span>
                fixed3 viewDir <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span><span class="token function">UnityWorldToViewPos</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>worldPos<span class="token punctuation">)</span><span class="token punctuation">.</span>xyz<span class="token punctuation">)</span><span class="token punctuation">;</span>
                fixed3 halfDir <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>lightDir <span class="token operator">+</span> viewDir<span class="token punctuation">)</span><span class="token punctuation">;</span>

                fixed3 ambient <span class="token operator">=</span> UNITY_LIGHTMODEL_AMBIENT<span class="token punctuation">.</span>xyz<span class="token punctuation">;</span> 
                fixed3 dffuse <span class="token operator">=</span> _LightColor0<span class="token punctuation">.</span>rgb <span class="token operator">*</span> _Color<span class="token punctuation">.</span>rgb <span class="token operator">*</span> <span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token punctuation">,</span> <span class="token function">dot</span><span class="token punctuation">(</span>worldNormal<span class="token punctuation">,</span> lightDir<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                fixed3 specular <span class="token operator">=</span> _LightColor0<span class="token punctuation">.</span>rgb <span class="token operator">*</span> _Specularity<span class="token punctuation">.</span>rgb <span class="token operator">*</span> <span class="token function">pow</span><span class="token punctuation">(</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token punctuation">,</span> <span class="token function">dot</span><span class="token punctuation">(</span>worldNormal<span class="token punctuation">,</span> halfDir<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">,</span> _Shininess<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">fixed</span> atten <span class="token operator">=</span> <span class="token number">1.0</span><span class="token punctuation">;</span>
                <span class="token keyword">fixed</span> shadow <span class="token operator">=</span> <span class="token function">SHADOW_ATTENUATION</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//调用宏，计算阴影贴图的衰减值</span>
                
                fixed3 finalColor <span class="token operator">=</span> ambient <span class="token operator">+</span> <span class="token punctuation">(</span>dffuse <span class="token operator">+</span> specular<span class="token punctuation">)</span> <span class="token operator">*</span> atten <span class="token operator">*</span> shadow<span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token function">fixed4</span><span class="token punctuation">(</span>ambient <span class="token operator">+</span> <span class="token punctuation">(</span>dffuse <span class="token operator">+</span> specular<span class="token punctuation">)</span> <span class="token operator">*</span> atten <span class="token operator">*</span> shadow<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            
            ENDCG
        <span class="token punctuation">&#125;</span>

        Pass
        <span class="token punctuation">&#123;</span>
            Tags <span class="token punctuation">&#123;</span><span class="token string">"LightMode"</span> <span class="token operator">=</span> <span class="token string">"ForwardAdd"</span><span class="token punctuation">&#125;</span>

            Blend One One 

            CGPROGRAM
            
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">multi_compile_fwdadd</span></span>

            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">vertex vert</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">fragment frag</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Lighting.cginc"</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"AutoLight.cginc"</span></span>

            fixed4 _Color<span class="token punctuation">;</span>
            fixed4 _Specularity<span class="token punctuation">;</span>
            <span class="token keyword">fixed</span> _Shininess<span class="token punctuation">;</span>

            <span class="token keyword">struct</span> <span class="token class-name">a2v</span>
            <span class="token punctuation">&#123;</span>
                float4 vertex <span class="token operator">:</span> POSITION<span class="token punctuation">;</span>
                float3 normal <span class="token operator">:</span> NORMAL<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

            <span class="token keyword">struct</span> <span class="token class-name">v2f</span>
            <span class="token punctuation">&#123;</span>
                float4 pos <span class="token operator">:</span> SV_POSITION<span class="token punctuation">;</span>
                float3 worldNormal <span class="token operator">:</span> TEXCOORD0<span class="token punctuation">;</span>
                float3 worldPos <span class="token operator">:</span> TEXCOORD1<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
            
            v2f <span class="token function">vert</span><span class="token punctuation">(</span>a2v v<span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                v2f o<span class="token punctuation">;</span>
                o<span class="token punctuation">.</span>pos <span class="token operator">=</span> <span class="token function">UnityObjectToClipPos</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>vertex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                o<span class="token punctuation">.</span>worldNormal <span class="token operator">=</span> <span class="token function">UnityObjectToWorldNormal</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>normal<span class="token punctuation">)</span><span class="token punctuation">;</span>
                o<span class="token punctuation">.</span>worldPos <span class="token operator">=</span> <span class="token function">mul</span><span class="token punctuation">(</span>unity_ObjectToWorld<span class="token punctuation">,</span> v<span class="token punctuation">.</span>vertex<span class="token punctuation">)</span><span class="token punctuation">.</span>xyz<span class="token punctuation">;</span>
                <span class="token keyword">return</span> o<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            fixed4 <span class="token function">frag</span><span class="token punctuation">(</span>v2f i<span class="token punctuation">)</span> <span class="token operator">:</span> SV_Target
            <span class="token punctuation">&#123;</span><span class="token comment">//每一个光源有五个属性：颜色，方向，位置，强度，衰减。</span>
                fixed3 worldNormal <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>worldNormal<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">USING_DIRECTIONAL_LIGHT</span></span>
                    fixed3 worldLightDir <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>_WorldSpaceLightPos0<span class="token punctuation">.</span>xyz<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
                    fixed3 worldLightDir <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>_WorldSpaceLightPos0<span class="token punctuation">.</span>xyz <span class="token operator">-</span> i<span class="token punctuation">.</span>worldPos<span class="token punctuation">.</span>xyz<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
                fixed3 viewDir <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span><span class="token function">UnityWorldToViewPos</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>worldPos<span class="token punctuation">)</span><span class="token punctuation">.</span>xyz<span class="token punctuation">)</span><span class="token punctuation">;</span>
                fixed3 halfDir <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>worldLightDir <span class="token operator">+</span> viewDir<span class="token punctuation">)</span><span class="token punctuation">;</span>

                fixed3 dffuse <span class="token operator">=</span> _LightColor0<span class="token punctuation">.</span>rgb <span class="token operator">*</span> _Color<span class="token punctuation">.</span>rgb <span class="token operator">*</span> <span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token punctuation">,</span> <span class="token function">dot</span><span class="token punctuation">(</span>worldNormal<span class="token punctuation">,</span> worldLightDir<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                fixed3 specular <span class="token operator">=</span> _LightColor0<span class="token punctuation">.</span>rgb <span class="token operator">*</span> _Specularity<span class="token punctuation">.</span>rgb <span class="token operator">*</span> <span class="token function">pow</span><span class="token punctuation">(</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token punctuation">,</span> <span class="token function">dot</span><span class="token punctuation">(</span>worldNormal<span class="token punctuation">,</span> halfDir<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">,</span> _Shininess<span class="token punctuation">)</span><span class="token punctuation">;</span>
                
                <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">USING_DIRECTIONAL_LIGHT</span></span>
                    <span class="token keyword">fixed</span> atten <span class="token operator">=</span> <span class="token number">1.0</span><span class="token punctuation">;</span>
                <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span> </span>
                    float3 lightCoord <span class="token operator">=</span> <span class="token function">mul</span><span class="token punctuation">(</span>unity_WorldToLight <span class="token punctuation">,</span> <span class="token function">float4</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>worldPos <span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>xyz<span class="token punctuation">;</span>
                    <span class="token keyword">fixed</span> atten <span class="token operator">=</span> <span class="token function">tex2D</span><span class="token punctuation">(</span>_LightTexture0 <span class="token punctuation">,</span> <span class="token function">dot</span><span class="token punctuation">(</span>lightCoord <span class="token punctuation">,</span> lightCoord<span class="token punctuation">)</span><span class="token punctuation">.</span>rr<span class="token punctuation">)</span><span class="token punctuation">.</span>UNITY_ATTEN_CHANNEL<span class="token punctuation">;</span>
                <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
                
                fixed3 finalColor <span class="token operator">=</span> <span class="token punctuation">(</span>dffuse <span class="token operator">+</span> specular<span class="token punctuation">)</span> <span class="token operator">*</span> atten<span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token function">fixed4</span><span class="token punctuation">(</span><span class="token punctuation">(</span>dffuse <span class="token operator">+</span> specular<span class="token punctuation">)</span> <span class="token operator">*</span> atten<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            
            ENDCG
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    FallBack <span class="token string">"Specular"</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p><img src="https://gitee.com/tonzin/picgo_image_inventory/raw/master/blog/20250317211008666.png" alt="image-20250316180721012"></p>
<p><strong>使用帧调试器查看阴影的绘制过程</strong></p>
<p><strong>统一管理光照衰减和阴影</strong></p>
<p>光照衰减因子 和 阴影值及光照结果相乘得到最终渲染结果<br>Unity提供了内置宏UNITY_LIGHT_ATTENUATION可以同时计算两个信息。</p>
<pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl">Shader <span class="token string">"Custom/Chapter93_ShadowAttenuation"</span>
<span class="token punctuation">&#123;</span>
    Properties
    <span class="token punctuation">&#123;</span>
        <span class="token function">_Color</span> <span class="token punctuation">(</span><span class="token string">"Color Tint"</span><span class="token punctuation">,</span> Color<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token function">_Specularity</span> <span class="token punctuation">(</span><span class="token string">"Specular"</span><span class="token punctuation">,</span> Color<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token function">_Shininess</span> <span class="token punctuation">(</span><span class="token string">"Shininess"</span><span class="token punctuation">,</span> <span class="token function">Range</span><span class="token punctuation">(</span><span class="token number">8.</span><span class="token punctuation">,</span> <span class="token number">256.</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">120</span>
    <span class="token punctuation">&#125;</span>
    SubShader
    <span class="token punctuation">&#123;</span>
        Tags <span class="token punctuation">&#123;</span><span class="token string">"Queue"</span> <span class="token operator">=</span> <span class="token string">"Geometry"</span><span class="token punctuation">&#125;</span>
        Pass
        <span class="token punctuation">&#123;</span>
            Tags <span class="token punctuation">&#123;</span><span class="token string">"LightMode"</span> <span class="token operator">=</span> <span class="token string">"ForwardBase"</span><span class="token punctuation">&#125;</span>

            CGPROGRAM
            
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">multi_compile_fwdbase</span></span>

            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">vertex vert</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">fragment frag</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Lighting.cginc"</span></span>

            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"AutoLight.cginc"</span><span class="token comment">//添加一个新的内置文件计算阴影</span></span>

            fixed4 _Color<span class="token punctuation">;</span>
            fixed4 _Specularity<span class="token punctuation">;</span>
            <span class="token keyword">float</span> _Shininess<span class="token punctuation">;</span>

            <span class="token keyword">struct</span> <span class="token class-name">a2v</span>
            <span class="token punctuation">&#123;</span>
                float4 vertex <span class="token operator">:</span> POSITION<span class="token punctuation">;</span>
                float3 normal <span class="token operator">:</span> NORMAL<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

            <span class="token keyword">struct</span> <span class="token class-name">v2f</span>
            <span class="token punctuation">&#123;</span>
                float4 pos <span class="token operator">:</span> SV_POSITION<span class="token punctuation">;</span>
                float3 worldNormal <span class="token operator">:</span> TEXCOORD0<span class="token punctuation">;</span>
                float3 worldPos <span class="token operator">:</span> TEXCOORD1<span class="token punctuation">;</span>

                <span class="token function">SHADOW_COORDS</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment">//添加一个新的宏，用于声明阴影贴图的UV坐标</span>
                <span class="token comment">//它的参数需要下一个可用的插值寄存器的索引值。</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
            
            v2f <span class="token function">vert</span><span class="token punctuation">(</span>a2v v<span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                v2f o<span class="token punctuation">;</span>
                <span class="token comment">//计算阴影贴图的UV坐标</span>
                o<span class="token punctuation">.</span>pos <span class="token operator">=</span> <span class="token function">UnityObjectToClipPos</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>vertex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                o<span class="token punctuation">.</span>worldNormal <span class="token operator">=</span> <span class="token function">UnityObjectToWorldNormal</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>normal<span class="token punctuation">)</span><span class="token punctuation">;</span>
                o<span class="token punctuation">.</span>worldPos <span class="token operator">=</span> <span class="token function">mul</span><span class="token punctuation">(</span>unity_ObjectToWorld<span class="token punctuation">,</span> v<span class="token punctuation">.</span>vertex<span class="token punctuation">)</span><span class="token punctuation">.</span>xyz<span class="token punctuation">;</span>

                <span class="token function">TRANSFER_SHADOW</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span> <span class="token comment">//调用宏，将阴影贴图的UV坐标传给寄存器2</span>

                <span class="token keyword">return</span> o<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            fixed4 <span class="token function">frag</span><span class="token punctuation">(</span>v2f i<span class="token punctuation">)</span> <span class="token operator">:</span> SV_Target
            <span class="token punctuation">&#123;</span>
                <span class="token keyword">fixed</span> shadow <span class="token operator">=</span> <span class="token function">SHADOW_ATTENUATION</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//调用宏，计算阴影贴图的衰减值</span>

                fixed3 worldNormal <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>worldNormal<span class="token punctuation">)</span><span class="token punctuation">;</span>
                fixed3 lightDir <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>_WorldSpaceLightPos0<span class="token punctuation">.</span>xyz<span class="token punctuation">)</span><span class="token punctuation">;</span>
                fixed3 viewDir <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span><span class="token function">UnityWorldToViewPos</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>worldPos<span class="token punctuation">)</span><span class="token punctuation">.</span>xyz<span class="token punctuation">)</span><span class="token punctuation">;</span>
                fixed3 halfDir <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>lightDir <span class="token operator">+</span> viewDir<span class="token punctuation">)</span><span class="token punctuation">;</span>

                fixed3 ambient <span class="token operator">=</span> UNITY_LIGHTMODEL_AMBIENT<span class="token punctuation">.</span>xyz<span class="token punctuation">;</span> 
                fixed3 dffuse <span class="token operator">=</span> _LightColor0<span class="token punctuation">.</span>rgb <span class="token operator">*</span> _Color<span class="token punctuation">.</span>rgb <span class="token operator">*</span> <span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token punctuation">,</span> <span class="token function">dot</span><span class="token punctuation">(</span>worldNormal<span class="token punctuation">,</span> lightDir<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                fixed3 specular <span class="token operator">=</span> _LightColor0<span class="token punctuation">.</span>rgb <span class="token operator">*</span> _Specularity<span class="token punctuation">.</span>rgb <span class="token operator">*</span> <span class="token function">pow</span><span class="token punctuation">(</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token punctuation">,</span> <span class="token function">dot</span><span class="token punctuation">(</span>worldNormal<span class="token punctuation">,</span> halfDir<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">,</span> _Shininess<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">fixed</span> atten <span class="token operator">=</span> <span class="token number">1.0</span><span class="token punctuation">;</span>
                
                fixed3 finalColor <span class="token operator">=</span> ambient <span class="token operator">+</span> <span class="token punctuation">(</span>dffuse <span class="token operator">+</span> specular<span class="token punctuation">)</span> <span class="token operator">*</span> atten <span class="token operator">*</span> shadow<span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token function">fixed4</span><span class="token punctuation">(</span>ambient <span class="token operator">+</span> <span class="token punctuation">(</span>dffuse <span class="token operator">+</span> specular<span class="token punctuation">)</span> <span class="token operator">*</span> atten <span class="token operator">*</span> shadow<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            
            ENDCG
        <span class="token punctuation">&#125;</span>

        Pass
        <span class="token punctuation">&#123;</span>
            Tags <span class="token punctuation">&#123;</span><span class="token string">"LightMode"</span> <span class="token operator">=</span> <span class="token string">"ForwardAdd"</span><span class="token punctuation">&#125;</span>

            Blend One One 

            CGPROGRAM
            
            <span class="token comment">//#pragma multi_compile_fwdadd_fullshadows</span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">multi_compile_fwdadd</span></span>

            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">vertex vert</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">fragment frag</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Lighting.cginc"</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"AutoLight.cginc"</span></span>

            fixed4 _Color<span class="token punctuation">;</span>
            fixed4 _Specularity<span class="token punctuation">;</span>
            <span class="token keyword">fixed</span> _Shininess<span class="token punctuation">;</span>

            <span class="token keyword">struct</span> <span class="token class-name">a2v</span>
            <span class="token punctuation">&#123;</span>
                float4 vertex <span class="token operator">:</span> POSITION<span class="token punctuation">;</span>
                float3 normal <span class="token operator">:</span> NORMAL<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

            <span class="token keyword">struct</span> <span class="token class-name">v2f</span>
            <span class="token punctuation">&#123;</span>
                float4 pos <span class="token operator">:</span> SV_POSITION<span class="token punctuation">;</span>
                float3 worldNormal <span class="token operator">:</span> TEXCOORD0<span class="token punctuation">;</span>
                float3 worldPos <span class="token operator">:</span> TEXCOORD1<span class="token punctuation">;</span>
                <span class="token function">SHADOW_COORDS</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
            
            v2f <span class="token function">vert</span><span class="token punctuation">(</span>a2v v<span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                v2f o<span class="token punctuation">;</span>
                o<span class="token punctuation">.</span>pos <span class="token operator">=</span> <span class="token function">UnityObjectToClipPos</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>vertex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                o<span class="token punctuation">.</span>worldNormal <span class="token operator">=</span> <span class="token function">UnityObjectToWorldNormal</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>normal<span class="token punctuation">)</span><span class="token punctuation">;</span>
                o<span class="token punctuation">.</span>worldPos <span class="token operator">=</span> <span class="token function">mul</span><span class="token punctuation">(</span>unity_ObjectToWorld<span class="token punctuation">,</span> v<span class="token punctuation">.</span>vertex<span class="token punctuation">)</span><span class="token punctuation">.</span>xyz<span class="token punctuation">;</span>
                <span class="token function">TRANSFER_SHADOW</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> o<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            fixed4 <span class="token function">frag</span><span class="token punctuation">(</span>v2f i<span class="token punctuation">)</span> <span class="token operator">:</span> SV_Target
            <span class="token punctuation">&#123;</span>
                <span class="token comment">//fixed shadow = SHADOW_ATTENUATION(i); //调用宏，计算阴影贴图的衰减值</span>
                fixed3 worldNormal <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>worldNormal<span class="token punctuation">)</span><span class="token punctuation">;</span>

                fixed3 worldLightDir <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span><span class="token function">UnityWorldSpaceLightDir</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>worldPos<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                fixed3 viewDir <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span><span class="token function">UnityWorldSpaceViewDir</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>worldPos<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                fixed3 halfDir <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>worldLightDir <span class="token operator">+</span> viewDir<span class="token punctuation">)</span><span class="token punctuation">;</span>

                fixed3 dffuse <span class="token operator">=</span> _LightColor0<span class="token punctuation">.</span>rgb <span class="token operator">*</span> _Color<span class="token punctuation">.</span>rgb <span class="token operator">*</span> <span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token punctuation">,</span> <span class="token function">dot</span><span class="token punctuation">(</span>worldNormal<span class="token punctuation">,</span> worldLightDir<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                fixed3 specular <span class="token operator">=</span> _LightColor0<span class="token punctuation">.</span>rgb <span class="token operator">*</span> _Specularity<span class="token punctuation">.</span>rgb <span class="token operator">*</span> <span class="token function">pow</span><span class="token punctuation">(</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token punctuation">,</span> <span class="token function">dot</span><span class="token punctuation">(</span>worldNormal<span class="token punctuation">,</span> halfDir<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">,</span> _Shininess<span class="token punctuation">)</span><span class="token punctuation">;</span>
                
                <span class="token comment">// #ifdef USING_DIRECTIONAL_LIGHT</span>
                <span class="token comment">//     fixed atten = 1.0;</span>
                <span class="token comment">// #else </span>
                <span class="token comment">//     float3 lightCoord = mul(unity_WorldToLight , float4(i.worldPos , 1)).xyz;</span>
                <span class="token comment">//     fixed atten = tex2D(_LightTexture0 , dot(lightCoord , lightCoord).rr).UNITY_ATTEN_CHANNEL;</span>
                <span class="token comment">// #endif</span>
                
                <span class="token function">UNITY_LIGHT_ATTENUATION</span><span class="token punctuation">(</span>atten <span class="token punctuation">,</span> i <span class="token punctuation">,</span> i<span class="token punctuation">.</span>worldPos<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//这次我们使用了内置宏来计算光照衰减和阴影，</span>
                <span class="token comment">//他接受三个参数，他会将光照衰减和阴影值相乘之后的结果存储到第一个参数当中。</span>
                <span class="token comment">//我们并没有声明第一个参数1atten，这是因为这个宏会帮我们声明这个变量。</span>
                <span class="token comment">//第二个参数是结构体v2f，它包含了顶点位置、法线、世界坐标、阴影贴图的UV坐标。</span>
                <span class="token comment">//这个参数会传递给SHADOW_ATTENUATION宏，它会计算阴影贴图的衰减值。</span>
                <span class="token comment">//第三个参数是世界空间的坐标，这个参数会用于计算光源空间下的坐标，</span>
                <span class="token comment">//再对光照衰减纹理采样来得到光照衰减。</span>
                fixed3 finalColor <span class="token operator">=</span> <span class="token punctuation">(</span>dffuse <span class="token operator">+</span> specular<span class="token punctuation">)</span> <span class="token operator">*</span> atten<span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token function">fixed4</span><span class="token punctuation">(</span><span class="token punctuation">(</span>dffuse <span class="token operator">+</span> specular<span class="token punctuation">)</span> <span class="token operator">*</span> atten<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//如果我们要给additional pass当中添加阴影效果，就需要使用</span>
                <span class="token comment">//#pragma multi_compile_fwdadd_fullshadow指令。这样一来，unity也会为这些额外的逐像素光源计算阴影。</span>
            <span class="token punctuation">&#125;</span>
            
            ENDCG
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    FallBack <span class="token string">"Specular"</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>对比效果前者为之前的代码，后者为之后的代码<br><img src="https://gitee.com/tonzin/picgo_image_inventory/raw/master/blog/20250317211008667.png" alt="image-20250316190908662"></p>
<p><img src="https://gitee.com/tonzin/picgo_image_inventory/raw/master/blog/20250317211008668.png" alt="image-20250316190758348"></p>
<h4 id="透明度物体的投影"><a href="#透明度物体的投影" class="headerlink" title="透明度物体的投影"></a>透明度物体的投影</h4><p>透明物体的实现通常会用到透明度测试或者透明度混合，我们需要小心设置这些物体的fallback<br>透明度测试的处理要在片元着色器舍弃某些片元</p>
<p><img src="https://gitee.com/tonzin/picgo_image_inventory/raw/master/blog/20250317211008669.png" alt="image-20250316192048380"></p>
<p>代码如下</p>
<pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl"><span class="token comment">// Upgrade NOTE: replaced '_Object2World' with 'unity_ObjectToWorld'</span>
<span class="token comment">// Upgrade NOTE: replaced 'mul(UNITY_MATRIX_MVP,*)' with 'UnityObjectToClipPos(*)'</span>

Shader <span class="token string">"Custom/Chapter94_TransparentShadowTest"</span>
<span class="token punctuation">&#123;</span>
    Properties
    <span class="token punctuation">&#123;</span>
        <span class="token function">_Color</span> <span class="token punctuation">(</span><span class="token string">"Color Tint"</span><span class="token punctuation">,</span> Color<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token function">_MainTex</span> <span class="token punctuation">(</span><span class="token string">"Main Texture"</span><span class="token punctuation">,</span> <span class="token number">2</span>D<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">"white"</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
        <span class="token function">_Cutoff</span> <span class="token punctuation">(</span><span class="token string">"Alpha Cutoff"</span><span class="token punctuation">,</span> <span class="token function">Range</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0.5</span> 
    <span class="token punctuation">&#125;</span>
    SubShader
    <span class="token punctuation">&#123;</span>
        Tags <span class="token punctuation">&#123;</span><span class="token string">"Queue"</span> <span class="token operator">=</span> <span class="token string">"AlphaTest"</span> <span class="token string">"IgnoreProjector"</span> <span class="token operator">=</span> <span class="token string">"True"</span> <span class="token string">"RenderType"</span> <span class="token operator">=</span> <span class="token string">"TransparentCutout"</span><span class="token punctuation">&#125;</span>

        Pass
        <span class="token punctuation">&#123;</span>
            Tags <span class="token punctuation">&#123;</span><span class="token string">"LightMode"</span> <span class="token operator">=</span> <span class="token string">"ForwardBase"</span><span class="token punctuation">&#125;</span>

            CGPROGRAM
            
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">vertex vert</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">fragment frag</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Lighting.cginc"</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"AutoLight.cginc"</span><span class="token comment">//++</span></span>

            fixed4 _Color<span class="token punctuation">;</span>
            <span class="token keyword">sampler2D</span> _MainTex<span class="token punctuation">;</span>
            float4 _MainTex_ST<span class="token punctuation">;</span>
            <span class="token keyword">float</span> _Cutoff<span class="token punctuation">;</span>

            <span class="token keyword">struct</span> <span class="token class-name">a2v</span>
            <span class="token punctuation">&#123;</span>
                float4 vertex <span class="token operator">:</span> POSITION<span class="token punctuation">;</span>
                float3 normal <span class="token operator">:</span> NORMAL<span class="token punctuation">;</span>
                float3 texcoord <span class="token operator">:</span> TEXCOORD0<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

            <span class="token keyword">struct</span> <span class="token class-name">v2f</span>
            <span class="token punctuation">&#123;</span>
                float4 pos <span class="token operator">:</span> SV_POSITION<span class="token punctuation">;</span>
                float3 worldNormal <span class="token operator">:</span> TEXCOORD0<span class="token punctuation">;</span>
                float3 worldPos <span class="token operator">:</span> TEXCOORD1<span class="token punctuation">;</span>
                float2 uv <span class="token operator">:</span> TEXCOORD2<span class="token punctuation">;</span>
                <span class="token function">SHADOW_COORDS</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token comment">//++</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

            v2f <span class="token function">vert</span> <span class="token punctuation">(</span>a2v v<span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                v2f o<span class="token punctuation">;</span>
                o<span class="token punctuation">.</span>pos <span class="token operator">=</span> <span class="token function">UnityObjectToClipPos</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>vertex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                o<span class="token punctuation">.</span>worldNormal <span class="token operator">=</span> <span class="token function">UnityObjectToWorldNormal</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>normal<span class="token punctuation">)</span><span class="token punctuation">;</span>
                o<span class="token punctuation">.</span>worldPos <span class="token operator">=</span> <span class="token function">mul</span><span class="token punctuation">(</span>unity_ObjectToWorld<span class="token punctuation">,</span> v<span class="token punctuation">.</span>vertex<span class="token punctuation">)</span><span class="token punctuation">.</span>xyz<span class="token punctuation">;</span>
                o<span class="token punctuation">.</span>uv <span class="token operator">=</span> <span class="token function">TRANSFORM_TEX</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>texcoord <span class="token punctuation">,</span> _MainTex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">TRANSFER_SHADOW</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span> <span class="token comment">//++</span>
                <span class="token keyword">return</span> o<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            fixed4 <span class="token function">frag</span><span class="token punctuation">(</span>v2f i<span class="token punctuation">)</span> <span class="token operator">:</span> SV_Target
            <span class="token punctuation">&#123;</span>
                fixed3 worldNormal <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>worldNormal<span class="token punctuation">)</span><span class="token punctuation">;</span>
                fixed3 worldLightDir <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span><span class="token function">UnityWorldSpaceLightDir</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>worldPos<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                fixed3 worldViewDir <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span><span class="token function">UnityWorldSpaceViewDir</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>worldPos<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                fixed4 texColor <span class="token operator">=</span> <span class="token function">tex2D</span><span class="token punctuation">(</span>_MainTex <span class="token punctuation">,</span> i<span class="token punctuation">.</span>uv<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token function">clip</span><span class="token punctuation">(</span>texColor<span class="token punctuation">.</span>a <span class="token operator">-</span> _Cutoff<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>texColor<span class="token punctuation">.</span>a <span class="token operator">-</span> _Cutoff <span class="token operator">&lt;</span> <span class="token number">0.0f</span><span class="token punctuation">)</span>
                <span class="token punctuation">&#123;</span>
                    <span class="token keyword">discard</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                fixed3 albedo <span class="token operator">=</span> texColor<span class="token punctuation">.</span>rgb <span class="token operator">*</span> _Color<span class="token punctuation">.</span>rgb<span class="token punctuation">;</span>
                fixed3 ambient <span class="token operator">=</span> UNITY_LIGHTMODEL_AMBIENT<span class="token punctuation">.</span>xyz <span class="token operator">*</span> albedo<span class="token punctuation">;</span>
                fixed3 diffuse <span class="token operator">=</span> _LightColor0<span class="token punctuation">.</span>rgb <span class="token operator">*</span> albedo <span class="token operator">*</span> <span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">dot</span><span class="token punctuation">(</span>worldNormal<span class="token punctuation">,</span> worldLightDir<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token function">UNITY_LIGHT_ATTENUATION</span><span class="token punctuation">(</span>atten<span class="token punctuation">,</span> i<span class="token punctuation">,</span> i<span class="token punctuation">.</span>pos<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//++</span>

                <span class="token keyword">return</span> <span class="token function">fixed4</span><span class="token punctuation">(</span>ambient <span class="token operator">+</span> diffuse <span class="token operator">*</span> atten<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            ENDCG
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    FallBack <span class="token string">"Transparent/Cutout/VertexLit"</span> <span class="token comment">//++</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://gitee.com/tonzin/picgo_image_inventory/raw/master/blog/20250317211008670.png" alt="image-20250316192442163"></p>
<p>为使用透明度混合的物体添加阴影是一件比较困难的事情，Unity所有内置的的透明度混合的UnityShader都没有包含阴影投射的Pass这意味着这些半透明物体不会参与深度图和阴影映射纹理的计算，也就是说，它们不会向其它物体投射投影，头痒它们也不会接受来自其他物体的投影。</p>
<p>由于透明度混合需要关闭深度写入由此带来的问题也影响了阴影的生成，总体来说，要想为这些半透明物体产生正确的阴影，需要在每一个光源空间下仍然严格按照从后往前的顺序进行渲染。这会让阴影处理变得非常复杂，而且也会影响性能。因此在unity当中所有内置的半透明shader是不会产生任何的阴影效果的。</p>
<p>当然我们也可以使用一些技巧强制为半透明物体生成阴影，通过把fallback设置成vertexlit，diffuse这些不透明物体使用的UnityShader，这样unity就会在他的fallback当中找到一个阴影投射的pass，然后我们可以通过物体的mesh renderer组件上的cast shadows和receive shadows选项来控制是否需要向其他物体投射或者接受阴影。</p>
<p><img src="https://gitee.com/tonzin/picgo_image_inventory/raw/master/blog/20250317211008671.png" alt="image-20250316193323694"></p>
<h1 id="中级纹理"><a href="#中级纹理" class="headerlink" title="中级纹理"></a>中级纹理</h1><h2 id="立方体纹理"><a href="#立方体纹理" class="headerlink" title="立方体纹理"></a>立方体纹理</h2><p>在图形学当中，立方体纹理是环境映射的一种实现方式。环境映射可以模拟物体周围的环境，而使用了环境映射的物体可以看起来像镀了层金属一样反射出周围的环境</p>
<p>立方体纹理一共包含了6张图像，这些图像对应了一个立方体的六个面，立方体纹理的名称也由此而来。立方体的每个面表示沿着世界空间下的轴向</p>
<p>对立方体纹理采用我们需要提供一个三维的纹理坐标。</p>
<p>这个三维纹理坐标表示了我们在世界空间下的一个3D方向。这个方向矢量从立方体的中心出发，当它向外部延伸的时候，就会和立方体的六个纹理之一发生相交，而采样得到的结果就是由该交点计算而来。</p>
<p>使用立方体纹理的好处在于它的实现简单快速，而且得到的效果也比较好。</p>
<p><strong>但是它也有一些缺点</strong></p>
<p>1 例如当场景当中引入了新的物体、光源、或者物体发生移动的时候我们就需要重新生成立方体纹理。</p>
<p>2 除此之外，立方体纹理也仅可以反射环境，但是不能反射使用了该立方体纹理的物体本身。</p>
<p>因为立方体纹理不可以模拟多次反射的结果，例如两个金属球互相反射的情况。</p>
<p>由于这样的原因想要得到令人信服的渲染结果，我们应该尽量对凸面体而不要对凹面体使用立方体纹理、</p>
<p>立方体纹理的应用：skybox，环境映射</p>
<p><strong>天空盒</strong></p>
<p>天空盒式游戏中用于模拟背景的一种方法<br>Unity当中使用天空盒，我们需要创建一个skybox材质，再把它献给该场景的相关设置即可。<br><img src="https://gitee.com/tonzin/picgo_image_inventory/raw/master/blog/20250317211008672.png" alt="image-20250316201055290"></p>
<p><img src="https://gitee.com/tonzin/picgo_image_inventory/raw/master/blog/20250317211008673.png" alt="image-20250316203027286"></p>
<p><img src="https://gitee.com/tonzin/picgo_image_inventory/raw/master/blog/20250317211008674.png" alt="image-20250316203100597"></p>
<p>最后得到的效果如下<br><img src="https://gitee.com/tonzin/picgo_image_inventory/raw/master/blog/20250317211008675.png" alt="image-20250316203304749"></p>
<p><strong>创建用于环境映射的立方体纹理</strong></p>
<p>除了天空盒子，立方体纹理当中最常见的用处是用于环境映射。通过这种方法，我们模拟出金属的质感<br>（如图在blender，有环境映射和没有环境映射的区别）<br><img src="https://gitee.com/tonzin/picgo_image_inventory/raw/master/blog/20250317211008676.png" alt="image-20250316203906053"></p>
<p><img src="https://gitee.com/tonzin/picgo_image_inventory/raw/master/blog/20250317211008677.png" alt="image-20250316203918889"></p>
<p>Unity当中创建用于环境映射的立方体纹理的方法有三种：<br>第一种方法是直接由一些特殊布局的纹理创建<br>第二种方法是手动创建一个cubemap资源，再把六张图赋值给他<br>第三种方法是脚本生成</p>
<p>如果使用第一种方法，我们需要提供一张具有特殊布局的纹理，例如类似正方体展开图的交叉布局、全景布局等等。然后我们只需要把这个纹理的Texture Type设置成CubeMap就可以了，Unity会为我们做好剩下的事情，在基于物理的渲染当中，我们通常会使用一张HDR图像来生成高质量的Cubemap。</p>
<p>第二种方法是Unity5之前的版本中使用的方法。我们首先需要在项目资源中创建一个cubemap，然后把六张纹理拖拽</p>
<p>第一种方法可以对纹理数据进行压缩，并且支持边缘修正，光滑反射和HDR等功能。</p>
<p>我们希望根据物体在场景中的位置不同，生成它们各自不同的立方体纹理。这时我们就可以在Unity中使用脚本来创建。这是通过利用Unity提供的Camera.RenderToCubemap函数来实现的。Camera.RenderToCubemap函数可以把从任意位置观察到的场景图像存储到6张图像当中，从而创建出这个位置上对应的立方体纹理。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">using UnityEngine<span class="token punctuation">;</span>
using UnityEditor<span class="token punctuation">;</span>
using System<span class="token punctuation">.</span>Collections<span class="token punctuation">;</span>

public class RenderCubemapWizard <span class="token operator">:</span> ScriptableWizard <span class="token punctuation">&#123;</span>
	
	public Transform renderFromPosition<span class="token punctuation">;</span>
	public Cubemap cubemap<span class="token punctuation">;</span>
	
	<span class="token keyword">void</span> <span class="token function">OnWizardUpdate</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		helpString <span class="token operator">=</span> <span class="token string">"Select transform to render from and cubemap to render into"</span><span class="token punctuation">;</span>
		isValid <span class="token operator">=</span> <span class="token punctuation">(</span>renderFromPosition <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>cubemap <span class="token operator">!=</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	
	<span class="token keyword">void</span> <span class="token function">OnWizardCreate</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token comment">// create temporary camera for rendering</span>
		GameObject go <span class="token operator">=</span> new <span class="token function">GameObject</span><span class="token punctuation">(</span> <span class="token string">"CubemapCamera"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		go<span class="token punctuation">.</span>AddComponent<span class="token operator">&lt;</span>Camera<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// place it on the object</span>
		go<span class="token punctuation">.</span>transform<span class="token punctuation">.</span>position <span class="token operator">=</span> renderFromPosition<span class="token punctuation">.</span>position<span class="token punctuation">;</span>
		<span class="token comment">// render into cubemap		</span>
		go<span class="token punctuation">.</span>GetComponent<span class="token operator">&lt;</span>Camera<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">RenderToCubemap</span><span class="token punctuation">(</span>cubemap<span class="token punctuation">)</span><span class="token punctuation">;</span>
		
		<span class="token comment">// destroy temporary camera</span>
		<span class="token function">DestroyImmediate</span><span class="token punctuation">(</span> go <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	
	<span class="token punctuation">[</span><span class="token function">MenuItem</span><span class="token punctuation">(</span><span class="token string">"GameObject/Render into Cubemap"</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
	<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">RenderCubemap</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		ScriptableWizard<span class="token punctuation">.</span>DisplayWizard<span class="token operator">&lt;</span>RenderCubemapWizard<span class="token operator">></span><span class="token punctuation">(</span>
			<span class="token string">"Render cubemap"</span><span class="token punctuation">,</span> <span class="token string">"Render!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这段代码在指定位置生成了一个带有camera组件的游戏对象，并且把它所观察到的地方渲染到指定的cubemap里面</p>
<p>关于具体用这个脚本生成cubemap的操作，见书，这是最终效果</p>
<p><img src="https://gitee.com/tonzin/picgo_image_inventory/raw/master/blog/20250317211008678.png" alt="image-20250316210422714"></p>
<p><img src="https://gitee.com/tonzin/picgo_image_inventory/raw/master/blog/20250317211008679.png" alt="image-20250316210607488"></p>
<p><strong>反射</strong><br>使用了反射效果的物体通常看起来都像镀一层金属</p>
<p>我们需要通过入射光线的方向和表面法线方向来计算法向方向。再利用反射方向对立方体纹理采样即可。</p>
<pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl"><span class="token comment">// Upgrade NOTE: replaced 'mul(UNITY_MATRIX_MVP,*)' with 'UnityObjectToClipPos(*)'</span>

Shader <span class="token string">"Custom/Chapter10_0_Reflection"</span>
<span class="token punctuation">&#123;</span>
    Properties
    <span class="token punctuation">&#123;</span>
        <span class="token function">_Color</span> <span class="token punctuation">(</span><span class="token string">"Color Tint"</span><span class="token punctuation">,</span> Color<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token function">_ReflectColor</span> <span class="token punctuation">(</span><span class="token string">"Reflection Color"</span><span class="token punctuation">,</span> Color<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token function">_ReflectAmount</span> <span class="token punctuation">(</span><span class="token string">"Reflect Amount"</span><span class="token punctuation">,</span> <span class="token function">Range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span>
        <span class="token function">_Cubemap</span> <span class="token punctuation">(</span><span class="token string">"Reflection Cubemap"</span> <span class="token punctuation">,</span> Cube<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">"_Skybox"</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    SubShader
    <span class="token punctuation">&#123;</span>
        Tags <span class="token punctuation">&#123;</span> <span class="token string">"RenderType"</span><span class="token operator">=</span><span class="token string">"Opaque"</span> <span class="token string">"Queue"</span> <span class="token operator">=</span> <span class="token string">"Geometry"</span> <span class="token punctuation">&#125;</span>
        Pass
        <span class="token punctuation">&#123;</span>
            Tags <span class="token punctuation">&#123;</span> <span class="token string">"LightMode"</span><span class="token operator">=</span><span class="token string">"ForwardBase"</span> <span class="token punctuation">&#125;</span> <span class="token comment">//+</span>

            CGPROGRAM
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">multi_compile_fwdbase</span></span>

            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">vertex vert</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">fragment frag</span></span>

			<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Lighting.cginc"</span></span>
			<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"AutoLight.cginc"</span></span>
            
            fixed4 _Color<span class="token punctuation">;</span>
            fixed4 _ReflectColor<span class="token punctuation">;</span>
            <span class="token keyword">float</span> _ReflectAmount<span class="token punctuation">;</span>
            samplerCUBE _Cubemap<span class="token punctuation">;</span> <span class="token comment">//这是一个新的类型，表示一个立方体贴图</span>

            <span class="token keyword">struct</span> <span class="token class-name">a2v</span>
            <span class="token punctuation">&#123;</span>
                float4 vertex <span class="token operator">:</span> POSITION<span class="token punctuation">;</span>
                float3 normal <span class="token operator">:</span> NORMAL<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
            
            <span class="token keyword">struct</span> <span class="token class-name">v2f</span>
            <span class="token punctuation">&#123;</span>
                float4 pos <span class="token operator">:</span> SV_POSITION<span class="token punctuation">;</span>
                float3 worldRefl <span class="token operator">:</span> TEXCOORD0<span class="token punctuation">;</span><span class="token comment">//将顶点上的反射向量传递到片段着色器</span>
                float3 worldNormal <span class="token operator">:</span> TEXCOORD1<span class="token punctuation">;</span>
                float3 worldPos <span class="token operator">:</span> TEXCOORD2<span class="token punctuation">;</span>
                float3 worldViewDir <span class="token operator">:</span> TEXCOORD3<span class="token punctuation">;</span>

                <span class="token function">SHADOW_COORDS</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token comment">//声明4个shadowmap坐标</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

            v2f <span class="token function">vert</span><span class="token punctuation">(</span>a2v v<span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                v2f o<span class="token punctuation">;</span>
                o<span class="token punctuation">.</span>pos <span class="token operator">=</span> <span class="token function">UnityObjectToClipPos</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>vertex<span class="token punctuation">)</span><span class="token punctuation">;</span>

                o<span class="token punctuation">.</span>worldNormal <span class="token operator">=</span> <span class="token function">UnityObjectToWorldNormal</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>normal<span class="token punctuation">)</span><span class="token punctuation">;</span>
                o<span class="token punctuation">.</span>worldPos <span class="token operator">=</span> <span class="token function">mul</span><span class="token punctuation">(</span>unity_ObjectToWorld<span class="token punctuation">,</span> v<span class="token punctuation">.</span>vertex<span class="token punctuation">)</span><span class="token punctuation">.</span>xyz<span class="token punctuation">;</span>

                o<span class="token punctuation">.</span>worldViewDir <span class="token operator">=</span> <span class="token function">UnityWorldSpaceViewDir</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span>worldPos<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">//在世界空间中计算视线方向的反射向量</span>

                o<span class="token punctuation">.</span>worldRefl <span class="token operator">=</span> <span class="token function">reflect</span><span class="token punctuation">(</span><span class="token operator">-</span>o<span class="token punctuation">.</span>worldViewDir <span class="token punctuation">,</span> o<span class="token punctuation">.</span>worldNormal<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token function">TRANSFER_SHADOW</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//计算阴影</span>

                <span class="token keyword">return</span> o<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            fixed4 <span class="token function">frag</span><span class="token punctuation">(</span>v2f i<span class="token punctuation">)</span> <span class="token operator">:</span> SV_Target
            <span class="token punctuation">&#123;</span>
                fixed3 worldNormal <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>worldNormal<span class="token punctuation">)</span><span class="token punctuation">;</span>
                fixed3 worldLightDir <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span><span class="token function">UnityWorldSpaceLightDir</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>worldPos<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                fixed3 worldViewDir <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>worldViewDir<span class="token punctuation">)</span><span class="token punctuation">;</span>

                fixed3 ambient <span class="token operator">=</span> UNITY_LIGHTMODEL_AMBIENT<span class="token punctuation">.</span>xyz<span class="token punctuation">;</span>
                fixed3 diffuse <span class="token operator">=</span> _LightColor0<span class="token punctuation">.</span>rgb <span class="token operator">*</span> _Color<span class="token punctuation">.</span>rgb <span class="token operator">*</span> <span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">dot</span><span class="token punctuation">(</span>worldNormal<span class="token punctuation">,</span> worldLightDir<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                fixed3 reflection <span class="token operator">=</span> <span class="token function">texCUBE</span><span class="token punctuation">(</span>_Cubemap<span class="token punctuation">,</span> i<span class="token punctuation">.</span>worldRefl<span class="token punctuation">)</span><span class="token punctuation">.</span>rgb <span class="token operator">*</span> _ReflectColor<span class="token punctuation">.</span>rgb <span class="token operator">*</span> _ReflectAmount<span class="token punctuation">;</span>
                <span class="token comment">//在世界空间中使用反射方向来得到cubemap</span>
                <span class="token function">UNITY_LIGHT_ATTENUATION</span><span class="token punctuation">(</span>atten <span class="token punctuation">,</span> i <span class="token punctuation">,</span> i<span class="token punctuation">.</span>worldPos<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//将外界颜色与阴影进行混合并且进行衰减</span>
                
                <span class="token comment">//将漫反射颜色与反射颜色进行混合</span>
                fixed3 color <span class="token operator">=</span> ambient <span class="token operator">+</span> <span class="token function">lerp</span><span class="token punctuation">(</span>diffuse <span class="token punctuation">,</span> reflection <span class="token punctuation">,</span> _ReflectAmount<span class="token punctuation">)</span> <span class="token operator">*</span> atten<span class="token punctuation">;</span>

                <span class="token keyword">return</span> <span class="token function">fixed4</span><span class="token punctuation">(</span>color <span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            ENDCG
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    FallBack <span class="token string">"Reflective/VertexLit"</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://gitee.com/tonzin/picgo_image_inventory/raw/master/blog/20250317211008680.png" alt="image-20250316215830330"></p>
<p>折射</p>
<p><img src="https://gitee.com/tonzin/picgo_image_inventory/raw/master/blog/20250317211008681.png" alt="image-20250316220049723"></p>
<p>一般来说当得到了折射方向我们就会直接使用它来对立方体纹理进行采样，但是这是不符合物理规律的。对于一个透明物体来说，一种更加准确的模拟方法需要计算两次折射</p>
<p>一次是光线进入到物体内部的时候。另一次则是光线从物体内部射出的时候，一般来说我们模拟一次就可以达到我们想要的效果。</p>
<p><img src="https://gitee.com/tonzin/picgo_image_inventory/raw/master/blog/20250317211008682.png" alt="image-20250316230543714"></p>
<p><img src="https://gitee.com/tonzin/picgo_image_inventory/raw/master/blog/20250317211008683.png" alt="image-20250316230753183"></p>
<p><img src="https://gitee.com/tonzin/picgo_image_inventory/raw/master/blog/20250317211008684.png" alt="image-20250316232750424"></p>
<p><img src="https://gitee.com/tonzin/picgo_image_inventory/raw/master/blog/20250317211008685.png" alt="image-20250316232953088"><br><img src="https://gitee.com/tonzin/picgo_image_inventory/raw/master/blog/20250317211008686.png" alt="image-20250316233014084"><br><img src="https://gitee.com/tonzin/picgo_image_inventory/raw/master/blog/20250317211008687.png" alt="image-20250316233054013"><br>Unity提供给了我们非常方便的函数来处理折射</p>
<p><img src="https://gitee.com/tonzin/picgo_image_inventory/raw/master/blog/20250317211008688.png" alt="image-20250317002302965"></p>
<pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl">Shader <span class="token string">"Custom/Chapter10_2_Refraction"</span>
<span class="token punctuation">&#123;</span>
    Properties
    <span class="token punctuation">&#123;</span>
        <span class="token function">_Color</span> <span class="token punctuation">(</span><span class="token string">"Color Tint"</span> <span class="token punctuation">,</span> Color<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token function">_RefractColor</span> <span class="token punctuation">(</span><span class="token string">"Refraction Color"</span><span class="token punctuation">,</span> Color<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token function">_RefractAmount</span> <span class="token punctuation">(</span><span class="token string">"Refraction Amount"</span><span class="token punctuation">,</span> <span class="token function">Range</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span>
        <span class="token function">_RefractRatio</span> <span class="token punctuation">(</span><span class="token string">"Refraction Ratio"</span><span class="token punctuation">,</span> <span class="token function">Range</span><span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0.5</span><span class="token comment">//只需要折射一次，玻璃的折射率一般是1.5，这里是相对折射率，则填0.5</span>
        <span class="token function">_Cubemap</span> <span class="token punctuation">(</span><span class="token string">"Refraction Cubemap"</span><span class="token punctuation">,</span> Cube<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">"_Skybox"</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    SubShader
    <span class="token punctuation">&#123;</span>
        Tags <span class="token punctuation">&#123;</span> <span class="token string">"RenderType"</span><span class="token operator">=</span><span class="token string">"Opaque"</span> <span class="token string">"Queue"</span> <span class="token operator">=</span> <span class="token string">"Geometry"</span> <span class="token punctuation">&#125;</span>
        
        Pass
        <span class="token punctuation">&#123;</span>
            Tags <span class="token punctuation">&#123;</span> <span class="token string">"LightMode"</span><span class="token operator">=</span><span class="token string">"ForwardBase"</span> <span class="token punctuation">&#125;</span>

            CGPROGRAM

            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">multi_compile_fwdbase</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">vertex vert</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">fragment frag</span></span>
            
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Lighting.cginc"</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"AutoLight.cginc"</span></span>


            fixed4 _Color<span class="token punctuation">;</span>
            fixed4 _RefractColor<span class="token punctuation">;</span>
            <span class="token keyword">float</span> _RefractAmount<span class="token punctuation">;</span>
            <span class="token keyword">float</span> _RefractRatio<span class="token punctuation">;</span>
            samplerCUBE _Cubemap<span class="token punctuation">;</span>

            <span class="token keyword">struct</span> <span class="token class-name">a2v</span>
            <span class="token punctuation">&#123;</span>
                float4 vertex <span class="token operator">:</span> POSITION<span class="token punctuation">;</span>
                float3 normal <span class="token operator">:</span> NORMAL<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

            <span class="token keyword">struct</span> <span class="token class-name">v2f</span>
            <span class="token punctuation">&#123;</span>
                float4 pos <span class="token operator">:</span> SV_POSITION<span class="token punctuation">;</span>
                float3 worldNormal <span class="token operator">:</span> TEXCOORD0<span class="token punctuation">;</span>
                float3 worldPos <span class="token operator">:</span> TEXCOORD1<span class="token punctuation">;</span>
                float3 worldRefra <span class="token operator">:</span> TEXCOORD2<span class="token punctuation">;</span>
                float3 worldViewDir <span class="token operator">:</span> TEXCOORD3<span class="token punctuation">;</span>
                <span class="token function">SHADOW_COORDS</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

            v2f <span class="token function">vert</span><span class="token punctuation">(</span>a2v v<span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                v2f o<span class="token punctuation">;</span>
                o<span class="token punctuation">.</span>pos <span class="token operator">=</span> <span class="token function">UnityObjectToClipPos</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>vertex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                o<span class="token punctuation">.</span>worldNormal <span class="token operator">=</span> <span class="token function">UnityObjectToWorldNormal</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>normal<span class="token punctuation">)</span><span class="token punctuation">;</span>
                o<span class="token punctuation">.</span>worldPos <span class="token operator">=</span> <span class="token function">mul</span><span class="token punctuation">(</span>unity_ObjectToWorld<span class="token punctuation">,</span> v<span class="token punctuation">.</span>vertex<span class="token punctuation">)</span><span class="token punctuation">.</span>xyz<span class="token punctuation">;</span>
                o<span class="token punctuation">.</span>worldViewDir <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span><span class="token function">UnityWorldSpaceViewDir</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span>worldPos<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">//计算反射</span>
                <span class="token comment">//o.worldRefl = reflect(-normalize(o.worldPos) , o.worldNormal); //语法为reflect(入射方向direction, 顶点上的法线normal)</span>

                <span class="token comment">//已知空气折射率1，玻璃折射率为_RefractRatio，则相对折射率是1/_RefractRatio</span>
                <span class="token comment">//再计算折射</span>
                o<span class="token punctuation">.</span>worldRefra <span class="token operator">=</span> <span class="token function">refract</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token function">normalize</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span>worldViewDir<span class="token punctuation">)</span> <span class="token punctuation">,</span> <span class="token function">normalize</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span>worldNormal<span class="token punctuation">)</span> <span class="token punctuation">,</span> _RefractRatio<span class="token punctuation">)</span><span class="token punctuation">;</span> 
                <span class="token comment">//语法为refract(入射方向direction, 法线normal, 相对折射率ratio)</span>

                <span class="token function">TRANSFER_SHADOW</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> o<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            fixed4 <span class="token function">frag</span><span class="token punctuation">(</span>v2f i<span class="token punctuation">)</span> <span class="token operator">:</span> SV_Target
            <span class="token punctuation">&#123;</span>
                fixed3 worldNormal <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>worldNormal<span class="token punctuation">)</span><span class="token punctuation">;</span>
                fixed3 worldViewDir <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>worldViewDir<span class="token punctuation">)</span><span class="token punctuation">;</span>
                fixed3 worldLightDir <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span><span class="token function">UnityWorldSpaceLightDir</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>worldPos<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                fixed3 ambient <span class="token operator">=</span> UNITY_LIGHTMODEL_AMBIENT<span class="token punctuation">.</span>xyz<span class="token punctuation">;</span>
                fixed3 diffuse <span class="token operator">=</span> _LightColor0<span class="token punctuation">.</span>rgb <span class="token operator">*</span> _Color<span class="token punctuation">.</span>rgb <span class="token operator">*</span> <span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">dot</span><span class="token punctuation">(</span>worldNormal<span class="token punctuation">,</span> worldLightDir<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                fixed3 refraction <span class="token operator">=</span> <span class="token function">texCUBE</span><span class="token punctuation">(</span>_Cubemap<span class="token punctuation">,</span> i<span class="token punctuation">.</span>worldRefra<span class="token punctuation">)</span><span class="token punctuation">.</span>rgb <span class="token operator">*</span> _RefractColor<span class="token punctuation">.</span>rgb<span class="token punctuation">;</span>

                <span class="token function">UNITY_LIGHT_ATTENUATION</span><span class="token punctuation">(</span>atten<span class="token punctuation">,</span> i<span class="token punctuation">,</span> i<span class="token punctuation">.</span>worldPos<span class="token punctuation">)</span><span class="token punctuation">;</span>

                fixed3 color <span class="token operator">=</span> ambient <span class="token operator">+</span> <span class="token function">lerp</span><span class="token punctuation">(</span>diffuse<span class="token punctuation">,</span> refraction<span class="token punctuation">,</span> _RefractAmount<span class="token punctuation">)</span> <span class="token operator">*</span> atten<span class="token punctuation">;</span>
                <span class="token comment">//我们没有对i.worldRefr进行归一化操作，因为对于立方体反射</span>

                <span class="token keyword">return</span> <span class="token function">fixed4</span><span class="token punctuation">(</span>color<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            ENDCG
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    FallBack <span class="token string">"Reflective/VertexLit"</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="菲涅尔反射"><a href="#菲涅尔反射" class="headerlink" title="菲涅尔反射"></a>菲涅尔反射</h2><p><img src="https://gitee.com/tonzin/picgo_image_inventory/raw/master/blog/20250317211008689.png" alt="image-20250317110759631"></p>
<pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl"><span class="token comment">// Upgrade NOTE: replaced '_Object2World' with 'unity_ObjectToWorld'</span>
<span class="token comment">// Upgrade NOTE: replaced '_World2Object' with 'unity_WorldToObject'</span>
<span class="token comment">// Upgrade NOTE: replaced 'mul(UNITY_MATRIX_MVP,*)' with 'UnityObjectToClipPos(*)'</span>

Shader <span class="token string">"Custom/Chapter10_3_Fersnel"</span>
<span class="token punctuation">&#123;</span>
    Properties
    <span class="token punctuation">&#123;</span>
        <span class="token function">_Color</span> <span class="token punctuation">(</span><span class="token string">"Color"</span><span class="token punctuation">,</span> Color<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token function">_FresnelScale</span><span class="token punctuation">(</span><span class="token string">"Fresnel Scale"</span> <span class="token punctuation">,</span> <span class="token function">Range</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0.5</span>
        <span class="token function">_Cubemap</span><span class="token punctuation">(</span><span class="token string">"Reflection Cubemap"</span> <span class="token punctuation">,</span> Cube<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">"_Skybox"</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    SubShader
    <span class="token punctuation">&#123;</span>
        Tags <span class="token punctuation">&#123;</span> <span class="token string">"RenderType"</span><span class="token operator">=</span><span class="token string">"Opaque"</span> <span class="token string">"Queue"</span><span class="token operator">=</span><span class="token string">"Geometry"</span> <span class="token punctuation">&#125;</span><span class="token comment">//中间不需要添加逗号</span>

        Pass
        <span class="token punctuation">&#123;</span>
            Tags <span class="token punctuation">&#123;</span> <span class="token string">"LightMode"</span><span class="token operator">=</span><span class="token string">"ForwardBase"</span> <span class="token punctuation">&#125;</span>

            CGPROGRAM
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">multi_compile_fwdbase</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">vertex vert</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">fragment frag</span></span>

            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Lighting.cginc"</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"AutoLight.cginc"</span></span>

            fixed4 _Color<span class="token punctuation">;</span>
            <span class="token keyword">float</span> _FresnelScale<span class="token punctuation">;</span>
            samplerCUBE _Cubemap<span class="token punctuation">;</span>

            <span class="token keyword">struct</span> <span class="token class-name">a2v</span>
            <span class="token punctuation">&#123;</span>
                float4 vertex <span class="token operator">:</span> POSITION<span class="token punctuation">;</span>
                float3 normal <span class="token operator">:</span> NORMAL<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

            <span class="token keyword">struct</span> <span class="token class-name">v2f</span>
            <span class="token punctuation">&#123;</span>
                float4 pos <span class="token operator">:</span> SV_POSITION<span class="token punctuation">;</span>
                float3 worldNormal <span class="token operator">:</span> TEXCOORD0<span class="token punctuation">;</span>
                float3 worldPos <span class="token operator">:</span> TEXCOORD1<span class="token punctuation">;</span>
                float3 worldViewDir <span class="token operator">:</span> TEXCOORD2<span class="token punctuation">;</span>
                float3 worldRefl <span class="token operator">:</span> TEXCOORD3<span class="token punctuation">;</span>
                <span class="token function">SHADOW_COORDS</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token comment">//这个参数实际上就是shadowmap的uv坐标，4代表声明的是TEXCOORD4，随意赋值会发生报错</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

            v2f <span class="token function">vert</span><span class="token punctuation">(</span>a2v v<span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                v2f o<span class="token punctuation">;</span>
                o<span class="token punctuation">.</span>pos <span class="token operator">=</span> <span class="token function">UnityObjectToClipPos</span><span class="token punctuation">(</span> v<span class="token punctuation">.</span>vertex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                o<span class="token punctuation">.</span>worldNormal <span class="token operator">=</span> <span class="token function">mul</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>normal <span class="token punctuation">,</span> <span class="token punctuation">(</span>float3x3<span class="token punctuation">)</span>unity_WorldToObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
                o<span class="token punctuation">.</span>worldPos <span class="token operator">=</span> <span class="token function">mul</span><span class="token punctuation">(</span>unity_ObjectToWorld <span class="token punctuation">,</span> v<span class="token punctuation">.</span>vertex<span class="token punctuation">)</span><span class="token punctuation">.</span>xyz<span class="token punctuation">;</span>
                o<span class="token punctuation">.</span>worldViewDir <span class="token operator">=</span> <span class="token function">UnityWorldSpaceViewDir</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span>worldPos<span class="token punctuation">)</span><span class="token punctuation">;</span>
                o<span class="token punctuation">.</span>worldRefl <span class="token operator">=</span> <span class="token function">reflect</span><span class="token punctuation">(</span><span class="token operator">-</span>o<span class="token punctuation">.</span>worldViewDir<span class="token punctuation">,</span> o<span class="token punctuation">.</span>worldNormal<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">TRANSFER_SHADOW</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> o<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            fixed4 <span class="token function">frag</span><span class="token punctuation">(</span>v2f i<span class="token punctuation">)</span> <span class="token operator">:</span> SV_Target
            <span class="token punctuation">&#123;</span>
                fixed3 worldNormal <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>worldNormal<span class="token punctuation">)</span><span class="token punctuation">;</span>
                fixed3 worldLightDir <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span><span class="token function">UnityWorldSpaceLightDir</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>worldPos<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                fixed3 worldViewDir <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>worldViewDir<span class="token punctuation">)</span><span class="token punctuation">;</span>
                
                fixed3 ambient <span class="token operator">=</span> UNITY_LIGHTMODEL_AMBIENT<span class="token punctuation">.</span>xyz<span class="token punctuation">;</span>

                <span class="token function">UNITY_LIGHT_ATTENUATION</span><span class="token punctuation">(</span>atten<span class="token punctuation">,</span> i<span class="token punctuation">,</span> i<span class="token punctuation">.</span>worldPos<span class="token punctuation">)</span><span class="token punctuation">;</span>

                fixed3 reflection <span class="token operator">=</span> <span class="token function">texCUBE</span><span class="token punctuation">(</span>_Cubemap<span class="token punctuation">,</span> i<span class="token punctuation">.</span>worldRefl<span class="token punctuation">)</span><span class="token punctuation">.</span>rgb<span class="token punctuation">;</span> <span class="token comment">// 反射光照</span>

                <span class="token comment">// 利用公式来计算菲涅耳反射，并且使用结果值混合漫反射光照和反射光照</span>

                <span class="token keyword">fixed</span> fresnel <span class="token operator">=</span> _FresnelScale <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> _FresnelScale<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> <span class="token function">dot</span><span class="token punctuation">(</span>worldNormal <span class="token punctuation">,</span> worldLightDir<span class="token punctuation">)</span> <span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                fixed3 diffuse <span class="token operator">=</span> _LightColor0<span class="token punctuation">.</span>rgb <span class="token operator">*</span> _Color<span class="token punctuation">.</span>rgb <span class="token operator">*</span> <span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token punctuation">,</span> <span class="token function">dot</span><span class="token punctuation">(</span>worldNormal <span class="token punctuation">,</span> worldLightDir<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">//在漫反射和镜面反射之间使用fresnel进行插值混合，注意fresnel可能大于1需要进行限制</span>
                fixed3 color <span class="token operator">=</span> ambient <span class="token operator">+</span> <span class="token function">lerp</span><span class="token punctuation">(</span>diffuse <span class="token punctuation">,</span> reflection <span class="token punctuation">,</span> <span class="token function">saturate</span><span class="token punctuation">(</span>fresnel<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> atten<span class="token punctuation">;</span>

                <span class="token keyword">return</span> <span class="token function">fixed4</span><span class="token punctuation">(</span>color <span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            ENDCG
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    FallBack <span class="token string">"Reflective/VertexLit"</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://gitee.com/tonzin/picgo_image_inventory/raw/master/blog/20250317211008690.png" alt="image-20250317113338392"></p>
<p>通过滑动条调整物体的漫反射强度</p>
<h2 id="渲染纹理"><a href="#渲染纹理" class="headerlink" title="渲染纹理"></a>渲染纹理</h2><p>渲染纹理一般用来模拟镜子效果<br>创建一个新场景<br>在project视图里面创建shader，material，以及一个<strong>Render Texture</strong><br><img src="https://gitee.com/tonzin/picgo_image_inventory/raw/master/blog/20250317211008691.png" alt="image-20250317122901192"></p>
<p>为了得到镜子内的图像我们需要新创建一个摄像机调整它的视角让其显示我们的镜子想要的内容。这个摄像机不需要直接显示在屏幕上，而是用于渲染到纹理</p>
<p>我们需要把创建的Render Texture拖拽到摄像机的Target Texture上</p>
<p>之后注意要把render texture拖到material里面才有效果</p>
<p><img src="https://gitee.com/tonzin/picgo_image_inventory/raw/master/blog/20250317211008692.png" alt="image-20250317123308060"></p>
<p><img src="https://gitee.com/tonzin/picgo_image_inventory/raw/master/blog/20250317211008693.png" alt="image-20250317124309070"><br>但是这仅仅是渲染出摄像机照片然后贴到墙上而已，并不是真正的镜子<br><img src="https://gitee.com/tonzin/picgo_image_inventory/raw/master/blog/20250317211008694.png" alt="image-20250317124345135"></p>
<pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl">Shader <span class="token string">"Custom/Chapter10_4_Mirror"</span>
<span class="token punctuation">&#123;</span>
    Properties
    <span class="token punctuation">&#123;</span>
        <span class="token function">_MainTex</span><span class="token punctuation">(</span><span class="token string">"Main Texture"</span> <span class="token punctuation">,</span> <span class="token number">2</span>D<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">"white"</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    SubShader
    <span class="token punctuation">&#123;</span>
        Tags <span class="token punctuation">&#123;</span> <span class="token string">"RenderType"</span><span class="token operator">=</span><span class="token string">"Opaque"</span> <span class="token punctuation">&#125;</span>
        Pass
        <span class="token punctuation">&#123;</span>
            CGPROGRAM
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">vertex vert</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">fragment frag</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"UnityCG.cginc"</span></span>

            <span class="token keyword">sampler2D</span> _MainTex<span class="token punctuation">;</span>
            float4 _MainTex_ST<span class="token punctuation">;</span>

            <span class="token keyword">struct</span> <span class="token class-name">a2v</span>
            <span class="token punctuation">&#123;</span>
                float4 vertex <span class="token operator">:</span> POSITION<span class="token punctuation">;</span>
                float2 texcoord <span class="token operator">:</span> TEXCOORD0<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

            <span class="token keyword">struct</span> <span class="token class-name">v2f</span>
            <span class="token punctuation">&#123;</span>
                float4 pos <span class="token operator">:</span> SV_POSITION<span class="token punctuation">;</span>
                float2 uv <span class="token operator">:</span> TEXCOORD0<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
            
            v2f <span class="token function">vert</span><span class="token punctuation">(</span>a2v v<span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                v2f o<span class="token punctuation">;</span>
                o<span class="token punctuation">.</span>pos <span class="token operator">=</span> <span class="token function">UnityObjectToClipPos</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>vertex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                o<span class="token punctuation">.</span>uv <span class="token operator">=</span> v<span class="token punctuation">.</span>texcoord<span class="token punctuation">;</span>
                o<span class="token punctuation">.</span>uv<span class="token punctuation">.</span>x <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">-</span> o<span class="token punctuation">.</span>uv<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
                <span class="token keyword">return</span> o<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            
            fixed4 <span class="token function">frag</span><span class="token punctuation">(</span>v2f i<span class="token punctuation">)</span> <span class="token operator">:</span> SV_Target
            <span class="token punctuation">&#123;</span>
                <span class="token keyword">return</span> <span class="token function">tex2D</span><span class="token punctuation">(</span>_MainTex <span class="token punctuation">,</span> i<span class="token punctuation">.</span>uv<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            ENDCG
        <span class="token punctuation">&#125;</span>

    <span class="token punctuation">&#125;</span>
    FallBack <span class="token string">"Specular"</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在unity当中，我们可以使用一种特殊的pass来完成获取屏幕图像的目的，这就是GrabPass。当我们在Shader当中定义了一个GrabPass之后，Unity会把当前屏幕的图像绘制在一个纹理当中，以便我们在后续的Pass当中访问它，我们通常会使用GrabPass来实现诸如玻璃等透明材质的模拟</p>
<p>与简单的透明混合不同，使用GrabPass可以让我们对物体后面的图像进行更加复杂的处理。例如使用法线来模拟折射的效果，而不再是简单的和原屏幕颜色进行混合</p>
<p>需要注意在使用GrabPass的时候，我们需要额外小心物体的渲染队列设置，正如之前所说的一样，GrabPass通常用于渲染透明物体，尽管代码里面不包含混合指令，但是我们往往需要把物体的渲染对了，这样才可以保证当渲染这个物体的时候，所有的不透明物体都已经被绘制在了屏幕上，从而获取正确的屏幕图像</p>
<p><img src="https://gitee.com/tonzin/picgo_image_inventory/raw/master/blog/20250317211008695.png" alt="image-20250317125648078"></p>
<p><img src="https://gitee.com/tonzin/picgo_image_inventory/raw/master/blog/20250317211008696.png" alt="image-20250317125659399"></p>
<pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl"><span class="token comment">// Upgrade NOTE: replaced '_Object2World' with 'unity_ObjectToWorld'</span>
<span class="token comment">// Upgrade NOTE: replaced 'mul(UNITY_MATRIX_MVP,*)' with 'UnityObjectToClipPos(*)'</span>

Shader <span class="token string">"Custom/Chapter10_4_Glass"</span>
<span class="token punctuation">&#123;</span>
    Properties
    <span class="token punctuation">&#123;</span>
        <span class="token function">_MainTex</span> <span class="token punctuation">(</span><span class="token string">"Texture"</span><span class="token punctuation">,</span> <span class="token number">2</span>D<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">"white"</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span> <span class="token comment">//是该玻璃的材质纹理</span>
        <span class="token function">_BumpMap</span> <span class="token punctuation">(</span><span class="token string">"Normal Map"</span><span class="token punctuation">,</span> <span class="token number">2</span>D<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">"bump"</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span> <span class="token comment">//玻璃的法线纹理</span>
        <span class="token function">_CubeMap</span> <span class="token punctuation">(</span><span class="token string">"Environment Map"</span><span class="token punctuation">,</span> Cube<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">"_Skybox"</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span> <span class="token comment">//模拟反射的环境纹理</span>
        <span class="token function">_Distortion</span> <span class="token punctuation">(</span><span class="token string">"Distortion"</span><span class="token punctuation">,</span> <span class="token function">Range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">10</span> <span class="token comment">//控制模拟折射时候的图像模拟程度</span>
        <span class="token function">_RefractAmount</span> <span class="token punctuation">(</span><span class="token string">"Refract Amount"</span><span class="token punctuation">,</span> <span class="token function">Range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1.0</span> <span class="token comment">//用于控制折射程度</span>
        <span class="token comment">//当RefractAmount=1时，玻璃只包含折射效果，当RefractAmount=0时，玻璃只包含反射效果</span>
    <span class="token punctuation">&#125;</span>
    SubShader
    <span class="token punctuation">&#123;</span>
        Tags <span class="token punctuation">&#123;</span> <span class="token string">"RenderType"</span><span class="token operator">=</span><span class="token string">"Opaque"</span> <span class="token string">"Queue"</span><span class="token operator">=</span><span class="token string">"Transparent"</span> <span class="token punctuation">&#125;</span>
        <span class="token comment">//看似矛盾，实际上服务于不同的需求</span>
        <span class="token comment">//把Queue设置成Transparent，可以确保该物体被渲染时其他不透明物体已经渲染完成，否则难以正确得到"透过玻璃看到的图像"</span>
        <span class="token comment">//而设置RenderType则是为了在使用着色器替换的时候，这个物体可以在需要的时候被正确渲染。</span>
        <span class="token comment">//这通常发生在我们需要得到摄像机的深度和法线纹理时</span>
        
        <span class="token comment">//定义了一个可以抓取屏幕图像的Pass，这个Pass中我们定义了一个字符串</span>
        <span class="token comment">//这个字符串内部的名称决定了抓得到的屏幕图像将会被存入哪个纹理当中</span>
        <span class="token comment">//实际上我们可以省略字符串，但是直接声明纹理名称的方法往往可以得到更高的性能。</span>
        GrabPass <span class="token punctuation">&#123;</span><span class="token string">"_RefractionTex"</span><span class="token punctuation">&#125;</span>

        Pass
        <span class="token punctuation">&#123;</span>
            Tags <span class="token punctuation">&#123;</span> <span class="token string">"LightMode"</span><span class="token operator">=</span><span class="token string">"ForwardBase"</span> <span class="token punctuation">&#125;</span>

            CGPROGRAM
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">multi_compile_fwdbase</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">vertex vert</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">fragment frag</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"UnityCG.cginc"</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"AutoLight.cginc"</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Lighting.cginc"</span></span>

            
            <span class="token keyword">sampler2D</span> _MainTex<span class="token punctuation">;</span>
            float4 _MainTex_ST<span class="token punctuation">;</span>
            <span class="token keyword">sampler2D</span> _BumpMap<span class="token punctuation">;</span>
            float4 _BumpMap_ST<span class="token punctuation">;</span>
            samplerCUBE _CubeMap<span class="token punctuation">;</span>
            <span class="token keyword">float</span> _Distortion<span class="token punctuation">;</span>
            <span class="token keyword">float</span> _RefractAmount<span class="token punctuation">;</span>

            <span class="token comment">//这两个变量对应了在使用GrabPass时候指定的纹理名称，_RefractionTex_TexelSize可以让我们得到该纹理的纹素（纹理像素？大小</span>
            <span class="token comment">//例如一个大小为256x512的纹理，它的纹素大小就是1/256,1/512。我们需要在对屏幕图像的采样坐标偏移的时候使用这个变量</span>
            <span class="token keyword">sampler2D</span> _RefractionTex<span class="token punctuation">;</span>
            float4 _RefractionTex_TexelSize<span class="token punctuation">;</span>

            <span class="token keyword">struct</span> <span class="token class-name">a2v</span>
            <span class="token punctuation">&#123;</span>
                float4 vertex <span class="token operator">:</span> POSITION<span class="token punctuation">;</span>
                float3 normal <span class="token operator">:</span> NORMAL<span class="token punctuation">;</span>
                float4 tangent <span class="token operator">:</span> TANGENT<span class="token punctuation">;</span>
                float2 texcoord <span class="token operator">:</span> TEXCOORD0<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

            <span class="token keyword">struct</span> <span class="token class-name">v2f</span>
            <span class="token punctuation">&#123;</span>
                float4 pos <span class="token operator">:</span> SV_POSITION<span class="token punctuation">;</span>
                float4 scrPos <span class="token operator">:</span> TEXCOORD0<span class="token punctuation">;</span>
                float4 uv <span class="token operator">:</span> TEXCOORD1<span class="token punctuation">;</span>
                float4 TtoW0 <span class="token operator">:</span> TEXCOORD2<span class="token punctuation">;</span>
                float4 TtoW1 <span class="token operator">:</span> TEXCOORD3<span class="token punctuation">;</span>
                float4 TtoW2 <span class="token operator">:</span> TEXCOORD4<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

            v2f <span class="token function">vert</span><span class="token punctuation">(</span>a2v v<span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                v2f o<span class="token punctuation">;</span>
                o<span class="token punctuation">.</span>pos <span class="token operator">=</span> <span class="token function">UnityObjectToClipPos</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>vertex<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">//调用内置的ComputeGrabScreenPos函数来得到对应被抓取的屏幕图像的采样坐标</span>
                <span class="token comment">//相比ComputeScreenPos的不同在于针对平台差异造成的采样坐标问题进行了处理</span>
                o<span class="token punctuation">.</span>scrPos <span class="token operator">=</span> <span class="token function">ComputeGrabScreenPos</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span>pos<span class="token punctuation">)</span><span class="token punctuation">;</span>

                o<span class="token punctuation">.</span>uv<span class="token punctuation">.</span>xy <span class="token operator">=</span> <span class="token function">TRANSFORM_TEX</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>texcoord <span class="token punctuation">,</span> _MainTex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                o<span class="token punctuation">.</span>uv<span class="token punctuation">.</span>zw <span class="token operator">=</span> <span class="token function">TRANSFORM_TEX</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>texcoord<span class="token punctuation">,</span> _BumpMap<span class="token punctuation">)</span><span class="token punctuation">;</span>

                float3 worldPos <span class="token operator">=</span> <span class="token function">mul</span><span class="token punctuation">(</span>unity_ObjectToWorld<span class="token punctuation">,</span> v<span class="token punctuation">.</span>vertex<span class="token punctuation">)</span><span class="token punctuation">.</span>xyz<span class="token punctuation">;</span>
                fixed3 worldNormal <span class="token operator">=</span> <span class="token function">UnityObjectToWorldNormal</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>normal<span class="token punctuation">)</span><span class="token punctuation">;</span>
                fixed3 worldTangent <span class="token operator">=</span> <span class="token function">UnityObjectToWorldDir</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>tangent<span class="token punctuation">.</span>xyz<span class="token punctuation">)</span><span class="token punctuation">;</span>
                fixed3 worldBinormal <span class="token operator">=</span> <span class="token function">cross</span><span class="token punctuation">(</span>worldNormal<span class="token punctuation">,</span> worldTangent<span class="token punctuation">)</span> <span class="token operator">*</span> v<span class="token punctuation">.</span>tangent<span class="token punctuation">.</span>w<span class="token punctuation">;</span>

                o<span class="token punctuation">.</span>TtoW0 <span class="token operator">=</span> <span class="token function">float4</span><span class="token punctuation">(</span>worldTangent<span class="token punctuation">.</span>x <span class="token punctuation">,</span> worldBinormal<span class="token punctuation">.</span>x<span class="token punctuation">,</span> worldNormal<span class="token punctuation">.</span>x<span class="token punctuation">,</span> worldPos<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
                o<span class="token punctuation">.</span>TtoW1 <span class="token operator">=</span> <span class="token function">float4</span><span class="token punctuation">(</span>worldTangent<span class="token punctuation">.</span>y <span class="token punctuation">,</span> worldBinormal<span class="token punctuation">.</span>y<span class="token punctuation">,</span> worldNormal<span class="token punctuation">.</span>y<span class="token punctuation">,</span> worldPos<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
                o<span class="token punctuation">.</span>TtoW2 <span class="token operator">=</span> <span class="token function">float4</span><span class="token punctuation">(</span>worldTangent<span class="token punctuation">.</span>z <span class="token punctuation">,</span> worldBinormal<span class="token punctuation">.</span>z<span class="token punctuation">,</span> worldNormal<span class="token punctuation">.</span>z<span class="token punctuation">,</span> worldPos<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">return</span> o<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            
            float4 <span class="token function">frag</span><span class="token punctuation">(</span>v2f i<span class="token punctuation">)</span> <span class="token operator">:</span> SV_Target
            <span class="token punctuation">&#123;</span>
                <span class="token comment">//采样主纹理</span>
                float3 worldPos <span class="token operator">=</span> <span class="token function">float3</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>TtoW0<span class="token punctuation">.</span>w<span class="token punctuation">,</span> i<span class="token punctuation">.</span>TtoW1<span class="token punctuation">.</span>w<span class="token punctuation">,</span> i<span class="token punctuation">.</span>TtoW2<span class="token punctuation">.</span>w<span class="token punctuation">)</span><span class="token punctuation">;</span>
                fixed3 worldViewDir <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span><span class="token function">UnityWorldSpaceViewDir</span><span class="token punctuation">(</span>worldPos<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                fixed3 bump <span class="token operator">=</span> <span class="token function">UnpackNormal</span><span class="token punctuation">(</span><span class="token function">tex2D</span><span class="token punctuation">(</span>_BumpMap<span class="token punctuation">,</span> i<span class="token punctuation">.</span>uv<span class="token punctuation">.</span>zw<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//对法线纹理进行采样，得到切线空间下的法线方向</span>

                <span class="token comment">//利用这个法线方向 计算在切线空间当中的法线偏移量，模拟折射的效果</span>
                <span class="token comment">//_Distortion越大，偏移量越大，玻璃背后的物体看起来变形程度越大。</span>
                float2 offset <span class="token operator">=</span> bump<span class="token punctuation">.</span>xy <span class="token operator">*</span> _Distortion <span class="token operator">*</span> _RefractionTex_TexelSize<span class="token punctuation">.</span>xy<span class="token punctuation">;</span>
                i<span class="token punctuation">.</span>scrPos<span class="token punctuation">.</span>xy <span class="token operator">=</span> offset <span class="token operator">+</span> i<span class="token punctuation">.</span>scrPos<span class="token punctuation">.</span>xy<span class="token punctuation">;</span>
                <span class="token comment">//通过scrPos透视除法得到真正的屏幕坐标，再用这个坐标对屏幕图像_Refractiontex进行采样，得到模拟的反射颜色</span>
                fixed3 refrCol <span class="token operator">=</span> <span class="token function">tex2D</span><span class="token punctuation">(</span>_RefractionTex <span class="token punctuation">,</span> i<span class="token punctuation">.</span>scrPos<span class="token punctuation">.</span>xy <span class="token operator">/</span> i<span class="token punctuation">.</span>scrPos<span class="token punctuation">.</span>w<span class="token punctuation">)</span><span class="token punctuation">.</span>rgb<span class="token punctuation">;</span>

                <span class="token comment">//将法线转换成世界坐标，并且计算反射结果</span>
                bump <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span><span class="token function">half3</span><span class="token punctuation">(</span><span class="token function">dot</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>TtoW0<span class="token punctuation">.</span>xyz<span class="token punctuation">,</span> bump<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">dot</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>TtoW1<span class="token punctuation">.</span>xyz<span class="token punctuation">,</span> bump<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">dot</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>TtoW2<span class="token punctuation">.</span>xyz<span class="token punctuation">,</span> bump<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                fixed3 reflDir <span class="token operator">=</span> <span class="token function">reflect</span><span class="token punctuation">(</span><span class="token operator">-</span>worldViewDir<span class="token punctuation">,</span> bump<span class="token punctuation">)</span><span class="token punctuation">;</span>
                fixed4 texColor <span class="token operator">=</span> <span class="token function">tex2D</span><span class="token punctuation">(</span>_MainTex<span class="token punctuation">,</span> i<span class="token punctuation">.</span>uv<span class="token punctuation">.</span>xy<span class="token punctuation">)</span><span class="token punctuation">;</span>
                fixed3 reflCol <span class="token operator">=</span> <span class="token function">texCUBE</span><span class="token punctuation">(</span>_CubeMap<span class="token punctuation">,</span> reflDir<span class="token punctuation">)</span><span class="token punctuation">.</span>rgb <span class="token operator">*</span> texColor<span class="token punctuation">.</span>rgb<span class="token punctuation">;</span>

                fixed3 finalColor <span class="token operator">=</span> reflCol <span class="token operator">*</span> _RefractAmount <span class="token operator">+</span> refrCol <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> _RefractAmount<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token function">fixed4</span><span class="token punctuation">(</span>finalColor<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            ENDCG
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    FallBack <span class="token string">"Reflective/VertexLit"</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://gitee.com/tonzin/picgo_image_inventory/raw/master/blog/20250317211008697.png" alt="image-20250317134203991"></p>
<p><img src="https://gitee.com/tonzin/picgo_image_inventory/raw/master/blog/20250317211008698.png" alt="image-20250317134729622"></p>
<p>得到一个这样的结果<br><img src="https://gitee.com/tonzin/picgo_image_inventory/raw/master/blog/20250317211008699.png" alt="image-20250317134836101"></p>
<p><img src="https://gitee.com/tonzin/picgo_image_inventory/raw/master/blog/20250317211008700.png" alt="image-20250317135400438"></p>
<p><strong>渲染纹理vsGrabPass</strong><br>Grab好处：实现简单。只需要写几行代码</p>
<p>渲染纹理好处：效率更好，在移动设备上使用渲染纹理可以自定义渲染纹理的大小，尽管这种方法需要把部分场景再次渲染一遍，但是我们可以通过调整摄像机的渲染层来减少第二次渲染时候的场景大小，或者控制摄像机是否开启，而GrabPass虽然不会重新渲染场景，但是它往往需要CPU直接读取后备缓冲中的数据，破坏了CPU和GPU之间的并行性，这是比较好使的</p>
<p>Unity引入了命令缓冲，这允许我们扩展渲染流水线，使用命令缓冲我们也可以得到类似抓屏的效果，它可以在不透明物体渲染后把当前的图像复制到一个临时的渲染目标纹理当中，然后在那里进行一些额外的操作，例如模糊等等，最后把图像传递给需要使用它的物体进行处理和显示。</p>
<h2 id="程序纹理"><a href="#程序纹理" class="headerlink" title="程序纹理"></a>程序纹理</h2><p>程序纹理指的是使用计算机生成的图像</p>
<p>好处是可以使用各种参数来控制纹理的外观，这些属性不仅仅是哪些颜色的属性，甚至可以是完全不同类型的图案属性，这使得我们可以得到更加丰富的动画和视觉效果</p>
<p>在Unity当中实现简单的程序纹理</p>
<p><img src="https://gitee.com/tonzin/picgo_image_inventory/raw/master/blog/20250317211008701.png" alt="image-20250317140144613"></p>
<p><img src="https://gitee.com/tonzin/picgo_image_inventory/raw/master/blog/20250317211008702.png" alt="image-20250317140528163"></p>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Collections</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Collections<span class="token punctuation">.</span>Generic</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">UnityEngine</span><span class="token punctuation">;</span>

<span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">ExecuteInEditMode</span></span><span class="token punctuation">]</span> <span class="token comment">//在编辑器模式下执行</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ProceduralTextureGeneration</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">MonoBehaviour</span></span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token class-name">Material</span> material <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">//材质球</span>

    <span class="token preprocessor property">#<span class="token directive keyword">region</span> 材质球属性</span>

    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">SerializeField</span><span class="token punctuation">,</span> <span class="token class-name">SetProperty</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">"textureWidth"</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
    <span class="token comment">//使用了插件https://github.com/LMNRY/SetProperty</span>
    <span class="token keyword">private</span> <span class="token class-name"><span class="token keyword">int</span></span> m_textureWidth <span class="token operator">=</span> <span class="token number">512</span><span class="token punctuation">;</span> <span class="token comment">//纹理宽度</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> textureWidth
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">get</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> m_textureWidth<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">set</span>
        <span class="token punctuation">&#123;</span>
            m_textureWidth <span class="token operator">=</span> <span class="token keyword">value</span><span class="token punctuation">;</span>
            <span class="token function">_UpdateMaterial</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">SerializeField</span><span class="token punctuation">,</span> <span class="token class-name">SetProperty</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">"backGroundColor"</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
    <span class="token keyword">private</span> <span class="token class-name">Color</span> m_backGroundColor <span class="token operator">=</span> Color<span class="token punctuation">.</span>white<span class="token punctuation">;</span> <span class="token comment">//背景颜色</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">Color</span> backGroundColor
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">get</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> m_backGroundColor<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">set</span>
        <span class="token punctuation">&#123;</span>
            m_backGroundColor <span class="token operator">=</span> <span class="token keyword">value</span><span class="token punctuation">;</span>
            <span class="token function">_UpdateMaterial</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">SerializeField</span><span class="token punctuation">,</span> <span class="token class-name">SetProperty</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">"circleColor"</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
    <span class="token keyword">private</span> <span class="token class-name">Color</span> m_circleColor <span class="token operator">=</span> Color<span class="token punctuation">.</span>yellow<span class="token punctuation">;</span> <span class="token comment">//图案颜色</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">Color</span> circleColor
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">get</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> m_circleColor<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">set</span>
        <span class="token punctuation">&#123;</span>
            m_circleColor <span class="token operator">=</span> <span class="token keyword">value</span><span class="token punctuation">;</span>
            <span class="token function">_UpdateMaterial</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">SerializeField</span> <span class="token punctuation">,</span> <span class="token class-name">SetProperty</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">"blurFactor"</span><span class="token punctuation">)</span></span></span> <span class="token punctuation">]</span>
    <span class="token keyword">private</span> <span class="token class-name"><span class="token keyword">float</span></span> m_blurFactor <span class="token operator">=</span> <span class="token number">2.0f</span><span class="token punctuation">;</span> <span class="token comment">//模糊程度</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">float</span></span> blurFactor
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">get</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> m_blurFactor<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">set</span>
        <span class="token punctuation">&#123;</span>
            m_blurFactor <span class="token operator">=</span> <span class="token keyword">value</span><span class="token punctuation">;</span>
            <span class="token function">_UpdateMaterial</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token preprocessor property">#<span class="token directive keyword">endregion</span></span>
    
    <span class="token keyword">private</span> <span class="token class-name">Texture2D</span> m_generatedTexture<span class="token punctuation">;</span> <span class="token comment">//生成的纹理</span>

    <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>material <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token class-name">Renderer</span> renderer <span class="token operator">=</span> gameObject<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetComponent</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Renderer<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>renderer <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                Debug<span class="token punctuation">.</span><span class="token function">LogWarning</span><span class="token punctuation">(</span><span class="token string">"不能找到一个网格来渲染"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            material <span class="token operator">=</span> renderer<span class="token punctuation">.</span>sharedMaterial<span class="token punctuation">;</span>
            <span class="token comment">// sharedMaterial：</span>
            <span class="token comment">// 作用：获取或设置该 Renderer 共享的材质（Material）。</span>
            <span class="token comment">// 影响范围：对 sharedMaterial 进行修改会影响所有使用该材质的对象，因为它是指向原始材质的引用。</span>
            <span class="token comment">// 性能：更高效，因为它不会自动创建新的材质实例。</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">_UpdateMaterial</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">_UpdateMaterial</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>material <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            m_generatedTexture <span class="token operator">=</span> <span class="token function">GenerateTexture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            material<span class="token punctuation">.</span><span class="token function">SetTexture</span><span class="token punctuation">(</span><span class="token string">"_MainTex"</span> <span class="token punctuation">,</span> m_generatedTexture<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">private</span> <span class="token return-type class-name">Color</span> <span class="token function">_MixColor</span><span class="token punctuation">(</span><span class="token class-name">Color</span> color0<span class="token punctuation">,</span> <span class="token class-name">Color</span> color1<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">float</span></span> mix<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token class-name">Color</span> mixColor <span class="token operator">=</span> Color<span class="token punctuation">.</span>white<span class="token punctuation">;</span>
		mixColor<span class="token punctuation">.</span>r <span class="token operator">=</span> Mathf<span class="token punctuation">.</span><span class="token function">Lerp</span><span class="token punctuation">(</span>color0<span class="token punctuation">.</span>r<span class="token punctuation">,</span> color1<span class="token punctuation">.</span>r<span class="token punctuation">,</span> mix<span class="token punctuation">)</span><span class="token punctuation">;</span>
		mixColor<span class="token punctuation">.</span>g <span class="token operator">=</span> Mathf<span class="token punctuation">.</span><span class="token function">Lerp</span><span class="token punctuation">(</span>color0<span class="token punctuation">.</span>g<span class="token punctuation">,</span> color1<span class="token punctuation">.</span>g<span class="token punctuation">,</span> mix<span class="token punctuation">)</span><span class="token punctuation">;</span>
		mixColor<span class="token punctuation">.</span>b <span class="token operator">=</span> Mathf<span class="token punctuation">.</span><span class="token function">Lerp</span><span class="token punctuation">(</span>color0<span class="token punctuation">.</span>b<span class="token punctuation">,</span> color1<span class="token punctuation">.</span>b<span class="token punctuation">,</span> mix<span class="token punctuation">)</span><span class="token punctuation">;</span>
		mixColor<span class="token punctuation">.</span>a <span class="token operator">=</span> Mathf<span class="token punctuation">.</span><span class="token function">Lerp</span><span class="token punctuation">(</span>color0<span class="token punctuation">.</span>a<span class="token punctuation">,</span> color1<span class="token punctuation">.</span>a<span class="token punctuation">,</span> mix<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> mixColor<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">private</span> <span class="token return-type class-name">Texture2D</span> <span class="token function">GenerateTexture</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token class-name">Texture2D</span> proceduralTexture <span class="token operator">=</span> 
        <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Texture2D</span><span class="token punctuation">(</span>textureWidth<span class="token punctuation">,</span> textureWidth<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name"><span class="token keyword">float</span></span> circleInterval <span class="token operator">=</span> textureWidth <span class="token operator">/</span> <span class="token number">4.0f</span><span class="token punctuation">;</span> <span class="token comment">//圆的间隔</span>
        <span class="token class-name"><span class="token keyword">float</span></span> radius <span class="token operator">=</span> textureWidth <span class="token operator">/</span> <span class="token number">8.0f</span><span class="token punctuation">;</span> <span class="token comment">//半径</span>
        <span class="token class-name"><span class="token keyword">float</span></span> edgeBlur <span class="token operator">=</span> <span class="token number">1.0f</span> <span class="token operator">/</span> blurFactor<span class="token punctuation">;</span>

        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> w <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span> w <span class="token operator">&lt;</span> textureWidth <span class="token punctuation">;</span> w<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> h <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span> h <span class="token operator">&lt;</span> textureWidth <span class="token punctuation">;</span> h<span class="token operator">++</span><span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                <span class="token comment">//使用背景颜色进行初始化</span>
                <span class="token class-name">Color</span> pixelColor <span class="token operator">=</span> backGroundColor<span class="token punctuation">;</span>

                <span class="token comment">//依次画9个圆</span>
                <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> i <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span> <span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
                <span class="token punctuation">&#123;</span>
                    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> j <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">3</span> <span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span>
                    <span class="token punctuation">&#123;</span>
                        <span class="token comment">//计算圆心坐标</span>
                        <span class="token class-name">Vector2</span> circleCenter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Vector2</span><span class="token punctuation">(</span>circleInterval <span class="token operator">*</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">,</span> circleInterval <span class="token operator">*</span> <span class="token punctuation">(</span>j <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">//计算当前像素与圆的距离</span>
                        <span class="token class-name"><span class="token keyword">float</span></span> dist <span class="token operator">=</span> Vector2<span class="token punctuation">.</span><span class="token function">Distance</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">Vector2</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> h<span class="token punctuation">)</span><span class="token punctuation">,</span> circleCenter<span class="token punctuation">)</span> <span class="token operator">-</span> radius<span class="token punctuation">;</span>
                        <span class="token comment">//模糊圆的边界</span>
                        <span class="token class-name">Color</span> color <span class="token operator">=</span> _MixColor
                        <span class="token punctuation">(</span>circleColor <span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Color</span><span class="token punctuation">(</span>pixelColor<span class="token punctuation">.</span>r<span class="token punctuation">,</span> pixelColor<span class="token punctuation">.</span>g<span class="token punctuation">,</span> pixelColor<span class="token punctuation">.</span>b<span class="token punctuation">,</span> <span class="token number">0.0f</span><span class="token punctuation">)</span>
                        <span class="token punctuation">,</span> Mathf<span class="token punctuation">.</span><span class="token function">SmoothStep</span><span class="token punctuation">(</span><span class="token number">0f</span> <span class="token punctuation">,</span> <span class="token number">1.0f</span> <span class="token punctuation">,</span> dist <span class="token operator">*</span> edgeBlur<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">//在 Mathf.SmoothStep(0f, 1.0f, x) 中，如果 x（即 dist * edgeBlur）小于 0f，</span>
                        <span class="token comment">// 函数将返回 0f，这意味着当前像素的颜色会完全混合成 circleColor。</span>
                        <span class="token comment">//与之前得到的颜色进行混合</span>
                        pixelColor <span class="token operator">=</span> <span class="token function">_MixColor</span><span class="token punctuation">(</span>pixelColor <span class="token punctuation">,</span> color <span class="token punctuation">,</span> color<span class="token punctuation">.</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>
                proceduralTexture<span class="token punctuation">.</span><span class="token function">SetPixel</span><span class="token punctuation">(</span>w  <span class="token punctuation">,</span> h <span class="token punctuation">,</span> pixelColor<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>

        proceduralTexture<span class="token punctuation">.</span><span class="token function">Apply</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> proceduralTexture<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>生成的纹理如下</p>
<p><img src="https://gitee.com/tonzin/picgo_image_inventory/raw/master/blog/20250317211008703.png" alt="image-20250317150038217"></p>
<p>Unity还有一种专门使用程序纹理的材质叫做<strong>程序材质</strong>，这类材质和我们之前使用的材质在本质上是一样的，不同的是，他们使用都是程序纹理，程序材质以及它使用的程序材质主要是在<strong>Substance Designer</strong>当中创建的。</p>
<h1 id="让画面动起来"><a href="#让画面动起来" class="headerlink" title="让画面动起来"></a>让画面动起来</h1><p><img src="https://gitee.com/tonzin/picgo_image_inventory/raw/master/blog/20250317211008704.png" alt="image-20250317150412727"></p>
<h2 id="纹理动画"><a href="#纹理动画" class="headerlink" title="纹理动画"></a>纹理动画</h2><p>序列帧动画</p>
<p>这种动画需要提供一张包含了关键帧图像的图像，例如这样</p>
<p><img src="https://gitee.com/tonzin/picgo_image_inventory/raw/master/blog/20250317211008705.png" alt="image-20250317150523876"></p>
<pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl"><span class="token comment">// Upgrade NOTE: replaced 'mul(UNITY_MATRIX_MVP,*)' with 'UnityObjectToClipPos(*)'</span>

Shader <span class="token string">"Custom/Chapter11_1_ImageSequenceAnimation"</span>
<span class="token punctuation">&#123;</span>
    Properties
    <span class="token punctuation">&#123;</span>
        <span class="token function">_Color</span> <span class="token punctuation">(</span><span class="token string">"Color"</span><span class="token punctuation">,</span> Color<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token function">_MainTex</span> <span class="token punctuation">(</span><span class="token string">"Image Sequence"</span><span class="token punctuation">,</span> <span class="token number">2</span>D<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">"white"</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
        <span class="token function">_HorizontalAmount</span> <span class="token punctuation">(</span><span class="token string">"Horizontal Amount"</span> <span class="token punctuation">,</span> <span class="token keyword">float</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">4</span>
        <span class="token function">_VerticalAmount</span> <span class="token punctuation">(</span><span class="token string">"Vertical Amount"</span> <span class="token punctuation">,</span> <span class="token keyword">float</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">4</span>
        <span class="token comment">//分别代表该图像在水平方向和竖直方向包含的关键帧个数，而_Speed代表动画播放速度 </span>
        <span class="token function">_Speed</span> <span class="token punctuation">(</span><span class="token string">"Speed"</span> <span class="token punctuation">,</span> <span class="token function">Range</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">30</span>
    <span class="token punctuation">&#125;</span>
    SubShader
    <span class="token punctuation">&#123;</span>
        Tags <span class="token punctuation">&#123;</span><span class="token string">"Queue"</span><span class="token operator">=</span><span class="token string">"Transparent"</span> <span class="token string">"IgnoreProjector"</span><span class="token operator">=</span><span class="token string">"True"</span> <span class="token string">"RenderType"</span><span class="token operator">=</span><span class="token string">"Transparent"</span> <span class="token punctuation">&#125;</span>
        <span class="token comment">//序列帧图像通常包含了透明管道，可以被当成是一个半透明对象来渲染</span>
        Pass
        <span class="token punctuation">&#123;</span>
            Tags <span class="token punctuation">&#123;</span><span class="token string">"LightMode"</span><span class="token operator">=</span><span class="token string">"ForwardBase"</span><span class="token punctuation">&#125;</span>

            ZWrite Off
            Blend SrcAlpha OneMinusSrcAlpha

            CGPROGRAM
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">multi_compile_fwdbase</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">vertex vert</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">fragment frag</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"UnityCG.cginc"</span></span>

            fixed4 _Color<span class="token punctuation">;</span>
            <span class="token keyword">sampler2D</span> _MainTex<span class="token punctuation">;</span>
            float4 _MainTex_ST<span class="token punctuation">;</span>
            <span class="token keyword">float</span> _HorizontalAmount<span class="token punctuation">;</span>
            <span class="token keyword">float</span> _VerticalAmount<span class="token punctuation">;</span>
            <span class="token keyword">float</span> _Speed<span class="token punctuation">;</span>

            <span class="token keyword">struct</span> <span class="token class-name">a2v</span>
            <span class="token punctuation">&#123;</span>
                float4 vertex <span class="token operator">:</span> POSITION<span class="token punctuation">;</span>
                float2 texcoord <span class="token operator">:</span> TEXCOORD0<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
            <span class="token keyword">struct</span> <span class="token class-name">v2f</span>
            <span class="token punctuation">&#123;</span>
                float4 pos <span class="token operator">:</span> SV_POSITION<span class="token punctuation">;</span>
                float2 uv <span class="token operator">:</span> TEXCOORD0<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
            
            v2f <span class="token function">vert</span> <span class="token punctuation">(</span>a2v v<span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                v2f o<span class="token punctuation">;</span>
                o<span class="token punctuation">.</span>pos <span class="token operator">=</span> <span class="token function">UnityObjectToClipPos</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>vertex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                o<span class="token punctuation">.</span>uv <span class="token operator">=</span> <span class="token function">TRANSFORM_TEX</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>texcoord <span class="token punctuation">,</span> _MainTex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> o<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            
            fixed4 <span class="token function">frag</span> <span class="token punctuation">(</span>v2f i<span class="token punctuation">)</span> <span class="token operator">:</span> SV_Target
            <span class="token punctuation">&#123;</span>
                <span class="token keyword">float</span> time<span class="token operator">=</span> <span class="token function">floor</span><span class="token punctuation">(</span>_Time<span class="token punctuation">.</span>y <span class="token operator">*</span> _Speed<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//即场景加载过后经历的时间，需要得到整数时间</span>
                <span class="token keyword">float</span> row <span class="token operator">=</span> <span class="token function">floor</span><span class="token punctuation">(</span>time <span class="token operator">/</span> _HorizontalAmount<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//找到当前的行索引</span>
                <span class="token keyword">float</span> column <span class="token operator">=</span> time <span class="token operator">-</span> row <span class="token operator">*</span> _HorizontalAmount<span class="token punctuation">;</span><span class="token comment">//找到当前的列索引</span>

                half2 uv <span class="token operator">=</span> i<span class="token punctuation">.</span>uv <span class="token operator">+</span> <span class="token function">half2</span><span class="token punctuation">(</span>column<span class="token punctuation">,</span> <span class="token operator">-</span>row<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//在原来的uv上加上行列索引值，得到真正的采样坐标</span>
                <span class="token comment">//如果row是正数，那么就会倒着播放</span>

                uv<span class="token punctuation">.</span>x <span class="token operator">/=</span> _HorizontalAmount<span class="token punctuation">;</span><span class="token comment">//于此同时，还需要将uv的x坐标除以水平方向的关键帧个数，以便得到正确的采样位置</span>
                uv<span class="token punctuation">.</span>y <span class="token operator">/=</span> _VerticalAmount<span class="token punctuation">;</span>



                fixed4 c <span class="token operator">=</span> <span class="token function">tex2D</span><span class="token punctuation">(</span>_MainTex <span class="token punctuation">,</span> uv<span class="token punctuation">)</span><span class="token punctuation">;</span>
                c<span class="token punctuation">.</span>rgb <span class="token operator">*=</span> _Color<span class="token punctuation">.</span>rgb<span class="token punctuation">;</span>

                <span class="token keyword">return</span> c<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            ENDCG
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    FallBack <span class="token string">"Transparent/VertexLit"</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p><img src="https://gitee.com/tonzin/picgo_image_inventory/raw/master/blog/20250317211008706.png" alt="image-20250317155846336"></p>
<p><img src="https://gitee.com/tonzin/picgo_image_inventory/raw/master/blog/20250317211008707.png" alt="image-20250317164855605"></p>
<p><img src="https://gitee.com/tonzin/picgo_image_inventory/raw/master/blog/20250317211008708.png" alt="image-20250317164716505"></p>
<p><strong>滚动背景</strong></p>
<p>注意摄像机要设置成正交</p>
<p><img src="https://gitee.com/tonzin/picgo_image_inventory/raw/master/blog/20250317211008709.png" alt="image-20250317170839398"><br>添加前景和后景的图片得到这种效果</p>
<pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl"><span class="token comment">// Upgrade NOTE: replaced 'mul(UNITY_MATRIX_MVP,*)' with 'UnityObjectToClipPos(*)'</span>

Shader <span class="token string">"Custom/Chapter11_2_ScrollingBackground"</span>
<span class="token punctuation">&#123;</span>
    Properties
    <span class="token punctuation">&#123;</span>
        <span class="token function">_MainTex</span> <span class="token punctuation">(</span><span class="token string">"Base Layer (RGB) "</span><span class="token punctuation">,</span> <span class="token number">2</span>D<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">"white"</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
        <span class="token function">_DetailTex</span> <span class="token punctuation">(</span><span class="token string">"2nd Layer (RGB) "</span><span class="token punctuation">,</span> <span class="token number">2</span>D<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">"white"</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
        <span class="token function">_ScrollX</span> <span class="token punctuation">(</span><span class="token string">"Base layer Scroll Speed"</span><span class="token punctuation">,</span> Float<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1.0</span>
        <span class="token function">_Scroll2X</span> <span class="token punctuation">(</span><span class="token string">"2nd layer Scroll Speed"</span><span class="token punctuation">,</span> Float<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1.0</span>
        <span class="token function">_Multiplier</span> <span class="token punctuation">(</span><span class="token string">"Multiplier"</span><span class="token punctuation">,</span> Float<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1.0</span>
    <span class="token punctuation">&#125;</span>
    
    SubShader
    <span class="token punctuation">&#123;</span>
        Tags <span class="token punctuation">&#123;</span> <span class="token string">"RenderType"</span><span class="token operator">=</span><span class="token string">"Opaque"</span> <span class="token punctuation">&#125;</span>
        
        Pass
        <span class="token punctuation">&#123;</span>
            Tags <span class="token punctuation">&#123;</span> <span class="token string">"LightMode"</span><span class="token operator">=</span><span class="token string">"ForwardBase"</span> <span class="token punctuation">&#125;</span>

            CGPROGRAM

            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">vertex vert</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">fragment frag</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"UnityCG.cginc"</span></span>

            <span class="token keyword">sampler2D</span> _MainTex<span class="token punctuation">;</span>
            <span class="token keyword">sampler2D</span> _DetailTex<span class="token punctuation">;</span>
            float4 _MainTex_ST<span class="token punctuation">;</span>
            float4 _DetailTex_ST<span class="token punctuation">;</span>
            <span class="token keyword">float</span> _ScrollX<span class="token punctuation">;</span>
            <span class="token keyword">float</span> _Scroll2X<span class="token punctuation">;</span>
            <span class="token keyword">float</span> _Multiplier<span class="token punctuation">;</span>


            <span class="token keyword">struct</span> <span class="token class-name">a2v</span>
            <span class="token punctuation">&#123;</span>
                float4 vertex <span class="token operator">:</span> POSITION<span class="token punctuation">;</span>
                float2 texcoord <span class="token operator">:</span> TEXCOORD0<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
            <span class="token keyword">struct</span> <span class="token class-name">v2f</span>
            <span class="token punctuation">&#123;</span>
                float4 pos <span class="token operator">:</span> SV_POSITION<span class="token punctuation">;</span>
                float4 uv <span class="token operator">:</span> TEXCOORD0<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

            v2f <span class="token function">vert</span><span class="token punctuation">(</span>a2v v<span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                v2f o<span class="token punctuation">;</span>
                o<span class="token punctuation">.</span>pos <span class="token operator">=</span> <span class="token function">UnityObjectToClipPos</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>vertex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                o<span class="token punctuation">.</span>uv<span class="token punctuation">.</span>xy <span class="token operator">=</span> <span class="token function">TRANSFORM_TEX</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>texcoord<span class="token punctuation">,</span> _MainTex<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">+</span> <span class="token function">frac</span><span class="token punctuation">(</span><span class="token function">float2</span> <span class="token punctuation">(</span>_ScrollX <span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span> <span class="token operator">*</span> _Time<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
                o<span class="token punctuation">.</span>uv<span class="token punctuation">.</span>zw <span class="token operator">=</span> <span class="token function">TRANSFORM_TEX</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>texcoord<span class="token punctuation">,</span> _DetailTex<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">frac</span><span class="token punctuation">(</span><span class="token function">float2</span> <span class="token punctuation">(</span>_Scroll2X<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span> <span class="token operator">*</span> _Time<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> o<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            fixed4 <span class="token function">frag</span><span class="token punctuation">(</span>v2f i<span class="token punctuation">)</span> <span class="token operator">:</span> SV_Target
            <span class="token punctuation">&#123;</span>
                fixed4 firstLayer <span class="token operator">=</span> <span class="token function">tex2D</span><span class="token punctuation">(</span>_MainTex <span class="token punctuation">,</span> i<span class="token punctuation">.</span>uv<span class="token punctuation">.</span>xy<span class="token punctuation">)</span><span class="token punctuation">;</span>
                fixed4 secondLayer <span class="token operator">=</span> <span class="token function">tex2D</span><span class="token punctuation">(</span>_DetailTex <span class="token punctuation">,</span> i<span class="token punctuation">.</span>uv<span class="token punctuation">.</span>zw<span class="token punctuation">)</span><span class="token punctuation">;</span>

                fixed4 c <span class="token operator">=</span> <span class="token function">lerp</span><span class="token punctuation">(</span>firstLayer<span class="token punctuation">,</span> secondLayer<span class="token punctuation">,</span> secondLayer<span class="token punctuation">.</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
                c<span class="token punctuation">.</span>rgb <span class="token operator">*=</span> _Multiplier<span class="token punctuation">;</span>

                <span class="token keyword">return</span> c<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            ENDCG
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    FallBack <span class="token string">"Diffuse"</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="顶点动画"><a href="#顶点动画" class="headerlink" title="顶点动画"></a>顶点动画</h2><p>2D河流的模拟<br>它的原理通常就是使用正弦函数还模拟水流的波动效果</p>
<pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl"><span class="token comment">// Upgrade NOTE: replaced 'mul(UNITY_MATRIX_MVP,*)' with 'UnityObjectToClipPos(*)'</span>

Shader <span class="token string">"Custom/Chapter11_3_Water"</span>
<span class="token punctuation">&#123;</span>
    Properties
    <span class="token punctuation">&#123;</span>
        <span class="token function">_MainTex</span> <span class="token punctuation">(</span><span class="token string">"Texture"</span><span class="token punctuation">,</span> <span class="token number">2</span>D<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">"white"</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token comment">//河流纹理</span>
        <span class="token function">_Color</span> <span class="token punctuation">(</span><span class="token string">"Color Tint"</span><span class="token punctuation">,</span> Color<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token comment">//整体颜色</span>
        <span class="token function">_Magnitude</span> <span class="token punctuation">(</span><span class="token string">"Magnitude"</span><span class="token punctuation">,</span> Float<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token comment">//控制水流波动的幅度</span>
        <span class="token function">_Frequency</span> <span class="token punctuation">(</span><span class="token string">"Frequency"</span><span class="token punctuation">,</span> Float<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token comment">//波动频率</span>
        <span class="token function">_InvWaveLength</span> <span class="token punctuation">(</span><span class="token string">"Distortion Inverse Wave Length"</span> <span class="token punctuation">,</span> Float<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">10</span><span class="token comment">//控制波长的倒数</span>
        <span class="token function">_Speed</span> <span class="token punctuation">(</span><span class="token string">"Speed"</span><span class="token punctuation">,</span> Float<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0.5</span><span class="token comment">//纹理移动速度</span>
    <span class="token punctuation">&#125;</span>
    SubShader
    <span class="token punctuation">&#123;</span>
        <span class="token comment">//需要设置透明效果合适的SubShader标签:</span>

        Tags <span class="token punctuation">&#123;</span> <span class="token string">"Queue"</span> <span class="token operator">=</span> <span class="token string">"Transparent"</span> <span class="token string">"IgnoreProjector"</span> <span class="token operator">=</span> <span class="token string">"True"</span> <span class="token string">"RenderType"</span> <span class="token operator">=</span> <span class="token string">"Transparent"</span>
        <span class="token string">"DisableBatching"</span> <span class="token operator">=</span> <span class="token string">"True"</span> <span class="token punctuation">&#125;</span>
        <span class="token comment">//一些SubShader会在使用Unity的批处理功能时会出现问题，这个时候就可以使用这个标签直接指明</span>
        <span class="token comment">//是否对这个SubShader使用批处理。而这些需要特殊处理的Shader通常就是包含了模型空间的</span>
        <span class="token comment">//顶点动画的Shader，这是因为，批处理会合并所有相关的模型，而这些模型各自的模型空间就会丢失</span>

        <span class="token comment">//而在本例中，我们需要在物体的模型空间下对定点位置进行偏移，因此在这里需要取消对这个Shader的批处理操作</span>
        Pass
        <span class="token punctuation">&#123;</span>
            Tags <span class="token punctuation">&#123;</span> <span class="token string">"LightMode"</span><span class="token operator">=</span><span class="token string">"ForwardBase"</span> <span class="token punctuation">&#125;</span>

            ZWrite Off
            Blend SrcAlpha OneMinusSrcAlpha
            Cull Off
                <span class="token comment">//为了让水流的每一个面都能够正常显示</span>

            CGPROGRAM
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">multi_compile_fwdbase</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">vertex vert</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">fragment frag</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"UnityCG.cginc"</span></span>

            <span class="token keyword">sampler2D</span> _MainTex<span class="token punctuation">;</span>
            float4 _MainTex_ST<span class="token punctuation">;</span>
            float4 _Color<span class="token punctuation">;</span>
            <span class="token keyword">float</span> _Magnitude<span class="token punctuation">;</span>
            <span class="token keyword">float</span> _Frequency<span class="token punctuation">;</span>
            <span class="token keyword">float</span> _InvWaveLength<span class="token punctuation">;</span>
            <span class="token keyword">float</span> _Speed<span class="token punctuation">;</span>

            <span class="token keyword">struct</span> <span class="token class-name">a2v</span>
            <span class="token punctuation">&#123;</span>
                float4 vertex <span class="token operator">:</span> POSITION<span class="token punctuation">;</span>
                float2 texcoord <span class="token operator">:</span> TEXCOORD0<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

            <span class="token keyword">struct</span> <span class="token class-name">v2f</span>
            <span class="token punctuation">&#123;</span>
                float4 pos <span class="token operator">:</span> SV_POSITION<span class="token punctuation">;</span>
                float2 uv <span class="token operator">:</span> TEXCOORD0<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>



            v2f <span class="token function">vert</span> <span class="token punctuation">(</span>a2v v<span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                v2f o<span class="token punctuation">;</span>

                float4 offset<span class="token punctuation">;</span>
                offset<span class="token punctuation">.</span>yzw <span class="token operator">=</span> <span class="token function">float3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                offset<span class="token punctuation">.</span>x <span class="token operator">=</span> <span class="token function">sin</span><span class="token punctuation">(</span>_Frequency <span class="token operator">*</span> _Time<span class="token punctuation">.</span>y <span class="token operator">+</span> v<span class="token punctuation">.</span>vertex<span class="token punctuation">.</span>x <span class="token operator">*</span> _InvWaveLength <span class="token operator">+</span> 
                    v<span class="token punctuation">.</span>vertex<span class="token punctuation">.</span>y <span class="token operator">*</span> _InvWaveLength <span class="token operator">+</span> v<span class="token punctuation">.</span>vertex<span class="token punctuation">.</span>z <span class="token operator">*</span> _InvWaveLength<span class="token punctuation">)</span> <span class="token operator">*</span> _Magnitude<span class="token punctuation">;</span>
                    <span class="token comment">//计算顶点在x方向上的偏移值</span>
                <span class="token comment">//Magnitute控制幅度</span>
                <span class="token comment">//_Time.y为正弦函数的参数，随时间增加</span>
                <span class="token comment">//偏移量由v.vertex.x、v.vertex.y、v.vertex.z三个参数决定，分别对应x、y、z轴</span>
                o<span class="token punctuation">.</span>pos <span class="token operator">=</span> <span class="token function">UnityObjectToClipPos</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>vertex <span class="token operator">+</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span>

                o<span class="token punctuation">.</span>uv <span class="token operator">=</span> <span class="token function">TRANSFORM_TEX</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>texcoord<span class="token punctuation">,</span> _MainTex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                o<span class="token punctuation">.</span>uv <span class="token operator">+=</span> <span class="token function">float2</span><span class="token punctuation">(</span><span class="token number">0.0</span> <span class="token punctuation">,</span> _Time<span class="token punctuation">.</span>y <span class="token operator">*</span> _Speed<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> o<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            
            fixed4 <span class="token function">frag</span> <span class="token punctuation">(</span>v2f i<span class="token punctuation">)</span> <span class="token operator">:</span> SV_Target<span class="token comment">//由于操作的是顶点，片段着色器的代码较为简单</span>
            <span class="token punctuation">&#123;</span>
                fixed4 c <span class="token operator">=</span> <span class="token function">tex2D</span><span class="token punctuation">(</span>_MainTex <span class="token punctuation">,</span> i<span class="token punctuation">.</span>uv<span class="token punctuation">)</span><span class="token punctuation">;</span>
                c<span class="token punctuation">.</span>rgb <span class="token operator">*=</span> _Color<span class="token punctuation">.</span>rgb<span class="token punctuation">;</span>

                <span class="token keyword">return</span> c<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            ENDCG
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    FallBack <span class="token string">"Transparent/VertexLit"</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://gitee.com/tonzin/picgo_image_inventory/raw/master/blog/20250317211008710.png" alt="image-20250317175334780"></p>
<p><img src="https://gitee.com/tonzin/picgo_image_inventory/raw/master/blog/20250317211008711.png" alt="image-20250317175432249"></p>
<p><strong>广告牌效果</strong><br>一种常见的顶点动画，常用于渲染烟雾、云朵、闪光效果等<br>广告牌技术的本质是构建旋转矩阵，而我们知道一个变换矩阵需要三个基向量，广告牌技术使用的基向量通常就是表面法线、指向上的方向以及指向右的方向，除此之外，我们还需要一个<strong>锚点</strong>这个锚点在旋转过程当中是固定不变的，以此来确定多边形在空间中的位置。</p>
<p>广告牌技术的难点是如何根据需求 构建三个互相正交的基向量</p>
<pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl"><span class="token comment">// Upgrade NOTE: replaced '_World2Object' with 'unity_WorldToObject'</span>
<span class="token comment">// Upgrade NOTE: replaced 'mul(UNITY_MATRIX_MVP,*)' with 'UnityObjectToClipPos(*)'</span>

Shader <span class="token string">"Custom/Chapter11_4_BillBoard"</span>
<span class="token punctuation">&#123;</span>
    Properties
    <span class="token punctuation">&#123;</span>
        <span class="token function">_MainTex</span> <span class="token punctuation">(</span><span class="token string">"Main Tex"</span><span class="token punctuation">,</span> <span class="token number">2</span>D<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">"white"</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
        <span class="token function">_Color</span> <span class="token punctuation">(</span><span class="token string">"Color Tint"</span><span class="token punctuation">,</span> Color<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token function">_VerticalBillboarding</span> <span class="token punctuation">(</span><span class="token string">"Vertical Billboarding"</span><span class="token punctuation">,</span> <span class="token function">Range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0.5</span>
    <span class="token punctuation">&#125;</span>
    SubShader
    <span class="token punctuation">&#123;</span>
        Tags <span class="token punctuation">&#123;</span> <span class="token string">"Queue"</span><span class="token operator">=</span><span class="token string">"Transparent"</span> <span class="token string">"IgnoreProjector"</span><span class="token operator">=</span><span class="token string">"True"</span> <span class="token string">"RenderType"</span><span class="token operator">=</span><span class="token string">"Transparent"</span> <span class="token string">"DisableBatching"</span><span class="token operator">=</span><span class="token string">"True"</span> <span class="token punctuation">&#125;</span>
        Pass
        <span class="token punctuation">&#123;</span>
            Tags <span class="token punctuation">&#123;</span> <span class="token string">"LightMode"</span><span class="token operator">=</span><span class="token string">"ForwardBase"</span> <span class="token punctuation">&#125;</span>
            ZWrite Off
            Blend SrcAlpha OneMinusSrcAlpha
            Cull Off
            
            <span class="token comment">//让广告牌的每一个面都可以显示</span>

            CGPROGRAM
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">vertex vert</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">fragment frag</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Lighting.cginc"</span></span>

            <span class="token keyword">sampler2D</span> _MainTex<span class="token punctuation">;</span>
            float4 _MainTex_ST<span class="token punctuation">;</span>
            float4 _Color<span class="token punctuation">;</span>
            <span class="token keyword">float</span> _VerticalBillboarding<span class="token punctuation">;</span>


            <span class="token keyword">struct</span> <span class="token class-name">a2v</span>
            <span class="token punctuation">&#123;</span>
                float4 vertex <span class="token operator">:</span> POSITION<span class="token punctuation">;</span>
                float2 texcoord <span class="token operator">:</span> TEXCOORD0<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

            <span class="token keyword">struct</span> <span class="token class-name">v2f</span>
            <span class="token punctuation">&#123;</span>
                float4 pos <span class="token operator">:</span> SV_POSITION<span class="token punctuation">;</span>
                float2 uv <span class="token operator">:</span> TEXCOORD0<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

            v2f <span class="token function">vert</span> <span class="token punctuation">(</span>a2v v<span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                v2f o<span class="token punctuation">;</span>
                
                <span class="token comment">//Suppose the center in object space is fixed</span>
                float3 center <span class="token operator">=</span> <span class="token function">float3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                float3 viewer <span class="token operator">=</span> <span class="token function">mul</span><span class="token punctuation">(</span>unity_WorldToObject<span class="token punctuation">,</span> <span class="token function">float4</span><span class="token punctuation">(</span>_WorldSpaceCameraPos<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>xyz<span class="token punctuation">;</span>
                <span class="token comment">//选择模型空间的原点作为广告牌的锚点，并且利用内置变量获取模型空间下的视角位置</span>
                
                float3 normalDir <span class="token operator">=</span> viewer <span class="token operator">-</span> center<span class="token punctuation">;</span><span class="token comment">//用观察位置和锚点计算目标法线方向</span>
                normalDir<span class="token punctuation">.</span>y <span class="token operator">=</span> normalDir<span class="token punctuation">.</span>y <span class="token operator">*</span> _VerticalBillboarding<span class="token punctuation">;</span> <span class="token comment">//根据_VerticalBillboarding控制垂直方向上的约束度</span>
                normalDir <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>normalDir<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//当_VerticalBillboarding为1的时候，意味着法线方向固定为视角方向，当_VerticalBillboarding为0的时候</span>
                <span class="token comment">//意味着向上方向固定为0,1,0，最后我们需要对计算得到的法线方向进行归一化操作来得到单位矢量</span>

                float3 upDir <span class="token operator">=</span> <span class="token function">abs</span><span class="token punctuation">(</span>normalDir<span class="token punctuation">.</span>y<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0.999</span><span class="token operator">?</span> <span class="token function">float3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">float3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//选择垂直于广告牌的向量作为up向量</span>
                float3 rightDir <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span><span class="token function">cross</span><span class="token punctuation">(</span>upDir<span class="token punctuation">,</span> normalDir<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//选择右向量</span>
                upDir <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span><span class="token function">cross</span><span class="token punctuation">(</span>normalDir<span class="token punctuation">,</span> rightDir<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//重新计算up向量</span>

                float3 centerOffs <span class="token operator">=</span> v<span class="token punctuation">.</span>vertex<span class="token punctuation">.</span>xyz <span class="token operator">-</span> center<span class="token punctuation">;</span> <span class="token comment">//计算目标位置到锚点的偏移</span>
                float3 localPos <span class="token operator">=</span> center <span class="token operator">+</span> rightDir <span class="token operator">*</span> centerOffs<span class="token punctuation">.</span>x <span class="token operator">+</span>
                upDir <span class="token operator">*</span> centerOffs<span class="token punctuation">.</span>y <span class="token operator">+</span> normalDir <span class="token operator">*</span> centerOffs<span class="token punctuation">.</span>z<span class="token punctuation">;</span> <span class="token comment">//将目标位置转换到本地坐标系下</span>

                o<span class="token punctuation">.</span>pos <span class="token operator">=</span> <span class="token function">UnityObjectToClipPos</span><span class="token punctuation">(</span><span class="token function">float4</span><span class="token punctuation">(</span>localPos <span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//将本地坐标系下的位置转换到屏幕空间</span>
                o<span class="token punctuation">.</span>uv <span class="token operator">=</span> <span class="token function">TRANSFORM_TEX</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>texcoord<span class="token punctuation">,</span> _MainTex<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//将纹理坐标转换到UV0</span>
                <span class="token keyword">return</span> o<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            float4 <span class="token function">frag</span> <span class="token punctuation">(</span>v2f i<span class="token punctuation">)</span> <span class="token operator">:</span> SV_Target
            <span class="token punctuation">&#123;</span>
                fixed4 c <span class="token operator">=</span> <span class="token function">tex2D</span><span class="token punctuation">(</span>_MainTex<span class="token punctuation">,</span> i<span class="token punctuation">.</span>uv<span class="token punctuation">)</span><span class="token punctuation">;</span>
                c<span class="token punctuation">.</span>rgb <span class="token operator">*=</span> _Color<span class="token punctuation">.</span>rgb<span class="token punctuation">;</span>
                <span class="token keyword">return</span> c<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            ENDCG
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    FallBack <span class="token string">"Transparent/VertexLit"</span>
<span class="token punctuation">&#125;</span>

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://gitee.com/tonzin/picgo_image_inventory/raw/master/blog/20250317211008712.png" alt="image-20250317193432333"></p>
<p><img src="https://gitee.com/tonzin/picgo_image_inventory/raw/master/blog/20250317211008713.png" alt="image-20250317202051219"></p>
<p><img src="https://gitee.com/tonzin/picgo_image_inventory/raw/master/blog/20250317211008714.png" alt="image-20250317203705402"></p>
<p>注意事项</p>
<p>1，批处理总是会破坏在模型空间下的顶点动画效果。这个时候我们可以通过SubShader的，DisableBatching标签来强制取消对该UnityShader的批处理，不过取消批处理会带来一定的性能下降，增加了DrawCall，因此我们应该尽量避免模型空间下的一些绝对位置和方向来计算。<br>在广告牌的例子当中，为了避免显式使用模型空间的中心来作为锚点，我们可以利用顶点颜色来存储每个顶点到锚点的距离值，这种做法在商业游戏当中非常常见。</p>
<p>其次，如果我们想要对顶点动画的物体添加阴影，那么往往得不到正确的阴影效果，这是因为Unity的阴影绘制需要调用一个ShaowCaster Pass，而如果直接使用这些内置的ShadowCaster Pass，这个Pass中并没有进行相关的顶点动画，因此Unity会仍然按照原来的顶点位置来计算阴影，这并不是我们所希望看到的。这个时候我们需要提供一个自定义的ShadowCasterPass，在这个Pass我们将进行同样的顶点变换过程，需要注意的是，如果Transparent&#x2F;VertexLit中没有定义ShadowCaster Pass，因此也就不会产生阴影。</p>
<p><img src="https://gitee.com/tonzin/picgo_image_inventory/raw/master/blog/20250317211008715.png" alt="image-20250317204547938"></p>
<p>阴影投射的重点在于我们需要按照正常Pass的处理来剔除片元或者进行顶点动画，以使得阴影可以和物体正常的渲染结果相互匹配</p>
<p>注意要把平面的two side勾选上</p>
<pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl"><span class="token comment">// Upgrade NOTE: replaced 'mul(UNITY_MATRIX_MVP,*)' with 'UnityObjectToClipPos(*)'</span>

Shader <span class="token string">"Custom/Chapter11_5_WaterShadow"</span>
<span class="token punctuation">&#123;</span>
    Properties
    <span class="token punctuation">&#123;</span>
        <span class="token function">_MainTex</span> <span class="token punctuation">(</span><span class="token string">"Texture"</span><span class="token punctuation">,</span> <span class="token number">2</span>D<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">"white"</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
        <span class="token function">_Color</span> <span class="token punctuation">(</span><span class="token string">"Color Tint"</span><span class="token punctuation">,</span> Color<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token function">_Magnitude</span> <span class="token punctuation">(</span><span class="token string">"Magnitude"</span><span class="token punctuation">,</span> Float<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span>
        <span class="token function">_Frequency</span> <span class="token punctuation">(</span><span class="token string">"Frequency"</span><span class="token punctuation">,</span> Float<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span>
        <span class="token function">_InvWaveLength</span> <span class="token punctuation">(</span><span class="token string">"Distortion Inverse Wave Length"</span> <span class="token punctuation">,</span> Float<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">10</span>
        <span class="token function">_Speed</span> <span class="token punctuation">(</span><span class="token string">"Speed"</span><span class="token punctuation">,</span> Float<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0.5</span>
    <span class="token punctuation">&#125;</span>
    SubShader
    <span class="token punctuation">&#123;</span>
        <span class="token comment">//需要设置透明效果合适的SubShader标签:</span>

        Tags <span class="token punctuation">&#123;</span> <span class="token string">"Queue"</span> <span class="token operator">=</span> <span class="token string">"Transparent"</span> <span class="token string">"IgnoreProjector"</span> <span class="token operator">=</span> <span class="token string">"True"</span> <span class="token string">"RenderType"</span> <span class="token operator">=</span> <span class="token string">"Transparent"</span>
        <span class="token string">"DisableBatching"</span> <span class="token operator">=</span> <span class="token string">"True"</span> <span class="token punctuation">&#125;</span>

        Pass
        <span class="token punctuation">&#123;</span>
            Tags <span class="token punctuation">&#123;</span> <span class="token string">"LightMode"</span><span class="token operator">=</span><span class="token string">"ForwardBase"</span> <span class="token punctuation">&#125;</span>

            ZWrite Off
            Blend SrcAlpha OneMinusSrcAlpha
            Cull Off

            CGPROGRAM
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">multi_compile_fwdbase</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">vertex vert</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">fragment frag</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"UnityCG.cginc"</span></span>

            <span class="token keyword">sampler2D</span> _MainTex<span class="token punctuation">;</span>
            float4 _MainTex_ST<span class="token punctuation">;</span>
            float4 _Color<span class="token punctuation">;</span>
            <span class="token keyword">float</span> _Magnitude<span class="token punctuation">;</span>
            <span class="token keyword">float</span> _Frequency<span class="token punctuation">;</span>
            <span class="token keyword">float</span> _InvWaveLength<span class="token punctuation">;</span>
            <span class="token keyword">float</span> _Speed<span class="token punctuation">;</span>

            <span class="token keyword">struct</span> <span class="token class-name">a2v</span>
            <span class="token punctuation">&#123;</span>
                float4 vertex <span class="token operator">:</span> POSITION<span class="token punctuation">;</span>
                float2 texcoord <span class="token operator">:</span> TEXCOORD0<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

            <span class="token keyword">struct</span> <span class="token class-name">v2f</span>
            <span class="token punctuation">&#123;</span>
                float4 pos <span class="token operator">:</span> SV_POSITION<span class="token punctuation">;</span>
                float2 uv <span class="token operator">:</span> TEXCOORD0<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

            v2f <span class="token function">vert</span> <span class="token punctuation">(</span>a2v v<span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                v2f o<span class="token punctuation">;</span>

                float4 offset<span class="token punctuation">;</span>
                offset<span class="token punctuation">.</span>yzw <span class="token operator">=</span> <span class="token function">float3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                offset<span class="token punctuation">.</span>x <span class="token operator">=</span> <span class="token function">sin</span><span class="token punctuation">(</span>_Frequency <span class="token operator">*</span> _Time<span class="token punctuation">.</span>y <span class="token operator">+</span> v<span class="token punctuation">.</span>vertex<span class="token punctuation">.</span>x <span class="token operator">*</span> _InvWaveLength <span class="token operator">+</span> 
                    v<span class="token punctuation">.</span>vertex<span class="token punctuation">.</span>y <span class="token operator">*</span> _InvWaveLength <span class="token operator">+</span> v<span class="token punctuation">.</span>vertex<span class="token punctuation">.</span>z <span class="token operator">*</span> _InvWaveLength<span class="token punctuation">)</span> <span class="token operator">*</span> _Magnitude<span class="token punctuation">;</span>

                o<span class="token punctuation">.</span>pos <span class="token operator">=</span> <span class="token function">UnityObjectToClipPos</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>vertex <span class="token operator">+</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span>

                o<span class="token punctuation">.</span>uv <span class="token operator">=</span> <span class="token function">TRANSFORM_TEX</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>texcoord<span class="token punctuation">,</span> _MainTex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                o<span class="token punctuation">.</span>uv <span class="token operator">+=</span> <span class="token function">float2</span><span class="token punctuation">(</span><span class="token number">0.0</span> <span class="token punctuation">,</span> _Time<span class="token punctuation">.</span>y <span class="token operator">*</span> _Speed<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> o<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            
            fixed4 <span class="token function">frag</span> <span class="token punctuation">(</span>v2f i<span class="token punctuation">)</span> <span class="token operator">:</span> SV_Target
            <span class="token punctuation">&#123;</span>
                fixed4 c <span class="token operator">=</span> <span class="token function">tex2D</span><span class="token punctuation">(</span>_MainTex <span class="token punctuation">,</span> i<span class="token punctuation">.</span>uv<span class="token punctuation">)</span><span class="token punctuation">;</span>
                c<span class="token punctuation">.</span>rgb <span class="token operator">*=</span> _Color<span class="token punctuation">.</span>rgb<span class="token punctuation">;</span>

                <span class="token keyword">return</span> c<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            ENDCG
        <span class="token punctuation">&#125;</span>

        Pass
        <span class="token punctuation">&#123;</span>
            Tags <span class="token punctuation">&#123;</span> <span class="token string">"LightMode"</span><span class="token operator">=</span><span class="token string">"ShadowCaster"</span> <span class="token punctuation">&#125;</span>

            CGPROGRAM
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">vertex vert</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">fragment frag</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">multi_compile_shadowcaster</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"UnityCG.cginc"</span></span>

            <span class="token keyword">float</span> _Magnitude<span class="token punctuation">;</span>
            <span class="token keyword">float</span> _Frequency<span class="token punctuation">;</span>
            <span class="token keyword">float</span> _InvWaveLength<span class="token punctuation">;</span>
            <span class="token keyword">float</span> _Speed<span class="token punctuation">;</span>

            <span class="token keyword">struct</span> <span class="token class-name">a2v</span>
            <span class="token punctuation">&#123;</span>
                float4 vertex <span class="token operator">:</span> POSITION<span class="token punctuation">;</span>
                float3 texcoord <span class="token operator">:</span> TEXCOORD0<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

            <span class="token keyword">struct</span> <span class="token class-name">v2f</span>
            <span class="token punctuation">&#123;</span>
                V2F_SHADOW_CASTER<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

            v2f <span class="token function">vert</span><span class="token punctuation">(</span>a2v v<span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                v2f o<span class="token punctuation">;</span>
                float4 offset<span class="token punctuation">;</span>
                offset<span class="token punctuation">.</span>yzw <span class="token operator">=</span> <span class="token function">float3</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                offset<span class="token punctuation">.</span>x <span class="token operator">=</span> <span class="token function">sin</span><span class="token punctuation">(</span>_Frequency <span class="token operator">*</span> _Time<span class="token punctuation">.</span>y <span class="token operator">+</span> v<span class="token punctuation">.</span>vertex<span class="token punctuation">.</span>x <span class="token operator">*</span> _InvWaveLength
                     <span class="token operator">+</span> v<span class="token punctuation">.</span>vertex<span class="token punctuation">.</span>y <span class="token operator">*</span> _InvWaveLength <span class="token operator">+</span> v<span class="token punctuation">.</span>vertex<span class="token punctuation">.</span>z <span class="token operator">*</span> _InvWaveLength<span class="token punctuation">)</span> <span class="token operator">*</span> _Magnitude<span class="token punctuation">;</span>
                v<span class="token punctuation">.</span>vertex <span class="token operator">=</span> v<span class="token punctuation">.</span>vertex <span class="token operator">+</span> offset<span class="token punctuation">;</span>
                <span class="token function">TRANSFER_SHADOW_CASTER</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span>
                <span class="token keyword">return</span> o<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            fixed4 <span class="token function">frag</span><span class="token punctuation">(</span>v2f i<span class="token punctuation">)</span> <span class="token operator">:</span> SV_Target
            <span class="token punctuation">&#123;</span>
                <span class="token function">SHADOW_CASTER_FRAGMENT</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
            <span class="token punctuation">&#125;</span>
            ENDCG
        <span class="token punctuation">&#125;</span>
         
    <span class="token punctuation">&#125;</span>
    FallBack <span class="token string">"Transparent/VertexLit"</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://gitee.com/tonzin/picgo_image_inventory/raw/master/blog/20250317211008716.png" alt="image-20250317210657661"></p>
<p>自定阴影投射Pass常用：V2F_SHADOW_CASTER、TRANSFER_SHADOW_CASTER_NORMALOFFSET、<br>SHADOW_CASTER_FRAGMENT<br>计算阴影投射时候需要的各种变量，而我们可以只关注自定义计算的部分，</p>
<p><img src="https://gitee.com/tonzin/picgo_image_inventory/raw/master/blog/20250317211008717.png" alt="image-20250317204944449"></p>
</article><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Unity/">Unity</a></div><div class="post_share"><div class="social-share" data-image="https://s3.bmp.ovh/imgs/2023/01/12/e92609f7d9e775f5.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2025/03/14/Blender%20%E7%A1%AC%E8%A1%A8%E9%9D%A2%E6%95%99%E7%A8%8B/"><img class="prev-cover" src="https://s3.bmp.ovh/imgs/2023/01/12/b290daacd1b79e32.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info"></div></div></a></div><div class="next-post pull-right"><a href="/2025/03/10/Unity%202D_RPG%E6%B8%B8%E6%88%8F%E5%88%B6%E4%BD%9C%E7%AC%94%E8%AE%B0/"><img class="next-cover" src="https://s3.bmp.ovh/imgs/2023/01/12/1e052378ba7e2bfd.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Unity Shader 入门精要高级</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2025/03/10/Unity%202D_RPG%E6%B8%B8%E6%88%8F%E5%88%B6%E4%BD%9C%E7%AC%94%E8%AE%B0/" title="Unity Shader 入门精要高级"><img class="cover" src="https://s3.bmp.ovh/imgs/2023/01/12/1e052378ba7e2bfd.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-03-10</div><div class="title">Unity Shader 入门精要高级</div></div></a></div><div><a href="/2022/10/28/Unity%20%E4%BB%8EBuilt%20in%E5%8D%87%E7%BA%A7%E5%88%B0Universal%20Render%20PipeLine/" title="Unity 从Built in升级到Universal Render PipeLine"><img class="cover" src="https://s3.bmp.ovh/imgs/2023/01/12/f8943481ff2f250b.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-10-28</div><div class="title">Unity 从Built in升级到Universal Render PipeLine</div></div></a></div><div><a href="/2025/03/17/Unity%20Shader%20%E5%85%A5%E9%97%A8%E7%B2%BE%E8%A6%81%E6%89%A9%E5%B1%95/" title="Unity Shader 入门精要扩展"><img class="cover" src="https://s3.bmp.ovh/imgs/2023/01/12/6b712c90bf59be49.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-03-17</div><div class="title">Unity Shader 入门精要扩展</div></div></a></div><div><a href="/2022/10/28/Unity%20%E5%B0%84%E5%87%BB%E7%94%9F%E5%AD%98%E6%B8%B8%E6%88%8F%E5%88%B6%E4%BD%9C%E7%AC%94%E8%AE%B0/" title="Unity 设计生存游戏制作笔记"><img class="cover" src="https://s3.bmp.ovh/imgs/2023/01/12/1e052378ba7e2bfd.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-10-28</div><div class="title">Unity 设计生存游戏制作笔记</div></div></a></div><div><a href="/2025/03/15/Unity%20Shader%20%E5%85%A5%E9%97%A8%E7%B2%BE%E8%A6%81%E9%AB%98%E7%BA%A7/" title="Unity Shader 入门精要高级"><img class="cover" src="https://s3.bmp.ovh/imgs/2023/01/12/1e052378ba7e2bfd.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-03-15</div><div class="title">Unity Shader 入门精要高级</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/OIP.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">某不知名的作者</div><div class="author-info__description">衬衫的价格是九磅十五便士</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">88</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">27</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">14</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/tonzinonin" target="_blank" title="Github"><i class="fab fa-github"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%AD%E7%BA%A7%E5%85%89%E7%85%A7"><span class="toc-number">1.</span> <span class="toc-text">中级光照</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E5%90%91%E6%B8%B2%E6%9F%93%E8%B7%AF%E5%BE%84"><span class="toc-number">1.1.</span> <span class="toc-text">前向渲染路径</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Unity%E4%B8%AD%E7%9A%84%E5%89%8D%E5%90%91%E6%B8%B2%E6%9F%93"><span class="toc-number">1.1.1.</span> <span class="toc-text">Unity中的前向渲染</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A1%B6%E7%82%B9%E7%85%A7%E6%98%8E%E6%B8%B2%E6%9F%93%E8%B7%AF%E5%BE%84"><span class="toc-number">1.1.2.</span> <span class="toc-text">顶点照明渲染路径</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BB%B6%E8%BF%9F%E6%B8%B2%E6%9F%93%E8%B7%AF%E5%BE%84"><span class="toc-number">1.1.3.</span> <span class="toc-text">延迟渲染路径</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Unity%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3%E4%B8%AD%E5%AF%B9%E6%B8%B2%E6%9F%93%E8%B7%AF%E5%BE%84%E7%9A%84%E6%AF%94%E8%BE%83"><span class="toc-number">1.1.4.</span> <span class="toc-text">Unity官方文档中对渲染路径的比较</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%89%E6%BA%90"><span class="toc-number">1.2.</span> <span class="toc-text">光源</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8%E5%89%8D%E5%90%91%E6%B8%B2%E6%9F%93%E5%BD%93%E4%B8%AD%E5%A4%84%E7%90%86%E4%B8%8D%E5%90%8C%E7%9A%84%E5%85%89%E6%BA%90%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.2.1.</span> <span class="toc-text">在前向渲染当中处理不同的光源类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Unity%E5%BD%93%E4%B8%AD%E7%9A%84%E5%85%89%E7%85%A7%E8%A1%B0%E5%87%8F"><span class="toc-number">1.2.2.</span> <span class="toc-text">Unity当中的光照衰减</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Unity%E5%BD%93%E4%B8%AD%E7%9A%84%E9%98%B4%E5%BD%B1"><span class="toc-number">1.2.3.</span> <span class="toc-text">Unity当中的阴影</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8D%E9%80%8F%E6%98%8E%E7%89%A9%E4%BD%93%E7%9A%84%E9%98%B4%E5%BD%B1"><span class="toc-number">1.2.3.1.</span> <span class="toc-text">不透明物体的阴影</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%8F%E6%98%8E%E5%BA%A6%E7%89%A9%E4%BD%93%E7%9A%84%E6%8A%95%E5%BD%B1"><span class="toc-number">1.2.3.2.</span> <span class="toc-text">透明度物体的投影</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%AD%E7%BA%A7%E7%BA%B9%E7%90%86"><span class="toc-number">2.</span> <span class="toc-text">中级纹理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AB%8B%E6%96%B9%E4%BD%93%E7%BA%B9%E7%90%86"><span class="toc-number">2.1.</span> <span class="toc-text">立方体纹理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%8F%B2%E6%B6%85%E5%B0%94%E5%8F%8D%E5%B0%84"><span class="toc-number">2.2.</span> <span class="toc-text">菲涅尔反射</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B8%B2%E6%9F%93%E7%BA%B9%E7%90%86"><span class="toc-number">2.3.</span> <span class="toc-text">渲染纹理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A8%8B%E5%BA%8F%E7%BA%B9%E7%90%86"><span class="toc-number">2.4.</span> <span class="toc-text">程序纹理</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%AE%A9%E7%94%BB%E9%9D%A2%E5%8A%A8%E8%B5%B7%E6%9D%A5"><span class="toc-number">3.</span> <span class="toc-text">让画面动起来</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BA%B9%E7%90%86%E5%8A%A8%E7%94%BB"><span class="toc-number">3.1.</span> <span class="toc-text">纹理动画</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A1%B6%E7%82%B9%E5%8A%A8%E7%94%BB"><span class="toc-number">3.2.</span> <span class="toc-text">顶点动画</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2025/03/29/Substance%20Painter%20Blender%E5%B7%A5%E4%BD%9C%E6%B5%81/" title="无题"><img src="https://s3.bmp.ovh/imgs/2023/01/12/e92609f7d9e775f5.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="无题"/></a><div class="content"><a class="title" href="/2025/03/29/Substance%20Painter%20Blender%E5%B7%A5%E4%BD%9C%E6%B5%81/" title="无题">无题</a><time datetime="2025-03-29T12:39:26.888Z" title="发表于 2025-03-29 20:39:26">2025-03-29</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/03/26/UnityShaderGraph/" title="无题"><img src="https://s3.bmp.ovh/imgs/2023/01/12/b290daacd1b79e32.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="无题"/></a><div class="content"><a class="title" href="/2025/03/26/UnityShaderGraph/" title="无题">无题</a><time datetime="2025-03-26T08:33:02.619Z" title="发表于 2025-03-26 16:33:02">2025-03-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/03/26/%E6%8A%80%E6%9C%AF%E7%BE%8E%E6%9C%AF%E5%85%A5%E9%97%A8/" title="无题"><img src="https://s3.bmp.ovh/imgs/2023/01/12/1e052378ba7e2bfd.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="无题"/></a><div class="content"><a class="title" href="/2025/03/26/%E6%8A%80%E6%9C%AF%E7%BE%8E%E6%9C%AF%E5%85%A5%E9%97%A8/" title="无题">无题</a><time datetime="2025-03-26T04:48:22.514Z" title="发表于 2025-03-26 12:48:22">2025-03-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/03/26/Gpu%E9%98%B3%E6%98%A5%E7%99%BD%E9%9B%AA%E4%B8%8E%E4%B8%8B%E9%87%8C%E5%B7%B4%E4%BA%BA%E7%AC%94%E8%AE%B0/" title="无题"><img src="https://s3.bmp.ovh/imgs/2023/01/12/4bcf264a84775fc0.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="无题"/></a><div class="content"><a class="title" href="/2025/03/26/Gpu%E9%98%B3%E6%98%A5%E7%99%BD%E9%9B%AA%E4%B8%8E%E4%B8%8B%E9%87%8C%E5%B7%B4%E4%BA%BA%E7%AC%94%E8%AE%B0/" title="无题">无题</a><time datetime="2025-03-26T02:43:50.830Z" title="发表于 2025-03-26 10:43:50">2025-03-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/03/25/Unity%E8%83%8C%E5%8C%85%E7%B3%BB%E7%BB%9F/" title="无题"><img src="https://s3.bmp.ovh/imgs/2023/01/12/4380663e3f60c5ab.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="无题"/></a><div class="content"><a class="title" href="/2025/03/25/Unity%E8%83%8C%E5%8C%85%E7%B3%BB%E7%BB%9F/" title="无题">无题</a><time datetime="2025-03-25T11:28:52.056Z" title="发表于 2025-03-25 19:28:52">2025-03-25</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: '',
      appKey: '',
      avatar: 'monsterid',
      serverURLs: '',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !true) {
  if (true) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>